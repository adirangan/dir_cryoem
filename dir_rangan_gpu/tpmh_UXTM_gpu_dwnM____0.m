function ...
[ ...
 UX_T_M_k_q_gpu_dwnM____ ...
] = ...
tpmh_UXTM_gpu_dwnM____0( ...
 FTK ...
,n_k_p_r ...
,k_p_gpu_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_gpu_wkM__ ...
,pm_n_UX_rank ...
,pm_UX_gpu_kn__ ...
,pm_X_weight_gpu_r_ ...
);

str_thisfunction = 'tpmh_UXTM_gpu_dwnM____0';

flag_verbose=0;

f_zero = gpuArray( single(0.0));
if ~strcmp(class(k_p_gpu_r_),'gpuArray'); tmp_t = tic(); k_p_gpu_r_ = gpuArray( (k_p_gpu_r_)); tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% k_p_gpu_r_: time %0.6fs',tmp_t)); end; end;
if ~strcmp(class(M_k_p_gpu_wkM__),'gpuArray'); tmp_t = tic(); M_k_p_gpu_wkM__ = gpuArray( (M_k_p_gpu_wkM__)); tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% M_k_p_gpu_wkM__: time %0.6fs',tmp_t)); end; end;
if ~strcmp(class(pm_UX_gpu_kn__),'gpuArray'); tmp_t = tic(); pm_UX_gpu_kn__ = gpuArray( (pm_UX_gpu_kn__)); tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% pm_UX_gpu_kn__: time %0.6fs',tmp_t)); end; end;
if ~strcmp(class(pm_X_weight_gpu_r_),'gpuArray'); tmp_t = tic(); pm_X_weight_gpu_r_ = gpuArray( (pm_X_weight_gpu_r_)); tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% pm_X_weight_gpu_r_: time %0.6fs',tmp_t)); end; end;

n_w_ = n_w_(:); n_w_max = max(n_w_); n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
if (numel(unique(n_w_))> 1); disp(sprintf(' %% Warning, n_w_ not uniform in %s',str_thisfunction)); end;
%%%%%%%%;

n_delta_v = FTK.n_delta_v;
delta_x_gpu_dM__ = repmat(reshape(gpuArray( FTK.delta_x_ ),[n_delta_v,1]),[1,n_M]);
delta_y_gpu_dM__ = repmat(reshape(gpuArray( FTK.delta_y_ ),[n_delta_v,1]),[1,n_M]);
[ ...
 T_M_k_p_gpu_wkdM___ ...
] = ...
transf_p_to_p_uniform_over_n_k_p_r_gpu_0( ...
 n_k_p_r ...
,k_p_gpu_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_gpu_wkM__ ...
,n_delta_v ...
,delta_x_gpu_dM__ ...
,delta_y_gpu_dM__ ...
);

pm_wUX_gpu_kn__ = diag(pm_X_weight_gpu_r_)*pm_UX_gpu_kn__;
UX_T_M_k_p_gpu_wndM____ = reshape(pagetranspose(pagemtimes(pm_wUX_gpu_kn__,'transpose',reshape(T_M_k_p_gpu_wkdM___,[n_w_max,n_k_p_r,n_delta_v,n_M]),'transpose')),[n_w_max,pm_n_UX_rank,n_delta_v,n_M]);

pm_n_w_ = n_w_max*ones(pm_n_UX_rank,1); pm_n_w_sum = sum(pm_n_w_);
UX_T_M_k_q_gpu_wndM____ = interp_p_to_q(pm_n_UX_rank,pm_n_w_,pm_n_w_sum,UX_T_M_k_p_gpu_wndM____);

UX_T_M_k_q_gpu_dwnM____ = permute(UX_T_M_k_q_gpu_wndM____,1+[2,0,1,3]);



