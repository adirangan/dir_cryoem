%%%%%%%%;
% Now try to load the data: ;
%%%%%%%%;
N_pixel_ = 0.125:0.125:5.0;
E2_rel__ = cell(length(N_pixel_),1);
n_svd_l__ = cell(length(N_pixel_),1);
F2_rel__ = cell(length(N_pixel_),1);
n_node__ = cell(length(N_pixel_),1);
np_sum = 0;
for np=1:length(N_pixel_);
N_pixel = N_pixel_(np);
fname_base = sprintf('E2vsF2_N%.2d',round(10*N_pixel));
fname_mat = sprintf('./dir_svd/%s.mat',fname_base);
if (~exist(fname_mat,'file'));
disp(sprintf(' %% could not find %s',fname_mat));
test_F_23(N_pixel);
else;%if (~exist(fname_mat,'file'));
%disp(sprintf(' %% loading %s',fname_mat));
load(fname_mat,'n_svd_l_','E2_rel_','n_node_','F2_rel_','N_pixel');
E2_rel__{np} = transpose(sqrt(E2_rel_)); F2_rel__{np} = transpose(sqrt(F2_rel_));
n_svd_l__{np} = transpose(n_svd_l_); n_node__{np} = (n_node_);
np_sum = np_sum + 1;
end;%if (exist(fname_mat,'file'));
end;%for np=1:length(N_pixel_);
%%%%%%%%;

%%%%%%%%;
% Now plot the data. ;
%%%%%%%%;
E2_rel_ = cell2mat(E2_rel__); F2_rel_ = cell2mat(F2_rel__);
n_svd_l_ = cell2mat(n_svd_l__); n_node_ = cell2mat(n_node__);
%%%%%%%%;
E2_p0_ = zeros(length(N_pixel_),1); E2_p1_ = zeros(length(N_pixel_),1); % linear regression. ;
for np=1:length(N_pixel_);
tmp_x_ = n_svd_l_(np,:);
tmp_y_ = log10(E2_rel_(np,:));
tmp_A_ = [dot(tmp_x_,tmp_x_) , sum(tmp_x_) ; sum(tmp_x_) , length(tmp_x_)] \ [dot(tmp_x_,tmp_y_) ; sum(tmp_y_)];
E2_p1_(np) = tmp_A_(1); E2_p0_(np) = tmp_A_(2);
end;%for np=1:length(N_pixel_);
flag_disp=0;
if flag_disp;
figure; 
hold on;
c_ = colormap(colormap_beach(64)); n_c = size(c_,1);
for np=1:length(N_pixel_);
nb = max(1,min(n_c,floor(n_c*np/length(N_pixel_))));
plot(n_svd_l_(np,:),log10(E2_rel_(np,:)),'o','Color',c_(nb,:));
plot(n_svd_l_(np,:),E2_p0_(np) + E2_p1_(np)*n_svd_l_(np,:),'.-','Color',c_(nb,:));
end;%for np=1:length(N_pixel_);
hold off;
disp('returning');return;
end;%if flag_disp;
%%%%%%%%;
F2_p0_ = zeros(length(N_pixel_),1); F2_p1_ = zeros(length(N_pixel_),1); % linear regression. ;
for np=1:length(N_pixel_);
tmp_x_ = log10(1+pi*(n_node_(np,:)-1).^2);
tmp_y_ = log10(F2_rel_(np,:));
tmp_A_ = [dot(tmp_x_,tmp_x_) , sum(tmp_x_) ; sum(tmp_x_) , length(tmp_x_)] \ [dot(tmp_x_,tmp_y_) ; sum(tmp_y_)];
F2_p1_(np) = tmp_A_(1); F2_p0_(np) = tmp_A_(2);
end;%for np=1:length(N_pixel_);
flag_disp=0;
if flag_disp;
figure; 
hold on;
c_ = colormap(colormap_beach(64)); n_c = size(c_,1);
for np=1:length(N_pixel_);
nb = max(1,min(n_c,floor(n_c*np/length(N_pixel_))));
tmp_x = log10(1+pi*(n_node_(np,:)-1).^2);
plot(tmp_x,log10(F2_rel_(np,:)),'o','Color',c_(nb,:));
plot(tmp_x,F2_p0_(np) + F2_p1_(np)*tmp_x,'.-','Color',c_(nb,:));
end;%for np=1:length(N_pixel_);
hold off;
disp('returning');return;
end;%if flag_disp;
%%%%%%%%;
l10E2_ = -(0:0.25:6);
E2_nterms_ = zeros(length(l10E2_),length(N_pixel_));
for ne=1:length(l10E2_);
l10E2 = l10E2_(ne);
for np=1:length(N_pixel_);
N_pixel = N_pixel_(np);
E2_nterms_(ne,np) = max(1,ceil((l10E2 - E2_p0_(np))/E2_p1_(np)));
end;%for np=1:length(N_pixel_);
end;%for ne=1:length(l10E2_);
%%%%%%%%;
l10F2_ = -(0:0.25:6);
F2_nterms_ = zeros(length(l10F2_),length(N_pixel_));
for ne=1:length(l10F2_);
l10F2 = l10F2_(ne);
for np=1:length(N_pixel_);
N_pixel = N_pixel_(np);
F2_nterms_(ne,np) = max(1,ceil(10.^((l10F2 - F2_p0_(np))/F2_p1_(np))));
end;%for np=1:length(N_pixel_);
end;%for ne=1:length(l10F2_);

%%%%%%%%;
% Now plot the data. ;
%%%%%%%%;
flag_disp=0;
if flag_disp;
colormap('hot');%colormap(colormap_beach(65));
%%%%%%%%;
subplot(3,1,1);
imagesc(log10(E2_nterms_),[0,8]); 
title(sprintf('SVD-expansion'));
tmp_ij_ = 4:4:length(N_pixel_); tmp_label = num2str(transpose(N_pixel_(tmp_ij_)),'%0.1f');
set(gca,'XTick',tmp_ij_,'XTickLabel',tmp_label); xtickangle(gca,90); 
xlabel('N Pixel');
tmp_ij_ = 1:4:length(l10E2_); tmp_label = num2str(transpose(l10E2_(tmp_ij_)),'%d');
set(gca,'YTick',tmp_ij_,'YTickLabel',tmp_label); 
ylabel('log10(E2)');
set(gca,'TickLength',[0 0])
c = colorbar; c.Label.String = 'log10(Nterms)';
%%%%%%%%;
subplot(3,1,2);
imagesc(log10(F2_nterms_),[0,8]); 
title(sprintf('Linear-Interpolation'));
tmp_ij_ = 4:4:length(N_pixel_); tmp_label = num2str(transpose(N_pixel_(tmp_ij_)),'%0.1f');
set(gca,'XTick',tmp_ij_,'XTickLabel',tmp_label); xtickangle(gca,90); 
xlabel('N Pixel');
tmp_ij_ = 1:4:length(l10E2_); tmp_label = num2str(transpose(l10E2_(tmp_ij_)),'%d');
set(gca,'YTick',tmp_ij_,'YTickLabel',tmp_label); 
ylabel('log10(E2)');
set(gca,'TickLength',[0 0])
c = colorbar; c.Label.String = 'log10(Nterms)';
%%%%%%%%;
subplot(3,1,3);
imagesc(log10(F2_nterms_./E2_nterms_),[0,5]); 
title(sprintf('Ratio'));
tmp_ij_ = 4:4:length(N_pixel_); tmp_label = num2str(transpose(N_pixel_(tmp_ij_)),'%0.1f');
set(gca,'XTick',tmp_ij_,'XTickLabel',tmp_label); xtickangle(gca,90); 
xlabel('N Pixel');
tmp_ij_ = 1:4:length(l10E2_); tmp_label = num2str(transpose(l10E2_(tmp_ij_)),'%d');
set(gca,'YTick',tmp_ij_,'YTickLabel',tmp_label); 
ylabel('log10(E2)');
set(gca,'TickLength',[0 0])
c = colorbar; c.Label.String = 'log10(Ratio)';
%%%%%%%%;
set(gcf,'Position',1+[0,0,768,1024]);
%%%%%%%%;
fname_fig = sprintf('./dir_svd/E2vsF2_FigA');
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
disp('returning');return;
end;%if flag_disp;

%%%%%%%%;
% Sanity check;
%%%%%%%%;
flag_disp=0;
if flag_disp;
np = find(N_pixel_==0.5);subplot(2,2,1);plot(log10(n_svd_l_(np,:)),log10(E2_rel_(np,:)),'ro-',log10(1+pi*(n_node_(np,:)-1).^2),log10(F2_rel_(np,:)),'bo-'); title(sprintf('N_pixel %f',N_pixel_(np)));
np = find(N_pixel_==1.5);subplot(2,2,2);plot(log10(n_svd_l_(np,:)),log10(E2_rel_(np,:)),'ro-',log10(1+pi*(n_node_(np,:)-1).^2),log10(F2_rel_(np,:)),'bo-'); title(sprintf('N_pixel %f',N_pixel_(np)));
np = find(N_pixel_==2.5);subplot(2,2,3);plot(log10(n_svd_l_(np,:)),log10(E2_rel_(np,:)),'ro-',log10(1+pi*(n_node_(np,:)-1).^2),log10(F2_rel_(np,:)),'bo-'); title(sprintf('N_pixel %f',N_pixel_(np)));
np = find(N_pixel_==3.5);subplot(2,2,4);plot(log10(n_svd_l_(np,:)),log10(E2_rel_(np,:)),'ro-',log10(1+pi*(n_node_(np,:)-1).^2),log10(F2_rel_(np,:)),'bo-'); title(sprintf('N_pixel %f',N_pixel_(np)));
disp('returning');return;
end;%if flag_disp;

%%%%%%%%;
% Now calculate same thing for lsq-interpolation; 
%%%%%%%%;
cd('/data/rangan/dir_cryoem/dir_rangan_playpen');
addpath('/data/rangan/dir_cryoem/chebfun');
np = 12; N_pixel = 1.5; %np = find(N_pixel_==1.5); N_pixel = N_pixel_(np);
tmp_n_node_ = [21    27    36    44    53    57    67]; %tmp_n_node_ = n_svd_l_(np,:);
E2_avg__ = cell(length(tmp_n_node_),1);
dt_ = min(1.0,0.125*(1:tmp_n_node_));
n_iteration_ = 128*[1:length(tmp_n_node_)];
flag_recalculate=0;
if flag_recalculate;
for nn=7;%for nn=1:length(tmp_n_node_);
n_node = tmp_n_node_(nn); dt = dt_(nn); n_iteration = n_iteration_(nn);
E2_avg__{nn} = test_F_24(N_pixel,n_node,dt,n_iteration);
end;%for nn=1:length(tmp_n_node_);
end;%if flag_recalculate;

%%%%%%%%;
% Extract a single N_pixel.; 
%%%%%%%%;
np = find(N_pixel_==1.5); N_pixel = N_pixel_(np);
tmp_n_node_ = n_svd_l_(np,:);
E2_avg_end_ = zeros(length(tmp_n_node_),1);
for nn=1:length(tmp_n_node_);
n_node = tmp_n_node_(nn);
fname_mat = sprintf('./dir_svd/E2_avg_N%.2d_n%d.mat',round(10*N_pixel),n_node);
load(fname_mat,'E2_avg_');
E2_avg_end_(nn) = sqrt(E2_avg_(end));
end;%for nn=1:length(tmp_n_node_);

flag_disp=0;
if flag_disp;
subplot(1,1,1); hold on;
plot(log10(n_svd_l_(np,:)),log10(E2_rel_(np,:)),'ro-');
plot(log10(tmp_n_node_),log10(E2_avg_end_),'mo-');
plot(log10(1+pi*(n_node_(np,:)-1).^2),log10(F2_rel_(np,:)),'bo-');
hold off;
xlabel('log10(Nterms)'); ylabel('log10(E2)'); title(sprintf('N pixel %0.1f',N_pixel_(np)));
legend('SVD-Expansion','LSQ-Interpolation','Linear-Interpolation');
fname_fig = sprintf('./dir_svd/E2vsF2_FigB_N%.2d',round(10*N_pixel_(np)));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
disp('returning');return;
end;%if flag_disp;

flag_disp=1;
if flag_disp;
subplot(1,1,1); hold on;
plot(log10(n_svd_l_(np,:)),log10(E2_rel_(np,:)),'co-');
plot(log10(tmp_n_node_),log10(E2_avg_end_),'go-');
plot(log10(1+pi*(n_node_(np,:)-1).^2),log10(F2_rel_(np,:)),'ro-');
plot(log10(E2_nterms_(:,np)),l10E2_,'c:');
plot(log10(F2_nterms_(:,np)),l10F2_,'r:');
hold off;
xlim([1,4]);ylim([-4.5,-0.5]);
set(gcf,'Position',1+[0,0,1024,256]);
xlabel('log10(Nterms)'); ylabel('log10(E2)'); title(sprintf('N pixel %0.1f',N_pixel_(np)));
legend('SVD-Expansion','LSQ-Interpolation','Linear-Interpolation');
fname_fig = sprintf('./dir_svd/E2vsF2_FigC_N%.2d',round(10*N_pixel_(np)));
print('-depsc',sprintf('%s.eps',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
disp('returning');return;
end;%if flag_disp;
