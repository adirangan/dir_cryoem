function [FTK] = gen_Jsvd_FTK_8(K_max,N_pixel,eps_target,l_max,n_a_degree,n_b_degree);
% Generating functional svd-expansion of various bessel-functions. ;
%
% Inputs: ;
% K_max: maximum K-value; K_target will be set to K_max. ;
% N_pixel: maximum pixel width (in wavelengths) allowed for square grid of displacements. ;
% eps_target: tolerance of svd-expansion. ;
% l_max: maximum order of bessel-functions in svd-expansion. ;
% n_a_degree: degree of jacobi-polynomials used to represent r = 2*pi*|k|. ;
% n_b_degree: degree of jacobi-polynomials used to represent d = |delta|. ;
% ;
% Outputs: a structure FTK with the following fields: ;
% n_svd_r: number of coefficients used to represent polynomials of r = 2*pi*k. ;
% svd_r_: vector of quadrature nodes associated with polynomials of r = 2*pi*k. ;
% svd_r_m: midpoint of interval for r = 2*pi*k. ;
% svd_r_c: half-width of interval for r = 2*pi*k. ;
% svd_r_w_: vector of quadrature weights for r = 2*pi*k. ;
% svd_r_Jx__: array of jacobi-polynomial evaluations for r = 2*pi*k. ; 
%             I.e., svd_r_Jx__(1+na_degree,1+nx) = jacobi-polynomial of degree na_degree evaluated at r-node nx. ;
% n_svd_d: number of coefficients used to represent polynomials of d = delta. ;
% svd_d_: vector of quadrature nodes associated with polynomials of d = delta. ;
% svd_d_m: midpoint of interval for d = delta. ;
% svd_d_c: half-width of interval for d = delta. ;
% svd_d_w_: vector of quadrature weights for d = delta. ;
% svd_d_Jx__: array of jacobi-polynomial evaluations for d = delta. ; 
%             I.e., svd_d_Jx__(1+nb_degree,1+nx) = jacobi-polynomial of degree nb_degree evaluated at d-node nx. ;
% n_svd_l: number of terms in svd-expansion. ;
% svd_l_: vector of bessel-orders for the terms in the svd-expansion. ;
% svd_U_d_jacocoef_: array of size n_b_degree-x-n_svd_l storing the delta-side of the svd-expansion. ;
% svd_s_: vector of length n_svd_l storing the singular-values of the svd-expansion. ;
% svd_V_r_jacocoef_: array of size n_a_degree-x-n_svd_l storing the r-side of the svd-expansion. ;
%     Note: if we define index_tmp_ to be the list of indices for which svd_l_ = l_tmp,: ;
%           then we can use the svd-expansion to reconstruct the bessel-function of order l_tmp. ;
%           For example, try: ;
%           gen_Jsvd_FTK_8();
% svd_U_d_chebcoef_: unrolled array of size n_b_degree-x-n_svd_l storing the delta-side of the svd-expansion evaluated at svd_d_. Unlike the polycoef expansion used by gen_Jsvd_FTK_7, this stores a chebcoef expansion. That is, svd_U_d_chebcoef_(1 + nl*n_svd_d + (0:n_svd_d-1)) contains the chebychev-coefficients (up to degree n_svd_d-1) required to evaluate the delta-side of the svd-expansion (see get_svd_chebval_U_d_0.m);
% svd_V_r_chebcoef_: unrolled array of size n_a_degree-x-n_svd_l storing the r-side of the svd-expansion evaluated at svd_r_. Unlike the polycoef expansion used by gen_Jsvd_FTK_7, this stores a chebcoef expansion. That is, svd_V_r_chebcoef_(1 + nl*n_svd_r + (0:n_svd_r-1)) contains the chebychev-coefficients (up to degree n_svd_r-1) required to evaluate the r-side of the svd-expansion (see get_svd_chebval_V_r_0.m);;

if (nargin<1);
flag_verbose=1; flag_disp=0;nf=0;
disp(sprintf(' %% testing gen_Jsvd_FTK_8'));
k_p_r_max = 48/(2*pi); k_eq_d = 1.0/(2*pi); str_L = 'L';
[ ...
 n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
] = ...
get_weight_3d_1( ...
 flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_L ...
);
pm_N_pixel = 1.0; delta_r_max = pm_N_pixel / (2*pi*k_p_r_max) * (pi*sqrt(2)) ;
svd_eps = 1e-4; l_max = 24; n_a_degree = 64; n_b_degree = 65;
%%%%;
FTK8 = gen_Jsvd_FTK_8(k_p_r_max,pm_N_pixel,svd_eps,l_max,n_a_degree,n_b_degree);
n_delta_v_requested = 2*FTK8.n_svd_l;
[FTK8.n_delta_v,FTK8.delta_x_,FTK8.delta_y_] = get_delta_2(delta_r_max,n_delta_v_requested);
FTK8.svd_d_max = delta_r_max;
FTK8.svd_chebval_U_d_ = reshape(get_svd_chebval_U_d_0(FTK8.svd_d_max,FTK8.n_svd_d,FTK8.svd_d_,FTK8.n_svd_l,FTK8.svd_l_,FTK8.svd_U_d_chebcoef_,FTK8.n_delta_v,FTK8.delta_x_,FTK8.delta_y_),[FTK8.n_svd_l*FTK8.n_delta_v,1]);
FTK8.svd_r_max = 2*pi*k_p_r_max;
FTK8.svd_chebval_V_r_ = reshape(get_svd_chebval_V_r_0(FTK8.svd_r_max,FTK8.n_svd_r,FTK8.svd_r_,FTK8.n_svd_l,FTK8.svd_l_,FTK8.svd_V_r_chebcoef_,n_k_p_r,2*pi*k_p_r_),[FTK8.n_svd_l*n_k_p_r,1]);
FTK8.svd_expiw__ = reshape(exp(-i*(pi/2 - reshape(atan2(FTK8.delta_y_,FTK8.delta_x_),[FTK8.n_delta_v,1]))*reshape(FTK8.svd_l_,[1,FTK8.n_svd_l])),[FTK8.n_delta_v,FTK8.n_svd_l]);
FTK8.svd_U_d_expiw_s__ = (permute(reshape(FTK8.svd_chebval_U_d_,[FTK8.n_svd_l,FTK8.n_delta_v]),[2,1]).*FTK8.svd_expiw__)*diag(FTK8.svd_s_);
%%%%;
% compare to ../dir_rangan_python/FTK_*.ascii. ;
%%%%;
FTKp = FTK8;
dir_ascii = '../dir_rangan_python/dir_ascii';
n_d = 16;
for nd=0:n_d-1;
na=0;
if nd==na; tmp_str_ascii = 'svd_r_'; tmp_local = FTK8.svd_r_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_r_w_'; tmp_local = FTK8.svd_r_w_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_d_'; tmp_local = FTK8.svd_d_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_d_w_'; tmp_local = FTK8.svd_d_w_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_l_'; tmp_local = FTK8.svd_l_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_U_d_jacocoef_'; tmp_local = FTK8.svd_U_d_jacocoef_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_s_'; tmp_local = FTK8.svd_s_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_V_r_jacocoef_'; tmp_local = FTK8.svd_V_r_jacocoef_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_U_d_chebcoef_'; tmp_local = FTK8.svd_U_d_chebcoef_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_V_r_chebcoef_'; tmp_local = FTK8.svd_V_r_chebcoef_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'delta_x_'; tmp_local = FTK8.delta_x_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'delta_y_'; tmp_local = FTK8.delta_y_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_chebval_U_d_'; tmp_local = FTK8.svd_chebval_U_d_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_chebval_V_r_'; tmp_local = FTK8.svd_chebval_V_r_; tab_p=0; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_expiw__'; tmp_local = FTK8.svd_expiw__; tab_p=1; end; na=na+1;
if nd==na; tmp_str_ascii = 'svd_U_d_expiw_s__'; tmp_local = FTK8.svd_U_d_expiw_s__; tab_p=1; end; na=na+1;
fname_ascii = sprintf('%s/FTK_%s.ascii',dir_ascii,tmp_str_ascii);
if ~exist(fname_ascii,'file'); disp(sprintf(' %% Warning, %s not found',fname_ascii)); end;
if  exist(fname_ascii,'file');
if (flag_verbose>1); disp(sprintf(' %% %s found, loading',fname_ascii)); end;
fid = fopen(fname_ascii,'r');
if tab_p==0; tmp_ascii = reshape(cell2mat(textscan(fid,'%f')),size(tmp_local)); end;
if tab_p==1; tmp_ascii = reshape(cell2mat(textscan(fid,'(%f)')),size(tmp_local)); end;
fclose(fid);
fnorm_disp(flag_verbose,tmp_str_ascii,tmp_local,'ascii',tmp_ascii,' %% <-- should be <1e-6');
na=0;
if nd==na; FTKp.svd_r_ = reshape(tmp_ascii,size(FTK8.svd_r_)); end; na=na+1;
if nd==na; FTKp.svd_r_w_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_d_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_d_w_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_l_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_U_d_jacocoef_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_s_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_V_r_jacocoef_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_U_d_chebcoef_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_V_r_chebcoef_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.delta_x_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.delta_y_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_chebval_U_d_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_chebval_V_r_ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_expiw__ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
if nd==na; FTKp.svd_U_d_expiw_s__ = reshape(tmp_ascii,size(tmp_local)); end; na=na+1;
end;%if  exist(fname_ascii,'file');
end;%for nd=0:n_d-1;
%%%%;
% double-check jacocoef_. ;
%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figbig;fig81s;
p_row = 1; p_col = 2; np=0;
llim_ = [-7,0];
%%;
tmp_FTK8_svd_U_d_jacocoef__ = reshape(FTK8.svd_U_d_jacocoef_,[FTK8.n_svd_l,FTK8.n_d_degree]);
tmp_FTKp_svd_U_d_jacocoef__ = reshape(FTKp.svd_U_d_jacocoef_,[FTKp.n_svd_l,FTKp.n_d_degree]);
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_U_d_jacocoef__-tmp_FTKp_svd_U_d_jacocoef__)),llim_);
set(gca,'XTick',1:FTK8.n_d_degree); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_U_d_jacocoef__ 8 vs p','Interpreter','none'); colorbar;
%%;
tmp_FTK8_svd_V_r_jacocoef__ = reshape(FTK8.svd_V_r_jacocoef_,[FTK8.n_svd_l,FTK8.n_r_degree]);
tmp_FTKp_svd_V_r_jacocoef__ = reshape(FTKp.svd_V_r_jacocoef_,[FTKp.n_svd_l,FTKp.n_r_degree]);
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_V_r_jacocoef__-tmp_FTKp_svd_V_r_jacocoef__)),llim_);
set(gca,'XTick',1:FTK8.n_r_degree); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_V_r_jacocoef__ 8 vs p','Interpreter','none'); colorbar;
%%;
sgtitle('svd_jacocoef_','Interpreter','none');
end;%if flag_disp;
%%%%;
% double-check chebcoef_. ;
%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figbig;fig81s;
p_row = 1; p_col = 2; np=0;
llim_ = [-7,0];
%%;
tmp_FTK8_svd_U_d_chebcoef__ = reshape(FTK8.svd_U_d_chebcoef_,[FTK8.n_svd_l,FTK8.n_d_degree]);
tmp_FTKp_svd_U_d_chebcoef__ = reshape(FTKp.svd_U_d_chebcoef_,[FTKp.n_svd_l,FTKp.n_d_degree]);
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_U_d_chebcoef__-tmp_FTKp_svd_U_d_chebcoef__)),llim_);
set(gca,'XTick',1:FTK8.n_d_degree); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_U_d_chebcoef__ 8 vs p','Interpreter','none'); colorbar;
%%;
tmp_FTK8_svd_V_r_chebcoef__ = reshape(FTK8.svd_V_r_chebcoef_,[FTK8.n_svd_l,FTK8.n_r_degree]);
tmp_FTKp_svd_V_r_chebcoef__ = reshape(FTKp.svd_V_r_chebcoef_,[FTKp.n_svd_l,FTKp.n_r_degree]);
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_V_r_chebcoef__-tmp_FTKp_svd_V_r_chebcoef__)),llim_);
set(gca,'XTick',1:FTK8.n_r_degree); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_V_r_chebcoef__ 8 vs p','Interpreter','none'); colorbar;
%%;
sgtitle('svd_chebcoef_','Interpreter','none');
end;%if flag_disp;
%%%%;
% double-check chebval_. ;
%%%%;
tmp_FTKq_svd_chebval_U_d_ = reshape(get_svd_chebval_U_d_0(FTKp.svd_d_max,FTKp.n_svd_d,FTKp.svd_d_,FTKp.n_svd_l,FTKp.svd_l_,FTKp.svd_U_d_chebcoef_,FTKp.n_delta_v,FTKp.delta_x_,FTKp.delta_y_),[FTKp.n_svd_l*FTKp.n_delta_v,1]);
tmp_FTKq_svd_chebval_V_r_ = reshape(get_svd_chebval_V_r_0(FTKp.svd_r_max,FTKp.n_svd_r,FTKp.svd_r_,FTKp.n_svd_l,FTKp.svd_l_,FTKp.svd_V_r_chebcoef_,n_k_p_r,2*pi*k_p_r_),[FTKp.n_svd_l*n_k_p_r,1]);
if flag_disp;
figure(1+nf);nf=nf+1;clf;figbig;fig81s;
p_row = 2; p_col = 3; np=0;
llim_ = [-7,0];
%%;
tmp_FTK8_svd_chebval_U_d__ = reshape(FTK8.svd_chebval_U_d_,[FTK8.n_svd_l,FTK8.n_delta_v]);
tmp_FTKp_svd_chebval_U_d__ = reshape(FTKp.svd_chebval_U_d_,[FTKp.n_svd_l,FTKp.n_delta_v]);
tmp_FTKq_svd_chebval_U_d__ = reshape(tmp_FTKq_svd_chebval_U_d_,[FTKp.n_svd_l,FTKp.n_delta_v]);
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_chebval_U_d__-tmp_FTKp_svd_chebval_U_d__)),llim_);
set(gca,'XTick',1:FTK8.n_delta_v); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_chebval_U_d__ 8 vs p','Interpreter','none'); colorbar;
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_chebval_U_d__-tmp_FTKq_svd_chebval_U_d__)),llim_);
set(gca,'XTick',1:FTK8.n_delta_v); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_chebval_U_d__ 8 vs q','Interpreter','none'); colorbar;
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTKp_svd_chebval_U_d__-tmp_FTKq_svd_chebval_U_d__)),llim_);
set(gca,'XTick',1:FTKp.n_delta_v); set(gca,'YTick',1:FTKp.n_svd_l); title('svd_chebval_U_d__ p vs q','Interpreter','none'); colorbar;
%%;
tmp_FTK8_svd_chebval_V_r__ = reshape(FTK8.svd_chebval_V_r_,[FTK8.n_svd_l,n_k_p_r]);
tmp_FTKp_svd_chebval_V_r__ = reshape(FTKp.svd_chebval_V_r_,[FTKp.n_svd_l,n_k_p_r]);
tmp_FTKq_svd_chebval_V_r__ = reshape(tmp_FTKq_svd_chebval_V_r_,[FTKp.n_svd_l,n_k_p_r]);
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_chebval_V_r__-tmp_FTKp_svd_chebval_V_r__)),llim_);
set(gca,'XTick',1:n_k_p_r); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_chebval_V_r__ 8 vs p','Interpreter','none'); colorbar;
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTK8_svd_chebval_V_r__-tmp_FTKq_svd_chebval_V_r__)),llim_);
set(gca,'XTick',1:n_k_p_r); set(gca,'YTick',1:FTK8.n_svd_l); title('svd_chebval_V_r__ 8 vs q','Interpreter','none'); colorbar;
%%;
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc(log10(abs(tmp_FTKp_svd_chebval_V_r__-tmp_FTKq_svd_chebval_V_r__)),llim_);
set(gca,'XTick',1:n_k_p_r); set(gca,'YTick',1:FTKp.n_svd_l); title('svd_chebval_V_r__ p vs q','Interpreter','none'); colorbar;
%%;
sgtitle('svd_chebval_','Interpreter','none');
end;%if flag_disp;
%%%%;
FTK7 = gen_Jsvd_FTK_7(k_p_r_max,pm_N_pixel,svd_eps,l_max,n_a_degree,n_b_degree);
assert(n_delta_v_requested==2*FTK7.n_svd_l);
[FTK7.n_delta_v,FTK7.delta_x_,FTK7.delta_y_] = get_delta_2(delta_r_max,n_delta_v_requested);
FTK7.svd_d_max = delta_r_max;
FTK7.svd_polyval_U_d_ = reshape(get_svd_polyval_U_d_0(FTK7.svd_d_max,FTK7.n_svd_d,FTK7.svd_d_,FTK7.n_svd_l,FTK7.svd_l_,FTK7.svd_U_d_,FTK7.n_delta_v,FTK7.delta_x_,FTK7.delta_y_),[FTK7.n_svd_l*FTK7.n_delta_v,1]);
FTK7.svd_r_max = 2*pi*k_p_r_max;
FTK7.svd_polyval_V_r_ = reshape(get_svd_polyval_V_r_0(FTK7.svd_r_max,FTK7.n_svd_r,FTK7.svd_r_,FTK7.n_svd_l,FTK7.svd_l_,FTK7.svd_V_r_,n_k_p_r,2*pi*k_p_r_),[FTK7.n_svd_l*n_k_p_r,1]);
FTK7.svd_expiw__ = reshape(exp(-i*(pi/2 - reshape(atan2(FTK7.delta_y_,FTK7.delta_x_),[FTK7.n_delta_v,1]))*reshape(FTK7.svd_l_,[1,FTK7.n_svd_l])),[FTK7.n_delta_v,FTK7.n_svd_l]);
FTK7.svd_U_d_expiw_s__ = (permute(reshape(FTK7.svd_polyval_U_d_,[FTK7.n_svd_l,FTK7.n_delta_v]),[2,1]).*FTK7.svd_expiw__)*diag(FTK7.svd_s_);
%%%%;
fnorm_disp(flag_verbose,'FTK7.n_r_degree',FTK7.n_r_degree,'FTK8.n_r_degree',FTK8.n_r_degree);
fnorm_disp(flag_verbose,'FTK7.n_d_degree',FTK7.n_d_degree,'FTK8.n_d_degree',FTK8.n_d_degree);
fnorm_disp(flag_verbose,'FTK7.n_svd_r',FTK7.n_svd_r,'FTK8.n_svd_r',FTK8.n_svd_r);
fnorm_disp(flag_verbose,'FTK7.svd_r_',FTK7.svd_r_,'FTK8.svd_r_',FTK8.svd_r_);
fnorm_disp(flag_verbose,'FTK7.svd_r_m',FTK7.svd_r_m,'FTK8.svd_r_m',FTK8.svd_r_m);
fnorm_disp(flag_verbose,'FTK7.svd_r_c',FTK7.svd_r_c,'FTK8.svd_r_c',FTK8.svd_r_c);
fnorm_disp(flag_verbose,'FTK7.svd_r_w_',FTK7.svd_r_w_,'FTK8.svd_r_w_',FTK8.svd_r_w_);
fnorm_disp(flag_verbose,'FTK7.n_svd_d',FTK7.n_svd_d,'FTK8.n_svd_d',FTK8.n_svd_d);
fnorm_disp(flag_verbose,'FTK7.svd_d_',FTK7.svd_d_,'FTK8.svd_d_',FTK8.svd_d_);
fnorm_disp(flag_verbose,'FTK7.svd_d_m',FTK7.svd_d_m,'FTK8.svd_d_m',FTK8.svd_d_m);
fnorm_disp(flag_verbose,'FTK7.svd_d_c',FTK7.svd_d_c,'FTK8.svd_d_c',FTK8.svd_d_c);
fnorm_disp(flag_verbose,'FTK7.svd_d_w_',FTK7.svd_d_w_,'FTK8.svd_d_w_',FTK8.svd_d_w_);
fnorm_disp(flag_verbose,'FTK7.n_svd_l',FTK7.n_svd_l,'FTK8.n_svd_l',FTK8.n_svd_l);
fnorm_disp(flag_verbose,'FTK7.svd_l_',FTK7.svd_l_,'FTK8.svd_l_',FTK8.svd_l_);
fnorm_disp(flag_verbose,'FTK7.svd_U_d_jacocoef_',FTK7.svd_U_d_jacocoef_,'FTK8.svd_U_d_jacocoef_',FTK8.svd_U_d_jacocoef_);
fnorm_disp(flag_verbose,'FTK7.svd_s_',FTK7.svd_s_,'FTK8.svd_s_',FTK8.svd_s_);
fnorm_disp(flag_verbose,'FTK7.svd_V_r_jacocoef_',FTK7.svd_V_r_jacocoef_,'FTK8.svd_V_r_jacocoef_',FTK8.svd_V_r_jacocoef_);
%fnorm_disp(flag_verbose,'FTK7.svd_U_d_',FTK7.svd_U_d_,'FTK8.svd_U_d_',FTK8.svd_U_d_); %<-- no longer a matched field. ;
%fnorm_disp(flag_verbose,'FTK7.svd_V_r_',FTK7.svd_V_r_,'FTK8.svd_V_r_',FTK8.svd_V_r_); %<-- no longer a matched field. ;
fnorm_disp(flag_verbose,'FTK7.n_delta_v',FTK7.n_delta_v,'FTK8.n_delta_v',FTK8.n_delta_v);
fnorm_disp(flag_verbose,'FTK7.delta_x_',FTK7.delta_x_,'FTK8.delta_x_',FTK8.delta_x_);
fnorm_disp(flag_verbose,'FTK7.delta_y_',FTK7.delta_y_,'FTK8.delta_y_',FTK8.delta_y_);
fnorm_disp(flag_verbose,'FTK7.svd_d_max',FTK7.svd_d_max,'FTK8.svd_d_max',FTK8.svd_d_max);
fnorm_disp(flag_verbose,'FTK7.svd_polyval_U_d_',FTK7.svd_polyval_U_d_,'FTK8.svd_chebval_U_d_',FTK8.svd_chebval_U_d_);
fnorm_disp(flag_verbose,'FTK7.svd_r_max',FTK7.svd_r_max,'FTK8.svd_r_max',FTK8.svd_r_max);
fnorm_disp(flag_verbose,'FTK7.svd_polyval_V_r_',FTK7.svd_polyval_V_r_,'FTK8.svd_chebval_V_r_',FTK8.svd_chebval_V_r_);
fnorm_disp(flag_verbose,'FTK7.svd_expiw__',FTK7.svd_expiw__,'FTK8.svd_expiw__',FTK8.svd_expiw__);
fnorm_disp(flag_verbose,'FTK7.svd_U_d_expiw_s__',FTK7.svd_U_d_expiw_s__,'FTK8.svd_U_d_expiw_s__',FTK8.svd_U_d_expiw_s__);
%%%%;
disp('returning'); return;
end;%if (nargin<1);

flag_verbose=1;
na = 0;
if (nargin<1+na); K_max=[]; end; na=na+1;
if (nargin<1+na); N_pixel=[]; end; na=na+1;
if (nargin<1+na); eps_target=[]; end; na=na+1;
if (nargin<1+na); l_max=[]; end; na=na+1;
if (nargin<1+na); n_a_degree=[]; end; na=na+1;
if (nargin<1+na); n_b_degree=[]; end; na=na+1;

if isempty(eps_target); eps_target = 1e-3; end;
if isempty(l_max); l_max = 24; end;
if isempty(n_a_degree); n_a_degree = 32; end;
if isempty(n_b_degree); n_b_degree = 32; end;
if (flag_verbose>1); 
disp(sprintf(' %% [entering gen_Jsvd_FTK_8] N_pixel %0.2f l_max %d, n_a_degree %d, n_b_degree %d, eps_target %0.6f',N_pixel,l_max,n_a_degree,n_b_degree,eps_target)); 
end;%if (flag_verbose>1);

% K_max = 48/(2*pi); N_pixel = 1; eps_target = 1e-3; l_max = 32; n_a_degree = 64; n_b_degree = 65; flag_verbose=1;

%%%%%%%%;
K_target = K_max;
z_target = N_pixel*pi*sqrt(2);
D_target = z_target/max(1e-12,2*pi*K_target);
%%%%%%%%;
r_max = 2*pi*K_target;
d_max = D_target;
a_m = r_max/2; a_r = a_m;
b_m = d_max/2; b_r = b_m;
%%%%%%%%;
[~,a_Jp_chebcoef__] = Jp_chebcoef_0([],n_a_degree); for na_degree=0:n_a_degree-1; a_Jp_chebcoef__(1+na_degree,:) = a_Jp_chebcoef__(1+na_degree,:)*sqrt(na_degree+1)/sqrt(2); end;
[~,b_Jp_chebcoef__] = Jp_chebcoef_0([],n_b_degree); for nb_degree=0:n_b_degree-1; b_Jp_chebcoef__(1+nb_degree,:) = b_Jp_chebcoef__(1+nb_degree,:)*sqrt(nb_degree+1)/sqrt(2); end;
%%%%%%%%;
[a_jx_,a_jw_] = jacpts(n_a_degree,0,1); a_jw_=transpose(a_jw_); %<-- w.r.t. weight (1+a_jx_). ;
a_Jx__ = zeros(n_a_degree,n_a_degree);
for na_degree=0:n_a_degree-1; a_Jx__(1+na_degree,:) = chebval_0(1+na_degree,a_Jp_chebcoef__(1+na_degree,1:1+na_degree),n_a_degree,a_jx_); end;%for na_degree=0:n_a_degree-1;
a_jt_ = a_jx_*a_r + a_m;
%%%%%%%%;
[b_jx_,b_jw_] = jacpts(n_b_degree,0,1); b_jw_=transpose(b_jw_); %<-- w.r.t. weight (1+b_jx_). ;
b_Jx__ = zeros(n_b_degree,n_b_degree);
for nb_degree=0:n_b_degree-1; b_Jx__(1+nb_degree,:) = chebval_0(1+nb_degree,b_Jp_chebcoef__(1+nb_degree,1:1+nb_degree),n_b_degree,b_jx_); end;%for nb_degree=0:n_b_degree-1;
b_jt_ = b_jx_*b_r + b_m;
%%%%%%%%;
[A_jt_ab__,B_jt_ab__] = ndgrid(a_jt_,b_jt_);
%%%%%%%%;

n_1 = 1;
n_svds = min([n_a_degree,n_b_degree]);
n_sl = n_svds*(1+2*l_max);
S_l_ = zeros(n_sl,1);
S_u__ = zeros(n_b_degree,n_sl);
S_s_ = zeros(1,n_sl);
S_v__ = zeros(n_a_degree,n_sl);
l=0; n_S=0; continue_flag=1;
while (continue_flag);
if (l==0); l_ = [0]; else l_ = [-l,+l]; end;
for l_tmp = l_;
F = @(a,b) besselj(l_tmp,a.*b);
F_jt_ab__ = F(A_jt_ab__,B_jt_ab__);
F_ab__ = zeros(n_a_degree,n_b_degree);
%jw_ab__ = a_jw_*transpose(b_jw_);
%for na_degree=0:n_a_degree-1;for nb_degree=0:n_b_degree-1;
%J_tmp_ab__ = transpose(a_Jx__(1+na_degree,:))*b_Jx__(1+nb_degree,:);
%S_tmp_ab__ = F_jt_ab__.*J_tmp_ab__.*jw_ab__;
%F_ab__(1+na_degree,1+nb_degree) = sum(S_tmp_ab__(:));
%end;end;%for na_degree=0:n_a_degree-1;for nb_degree=0:n_b_degree-1;
a_Jx_a1a1____ = bsxfun(@times,reshape(transpose(a_Jx__),[n_a_degree,n_1,n_a_degree,n_1]),reshape(a_jw_,[n_a_degree,n_1,n_1,n_1]));
b_Jx_1b1b____ = bsxfun(@times,reshape(transpose(b_Jx__),[n_1,n_b_degree,n_1,n_b_degree]),reshape(b_jw_,[n_1,n_b_degree,n_1,n_1]));
F_jt_ab11____ = reshape(F_jt_ab__,[n_a_degree,n_b_degree,n_1,n_1]);
F_ab__ = reshape(sum(a_Jx_a1a1____.*b_Jx_1b1b____.*F_jt_ab11____,1+[0,1]),[n_a_degree,n_b_degree]);
[U__,Sigma__,V__] = svds(transpose(F_ab__),n_svds); Sigma_ = diag(Sigma__); [index_ret_] = find(Sigma_>eps_target)-1 ;
if ~isempty(index_ret_);
if (flag_verbose>1); disp(sprintf(' %% l %+.2d, found %d terms [%0.2f,..,%0.2f];',l_tmp,length(1+index_ret_),Sigma_(1+index_ret_(1)),Sigma_(1+index_ret_(end)))); end;%if
for index = 0:length(index_ret_)-1;
S_l_(1,1+n_S) = l_tmp;
S_u__(:,1+n_S) = U__(:,1+index_ret_(1+index));
S_s_(1,1+n_S) = Sigma_(1+index_ret_(1+index),1);
S_v__(:,1+n_S) = V__(:,1+index_ret_(1+index));
n_S = n_S + 1;
end;%for index = 0:length(index_ret_)-1;
end;%if ~isempty(index_ret_);
end;%for l_tmp = l_;
l=l+1;
if (l>l_max); continue_flag=0; else continue_flag=1; end;
end;%while (continue_flag);
if (flag_verbose>1); disp(sprintf(' %% total of n_S %d terms found;',n_S)); end%if;
S_l_ = S_l_(1,1:n_S);
S_u__ = S_u__(:,1:n_S);
S_s_ = S_s_(1,1:n_S);
S_v__ = S_v__(:,1:n_S);

FTK = struct('type','FTK');
FTK.n_r_degree = n_a_degree; FTK.n_d_degree = n_b_degree;
FTK.n_svd_r = length(a_jt_); FTK.svd_r_ = a_jt_;
FTK.svd_r_m = a_m; FTK.svd_r_c = a_r; FTK.svd_r_w_ = a_jw_; FTK.svd_r_Jx__ = a_Jx__; 
FTK.svd_r_Jp_chebcoef__ = a_Jp_chebcoef__;
FTK.n_svd_d = length(b_jt_); FTK.svd_d_ = b_jt_;
FTK.svd_d_m = b_m; FTK.svd_d_c = b_r; FTK.svd_d_w_ = b_jw_; FTK.svd_d_Jx__ = b_Jx__;
FTK.svd_d_Jp_chebcoef__ = b_Jp_chebcoef__;
FTK.n_svd_l = n_S;
FTK.svd_l_ = []; if (exist('S_l_','var')); FTK.svd_l_ = S_l_; end;
FTK.svd_U_d_jacocoef_ = []; if (exist('S_u__','var')); FTK.svd_U_d_jacocoef_ = S_u__; end;
FTK.svd_s_ = []; if (exist('S_s_','var')); FTK.svd_s_ = S_s_; end;
FTK.svd_V_r_jacocoef_ = []; if (exist('S_v__','var')); FTK.svd_V_r_jacocoef_ = S_v__; end;

svd_j_d_chebcoef_ = zeros(FTK.n_d_degree,FTK.n_svd_l);
svd_j_r_chebcoef_ = zeros(FTK.n_r_degree,FTK.n_svd_l);
for nl=0:FTK.n_svd_l-1;
%%%%%%%%;
tmp_p_j_chebcoef_ = zeros(FTK.n_d_degree,1);
for nd_degree=0:FTK.n_d_degree-1;
tmp_j_chebcoef_ = FTK.svd_d_Jp_chebcoef__(1+nd_degree,1:nd_degree+1)*FTK.svd_U_d_jacocoef_(1+nd_degree,1+nl);
tmp_index_ = 0 : min(FTK.n_d_degree,length(tmp_j_chebcoef_)) - 1;
tmp_p_j_chebcoef_(1+tmp_index_) = tmp_p_j_chebcoef_(1+tmp_index_) + transpose(tmp_j_chebcoef_(1+tmp_index_));
end;% for nd_degree=0:FTK.n_d_degree-1;
svd_j_d_chebcoef_(:,1+nl) = tmp_p_j_chebcoef_;
%%%%%%%%;
tmp_p_j_chebcoef_ = zeros(FTK.n_r_degree,1);
for nr_degree=0:FTK.n_r_degree-1;
tmp_j_chebcoef_ = FTK.svd_r_Jp_chebcoef__(1+nr_degree,1:nr_degree+1)*FTK.svd_V_r_jacocoef_(1+nr_degree,1+nl);
tmp_index_ = 0 : min(FTK.n_r_degree,length(tmp_j_chebcoef_)) - 1;
tmp_p_j_chebcoef_(1+tmp_index_) = tmp_p_j_chebcoef_(1+tmp_index_) + transpose(tmp_j_chebcoef_(1+tmp_index_));
end;%for nr_degree=0:FTK.n_r_degree-1;
svd_j_r_chebcoef_(:,1+nl) = tmp_p_j_chebcoef_;
%%%%%%%%;
end;%for nl=0:FTK.n_svd_l-1;

FTK.svd_U_d_chebcoef_ = svd_j_d_chebcoef_(:);
FTK.svd_V_r_chebcoef_ = svd_j_r_chebcoef_(:);

