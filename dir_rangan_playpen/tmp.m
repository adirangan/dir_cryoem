%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Set displacement delta_ ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
%delta_x = (2*pi/max_k_c)*1.5*0.5; delta_y = (2*pi/max_k_c)*1.5*sqrt(3)/2;
%delta_x = (2*pi/max_k_c)*3*rand()*0.5; delta_y = (2*pi/max_k_c)*3*rand()*sqrt(3)/2;
%delta_x = 1/ng; delta_y = 0;
%delta_d = sqrt(delta_x.^2 + delta_y.^2); delta_w = atan2(delta_y,delta_x);
%delta_d = 2*pi/max_k_c*2.0; 
delta_d = svd_d_(end)*(2*pi);
delta_w = 1*pi/6;
delta_x = delta_d*cos(delta_w); delta_y = delta_d*sin(delta_w);
disp(sprintf(' %% delta_x_c (%f,%f) delta_x_p (%f,%f)',delta_x,delta_y,delta_d,delta_w));

T_k_p_ = exp(-i*delta_d*R_k_p_.*cos(W_k_p_-delta_w)); Tlim_k = [-1,+1];
phi_k_p_ = W_k_p_-delta_w;
rd_k_p_ = delta_d*R_k_p_;
J_k_p_ = 0*T_k_p_;
for l=0:l_max;
if (l==0); J_k_p_ = J_k_p_ + besselj(0,rd_k_p_); end;
if (l>0); J_k_p_ = J_k_p_ + exp(+i*l*pi/2).*besselj(-l,rd_k_p_).*exp(-i*l*phi_k_p_) + exp(-i*l*pi/2).*besselj(+l,rd_k_p_).*exp(+i*l*phi_k_p_); end;
end;%for l=0:l_max;
Jlim_k = [-1,+1];
disp_flag=1;
if disp_flag;
figure(1);
subplot(2,3,1); clim = polarpatch(R_k_p_,W_k_p_,real(T_k_p_),Tlim_k); colorbar; title('real(T)');
subplot(2,3,4); clim = polarpatch(R_k_p_,W_k_p_,imag(T_k_p_),Tlim_k); colorbar; title('imag(T)');
subplot(2,3,2); clim = polarpatch(R_k_p_,W_k_p_,real(J_k_p_),Jlim_k); colorbar; title('real(J)');
subplot(2,3,5); clim = polarpatch(R_k_p_,W_k_p_,imag(J_k_p_),Jlim_k); colorbar; title('imag(J)');
subplot(2,3,3); clim = polarpatch(R_k_p_,W_k_p_,real(T_k_p_-J_k_p_)); colorbar; title('real(J-T)');
subplot(2,3,6); clim = polarpatch(R_k_p_,W_k_p_,imag(T_k_p_-J_k_p_)); colorbar; title('imag(J-T)');
end;%if disp_flag;

X_k_p_ = 0*T_k_p_;
phi_k_p_ = W_k_p_-delta_w;
delta_d_2 = delta_d/(2*pi);
ij_par = find(abs(svd_d_-delta_d_2)<1e-7);
if (~isempty(ij_par)); svd_U_d_2_ = svd_U_d_(ij_par,:); end;
if (isempty(ij_par));
ij_pre = max(find(svd_d_<delta_d_2));
ij_pos = min(find(svd_d_>delta_d_2));
d_pre = delta_d_2 - svd_d_(ij_pre);
d_pos = svd_d_(ij_pos) - delta_d_2;
w_pre = d_pos/(d_pos+d_pre);
w_pos = d_pre/(d_pos+d_pre);
svd_U_d_2_ = w_pre*svd_U_d_(ij_pre,:) + w_pos*svd_U_d_(ij_pos,:);
end;%if (isempty(ij_par));
for ns=1:n_S;
l = svd_l_(ns);
S = svd_s_(ns);
U_d = svd_U_d_2_(1,ns);
V_r_ = svd_V_r_(:,ns);
X_k_p_ = X_k_p_ + exp(-i*l*pi/2).*U_d.*S.*(ones(ng,1)*transpose(V_r_)).*exp(+i*l*phi_k_p_);
end;%for ns=1:n_S;
Xlim_k = [-1,+1];
disp_flag=1;
if disp_flag;
figure(4);
subplot(2,3,1); clim = polarpatch(R_k_p_,W_k_p_,real(T_k_p_),Tlim_k); colorbar; title('real(T)');
subplot(2,3,4); clim = polarpatch(R_k_p_,W_k_p_,imag(T_k_p_),Tlim_k); colorbar; title('imag(T)');
subplot(2,3,2); clim = polarpatch(R_k_p_,W_k_p_,real(X_k_p_),Xlim_k); colorbar; title('real(X)');
subplot(2,3,5); clim = polarpatch(R_k_p_,W_k_p_,imag(X_k_p_),Xlim_k); colorbar; title('imag(X)');
subplot(2,3,3); clim = polarpatch(R_k_p_,W_k_p_,real(T_k_p_-X_k_p_)); colorbar; title('real(X-T)');
subplot(2,3,6); clim = polarpatch(R_k_p_,W_k_p_,imag(T_k_p_-X_k_p_)); colorbar; title('imag(X-T)');
end;%if disp_flag;


