function ...
[ ...
 X_kk__ ...
,X_weight_r_ ...
,X_ori_kk__ ...
,X_tau_kk__ ...
,weight_so3 ...
,n_m_max ...
,polar_a_ ...
] = ...
principled_marching_cost_matrix_7( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_k_p_r_ ...
,l_max_ ...
,n_molecule ...
,molecule_density_ ...
,a_k_Y_ykv__ ...
,CTF_k_p_r_xcor_kk__ ...
,delta_sigma ...
,pm_delta_integral_tolerance ...
);
%%%%%%%%;
% updated version of principled_marching_cost_matrix_6.m. ;
% more efficient calculation of volumetric cost. ;
% scales by inverse-standard-deviations. ;
% scales by cross-correlation of CTF_k_p_r_. ;
% integrates over multiple molecules. ;
% accounts for (isotropic gaussian) distribution of translations with standard-deviation delta_sigma. ;
% allows for delta_sigma==0. ;
%%%%%%%%;

flag_verbose=0;
str_thisfunction = 'principled_marching_cost_matrix_7';

if (nargin<1);
flag_verbose=1;
if (flag_verbose>0); disp(sprintf(' %% testing %s',str_thisfunction')); end;
n_k_p_r = 49;
k_p_r_ = transpose(linspace(1,7,n_k_p_r));
weight_k_p_r_ = cos(k_p_r_).^2;
l_max_ = ceil(3 + k_p_r_*0.5);
n_molecule = 2;
molecule_density_ = transpose(linspace(3,5,n_molecule));
n_y_ = (1+l_max_).^2;
n_y_sum = sum(n_y_);
a_k_Y_ykv__ = reshape(linspace(1,10,n_y_sum*n_molecule),[n_y_sum,n_molecule]) + i*reshape(linspace(0,9,n_y_sum*n_molecule),[n_y_sum,n_molecule]);
CTF_k_p_r_xcor_k_ = transpose(linspace(5,11,n_k_p_r));
CTF_k_p_r_xcor_kk__ = CTF_k_p_r_xcor_k_*transpose(CTF_k_p_r_xcor_k_);
delta_sigma = 0.05;
pm_delta_integral_tolerance = 1e-3;
%%%%%%%%;
tmp_t=tic();
[ ...
 X_6_kk__ ...
,X_6_weight_r_ ...
,X_6_ori_kk__ ...
,X_6_tau_kk__ ...
,weight_so3_6 ...
,n_m_max_6 ...
,polar_a_6_ ...
] = ...
principled_marching_cost_matrix_6( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_k_p_r_ ...
,l_max_ ...
,n_molecule ...
,molecule_density_ ...
,a_k_Y_ykv__ ...
,CTF_k_p_r_xcor_kk__ ...
,delta_sigma ...
,pm_delta_integral_tolerance ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% principled_marching_cost_matrix_6: %0.6fs',tmp_t)); end;
%%%%%%%%;
tmp_t=tic();
[ ...
 X_7_kk__ ...
,X_7_weight_r_ ...
,X_7_ori_kk__ ...
,X_7_tau_kk__ ...
,weight_so3_7 ...
,n_m_max_7 ...
,polar_a_7_ ...
] = ...
principled_marching_cost_matrix_7( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_k_p_r_ ...
,l_max_ ...
,n_molecule ...
,molecule_density_ ...
,a_k_Y_ykv__ ...
,CTF_k_p_r_xcor_kk__ ...
,delta_sigma ...
,pm_delta_integral_tolerance ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% principled_marching_cost_matrix_7: %0.6fs',tmp_t)); end;
%%%%%%%%;
fnorm_disp(flag_verbose,'X_6_kk__',X_6_kk__,'X_7_kk__',X_7_kk__,' %%<-- should be zero');
fnorm_disp(flag_verbose,'X_6_weight_r_',X_6_weight_r_,'X_7_weight_r_',X_7_weight_r_,' %%<-- should be zero');
fnorm_disp(flag_verbose,'X_6_ori_kk__',X_6_ori_kk__,'X_7_ori_kk__',X_7_ori_kk__,' %%<-- should be zero');
fnorm_disp(flag_verbose,'X_6_tau_kk__',X_6_tau_kk__,'X_7_tau_kk__',X_7_tau_kk__,' %%<-- should be zero');
plot(X_6_tau_kk__,X_7_tau_kk__,'o');
fnorm_disp(flag_verbose,'weight_so3_6',weight_so3_6,'weight_so3_7',weight_so3_7,' %%<-- should be zero');
fnorm_disp(flag_verbose,'n_m_max_6',n_m_max_6,'n_m_max_7',n_m_max_7,' %%<-- should be zero');
fnorm_disp(flag_verbose,'polar_a_6_',polar_a_6_,'polar_a_7_',polar_a_7_,' %%<-- should be zero');
%%%%;
% compare to ../dir_rangan_python/dir_pymat/test_principled_marching_cost_matrix_7.mat. ;
%%%%;
dir_pymat = '../dir_rangan_python/dir_pymat';
fname_pymat = sprintf('%s/test_principled_marching_cost_matrix_7.mat',dir_pymat);
if ~exist(fname_pymat,'file'); disp(sprintf(' %% Warning, %s not found',fname_pymat)); end;
if  exist(fname_pymat,'file');
disp(sprintf(' %% %s found, loading',fname_pymat));
tmp_ = load(fname_pymat);
fnorm_disp(flag_verbose,'X_7_kk__',X_7_kk__,'tmp_.X_7_kk__',tmp_.X_7_kk__,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'X_7_weight_r_',X_7_weight_r_,'tmp_.X_7_weight_r_',tmp_.X_7_weight_r_,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'X_7_ori_kk__',X_7_ori_kk__,'tmp_.X_7_ori_kk__',tmp_.X_7_ori_kk__,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'X_7_tau_kk__',X_7_tau_kk__,'tmp_.X_7_tau_kk__',tmp_.X_7_tau_kk__,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'weight_so3_7',weight_so3_7,'tmp_.weight_so3_7',tmp_.weight_so3_7,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'n_m_max_7',n_m_max_7,'double(tmp_.n_m_max_7)',double(tmp_.n_m_max_7),' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'polar_a_7_',polar_a_7_,'tmp_.polar_a_7_',tmp_.polar_a_7_,' %%<-- should be <1e-6');
end;%if  exist(fname_pymat,'file');
%%%%%%%%;
disp('returning'); return;
end;%if (nargin<1);

na=0;
if (nargin<1+na); n_k_p_r=[]; end; na=na+1;
if (nargin<1+na);,k_p_r_=[]; end; na=na+1;
if (nargin<1+na);,weight_k_p_r_=[]; end; na=na+1;
if (nargin<1+na);,l_max_=[]; end; na=na+1;
if (nargin<1+na);,n_molecule=[]; end; na=na+1;
if (nargin<1+na);,molecule_density_=[]; end; na=na+1;
if (nargin<1+na);,a_k_Y_ykv__=[]; end; na=na+1;
if (nargin<1+na);,CTF_k_p_r_xcor_kk__=[]; end; na=na+1;
if (nargin<1+na);,delta_sigma=[]; end; na=na+1;
if (nargin<1+na);,pm_delta_integral_tolerance=[]; end; na=na+1;

if isempty(CTF_k_p_r_xcor_kk__); CTF_k_p_r_xcor_kk__ = ones(n_k_p_r,n_k_p_r); end;
if isempty(delta_sigma); delta_sigma = 0; end;
if isempty(pm_delta_integral_tolerance); pm_delta_integral_tolerance = 1e-3; end;
if (pm_delta_integral_tolerance<=0); pm_delta_integral_tolerance = 1e-3; end;

if (isempty(n_molecule)); n_molecule = 1; molecule_density_ = ones(n_molecule,1); end;
if (n_molecule==0); n_molecule = 1; molecule_density_ = ones(n_molecule,1); end;
%%%%%%%%;
tmp_t = tic();
n_y_ = (1+l_max_).^2;
n_y_max = max(n_y_);
n_y_sum = sum(n_y_);
n_y_csum_ = cumsum([0;n_y_]);
l_max_max = max(l_max_);
m_max_ = -l_max_max : +l_max_max;
n_m_max = 1+2*l_max_max;
n_polar_a = n_m_max; polar_a_ = linspace(-pi,pi,n_polar_a+1); polar_a_ = transpose(polar_a_(1:end-1));
weight_so3 = (2*pi)*(2*pi)*4; %<-- total volume of so3. ;
a_k_Y_ykv___ = zeros(n_y_max,n_k_p_r,n_molecule);
for nmolecule=0:n_molecule-1;
a_k_Y_ykv___(:,:,1+nmolecule) = local_yk__from_yk_(n_k_p_r,l_max_,a_k_Y_ykv__(:,1+nmolecule));
end;%for nmolecule=0:n_molecule-1;
tmp_t = toc(tmp_t); if (flag_verbose>1); disp(sprintf(' %% a_k_Y_ykv___: %0.3fs',tmp_t)); end;
if (isempty(molecule_density_)); molecule_density_ = ones(n_molecule,1); end;
molecule_density_ = molecule_density_/max(1e-12,sum(molecule_density_));
%%%%%%%%;

%%%%%%%%;
tmp_t = tic();
[I_pos__,I_neg_] = pm_delta_integral_3(n_k_p_r,k_p_r_,delta_sigma,l_max_max,pm_delta_integral_tolerance);
I_pos__ = I_pos__/(2*pi);
I_neg__ = (I_neg_*transpose(I_neg_))/(2*pi)^2;
tmp_t = toc(tmp_t); if (flag_verbose>1); disp(sprintf(' %% I_pos__ and I_neg_: %0.3fs',tmp_t)); end;
%%%%%%%%;
tmp_t = tic();
X_weight_r_ = sqrt(weight_k_p_r_);
tmp_t = toc(tmp_t); if (flag_verbose>1); disp(sprintf(' %% X_weight_r_: %0.3fs',tmp_t)); end;
%%%%%%%%;
tmp_t = tic();
mu_vv__ = reshape(molecule_density_,[n_molecule,1])*reshape(molecule_density_,[1,n_molecule]);
w_kk__ = reshape(X_weight_r_,[n_k_p_r,1])*reshape(X_weight_r_,[1,n_k_p_r]);
X_ori_kk__ = squeeze(sum(bsxfun(@times,reshape(mu_vv__,[1,1,1,n_molecule,n_molecule]),bsxfun(@times,reshape(w_kk__,[1,n_k_p_r,n_k_p_r,1,1]),bsxfun(@times,reshape(CTF_k_p_r_xcor_kk__,[1,n_k_p_r,n_k_p_r,1,1]),sum(conj(reshape(a_k_Y_ykv___,[n_y_max,n_k_p_r,1,n_molecule,1])).*reshape(a_k_Y_ykv___,[n_y_max,1,n_k_p_r,1,n_molecule]),1+0)))),1+[3,4]));
X_tau_kk__ = (4*pi).^2 .* squeeze(sum(bsxfun(@times,reshape(mu_vv__,[1,1,1,n_molecule,n_molecule]),bsxfun(@times,reshape(w_kk__,[1,n_k_p_r,n_k_p_r,1,1]),bsxfun(@times,reshape(CTF_k_p_r_xcor_kk__,[1,n_k_p_r,n_k_p_r,1,1]),sum(conj(reshape(a_k_Y_ykv___(1+0,:,:),[1,n_k_p_r,1,n_molecule,1])).*reshape(a_k_Y_ykv___(1+0,:,:),[1,1,n_k_p_r,1,n_molecule]),1+0)))),1+[3,4]));
%%%%%%%%;
X_kk__ = real(X_ori_kk__)*weight_so3.*I_pos__ - real(X_tau_kk__).*I_neg__;
%%%%%%%%;
tmp_t = toc(tmp_t); if (flag_verbose>1); disp(sprintf(' %% X_kk__: %0.3fs',tmp_t)); end;

