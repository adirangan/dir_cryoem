flag_verbose=1; flag_disp=1;nf=0;

if (flag_verbose>0); disp(sprintf(' %% testing qbp_uniform_over_n_k_p_r_10'));end;
n_1 = 1; n_2 = 2; n_3 = 3;
k_eq_d_double = 1.0;
k_int = 48;
viewing_k_eq_d_double = 1.0;
n_w_int = 1.0;
n_source = 16;

%%%%%%%%;
% Now set up k-quadrature on sphere. ;
%%%%%%%%;
k_p_r_max = k_int/(2*pi); k_eq_d = k_eq_d_double/(2*pi); str_L = 'L';
flag_uniform_over_n_k_p_r = 1; flag_uniform_over_polar_a = 0;
[ ...
 n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,~ ...
,~ ...
,~ ...
,~ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
] = ...
sample_sphere_7( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_L ...
,flag_uniform_over_n_k_p_r ...
,flag_uniform_over_polar_a ...
); %<-- sum(weight_3d_k_p_r_)*(4*pi) = (4/3)*pi*k_p_r_max^3 --> sum(weight_3d_k_p_r_) = (1/3)*k_p_r_max^3 ;
%%%%%%%%;
% extract outer shell for visualization. ;
%%%%%%%%;
index_outer_shell_ = n_qk_csum_(1+n_k_p_r-1):n_qk_csum_(1+n_k_p_r-1+1)-1;
n_outer_shell = numel(index_outer_shell_);
k_outer_shell_r_q_ = k_p_r_qk_(1+index_outer_shell_);
assert(std(k_outer_shell_r_q_,1)< 1e-6);
k_outer_shell_azimu_b_q_ = k_p_azimu_b_qk_(1+index_outer_shell_);
k_outer_shell_polar_a_q_ = k_p_polar_a_qk_(1+index_outer_shell_);
%%%%%%%%;
% Set up k-quadrature on disc. ;
%%%%%%%%;
n_w_int = 1;
l_max_upb = round(2*pi*k_p_r_max);
n_w_max = n_w_int*2*(l_max_upb+1);
template_k_eq_d = -1;
n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,template_k_eq_d ...
,n_w_0in_ ...
,weight_3d_k_p_r_ ...
);
n_w_max = max(n_w_);
n_w_sum = sum(n_w_);
n_w_csum_ = cumsum([0;n_w_]);
%%%%%%%%;

%%%%%%%%;
% Now set up volume with plane-wave sources. ;
%%%%%%%%;
delta_a_c_3s__ = zeros(n_3,n_source);
for nsource=0:n_source-1;
tmp_t = nsource/max(1,n_source);
tmp_r = 0.5*tmp_t.^(1/4); tmp_a = 5*pi*tmp_t; tmp_b = 17*pi*tmp_t;
tmp_x_0 = tmp_r*sin(tmp_a)*cos(tmp_b); tmp_x_1 = tmp_r*sin(tmp_a)*sin(tmp_b); tmp_x_2 = tmp_r*cos(tmp_a);
delta_a_c_3s__(:,1+nsource) = [tmp_x_0;tmp_x_1;tmp_x_2];
end;%for nsource=0:n_source-1;
n_source = size(delta_a_c_3s__,1+1);
a_k_p_form_qk_ = zeros(n_qk,1);
for nsource=0:n_source-1;
delta_a_c_ = delta_a_c_3s__(:,1+nsource);
a_k_p_form_qk_ = a_k_p_form_qk_ + exp(+i*2*pi*(k_c_0_qk_*delta_a_c_(1+0) + k_c_1_qk_*delta_a_c_(1+1) + k_c_2_qk_*delta_a_c_(1+2)));
end;%for nsource=0:n_source-1;
disp(sprintf(' %% fnorm(a_k_p_form_qk_): %0.16f',fnorm(a_k_p_form_qk_)));
%%%%%%%%;

k_p_r_max = 48/(2*pi); k_eq_d = 1.0/(2*pi); str_L = 'L';
[ ...
 n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
] = ...
get_weight_3d_1( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_L ...
);
%%%%;
n_w_int = 1;
l_max_upb = round(2*pi*k_p_r_max);
l_max_max = min(l_max_upb,1+ceil(2*pi*k_p_r_(end)));
n_w_max = n_w_int*2*(l_max_max+1); n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_0in_ ...
,weight_3d_k_p_r_ ...
);
n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
%%%%%%%%;

%%%%%%%%;
% Now convert to a_k_Y_yk_. ;
%%%%%%%%;
[ ...
 l_max_upb ...
,l_max_ ...
,l_max_max ...
,n_m_max ...
,m_max_ ...
,n_y_ ...
,n_y_max ...
,n_y_sum ...
,n_y_csum_ ...
,Y_l_val_yk_ ...
,Y_m_val_yk_ ...
,Y_k_val_yk_ ...
,weight_Y_yk_ ...
] = ...
get_weight_Y_0( ...
 flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
);
%%%%%%%%;
tmp_t=tic();
[ ...
 a_k_Y_quad_yk_ ...
] = ...
convert_k_p_to_spharm_uniform_over_n_k_p_r_5( ...
 flag_verbose ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_k_p_form_qk_ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% convert_k_p_to_spharm_uniform_over_n_k_p_r_5 time %0.2fs',tmp_t));
%%%%%%%%;
tmp_t=tic();
a_k_Y_form_yk_ = zeros(n_y_sum,1);
for nsource=0:n_source-1;
a_k_Y_form_yk_ = a_k_Y_form_yk_ + plane_wave_expansion_1(n_k_p_r,k_p_r_,delta_a_c_3s__(:,1+nsource),l_max_);
end;%for nsource=0:n_source-1;
tmp_t = toc(tmp_t); disp(sprintf(' %% plane_wave_expansion_1 time %0.2fs',tmp_t));
fnorm_disp(flag_verbose,'a_k_Y_form_yk_',a_k_Y_form_yk_,'a_k_Y_quad_yk_',a_k_Y_quad_yk_,' %%<-- should be small');
%%%%%%%%;
n_x_c = 64;
half_diameter_x_c = 1.0d0;
diameter_x_c = 2.0d0*half_diameter_x_c;
x_p_r_max = 1.0;
x_c_0_ = linspace(-x_p_r_max,+x_p_r_max,n_x_c); d_x_0 = mean(diff(x_c_0_));
x_c_1_ = linspace(-x_p_r_max,+x_p_r_max,n_x_c); d_x_1 = mean(diff(x_c_1_));
x_c_2_ = linspace(-x_p_r_max,+x_p_r_max,n_x_c); d_x_2 = mean(diff(x_c_2_));
[x_c_0___,x_c_1___,x_c_2___] = ndgrid(x_c_0_,x_c_1_,x_c_2_); n_xxx_c = n_x_c^3;
weight_xxx_c = d_x_0 * d_x_1 * d_x_2 ;
tmp_t=tic();
[ ...
 a_x_c_quad_xxx_ ...
] = ...
convert_k_p_to_x_c_1( ...
 flag_verbose ...
,n_qk ...
,weight_3d_k_p_qk_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,k_p_r_max ...
,n_xxx_c ...
,weight_xxx_c ...
,x_c_0___ ...
,x_c_1___ ...
,x_c_2___ ...
,x_p_r_max ...
,a_k_p_form_qk_ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% convert_k_p_to_x_c_1 time %0.2fs',tmp_t));
%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figsml;
isosurface_f_x_u_1([],a_x_c_quad_xxx_);
title('a_x_c_quad_xxx_','Interpreter','none');
end;%if flag_disp;
%%%%%%%%;

%%%%%%%%;
% select some viewing-angles and templates. ;
%%%%%%%%;
tmp_t=tic();
viewing_euler_k_eq_d = viewing_k_eq_d_double*1.0/max(1e-12,k_p_r_max);
template_inplane_k_eq_d = -1; flag_uniform_over_polar_a = 0;
[ ...
 template_wkS___ ...
,n_w ...
,n_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
] = ...
pm_template_3( ...
 flag_verbose ...
,l_max_max ...
,n_k_p_r ...
,reshape(local_yk__from_yk_(n_k_p_r,l_max_,a_k_Y_form_yk_),[n_y_max,n_k_p_r]) ...
,viewing_euler_k_eq_d ...
,template_inplane_k_eq_d ...
,n_w_max ...
);
S_k_p_wkS__ = reshape(template_wkS___,[n_w_sum,n_S]);
tmp_t = toc(tmp_t); disp(sprintf(' %% convert_k_p_to_x_c_1 time %0.2fs',tmp_t));
%%%%%%%%;

%%%%%%%%;
% define rotations in 2d and 3d. ;
%%%%%%%%;
R2 = @(gamma_z) ...
[ +cos(gamma_z) -sin(gamma_z) ; ...
  +sin(gamma_z) +cos(gamma_z) ; ...
] ;
%%%%%%%%;
Rz = @(azimu_b) ...
[ +cos(azimu_b) -sin(azimu_b) 0 ; ...
  +sin(azimu_b) +cos(azimu_b) 0 ; ...
   0             0            1 ; ...
] ;
%%%%%%%%;
Ry = @(polar_a) ...
[ +cos(polar_a) 0 +sin(polar_a) ; ...
   0            1  0            ; ...
  -sin(polar_a) 0 +cos(polar_a) ; ...
];
%%%%%%%%;

%%%%%%%%;
% Now test a few templates analytically. ;
%%%%%%%%;
n_test = 8;
for ntest=0:n_test-1;
nS = max(0,min(n_S-1,floor(n_S*ntest/max(1,n_test))));
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
R_k_p_wk_ = zeros(n_w_sum,1);
for nsource=0:n_source-1;
tmp_delta_ = tmp_R__*delta_a_c_3s__(:,1+nsource);
R_k_p_wk_ = R_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_(1+0) + k_c_1_wk_*tmp_delta_(1+1)));
end;%for nsource=0:n_source-1;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
fnorm_disp(flag_verbose,'S_k_p_wk_',S_k_p_wk_,'R_k_p_wk_',R_k_p_wk_,' %%<-- should be small');
end;%for ntest=0:n_test-1;
%%%%%%%%;

%%%%;
% Now we generate a selection of synthetic-images, copied from the templates, ;
% as well as a collection of anisotropic planar-CTF-functions. ;
%%%%;
n_M = n_S*2;
index_nS_from_nM_ = max(0,min(n_S-1,floor(mod(transpose(0:n_M-1),n_S))));
euler_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_);
euler_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_);
euler_gamma_z_M_ = 2*pi*transpose(0:n_M-1)/max(1,n_M) + pi/2;
image_delta_x_M_ = +0.05*(mod(transpose(0:n_M-1),11)-5)/5;
image_delta_y_M_ = +0.07*(mod(transpose(0:n_M-1),15)-7)/7;
n_CTF = 8; %<-- some number of CTF-functions. ;
CTF_phi_C_ = zeros(n_CTF,1);
CTF_k_p_wkC__ = zeros(n_w_sum,n_CTF);
for nCTF=0:n_CTF-1;
CTF_phi = 2*pi*nCTF/max(1,n_CTF) + pi/2;
CTF_phi_C_(1+nCTF) = CTF_phi;
CTF_k_p_wk_ = 2*k_p_r_wk_.*cos(k_p_w_wk_ - CTF_phi);
CTF_k_p_wkC__(:,1+nCTF) = CTF_k_p_wk_;
end;%for nCTF=0:n_CTF-1;
index_nCTF_from_nM_ = mod(transpose([0:n_M-1]),n_CTF);
M_k_p_wkM__ = zeros(n_w_sum,n_M);
for nM=0:n_M-1;
nCTF = index_nCTF_from_nM_(1+nM);
CTF_k_p_wk_ = CTF_k_p_wkC__(:,1+nCTF);
nS = index_nS_from_nM_(1+nM);
gamma_z = euler_gamma_z_M_(1+nM);
delta_x = image_delta_x_M_(1+nM);
delta_y = image_delta_y_M_(1+nM);
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
M_k_p_wk_ = transf_p_to_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,CTF_k_p_wk_.*rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,S_k_p_wk_,+gamma_z),-delta_x,-delta_y);
M_k_p_wkM__(:,1+nM) = M_k_p_wk_;
end;%for nM=0:n_M-1;
%%%%;
% alternatively, since n_w_ is uniform, we can perform the rotations all at once. ;
%%%%;
tmp_q_ = periodize(transpose(0:n_w_max-1),-n_w_max/2,+n_w_max/2);
N_k_p_wkM__ = zeros(n_w_sum,n_M);
N_k_p_wkM__ = ...
transf_p_to_p(n_k_p_r,k_p_r_,n_w_,n_w_sum, ...
CTF_k_p_wkC__(:,1+index_nCTF_from_nM_) ...
.* ...
reshape( ...
	 ifft( ...
	       bsxfun(@times ...
		      ,fft(reshape(S_k_p_wkS__(:,1+index_nS_from_nM_),[n_w_max,n_k_p_r,n_M]),[],1+0) ...
		      ,reshape(exp(-i*bsxfun(@times,reshape(tmp_q_,[n_w_max,1]),reshape(euler_gamma_z_M_,[1,n_M]))),[n_w_max,1,n_M]) ...
		     ) ...
	       ,[],1+0 ...
	     ) ...
	 ,[n_w_sum,n_M] ...
       ) ...
,-image_delta_x_M_ ...
,-image_delta_y_M_ ...
);
%%%%%%%%;
fnorm_disp(flag_verbose,'N_k_p_wkM__',N_k_p_wkM__,'M_k_p_wkM__',M_k_p_wkM__,' %%<-- should be zero');

%%%%%%%%;
% Now we compare reconstructions. ;
%%%%%%%%;
a_k_p_relerror = @(a_k_p_test_qk_) sqrt(sum(abs(a_k_p_form_qk_ - a_k_p_test_qk_).^2.*weight_3d_k_p_qk_)./max(1e-12,sum(abs(a_k_p_form_qk_).^2.*weight_3d_k_p_qk_qk_)));
a_k_Y_relerror = @(a_k_Y_test_yk_) sqrt(sum(abs(a_k_Y_form_yk_ - a_k_Y_test_yk_).^2.*weight_Y_yk_)./max(1e-12,sum(abs(a_k_Y_form_yk_).^2.*weight_Y_yk_))); 
%%%%%%%%;
tmp_t=tic();
qbp_eps = 1e-6;
[ ...
 a_k_Y_qbpr_yk_ ...
] = ...
qbp_6( ...
 qbp_eps ...
,n_k_p_r ...
,k_p_r_ ...
,l_max_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,+image_delta_x_M_ ...
,+image_delta_y_M_ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% qbp_6 time %0.2fs',tmp_t));
fnorm_disp(flag_verbose,'a_k_Y_form_yk_',a_k_Y_form_yk_,'a_k_Y_qbpr_yk_',a_k_Y_qbpr_yk_);
if (flag_verbose>0); disp(sprintf(' %% a_k_Y_form_yk_ vs a_k_Y_qbpr_yk_: volumetric-relative-error: %0.16f',a_k_Y_relerror(a_k_Y_qbpr_yk_))); end;
%%%%%%%%;
tmp_t=tic();
qbp_eps = 1e-6;
[ ...
 a_k_Y_qbpu_yk_ ...
] = ...
qbp_uniform_over_n_k_p_r_10( ...
 qbp_eps ...
,n_k_p_r ...
,k_p_r_ ...
,l_max_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,+image_delta_x_M_ ...
,+image_delta_y_M_ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% qbp_uniform_over_n_k_p_r_10 time %0.2fs',tmp_t));
fnorm_disp(flag_verbose,'a_k_Y_form_yk_',a_k_Y_form_yk_,'a_k_Y_qbpu_yk_',a_k_Y_qbpu_yk_);
if (flag_verbose>0); disp(sprintf(' %% a_k_Y_form_yk_ vs a_k_Y_qbpu_yk_: volumetric-relative-error: %0.16f',a_k_Y_relerror(a_k_Y_qbpu_yk_))); end;
%%%%%%%%;
tmp_t=tic();
half_diameter_x_c = 1.0;
n_x_u_pack = 64;
[ ... 
 a_x_u_qbpr_xxx_ ...
] = ...
convert_spharm_to_x_c_uniform_over_n_k_p_r_5( ...
 flag_verbose ...
,k_eq_d ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_k_Y_qbpr_yk_ ...
,half_diameter_x_c ...
,n_x_u_pack ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% convert_spharm_to_x_c_uniform_over_n_k_p_r_5 time %0.2fs',tmp_t));
%%%%%%%%;
tmp_t=tic();
half_diameter_x_c = 1.0;
n_x_u_pack = 64;
[ ... 
 a_x_u_qbpu_xxx_ ...
] = ...
convert_spharm_to_x_c_uniform_over_n_k_p_r_5( ...
 flag_verbose ...
,k_eq_d ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_k_Y_qbpu_yk_ ...
,half_diameter_x_c ...
,n_x_u_pack ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% convert_spharm_to_x_c_uniform_over_n_k_p_r_5 time %0.2fs',tmp_t));
%%%%%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figmed;
subplot(1,2,1);
isosurface_f_x_u_1([],a_x_u_qbpr_xxx_);
title('a_x_u_qbpr_xxx_','Interpreter','none');
subplot(1,2,2);
isosurface_f_x_u_1([],a_x_u_qbpu_xxx_);
title('a_x_u_qbpu_xxx_','Interpreter','none');
end;%if flag_disp;
%%%%%%%%;
