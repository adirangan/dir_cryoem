function ...
[ ...
 X_kk__ ...
,X_weight_r_ ...
] = ...
principled_marching_empirical_cost_matrix_2( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_2d_k_p_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
);
% empirical (2d) cost. ;

flag_verbose=0;
str_thisfunction = 'principled_marching_empirical_cost_matrix_2';

if (nargin<1);
flag_verbose=1;
if (flag_verbose>0); disp(sprintf(' %% testing %s',str_thisfunction)); end;
n_k_p_r = 49;
k_p_r_ = sort(rand(n_k_p_r,1));
weight_2d_k_p_r_ = rand(n_k_p_r,1);
n_w_max = 98;
n_w_ = n_w_max*ones(n_k_p_r,1); n_w_sum = sum(n_w_);
n_M = 1024;
M_k_p_wkM__ = randn(n_w_sum,n_M) + i*randn(n_w_sum,n_M);
M_k_q_wkM__ = interp_p_to_q(n_k_p_r,n_w_,n_w_sum,M_k_p_wkM__);
%%%%%%%%;
tmp_t=tic();
[ ...
 X_0_kk__ ...
,X_0_weight_r_ ...
] = ...
principled_marching_empirical_cost_matrix_0( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_2d_k_p_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% principled_marching_empirical_cost_matrix_0: %0.6fs',tmp_t)); end;
%%%%%%%%;
tmp_t=tic();
[ ...
 X_1_kk__ ...
,X_1_weight_r_ ...
] = ...
principled_marching_empirical_cost_matrix_1( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_2d_k_p_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% principled_marching_empirical_cost_matrix_1: %0.6fs',tmp_t)); end;
%%%%%%%%;
tmp_t=tic();
[ ...
 X_2_kk__ ...
,X_2_weight_r_ ...
] = ...
principled_marching_empirical_cost_matrix_2( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_2d_k_p_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% principled_marching_empirical_cost_matrix_2: %0.6fs',tmp_t)); end;
%%%%%%%%;
fnorm_disp(flag_verbose,'X_0_kk__',X_0_kk__,'X_1_kk__',X_1_kk__,' %%<-- should be zero');
fnorm_disp(flag_verbose,'X_0_kk__',X_0_kk__,'X_2_kk__',X_2_kk__,' %%<-- should be zero');
fnorm_disp(flag_verbose,'X_0_weight_r_',X_0_weight_r_,'X_1_weight_r_',X_1_weight_r_,' %%<-- should be zero');
fnorm_disp(flag_verbose,'X_0_weight_r_',X_0_weight_r_,'X_2_weight_r_',X_2_weight_r_,' %%<-- should be zero');
%%%%%%%%;
disp('returning'); return;
end;%if (nargin<1);

n_w_max = max(n_w_);
n_w_sum = sum(n_w_);
n_w_csum_ = cumsum([0;n_w_]);
M_k_q_wkM__ = interp_p_to_q(n_k_p_r,n_w_,n_w_sum,M_k_p_wkM__);

if numel(unique(n_w_))> 1;
M_k_q_rwM___ = reshape(innerproduct_q_k_stretch_quad_stack____1(n_k_p_r,n_w_,n_M,M_k_q_wkM__,0),[n_k_p_r,n_w_max,n_M]);
end;%if numel(unique(n_w_))> 1;
if numel(unique(n_w_))==1;
M_k_q_rwM___ = permute(reshape(M_k_q_wkM__,[n_w_max,n_k_p_r,n_M]),1+[1,0,2]); M_k_q_rwM___(:,1+n_w_max/2,:) = 0;
end;%if numel(unique(n_w_))==1;

X_00_kk__ = sum(pagemtimes(conj(M_k_q_rwM___),'none',M_k_q_rwM___,'transpose'),1+2) * (2*pi)^2/max(1,n_M);

X_01_kk__ = zeros(n_k_p_r,n_k_p_r);
M_k_q_r0M_ = sum(reshape(M_k_q_rwM___(:,1+0,:),[n_k_p_r,n_M]),1+1);
X_01_kk__ = (2*pi)^2 * conj(M_k_q_r0M_) * transpose(M_k_q_r0M_) / max(1,n_M^2) ;

X_weight_r_ = sqrt(weight_2d_k_p_r_);

X_kk__ = diag(X_weight_r_) * (2*real(X_00_kk__) - 2*real(X_01_kk__)) * diag(X_weight_r_) ;

