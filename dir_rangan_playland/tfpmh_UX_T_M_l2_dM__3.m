function UX_T_M_l2_dM__ = tfpmh_UX_T_M_l2_dM__3(FTK,n_w_,n_M,pm_n_UX_rank,svd_V_UX_M_lwnM____);
%%%%%%%%;
% Assumes n_w_ = n_w_max*ones(n_k_p_r,1);
% Similar to tfpmh_UX_T_M_l2_dM__1, ;
% except takes advantage of polar-arrangement of displacements ;
% to calculate UX_T_M_k_q_dwnM____. ;
% Note that, due to use of sparse indexing, ;
% this is not actually faster than tfpmh_UX_T_M_l2_dM__1. ;
%%%%%%%%;
str_thisfunction = 'tfpmh_UX_T_M_l2_dM__3';
flag_verbose=1;
n_svd_l = FTK.n_svd_l;
n_delta_v = FTK.n_delta_v;
n_delta_p_r = FTK.n_delta_p_r;
n_delta_p_w = FTK.n_delta_p_w;
n_1 = 1;
UX_T_M_l2_dM__ = zeros(n_delta_v,n_M);
n_w_max = max(n_w_); n_k_p_r = numel(n_w_);
n_w_sum = sum(n_w_); if (n_w_sum~=n_w_max*n_k_p_r); disp(sprintf(' %% Warning, n_w_sum %d ~= n_w_max*n_k_p_r %d*%d in %s',n_w_sum,n_w_max,n_k_p_r,str_thisfunction)); end;

tmp_t=tic();
svd_expil_s_V_UX_M_l1wnM_____ = reshape(bsxfun(@times,reshape(FTK.svd_expil_l_(:).*FTK.svd_s_(:),[n_svd_l,1]),svd_V_UX_M_lwnM____),[n_svd_l,n_1,n_w_max,pm_n_UX_rank,n_M]);
n_op = n_svd_l * n_1 * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% svd_expil_s_V_UX_M_l1wnM_____: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;
tmp_t=tic();
%svd_U_d_0_expil_s_V_UX_M_l1wnM_____ = reshape(FTK.svd_l_from_nl__ * reshape(bsxfun(@times,reshape(FTK.svd_chebval_U_d_l0_,[n_svd_l,n_1,n_1,n_1,n_1]),svd_expil_s_V_UX_M_l1wnM_____),[n_svd_l,n_1*n_w_max*pm_n_UX_rank*n_M]),[n_delta_p_w,n_1,n_w_max,pm_n_UX_rank,n_M]);
svd_U_d_0_expil_s_V_UX_M_l1wnM_____ = reshape(pagemtimes(full(FTK.svd_l_from_nl__),reshape(bsxfun(@times,reshape(FTK.svd_chebval_U_d_l0_,[n_svd_l,n_1,n_1,n_1,n_1]),svd_expil_s_V_UX_M_l1wnM_____),[n_svd_l,n_1,n_w_max,pm_n_UX_rank,n_M])),[n_delta_p_w,n_1,n_w_max,pm_n_UX_rank,n_M]);
n_op = (nnz(FTK.svd_l_from_nl__)*n_delta_p_w + n_svd_l) * n_1 * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% svd_U_d_0_expil_s_V_UX_M_l1wnM_____: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;
tmp_t=tic();
%svd_U_d_r_expil_s_V_UX_M_lrwnM_____ = reshape(FTK.svd_l_from_nl__ * reshape(bsxfun(@times,reshape(FTK.svd_chebval_U_d_lr__,[n_svd_l,n_delta_p_r,n_1,n_1,n_1]),svd_expil_s_V_UX_M_l1wnM_____),[n_svd_l,n_delta_p_r*n_w_max*pm_n_UX_rank*n_M]),[n_delta_p_w,n_delta_p_r,n_w_max,pm_n_UX_rank,n_M]);
svd_U_d_r_expil_s_V_UX_M_lrwnM_____ = reshape(pagemtimes(full(FTK.svd_l_from_nl__),reshape(bsxfun(@times,reshape(FTK.svd_chebval_U_d_lr__,[n_svd_l,n_delta_p_r,n_1,n_1,n_1]),svd_expil_s_V_UX_M_l1wnM_____),[n_svd_l,n_delta_p_r,n_w_max,pm_n_UX_rank,n_M])),[n_delta_p_w,n_delta_p_r,n_w_max,pm_n_UX_rank,n_M]);
n_op = (nnz(FTK.svd_l_from_nl__)*n_delta_p_w + n_svd_l) * n_delta_p_r * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% svd_U_d_r_expil_s_V_UX_M_lrwnM_____: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;
tmp_t=tic();
UX_T_M_k_q_wrwnM_____ = ifft(svd_U_d_r_expil_s_V_UX_M_lrwnM_____,n_delta_p_w,1+0)*n_delta_p_w;
n_op = n_delta_p_w*log(n_delta_p_w) * n_delta_p_r * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% UX_T_M_k_q_wrwnM_____: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;
tmp_t=tic();
UX_T_M_k_q_dwnM____ = cat(1+0,reshape(sum(svd_U_d_0_expil_s_V_UX_M_l1wnM_____,1+[0,1]),[n_1,n_w_max,pm_n_UX_rank,n_M]),reshape(UX_T_M_k_q_wrwnM_____,[n_delta_p_w*n_delta_p_r,n_w_max,pm_n_UX_rank,n_M]));
n_op = n_delta_v * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% UX_T_M_k_q_dwnM____: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;

flag_check=1;
if flag_check;
flag_verbose=1;
tmp_t=tic();
UX_T_N_k_q_dwnM____ = reshape(pagemtimes(FTK.svd_U_d_expiw_s__,svd_V_UX_M_lwnM____),[n_delta_v,n_w_max,pm_n_UX_rank,n_M]);
n_op = n_delta_v * n_svd_l * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% UX_T_N_k_q_dwnM____: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;
fnorm_disp(flag_verbose,'UX_T_N_k_q_dwnM____',UX_T_N_k_q_dwnM____,'UX_T_M_k_q_dwnM____',UX_T_M_k_q_dwnM____,' %<-- should be zero');
end;%if flag_check;

tmp_t=tic();
UX_T_M_l2_dM__ = reshape(sum(reshape(permute(abs(UX_T_M_k_q_dwnM____).^2,1+[1,2,0,3]),[n_w_max*pm_n_UX_rank,n_delta_v,n_M]),1+0) * n_w_max,[n_delta_v,n_M]);
n_op = n_delta_v * n_w_max * pm_n_UX_rank * n_M ;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% UX_T_M_l2_dM__: time %0.6fs n_op %.2fG',tmp_t,n_op/1e9)); end;
