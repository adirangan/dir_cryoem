%{
%%%%%%%%;
% extracted from test_empm_FINYU5_27.m ;
%%%%%%%%;
XA_fname_pre = sprintf('%s_mat/X_2d_Memp_d1_%s',dir_pm,str_xfix);
[XA_flag_skip,XA_fname_mat] = open_fname_tmp(XA_fname_pre,date_diff_threshold,flag_force_create_mat,flag_force_create_tmp);
tmp_XA_ = load(XA_fname_mat);
%%%%;
tmp_XA_euler_polar_a_M_ = tmp_XA_.euler_polar_a_Mi__(:,end);
tmp_XA_euler_azimu_b_M_ = tmp_XA_.euler_azimu_b_Mi__(:,end);
tmp_XA_euler_gamma_z_M_ = tmp_XA_.euler_gamma_z_Mi__(:,end);
tmp_XA_image_delta_x_M_ = tmp_XA_.image_delta_x_acc_Mi__(:,end) + tmp_XA_.image_delta_x_upd_Mi__(:,end);
tmp_XA_image_delta_y_M_ = tmp_XA_.image_delta_y_acc_Mi__(:,end) + tmp_XA_.image_delta_y_upd_Mi__(:,end);
%%%%;
fname_XA_k_Y_mat = sprintf('%s_a_k_Y_.mat',tmp_XA_.parameter.fname_pre);
tmp_ = load(fname_XA_k_Y_mat); tmp_XA_a_k_Y_reco_yk_ = tmp_.a_k_Y_reco_yk_; clear tmp_;
%}
%{
tmp_dir_base = '/data/rangan/dir_cryoem/';
tmp_dir_pm_mat = sprintf('%s/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm_mat',tmp_dir_base);
tmp_fname_mat = sprintf('%s/test_tfpmut_wrap_6.mat',tmp_dir_pm_mat);
 save(tmp_fname_mat ...
      ,'n_k_p_r' ...
      ,'k_p_r_' ...
      ,'k_p_r_max' ...
      ,'weight_3d_k_p_r_' ...
      ,'weight_2d_k_p_r_' ...
      ,'n_w_' ...
      ,'weight_2d_k_p_wk_' ...
      ,'l_max_' ...
      ,'n_CTF' ...
      ,'CTF_k_p_wkC__' ...
      ,'index_nCTF_from_nM_' ...
      ,'n_M' ...
      ,'M_k_p_wkM__' ...
      ,'tmp_XA_euler_polar_a_M_' ...
      ,'tmp_XA_euler_azimu_b_M_' ...
      ,'tmp_XA_euler_gamma_z_M_' ...
      ,'tmp_XA_image_delta_x_M_' ...
      ,'tmp_XA_image_delta_y_M_' ...
      ,'tmp_XA_a_k_Y_reco_yk_' ...
      );
%}
%{
flag_verbose=1;
rseed=0;
tolerance_pm=0.100000000000000;
delta_r_max=0.017631663493955;
delta_r_upb=0.141053307951639;
dir_pm = '/data/rangan/dir_cryoem/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm';
flag_alternate_MS_vs_SM=1;
flag_force_create_mat=0;
flag_force_create_tmp=1;
flag_gpu=1;
tolerance_master=0.010000000000000;
flag_rank_vs_tolerance=0;
flag_clump_vs_cluster=0;
rank_pm=10;
rank_CTF=4;
k_p_r_max=7.639437268410976;
sample_sphere_k_eq_d=0.159154943091895;
half_diameter_x_c=1;
n_x_u_pack=64;
cg_lsq_n_order=5;
date_diff_threshold=0.250000000000000;
flag_qbp_vs_lsq=1;
qbp_eps=0.010000000000000;
str_strategy_prefix='';
n_complete_calculation=0;
fname_pre='/data/rangan/dir_cryoem/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm_mat/X_2d_Memp_d1_a1t0017p10r0';
%}
%{
% Now focus on: ;
/data/rangan/dir_cryoem/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm_mat/test_tfpmut_wrap_6_XA_from_matlab_stage_9_0.mat. ;
%}

str_thisfunction = 'test_tfpmut_wrap_6_stage_9';
%%%%%%%%%%%%%%%%;
flag_verbose=1;
tmp_dir_base = '/data/rangan/dir_cryoem/';
tmp_dir_pm_mat = sprintf('%s/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm_mat',tmp_dir_base);
tmp_fname_mat = sprintf('%s/test_tfpmut_wrap_6_a1t0017p10r1.mat',tmp_dir_pm_mat);
load(tmp_fname_mat); weight_3d_k_p_r_= weight_3d_k_p_r_(:);
parameter = struct('type','parameter');
parameter.flag_verbose=flag_verbose;
parameter.rseed=0;
parameter.tolerance_pm=0.100000000000000;
parameter.delta_r_max=0.017631663493955;
parameter.delta_r_upb=0.141053307951639;
parameter.dir_pm = '/data/rangan/dir_cryoem/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm';
parameter.flag_alternate_MS_vs_SM=1;
parameter.flag_force_create_mat=0;
parameter.flag_force_create_tmp=1;
parameter.flag_gpu=1;
parameter.tolerance_master=0.010000000000000;
parameter.flag_rank_vs_tolerance=0;
parameter.flag_clump_vs_cluster=0;
parameter.rank_pm=10;
parameter.rank_CTF=4;
parameter.k_p_r_max=7.639437268410976;
parameter.sample_sphere_k_eq_d=0.159154943091895;
parameter.half_diameter_x_c=1;
parameter.n_x_u_pack=64;
parameter.cg_lsq_n_order=5;
parameter.date_diff_threshold=0.250000000000000;
parameter.flag_qbp_vs_lsq=1;
parameter.qbp_eps=0.010000000000000;
parameter.str_strategy_prefix='';
parameter.n_complete_calculation=0;
parameter.n_iteration=32;
%%%%%%%%%%%%%%%%;
fname_mat = '/data/rangan/dir_cryoem/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm_mat/test_tfpmut_wrap_6_XA_from_matlab_stage_4.mat';
if ~exist(fname_mat,'file'); disp(sprintf(' %% %s not found',fname_mat)); end;
if  exist(fname_mat,'file'); load(fname_mat); end;%if  exist(fname_mat,'file');
tmp_t = tic();
parameter_FTK = parameter;
parameter_FTK.delta_r_max = delta_r_max;
parameter_FTK.svd_eps = svd_eps;
parameter_FTK.n_delta_v_requested = n_delta_v_requested;
[parameter_FTK,FTK] = tfh_FTK_4(parameter_FTK,n_k_p_r,k_p_r_,k_p_r_max);
tmp_t = toc(tmp_t); if (flag_verbose>1); disp(sprintf(' %% FTK: %0.3fs',tmp_t)); end;
parameter = parameter_timing_update(parameter,sprintf('%s: tfh_FTK_4',str_thisfunction),tmp_t);
assert(FTK.svd_d_max>=delta_r_max);
assert(FTK.n_delta_v>=n_delta_v_requested);
n_delta_v = FTK.n_delta_v;
n_svd_l = FTK.n_svd_l;
%%%%%%%%%%%%%%%%;
fname_mat = '/data/rangan/dir_cryoem/dir_FINYU_nx64s003nM1024nCTF50p40V300D25000r050A010/dir_pm_mat/test_tfpmut_wrap_6_XA_from_matlab_stage_9_0.mat';
if ~exist(fname_mat,'file'); disp(sprintf(' %% %s not found',fname_mat)); end;
if  exist(fname_mat,'file');
%%%%%%%%%%%%%%%%;
load(fname_mat);
%clear M_k_q_wkM__ ;
%clear UX_T_M_l2_dM__ ;
%clear UX_M_l2_M_ ;
%clear svd_V_UX_M_lwnM____ ;
%clear UX_CTF_S_k_q_wnS__ ;
%clear UX_CTF_S_l2_S_ ;
if ~exist('M_k_q_wkM__','var'); M_k_q_wkM__=[]; end;
if ~exist('UX_T_M_l2_dM__','var'); UX_T_M_l2_dM__=[]; end;
if ~exist('UX_M_l2_M_','var'); UX_M_l2_M_=[]; end;
if ~exist('svd_V_UX_M_lwnM____','var'); svd_V_UX_M_lwnM____=[]; end;
if ~exist('UX_CTF_S_k_q_wnS__','var'); UX_CTF_S_k_q_wnS__=[]; end;
if ~exist('UX_CTF_S_l2_S_','var'); UX_CTF_S_l2_S_=[]; end;
parameter.flag_verbose = max(0,flag_verbose-1);
parameter.flag_precompute_M_k_q_wkM__ = 1*1;
parameter.flag_precompute_UX_T_M_l2_dM__ = 1*1;
parameter.flag_precompute_UX_M_l2_M_ = 1*1;
parameter.flag_precompute_svd_V_UX_M_lwnM____ = 1*1;
parameter.flag_precompute_UX_CTF_S_k_q_wnS__ = flag_precompute_UX_CTF_S_k_q_wnS__;
parameter.flag_precompute_UX_CTF_S_l2_S_ = flag_precompute_UX_CTF_S_l2_S_;
if parameter.flag_precompute_UX_CTF_S_k_q_wnS__==0 & parameter.flag_precompute_UX_CTF_S_l2_S_==0;
index_nS_to_update_ = [];
else; 
index_nS_to_update_ = transpose(0:n_S-1);
end;%if;
%%%%%%%%;
index_nM_to_update_ = transpose(randperm(n_M,min(n_M,8))-1);
parameter.flag_verbose = 0;
%parameter.flag_tf_vs_bf = 1; FTK.flag_tf_vs_bf = 1;
%%%%%%%%;
tmp_t = tic();
[ ...
 parameter ...
,Z_SM__ ...
,UX_CTF_S_l2_S_ ...
,UX_T_M_l2_SM__ ...
,X_SM__ ...
,delta_x_SM__ ...
,delta_y_SM__ ...
,gamma_z_SM__ ...
,index_sub_SM__ ...
,index_nM_from_ncluster__ ...
,n_index_nM_from_ncluster_ ...
,M_k_q_wkM__ ...
,UX_T_M_l2_dM__ ...
,UX_M_l2_M_ ...
,svd_V_UX_M_lwnM____ ...
,UX_CTF_S_k_q_wnS__ ...
] = ...
tfpmh_Z_cluster_wrap_SM__14( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_S ...
,S_k_p_wkS__ ...
,n_CTF ...
,CTF_k_p_r_kC__ ...
,index_nCTF_from_nM_ ...
,n_M ...
,M_pert_k_p_wkM__ ...
,n_cluster ...
,index_ncluster_from_nCTF_ ...
,pm_n_UX_rank_c_ ...
,pm_UX_knc___ ...
,pm_X_weight_rc__ ...
,FTK ...
,index_nM_to_update_ ...
,M_k_q_wkM__ ...
,UX_T_M_l2_dM__ ...
,UX_M_l2_M_ ...
,svd_V_UX_M_lwnM____ ...
,index_nS_to_update_ ...
,UX_CTF_S_k_q_wnS__ ...
,UX_CTF_S_l2_S_ ...
);
parameter.flag_verbose = flag_verbose;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% %% X_SM__: %0.3fs',tmp_t)); end;
parameter = parameter_timing_update(parameter,sprintf('%s: tfpmh_Z_cluster_wrap_SM__14',str_thisfunction),tmp_t);
%%%%%%%%;
end;%if  exist(fname_mat,'file');
%%%%%%%%%%%%%%%%;
parameter_timing_printf(parameter);
