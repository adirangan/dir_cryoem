%%%%%%%%;
platform = 'rusty';
if (exist('platform.type','file')); fp=fopen('platform.type'); platform = fscanf(fp,'%s'); fclose(fp); end;
if (strcmp(platform,'access1')); setup_access1; string_root = 'data'; end;
if (strcmp(platform,'OptiPlex')); setup_OptiPlex; string_root = 'home'; end;
if (strcmp(platform,'eval1')); setup_eval1; string_root = 'home'; end;
if (strcmp(platform,'rusty')); setup_rusty; string_root = 'mnt/home'; end;
%%%%%%%%;

table_data__ = { ...
'rib80s_x0' , 'rib80s' , 1.34 , 'emd_2660.mrc' , 'shiny_2sets.star' ; ...
};
n_experiment = size(table_data__,1);
%%%%%%%%;
nexperiment = 0;
na=0;
fname_prefix = table_data__{1+nexperiment,1+na}; na=na+1;
dir_nopath_data_star = table_data__{1+nexperiment,1+na}; na=na+1;
Pixel_Spacing = table_data__{1+nexperiment,1+na}; na=na+1;
fname_nopath_volume = table_data__{1+nexperiment,1+na}; na=na+1;
fname_nopath_star = table_data__{1+nexperiment,1+na}; na=na+1;
disp(sprintf(' %% nexperiment %d/%d: %16s %16s %0.3f %16s %32s' ...
	     ,nexperiment,n_experiment ...
	     ,fname_prefix,dir_nopath_data_star,Pixel_Spacing,fname_nopath_volume,fname_nopath_star ...
	     ));
global_parameter = struct('type','parameter');
if (strcmp(dir_nopath_data_star,'LSUbl17dep')); global_parameter.flag_invert = 0; end;
if (strcmp(dir_nopath_data_star,'LSUbl17dep')); global_parameter.flag_center_image = 1; end;
if (strcmp(dir_nopath_data_star,'precatalytic_spliceosome')); global_parameter.flag_center_image = 1; end;

if isempty(global_parameter); global_parameter = struct('type','parameter'); end;
if (~isfield(global_parameter,'flag_recalc')); global_parameter.flag_recalc = 0; end; %<-- parameter_bookmark. ;
if (~isfield(global_parameter,'flag_replot')); global_parameter.flag_replot = 0; end; %<-- parameter_bookmark. ;
if (~isfield(global_parameter,'flag_center_volume')); global_parameter.flag_center_volume = 0; end; %<-- parameter_bookmark. ;
if (~isfield(global_parameter,'flag_center_image')); global_parameter.flag_center_image = 0; end; %<-- parameter_bookmark. ;
if (~isfield(global_parameter,'flag_invert')); global_parameter.flag_invert = 0; end; %<-- parameter_bookmark. ;
if (~isfield(global_parameter,'tolerance_master')); global_parameter.tolerance_master = 1e-2; end; %<-- parameter_bookmark. ;
flag_recalc = global_parameter.flag_recalc;
flag_replot = global_parameter.flag_replot;
flag_center_volume = global_parameter.flag_center_volume;
flag_center_image = global_parameter.flag_center_image;
flag_invert = global_parameter.flag_invert;
tolerance_master = global_parameter.tolerance_master;
nf=0;

%%%%%%%%;
fname_prefix_xfix = sprintf('%s',fname_prefix);
dir_pm = sprintf('/%s/rangan/dir_cryoem/dir_%s/dir_pm',string_root,fname_prefix_xfix);
if (~exist(sprintf('%s_mat',dir_pm),'dir')); disp(sprintf(' %% mkdir %s_mat',dir_pm)); mkdir(sprintf('%s_mat',dir_pm)); end;
if (~exist(sprintf('%s_jpg',dir_pm),'dir')); disp(sprintf(' %% mkdir %s_jpg',dir_pm)); mkdir(sprintf('%s_jpg',dir_pm)); end;
dir_relion = sprintf('/%s/rangan/dir_cryoem/dir_%s/dir_relion',string_root,fname_prefix_xfix);
if (~exist(sprintf('%s_mat',dir_relion),'dir')); disp(sprintf(' %% mkdir %s_mat',dir_relion)); mkdir(sprintf('%s_mat',dir_relion)); end;
if (~exist(sprintf('%s_jpg',dir_relion),'dir')); disp(sprintf(' %% mkdir %s_jpg',dir_relion)); mkdir(sprintf('%s_jpg',dir_relion)); end;
string_rusty_root = 'mnt/home';
dir_relion_bin = sprintf('/%s/rangan/relion/build/bin',string_rusty_root);
dir_data_star = sprintf('/%s/rangan/dir_cryoem/dir_%s',string_root,dir_nopath_data_star);
%%%%%%%%;
% all classes and subclasses. ;
%%%%%%%%;
fname_nopath_volume_ = ...
{ ...
 fname_nopath_volume ... %<-- class 0. ;
};
n_volume = numel(fname_nopath_volume_);
flag_het = 0; if (n_volume> 1); flag_het = 1; end;

verbose = 1;

fname_mat = sprintf('%s_mat/a_x_u_base_.mat',dir_pm); load(fname_mat);
fname_mat = sprintf('%s_mat/a_k_p_quad_.mat',dir_pm); load(fname_mat);
fname_mat = sprintf('%s_mat/a_k_Y_quad_.mat',dir_pm); load(fname_mat);
fname_mat = sprintf('%s_mat/S_k_p__.mat',dir_pm); load(fname_mat);
fname_mat = sprintf('%s_mat/M_k_p__.mat',dir_pm); load(fname_mat);
fname_mat = sprintf('%s_mat/CTF_k_p_wkC__.mat',dir_pm); load(fname_mat);

flag_recalc = 0;
tmp_delta_r_max = 0.030;
tmp_delta_r_upb = 0.250;
flag_N_vs_M = flag_center_image;
if flag_N_vs_M==0; tmp_N_k_p__ = M_k_p__; tmp_str = 'M'; end;%if flag_N_vs_M==0; 
if flag_N_vs_M==1; tmp_N_k_p__ = N_k_p__; tmp_str = 'N'; end;%if flag_N_vs_M==1;
%%%%%%%%;
tmp_fname_mat = sprintf('%s_mat/a_k_Y_reco_from_%s__.mat',dir_pm,tmp_str);
if ( exist(tmp_fname_mat,'file'));
fname_pre = sprintf('%s_mat/a_k_Y_reco_stab_from_%s_extend__',dir_pm,tmp_str);
[flag_skip,fname_mat] = open_fname_tmp(fname_pre);
if (flag_recalc | ~flag_skip);
%%%%%%%%;
tmp_ = load(tmp_fname_mat);
tmp_euler_polar_a_true_ = tmp_.euler_polar_a_Mi__(:,end);
tmp_euler_azimu_b_true_ = tmp_.euler_azimu_b_Mi__(:,end);
tmp_euler_gamma_z_true_ = tmp_.euler_gamma_z_Mi__(:,end);
tmp_image_delta_x_true_ = tmp_.image_delta_x_acc_Mi__(:,end) + tmp_.image_delta_x_upd_Mi__(:,end);
tmp_image_delta_y_true_ = tmp_.image_delta_y_acc_Mi__(:,end) + tmp_.image_delta_y_upd_Mi__(:,end);
clear tmp_;
%%%%%%%%;
parameter = struct('type','parameter');
parameter.tolerance_master = tolerance_master;
parameter.n_iteration = 48;
parameter.delta_r_max = tmp_delta_r_max;
parameter.n_delta_v_requested = 24;
parameter.delta_r_upb = tmp_delta_r_upb;
parameter.fname_pre = fname_pre;
parameter.rank_vs_tolerance = 0;
parameter.flag_alternate_MS_vs_SM = -1; %<-- stick with flag_MS_vs_SM. ;
parameter.flag_MS_vs_SM = 0;
parameter.f_rand = 0.05;
ampmut_wrap_5( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,weight_2d_k_p_r_ ...
,n_w_max ...
,l_max_ ...
,index_nCTF_from_nM_ ...
,n_CTF ...
,CTF_k_p_r_kC__ ...
,n_M ...
,tmp_N_k_p__ ...
,tmp_euler_polar_a_true_ ...
,tmp_euler_azimu_b_true_ ...
,tmp_euler_gamma_z_true_ ...
,tmp_image_delta_x_true_ ...
,tmp_image_delta_y_true_ ...
,a_k_Y_quad_ ...
);
close_fname_tmp(fname_pre);
end;%if (flag_recalc | ~flag_skip);
end;%if ( exist(tmp_fname_mat,'file'));
%%%%%%%%;
tmp_fname_mat = sprintf('%s_mat/a_k_Y_reco_stab_from_%s_extend__.mat',dir_pm,tmp_str);
if ( exist(tmp_fname_mat,'file'));
fname_pre = sprintf('%s_mat/a_k_Y_reco_stab_alig_from_%s_extend__',dir_pm,tmp_str);
[flag_skip,fname_mat] = open_fname_tmp(fname_pre);
if (flag_recalc | ~flag_skip);
tmp_ = load(tmp_fname_mat);
n_iteration = tmp_.parameter.n_iteration;
X_best_reco_stab_alig_i_ = zeros(n_iteration,1);
flag_flip_reco_stab_alig_i_ = zeros(n_iteration,1);
euler_polar_a_reco_stab_alig_i_ = zeros(n_iteration,1);
euler_azimu_b_reco_stab_alig_i_ = zeros(n_iteration,1);
euler_gamma_z_reco_stab_alig_i_ = zeros(n_iteration,1);
image_delta_x_reco_stab_alig_i_ = zeros(n_iteration,1);
image_delta_y_reco_stab_alig_i_ = zeros(n_iteration,1);
image_delta_z_reco_stab_alig_i_ = zeros(n_iteration,1);
for niteration=0:n_iteration-1;
euler_polar_a_reco_stab_ = tmp_.euler_polar_a_Mi__(:,1+niteration);
euler_azimu_b_reco_stab_ = tmp_.euler_azimu_b_Mi__(:,1+niteration);
euler_gamma_z_reco_stab_ = tmp_.euler_gamma_z_Mi__(:,1+niteration);
image_delta_x_reco_stab_ = tmp_.image_delta_x_acc_Mi__(:,1+niteration) + tmp_.image_delta_x_upd_Mi__(:,1+niteration);
image_delta_y_reco_stab_ = tmp_.image_delta_y_acc_Mi__(:,1+niteration) + tmp_.image_delta_y_upd_Mi__(:,1+niteration);
tmp_n_order = 5;
a_k_Y_reco_stab_ = ...
cg_lsq_6( ...
 tmp_n_order ...
,n_k_p_r ...
,k_p_r_ ...
,l_max_ ...
,n_w_ ...
,n_M ...
,tmp_N_k_p__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_r_kC__ ...
,euler_polar_a_reco_stab_ ...
,euler_azimu_b_reco_stab_ ...
,euler_gamma_z_reco_stab_ ...
,image_delta_x_reco_stab_ ...
,image_delta_y_reco_stab_ ...
);
%%%%;
[ ... 
 a_k_Y_reco_stab_alig_ ...
,X_best_reco_stab_alig ...
,flag_flip_reco_stab_alig ...
,euler_polar_a_reco_stab_alig ...
,euler_azimu_b_reco_stab_alig ...
,euler_gamma_z_reco_stab_alig ...
,image_delta_x_reco_stab_alig ...
,image_delta_y_reco_stab_alig ...
,image_delta_z_reco_stab_alig ...
] = ...
spharm_register_and_rotate_2( ...
 n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_k_Y_quad_ ...
,a_k_Y_reco_stab_ ...
);
X_best_reco_stab_alig_i_(1+niteration) = X_best_reco_stab_alig;
flag_flip_reco_stab_alig_i_(1+niteration) = flag_flip_reco_stab_alig;
euler_polar_a_reco_stab_alig_i_(1+niteration) = euler_polar_a_reco_stab_alig;
euler_azimu_b_reco_stab_alig_i_(1+niteration) = euler_azimu_b_reco_stab_alig;
euler_gamma_z_reco_stab_alig_i_(1+niteration) = euler_gamma_z_reco_stab_alig;
image_delta_x_reco_stab_alig_i_(1+niteration) = image_delta_x_reco_stab_alig;
image_delta_y_reco_stab_alig_i_(1+niteration) = image_delta_y_reco_stab_alig;
image_delta_z_reco_stab_alig_i_(1+niteration) = image_delta_z_reco_stab_alig;
end;%for niteration=0:n_iteration-1;
%%%%;
save(fname_mat ...
     ,'a_k_Y_reco_stab_' ...
     ,'euler_polar_a_reco_stab_' ...
     ,'euler_azimu_b_reco_stab_' ...
     ,'euler_gamma_z_reco_stab_' ...
     ,'image_delta_x_reco_stab_' ...
     ,'image_delta_y_reco_stab_' ...
     ,'a_k_Y_reco_stab_alig_' ...
     ,'X_best_reco_stab_alig' ...
     ,'flag_flip_reco_stab_alig' ...
     ,'euler_polar_a_reco_stab_alig' ...
     ,'euler_azimu_b_reco_stab_alig' ...
     ,'euler_gamma_z_reco_stab_alig' ...
     ,'image_delta_x_reco_stab_alig' ...
     ,'image_delta_y_reco_stab_alig' ...
     ,'X_best_reco_stab_alig_i_' ...
     ,'flag_flip_reco_stab_alig_i_' ...
     ,'euler_polar_a_reco_stab_alig_i_' ...
     ,'euler_azimu_b_reco_stab_alig_i_' ...
     ,'euler_gamma_z_reco_stab_alig_i_' ...
     ,'image_delta_x_reco_stab_alig_i_' ...
     ,'image_delta_y_reco_stab_alig_i_' ...
     );
close_fname_tmp(fname_pre);
end;%if (flag_recalc | ~flag_skip);
end;%if ( exist(tmp_fname_mat,'file'));
%%%%%%%%;

%%%%%%%%;
% add a_x_u_reco_stab_alig_. ;
%%%%%%%%;
flag_N_vs_M = flag_center_image;
if flag_N_vs_M==0; tmp_N_k_p__ = M_k_p__; tmp_str = 'M'; end;%if flag_N_vs_M==0; 
if flag_N_vs_M==1; tmp_N_k_p__ = N_k_p__; tmp_str = 'N'; end;%if flag_N_vs_M==1;
tmp_fname_mat = sprintf('%s_mat/a_k_Y_reco_stab_alig_from_%s_extend__.mat',dir_pm,tmp_str);
tmp_ = load(tmp_fname_mat);
if  isfield(tmp_,'a_x_u_reco_stab_alig_');
if (verbose); disp(sprintf(' %% a_x_u_reco_stab_alig_ found, not creating')); end;
end;%if  isfield(tmp_,'a_x_u_reco_stab_alig_');
if ~isfield(tmp_,'a_x_u_reco_stab_alig_');
if (verbose); disp(sprintf(' %% a_x_u_reco_stab_alig_ not found, creating')); end;
sample_sphere_k_eq_d = 1/(2*pi);
[ ... 
  tmp_.a_x_u_reco_stab_alig_ ...
] = ...
convert_spharm_to_x_c_3( ...
 sample_sphere_k_eq_d ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,tmp_.a_k_Y_reco_stab_alig_ ...
,half_diameter_x_c ...
,n_x_u_pack ...
);
save(tmp_fname_mat,'-struct','tmp_','a_x_u_reco_stab_alig_','-append');
end;%if ~isfield(tmp_,'a_x_u_reco_stab_alig_');

flag_disp=0;
if flag_disp;
%%%%%%%%;
% plot viewing-angle-distribution. ;
%%%%%%%%;
flag_N_vs_M = flag_center_image;
if flag_N_vs_M==0; tmp_N_k_p__ = M_k_p__; tmp_str = 'M'; end;%if flag_N_vs_M==0; 
if flag_N_vs_M==1; tmp_N_k_p__ = N_k_p__; tmp_str = 'N'; end;%if flag_N_vs_M==1;
tmp_fname_mat = sprintf('%s_mat/a_k_Y_reco_stab_from_%s_extend__.mat',dir_pm,tmp_str);
tmp_ = load(tmp_fname_mat);
%%%%;
[ ...
 tmp_n_all ...
,tmp_azimu_b_all_ ...
,tmp_polar_a_all_ ...
,tmp_weight_all_ ...
,tmp_k_c_0_all_ ...
,tmp_k_c_1_all_ ...
,tmp_k_c_2_all_ ...
,tmp_n_polar_a ...
,tmp_polar_a_ ...
,tmp_n_azimu_b_ ...
] = ...
sample_shell_5( ...
 1.0 ...
,1.0/(2*pi) ...
) ;
%%%%;
n_iteration = tmp_.parameter.n_iteration;
for niteration=0:n_iteration-1;
subplot(6,8,1+niteration);
[ ...
 hist_ ...
 weighted_hist_ ...
] = ...
hist2d_polar_a_azimu_b_0( ...
 tmp_polar_a_all_ ...
,tmp_azimu_b_all_ ...
,tmp_weight_all_ ...
,tmp_.euler_polar_a_Mi__(:,1+niteration) ...
,tmp_.euler_azimu_b_Mi__(:,1+niteration) ...
,[] ...
,colormap_beach ...
,1 ...
,0 ...
);
axisnotick;
end;%for niteration=0:n_iteration-1;
%%%%;
end;%if flag_disp;

flag_disp=1;
if flag_disp;
%%%%%%%%;
% plot volumes. ;
%%%%%%%%;
fname_fig = sprintf('%s_jpg/a_x_u_base_vs_stab_fig_FIGA',dir_pm);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if (verbose); disp(sprintf(' %% %s not found, creating',fname_fig)); end;
figure(1+nf);nf=nf+1;clf;
p_row = 3; p_col = 3; np=0;
for prow=0:p_row-1;for pcol=0:p_col-1;
if prow==0; tmp_prctile = 99; end;
if prow==1; tmp_prctile = 97; end;
if prow==2; tmp_prctile = 95; end;
if pcol==0; tmp_a_x_u_ = a_x_u_base_; tmp_str_ = 'base'; end;
if pcol==1; tmp_a_x_u_ = a_x_u_reco_; tmp_str_ = 'reco'; end;
if pcol==2; tmp_a_x_u_ = tmp_.a_x_u_reco_stab_alig_; tmp_str_ = 'stab_alig'; end;
subplot(p_row,p_col,1+np);np=np+1;
isosurface_cut_f_x_u_0(tmp_a_x_u_,tmp_prctile,[],(1-colormap('bone')));
title(sprintf('%s p%d',tmp_str_,tmp_prctile),'Interpreter','none');
xlabel(''); ylabel(''); zlabel('');
end;end;%for prow=0:p_row-1;for pcol=0:p_col-1;
set(gcf,'Position',1+[0,0,1024,1024]);
sgtitle(fname_fig,'Interpreter','none');
if (verbose); disp(sprintf(' %% writing %s',fname_fig)); end;
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
end;%if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
if (verbose); disp(sprintf(' %% %s found, not creating',fname_fig)); end;
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
end;%if flag_disp;


flag_disp=1;
if flag_disp;
%%%%%%%%;
% plot volume cross-section. ;
%%%%%%%%;
fname_fig = sprintf('%s_jpg/a_x_u_base_vs_stab_fig_FIGB',dir_pm);
if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if (verbose); disp(sprintf(' %% %s not found, creating',fname_fig)); end;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;
p_row = 3; p_col = 5; np=0;
n_x_c = n_x_u_pack;
xlim_ = [-1,+1];
plim_ = [93,100];
X_ = transpose(linspace(min(xlim_),max(xlim_),n_x_c));
X_cut_ = transpose(linspace(0.5*min(xlim_),0.5*max(xlim_),2+p_col));
X_cut_ = X_cut_(2:end-1);
n_contour = 32;
for prow=0:p_row-1;
if prow==0; tmp_a_x_u_ = a_x_u_base_; tmp_str_ = 'base'; end;
if prow==1; tmp_a_x_u_ = a_x_u_reco_; tmp_str_ = 'reco'; end;
if prow==2; tmp_a_x_u_ = tmp_.a_x_u_reco_stab_alig_; tmp_str_ = 'stab_alig'; end;
tmp_a_x_u_ = real(tmp_a_x_u_);
tmp_a_x_u___ = interp1(X_,reshape(tmp_a_x_u_,[n_x_c,n_x_c,n_x_c]),X_cut_);
alim_ = prctile(tmp_a_x_u_(:),plim_);
for pcol=0:p_col-1;
tmp_a_x_u__ = squeeze(tmp_a_x_u___(1+pcol,:,:));
subplot_(1+np) = subplot(p_row,p_col,1+np);np=np+1;
[c,h] = contourf(tmp_a_x_u__,linspace(min(alim_),max(alim_),n_contour));
set(h,'LineStyle','none');
axis image; axisnotick;
end;end;%for prow=0:p_row-1;for pcol=0:p_col-1;
for np=0:p_row*p_col-1;
colormap(subplot_(1+np),colormap(1-colormap('bone')));
end;%for np=0:p_row*p_col-1;
figbig;
sgtitle(fname_fig,'Interpreter','none');
if (verbose); disp(sprintf(' %% writing %s',fname_fig)); end;
print('-djpeg',sprintf('%s.jpg',fname_fig));
close(gcf);
%%%%%%%%;
end;%if (flag_replot | ~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
if (verbose); disp(sprintf(' %% %s found, not creating',fname_fig)); end;
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
%%%%%%%%;
end;%if flag_disp;





