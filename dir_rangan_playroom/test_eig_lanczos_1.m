flag_verbose = 1;
flag_disp = 1; nf=0;
rng(0);

%%%%%%%%;
% testing lanczos method ;
% for finding smallest eigenvalue of ;
% symmetric-positive-definite matrix. ;
%%%%%%%%;
n_x = 64;
r_ = transpose([0:n_x-1])/max(1,n_x-1);
eta = 0.75; %<-- width of spectrum. ;
sigma = 0.25;
S_ = (1-eta) + (eta)*exp(-r_.^2 / (2*sigma^2));
S_ = S_ + (1-eta)*(sin(2*pi*r_) + 0.5*sin(4*pi*r_) + 0.25*sin(8*pi*r_));
S_ = sort(S_ - min(S_) + (1-eta),'descend');
[U__,~] = qr(rand(n_x,n_x));
A__ = U__*diag(S_)*transpose(U__);
n_x_pert = floor(n_x*2/3);
A00__ = A__(1:n_x_pert,1:n_x_pert);
A01__ = A__(1:n_x_pert,n_x_pert+1:n_x);
A10__ = A__(n_x_pert+1:n_x,1:n_x_pert);
A11__ = A__(n_x_pert+1:n_x,n_x_pert+1:n_x);
eps_pert = 1*1e-2;
A01__ = A01__ + eps_pert*rand(size(A01__));
A10__ = A10__ + eps_pert*rand(size(A10__));
A_pert__ = [A00__ , A01__ ; A10__ , A11__];
S_pert_ = eigs(A_pert__,n_x);
A = @(x_) A__*x_ ; %<-- matrix function. ;
A_pert = @(x_) A_pert__*x_ ; %<-- matrix function. ;
b_ = zeros(n_x,1);
%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
% testing lanczos method ;
% for finding extreme eigenvalues of ;
% symmetric-positive-definite matrix. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
n_iteration = n_x;
v_xi__ = zeros(n_x,n_iteration);
alph_i_ = zeros(n_iteration,1);
beta_i_ = zeros(n_iteration,1);
lambda_xi__ = zeros(n_x,n_iteration);
w_ = [];
v_ = [];
%%%%%%%%%%%%%%%%;
for niteration=0:n_iteration-1;
%%%%%%%%%%%%%%%%;
if niteration==0;
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, setting beta to zero ',niteration)); end;
beta_i_(1+niteration)=0;
end;%if niteration==0;
if niteration> 0;
beta_i_(1+niteration) = sqrt(ctranspose(w_)*w_);
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, beta_i_(1+niteration) = %0.6f',niteration,beta_i_(1+niteration))); end;
end;%if niteration> 0;
%%%%%%%%;
if abs(beta_i_(1+niteration))>=1e-12;
v_ = w_/beta_i_(1+niteration);
end;%if abs(beta_i_(1+niteration))>=1e-12;
if abs(beta_i_(1+niteration))< 1e-12;
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, beta close to zero, generating new v_',niteration)); end;
v_ = ones(n_x,1);%v_ = rand(n_x,1);
if niteration>=1; v_ = v_ - v_xi__(:,1+[0:niteration-1])*(ctranspose(v_xi__(:,1+[0:niteration-1]))*v_); end;%if niteration>=1;
v_ = v_/max(1e-12,fnorm(v_));
end;%if abs(beta_i_(1+niteration))< 1e-12;
%%%%%%%%;
v_xi__(:,1+niteration) = v_;
%%;
w_ = v_xi__(:,1+niteration);
w_ = A(w_);
alph_i_(1+niteration) = ctranspose(w_)*v_xi__(:,1+niteration);
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, alph_i_(1+niteration) = %0.6f',niteration,alph_i_(1+niteration))); end;
w_ = w_ - alph_i_(1+niteration)*v_xi__(:,1+niteration+0);
if niteration>=1; w_ = w_ - beta_i_(1+niteration)*v_xi__(:,1+niteration-1); end;
%%%%;
if (flag_verbose>2);
[tmp_VV_ii__] = ctranspose(v_xi__(:,1:1+niteration))*v_xi__(:,1:1+niteration);
tmp_str_format = ' %% %%'; for ni=0:niteration; tmp_str_format = sprintf('%s %%+0.4f',tmp_str_format); end; tmp_str_format = sprintf('%s\\n',tmp_str_format);
disp(sprintf(' %% abs(tmp_VV_ii__): \n %s',num2str(transpose(abs(tmp_VV_ii__(:))),tmp_str_format)));
end;%if (flag_verbose>2);
%%%%%%%%%%%%%%%%;
end;%for niteration=0:n_iteration-1;
%%%%%%%%%%%%%%%%;

n_iteration = numel(alph_i_); T__ = real(spdiags([circshift(beta_i_,-1),alph_i_,beta_i_],[-1,0,+1],n_iteration,n_iteration));
lambda_xi__ = -Inf*ones(n_iteration,n_iteration);
for niteration=0:n_iteration-1;
T_sub__ = T__(1:1+niteration,1:1+niteration);
lambda_sub_ = eigs(T_sub__,[],1+niteration);
lambda_xi__(1:1+niteration,1+niteration) = sort(lambda_sub_,'ascend');
end;%for niteration=0:n_iteration-1;
S_x_ = sort(eigs(T__,[],n_iteration),'ascend');
%%%%%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figmed;fig81s;
markersize_use = 8;
linewidth_sml = 0.5;
linewidth_big = 2;
%%%%;
subplot(1,1,1);
hold on;
plot(repmat([0;n_iteration],[1,n_iteration]),repmat(reshape(S_x_,[1,n_iteration]),[2,1]),'-','Color',0.85*[1,1,1],'LineWidth',linewidth_sml);
ni_xi__ = repmat([1:n_iteration],[n_iteration,1]);
tmp_index_ = efind(isfinite(lambda_xi__));
plot(ni_xi__(1+tmp_index_),lambda_xi__(1+tmp_index_),'r.','MarkerSize',markersize_use);
hold off;
xlabel('iteration'); ylabel('sigma');
xlim([0,1+n_iteration]);
ylim([min(S_x_)-0.25,max(S_x_)+0.25]);
title('A (not perturbed)');
%%%%;
end;%if flag_disp;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
% Recalculate with perturbation. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
n_iteration = n_x;
v_pert_xi__ = zeros(n_x,n_iteration);
alph_pert_i_ = zeros(n_iteration,1);
beta_pert_i_ = zeros(n_iteration,1);
lambda_pert_xi__ = zeros(n_x,n_iteration);
w_pert_ = [];
v_pert_ = [];
%%%%%%%%%%%%%%%%;
for niteration=0:n_iteration-1;
%%%%%%%%%%%%%%%%;
if niteration==0;
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, setting beta_pert to zero ',niteration)); end;
beta_pert_i_(1+niteration)=0;
end;%if niteration==0;
if niteration> 0;
beta_pert_i_(1+niteration) = sqrt(ctranspose(w_pert_)*w_pert_);
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, beta_pert_i_(1+niteration) = %0.6f',niteration,beta_pert_i_(1+niteration))); end;
end;%if niteration> 0;
%%%%%%%%;
if abs(beta_pert_i_(1+niteration))>=1e-12;
v_pert_ = w_pert_/beta_pert_i_(1+niteration);
end;%if abs(beta_pert_i_(1+niteration))>=1e-12;
if abs(beta_pert_i_(1+niteration))< 1e-12;
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, beta_pert close to zero, generating new v_pert_',niteration)); end;
v_pert_ = ones(n_x,1);%v_pert_ = rand(n_x,1);
if niteration>=1; v_pert_ = v_pert_ - v_pert_xi__(:,1+[0:niteration-1])*(ctranspose(v_pert_xi__(:,1+[0:niteration-1]))*v_pert_); end;%if niteration>=1;
v_pert_ = v_pert_/max(1e-12,fnorm(v_pert_));
end;%if abs(beta_pert_i_(1+niteration))< 1e-12;
%%%%%%%%;
v_pert_xi__(:,1+niteration) = v_pert_;
%%;
w_pert_ = v_pert_xi__(:,1+niteration);
w_pert_ = A_pert(w_pert_);
alph_pert_i_(1+niteration) = ctranspose(w_pert_)*v_pert_xi__(:,1+niteration);
if (flag_verbose>1); disp(sprintf(' %% %% ni %.2d, alph_pert_i_(1+niteration) = %0.6f',niteration,alph_pert_i_(1+niteration))); end;
w_pert_ = w_pert_ - alph_pert_i_(1+niteration)*v_pert_xi__(:,1+niteration+0);
if niteration>=1; w_pert_ = w_pert_ - beta_pert_i_(1+niteration)*v_pert_xi__(:,1+niteration-1); end;
%%%%;
if (flag_verbose>2);
[tmp_VV_pert_ii__] = ctranspose(v_pert_xi__(:,1:1+niteration))*v_pert_xi__(:,1:1+niteration);
tmp_str_format = ' %% %%'; for ni=0:niteration; tmp_str_format = sprintf('%s %%+0.4f',tmp_str_format); end; tmp_str_format = sprintf('%s\\n',tmp_str_format);
disp(sprintf(' %% abs(tmp_VV_pert_ii__): \n %s',num2str(transpose(abs(tmp_VV_pert_ii__(:))),tmp_str_format)));
end;%if (flag_verbose>2);
%%%%%%%%%%%%%%%%;
end;%for niteration=0:n_iteration-1;
%%%%%%%%%%%%%%%%;

n_iteration = numel(alph_pert_i_); T_pert__ = real(spdiags([circshift(beta_pert_i_,-1),alph_pert_i_,beta_pert_i_],[-1,0,+1],n_iteration,n_iteration));
lambda_pert_xi__ = -Inf*ones(n_iteration,n_iteration);
for niteration=0:n_iteration-1;
T_pert_sub__ = T_pert__(1:1+niteration,1:1+niteration);
lambda_pert_sub_ = eigs(T_pert_sub__,[],1+niteration);
lambda_pert_xi__(1:1+niteration,1+niteration) = sort(lambda_pert_sub_,'ascend');
end;%for niteration=0:n_iteration-1;
S_pert_x_ = sort(eigs(T_pert__,[],n_iteration),'ascend');
%%%%%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figmed;fig81s;
markersize_use = 8;
linewidth_sml = 0.5;
linewidth_big = 2;
%%%%;
subplot(1,1,1);
hold on;
plot(repmat([0;n_iteration],[1,n_iteration]),repmat(reshape(S_pert_x_,[1,n_iteration]),[2,1]),'-','Color',0.85*[1,1,1],'LineWidth',linewidth_sml);
ni_xi__ = repmat([1:n_iteration],[n_iteration,1]);
tmp_index_ = efind(isfinite(lambda_pert_xi__));
plot(ni_xi__(1+tmp_index_),lambda_pert_xi__(1+tmp_index_),'r.','MarkerSize',markersize_use);
hold off;
xlabel('iteration'); ylabel('sigma');
xlim([0,1+n_iteration]);
ylim([min(S_pert_x_)-0.25,max(S_pert_x_)+0.25]);
title('A (yes perturbed)');
%%%%;
end;%if flag_disp;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
% Compare lanczos to arnoldi. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
n_iteration = n_x;
v_pert_xi__ = zeros(n_x,n_iteration);
H_pert__ = zeros(n_iteration,n_iteration);
lambda_pert_xi__ = zeros(n_x,n_iteration);
w_pert_ = [];
v_pert_ = [];
%%%%%%%%%%%%%%%%;
for niteration=0:n_iteration-1;
%%%%%%%%%%%%%%%%;
if niteration==0;
v_pert_ = ones(n_x,1);
v_pert_ = v_pert_/max(1e-12,fnorm(v_pert_));
v_pert_xi__(:,1+niteration) = v_pert_;
end;%if niteration==0;
w_pert_ = A_pert(v_pert_xi__(:,1+niteration));
H_pert__(1:1+niteration,1+niteration) = ctranspose(v_pert_xi__(:,1:1+niteration))*w_pert_;
w_pert_ = w_pert_ - v_pert_xi__(:,1:1+niteration)*(H_pert__(1:1+niteration,1+niteration));
H_pert__(1+niteration+1,1+niteration+0) = fnorm(w_pert_);
if abs(H_pert__(1+niteration+1,1+niteration+0))< 1e-12;
v_pert_ = randn(n_x,1); v_pert_ = v_pert_/max(1e-12,fnorm(v_pert_));
v_pert_xi__(:,1+niteration+1) = v_pert_;
end;%if abs(H_pert__(1+niteration+1,1+niteration+0))< 1e-12;
if abs(H_pert__(1+niteration+1,1+niteration+0))>=1e-12;
v_pert_xi__(:,1+niteration+1) =w_pert_/max(1e-12,H_pert__(1+niteration+1,1+niteration+0));
end;%if abs(H_pert__(1+niteration+1,1+niteration+0))>=1e-12;
%%%%%%%%%%%%%%%%;
end;%for niteration=0:n_iteration-1;
%%%%%%%%%%%%%%%%;

lambda_pert_xi__ = -Inf*ones(n_iteration,n_iteration);
for niteration=0:n_iteration-1;
H_pert_sub__ = H_pert__(1:1+niteration,1:1+niteration);
lambda_pert_sub_ = real(eigs(H_pert_sub__,[],1+niteration));
lambda_pert_xi__(1:1+niteration,1+niteration) = sort(lambda_pert_sub_,'ascend');
end;%for niteration=0:n_iteration-1;
S_pert_x_ = sort(real(eigs(H_pert__(1:n_x,1:n_x),[],n_iteration)),'ascend');
R_pert_x_ = sort(real(eigs(A_pert__(1:n_x,1:n_x),[],n_iteration)),'ascend');
%%%%%%%%;
if flag_disp;
figure(1+nf);nf=nf+1;clf;figmed;fig81s;
markersize_use = 8;
linewidth_sml = 0.5;
linewidth_big = 2;
%%%%;
subplot(1,1,1);
hold on;
plot(repmat([0;n_iteration],[1,n_iteration]),repmat(reshape(R_pert_x_,[1,n_iteration]),[2,1]),'-','Color',0.85*[1,1,1],'LineWidth',linewidth_sml);
plot(repmat([0;n_iteration],[1,n_iteration]),repmat(reshape(S_pert_x_,[1,n_iteration]),[2,1]),'-','Color',0.35*[1,1,1],'LineWidth',linewidth_sml);
ni_xi__ = repmat([1:n_iteration],[n_iteration,1]);
tmp_index_ = efind(isfinite(lambda_pert_xi__));
plot(ni_xi__(1+tmp_index_),lambda_pert_xi__(1+tmp_index_),'r.','MarkerSize',markersize_use);
hold off;
xlabel('iteration'); ylabel('sigma');
xlim([0,1+n_iteration]);
ylim([min(S_pert_x_)-0.25,max(S_pert_x_)+0.25]);
title('A (yes perturbed)');
%%%%;
end;%if flag_disp;

%%%%%%%%;
% Verdict: Arnoldi is less stable than Lanczos, even when the perturbation is very small. ;
% The instability onsets around the same time that the v_xi__ cease to be orthogonal. ;
% imagesc(log10(abs(transpose(v_pert_xi__)*v_pert_xi__)));colorbar;
% imagesc(log10(abs(H_pert__)));colorbar;
%%%%%%%%;
