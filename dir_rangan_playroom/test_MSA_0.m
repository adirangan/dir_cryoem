%%%%%%%%;
% setting up simple multi-slice-alignment. ;
% assume a 2d-volume x, comprising a single ring. ;
% Assume that x is restricted to just 2 bessel-coefficients, implying a circle in C. ;
%%%%%%%%;

clear;
%%%%%%%%;
platform = 'rusty';
if (exist('platform.type','file')); fp=fopen('platform.type'); platform = fscanf(fp,'%s'); fclose(fp); end;
if (strcmp(platform,'access1')); setup_access1; string_root = 'data'; end;
if (strcmp(platform,'OptiPlex')); setup_OptiPlex; string_root = 'home'; end;
if (strcmp(platform,'eval1')); setup_eval1; string_root = 'home'; end;
if (strcmp(platform,'rusty')); setup_rusty; string_root = 'mnt/home'; end;
%%%%%%%%;

figure(1);clf;figbig;
fig80s();
markersize_use = 6;
linewidth_use = 1;
n_contour = 64;
p_row = 3; np=0;
n_point = 16;
n_x = 256;
snr_ = 10.^[1:-0.5:-1.5]; n_snr = numel(snr_);
for nsnr=0:n_snr-1;
snr = snr_(1+nsnr);
gamma_z_ = linspace(0,2*pi,n_point+1); gamma_z_ = transpose(gamma_z_(1:end-1));
M_p2__ = [cos(gamma_z_) , sin(gamma_z_)];
M_l2 = fnorm(M_p2__);
sigma=0; if (snr> 0); sigma = M_l2/max(1e-12,snr); end;
rseed=0;rng(rseed);
M_p2__ = M_p2__ + sigma*randn(size(M_p2__));
xlim_ = mean(M_p2__(:)) + 3.5*std(M_p2__(:),1)*[-1,+1];
x_0_ = linspace(min(xlim_),max(xlim_),n_x);
x_1_ = linspace(min(xlim_),max(xlim_),n_x);
[x_0__,x_1__] = ndgrid(x_0_,x_1_); n_xx = n_x^2;
N_0_p01___ = reshape(bsxfun(@minus,M_p2__(:,1+0),reshape(x_0__(:),[1,n_xx])),[n_point,n_x,n_x]);
N_1_p01___ = reshape(bsxfun(@minus,M_p2__(:,1+1),reshape(x_1__(:),[1,n_xx])),[n_point,n_x,n_x]);
r_p01___ = zeros(n_point,n_xx);
r_p01___ = sqrt( N_0_p01___.^2 + N_1_p01___.^2 );
r_p01___ = reshape(r_p01___,[n_point,n_x,n_x]);
r_x01___ = mean(r_p01___,1);
dr_p01___ = bsxfun(@minus,r_p01___,r_x01___);
L_x01___ = mean(dr_p01___.^2,1);
DL0_x01___ = mean(N_0_p01___.*dr_p01___./max(1e-14,r_p01___),1);
DL1_x01___ = mean(N_1_p01___.*dr_p01___./max(1e-14,r_p01___),1);
DL_x01___ = sqrt( DL0_x01___.^2 + DL1_x01___.^2);
subplot_(1+np) = subplot(p_row,ceil(2*n_snr/p_row),1+np);np=np+1;
hold on;
contour(x_0_,x_1_,squeeze(L_x01___),transpose(prctile(L_x01___,[0:1:50],'all')),'LineWidth',linewidth_use);
plot(M_p2__(:,1+1),M_p2__(:,1+0),'.','MarkerSize',markersize_use,'MarkerEdgeColor','y');
hold off;
xlim(xlim_);ylim(xlim_);
axis square; axisnotick;
title(sprintf('snr %0.3f L',snr));
subplot_(1+np) = subplot(p_row,ceil(2*n_snr/p_row),1+np);np=np+1;
hold on;
contourf(x_0_,x_1_,squeeze(DL_x01___),transpose(prctile(DL_x01___,[0:1:100],'all')),'LineStyle','none'); 
xlim(xlim_);ylim(xlim_); axis square; axisnotick;
%plot(M_p2__(:,1+1),M_p2__(:,1+0),'.','MarkerSize',markersize_use,'MarkerEdgeColor','y');
hold off;
xlim(xlim_);ylim(xlim_);
axis square; axisnotick;
title(sprintf('snr %0.3f DL',snr));
end;%for nsnr=0:n_snr-1;
%%%%;
np=0;
for nsnr=0:n_snr-1;
colormap(subplot_(1+np),colormap_80s); np=np+1; np=np+1;
end;%for nsnr=0:n_snr-1;
np=1;
for nsnr=0:n_snr-1;
colormap(subplot_(1+np),colormap_beach); np=np+1; np=np+1;
drawnow();
end;%for nsnr=0:n_snr-1;

