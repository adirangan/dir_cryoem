function a_k_p__ = cg_evaluate_n_0(l_max,a_k_Y_,n_polar_a,n_azimu_b);
% evaluates spherical_harmonic_expansion a_k_Y_ on a tensor-product spherical grid. ;
% Note that a_k_Y_ is ordered linearly, with m_val varying quickly and l_val varying slowly. ;
% Note that a_k_p__ is ordered with polar_a varying quickly, and azimu_b varying slowly. ;
%%%%%%%%;
if (nargin<4);
disp(sprintf(' %% testing cg_evaluate_n_0 and cg_evaluate_t_0'));
n_polar_a = 16;
n_azimu_b = 18;
l_max = 4;
n_lm_max = (1+l_max)^2;
A__ = zeros(n_polar_a*n_azimu_b,n_lm_max);
for nlm_max=0:n_lm_max-1;
tmp_a_k_Y_ = zeros(n_lm_max,1); tmp_a_k_Y_(1+nlm_max,1)=1;
A__(:,1+nlm_max) = reshape(cg_evaluate_n_0(l_max,tmp_a_k_Y_,n_polar_a,n_azimu_b),[n_polar_a*n_azimu_b,1]);
end;%for nlm_max=0:n_lm_max-1;
B__ = zeros(n_lm_max,n_polar_a*n_azimu_b);
for nall=0:n_polar_a*n_azimu_b-1;
tmp_a_k_p__ = zeros(n_polar_a,n_azimu_b); tmp_a_k_p__(1+nall)=1;
B__(:,1+nall) = cg_evaluate_t_0(n_polar_a,n_azimu_b,tmp_a_k_p__,l_max);
end;%for nall=0:n_polar_a*n_azimu_b-1;
flag_plot=0;
if flag_plot;
subplot(2,2,1); imagesc(real(A__)); title('real(A)');
subplot(2,2,2); imagesc(imag(A__)); title('imag(A)');
subplot(2,2,3); imagesc(real(B__)); title('real(B)');
subplot(2,2,4); imagesc(imag(B__)); title('imag(B)');
figbig;
end;%if flag_plot;
disp(sprintf(' %% cg_n__ vs ctranspose(cg_t__): %0.16f',fnorm(A__-ctranspose(B__))/fnorm(A__)));
%%%%%%%%;
n_polar_a = 65; polar_a_ = transpose(linspace(0,pi,n_polar_a)); weight_polar_a_ = sin(polar_a_)*pi/(n_polar_a-1); weight_polar_a_(2:2:end) = weight_polar_a_(2:2:end)*4/3; weight_polar_a_(1:2:end) = weight_polar_a_(1:2:end)*2/3; %<-- simpson rule. ;
n_azimu_b = 128; azimu_b_ = transpose(linspace(0,2*pi,n_azimu_b+1)); azimu_b_ = azimu_b_(1:end-1); weight_azimu_b = 2*pi/n_azimu_b;
weight__ = weight_polar_a_*weight_azimu_b*ones(1,n_azimu_b);
[polar_a__,azimu_b__] = ndgrid(polar_a_,azimu_b_);
polar_a_all_ = polar_a__(:);
azimu_b_all_ = azimu_b__(:);
n_all = n_polar_a*n_azimu_b;
l_max = 4;
n_lm_max = (1+l_max)^2;
[Ylm__] = get_Ylm__(1+l_max,0:l_max,n_all,azimu_b_all_,polar_a_all_);
I_form__ = eye(n_lm_max,n_lm_max);
I_quad__ = zeros(n_lm_max,n_lm_max);
nlm_1_max=0;
for l_val_1=0:l_max;
for m_val_1=-l_val_1:+l_val_1;
tmp_a_k_Y_ = zeros(n_lm_max,1); tmp_a_k_Y_(1+l_val_1^2+l_val_1+m_val_1,1) = 1;
tmp_a_k_p__ = cg_evaluate_n_0(l_max,tmp_a_k_Y_,n_polar_a,n_azimu_b);
nlm_2_max=0;
for l_val_2=0:l_max;
for m_val_2=-l_val_2:+l_val_2;
I_quad__(1+nlm_1_max,1+nlm_2_max) = sum(ctranspose(Ylm__{1+l_val_2}(1+l_val_2+m_val_2,:)).*tmp_a_k_p__(:).*weight__(:),'all');
nlm_2_max=nlm_2_max+1;
end;%for m_val_2=-l_val_2:+l_val_2;
end;%for l_val_2=0:l_max;
assert(nlm_2_max==n_lm_max);
nlm_1_max=nlm_1_max+1;
end;%for m_val_1=-l_val_1:+l_val_1;
end;%for l_val_1=0:l_max;
assert(nlm_1_max==n_lm_max);
flag_plot=0;
if flag_plot;
subplot(2,2,1); imagesc(real(I_form__)); title('real(I_form)');
subplot(2,2,2); imagesc(imag(I_form__)); title('imag(I_form)');
subplot(2,2,3); imagesc(real(I_quad__)); title('real(I_quad)');
subplot(2,2,4); imagesc(imag(I_quad__)); title('imag(I_quad)');
figbig;
end;%if flag_plot;
disp(sprintf(' %% orthonormality (simpson''s quadrature): I_form__ vs I_quad__: %0.16f',fnorm(I_form__-I_quad__)/fnorm(I_form__)));
%%%%%%%%;
disp('returning'); return;
end;%if (nargin<4);

% evaluate a_k_Y_ on tensor spherical grid. ;
n_l_val = 1 + 1*l_max;
n_lm_max = (1+l_max)^2;
n_m_abs = 1 + 1*l_max;
n_m_val = 1 + 2*l_max;
if (n_azimu_b<n_m_val); disp(sprintf(' %% Warning, n_azimu_b %d < n_m_val %d',n_azimu_b,n_m_val)); end;
n_azimu_b = max(n_azimu_b,n_m_val); %<-- important later for ifft. ;
polar_a_ = transpose(linspace(0,pi,n_polar_a));
cos_polar_a_ = cos(polar_a_);
azimu_b_ = transpose(linspace(0,2*pi,n_azimu_b+1));
azimu_b_ = azimu_b_(1:end-1);

legendre_normalization__ = zeros(n_l_val,n_m_abs);
for l_val=0:l_max;
tmp_a1 = ((1+2*l_val)/(4*pi));
for m_abs=0:l_val;
tmp_a2 = exp(lfactorial(l_val-m_abs) - lfactorial(l_val+m_abs));
tmp_a3 = sqrt(tmp_a1*tmp_a2);
legendre_normalization__(1+l_val,1+m_abs) = tmp_a3;
end;%for m_abs=0:l_val;
end;%for l_val=0:l_max;

legendre_evaluate_lmj___ = zeros(n_l_val,n_m_val,n_polar_a); %<-- will include normalization. ;
for l_val=0:l_max;
tmp_n_m_abs = 1 + 1*l_val;
tmp_P__ = legendre(l_val,cos_polar_a_,'unnorm');
tmp_ZP__ = diag(legendre_normalization__(1+l_val,1:tmp_n_m_abs))*reshape(tmp_P__,[tmp_n_m_abs,n_polar_a]);
legendre_evaluate_lmj___(1+l_val,1 + l_max + [0:+1:+l_val],:) = tmp_ZP__;
legendre_evaluate_lmj___(1+l_val,1 + l_max + [0:-1:-l_val],:) = tmp_ZP__;
end;%for l_val=0:l_max;

legendre_evaluate_ljm___ = permute(legendre_evaluate_lmj___,[1,3,2]);

%%%%%%%%;
% Create a_k_Y_lm__ so that rows correspond to l_val and columns correpond to m_val. ;
%%%%%%%%;
a_k_Y_lm__ = convert_spharm_to_spharm__0(l_max,a_k_Y_);
%%%%%%%%;
% Create a_k_Y_ml__ so that rows correspond to m_val and columns correspond to l_val. ;
%%%%%%%%;
a_k_Y_ml__ = permute(a_k_Y_lm__,[2,1]); %<-- non-conjugate transpose. ;

%%%%%%%%;
% Our main goal is to compute: ;
% a_k_p__(1+npolar_a,1+nazimu_b) = ;
% \sum_{l_val=0}^{l_val=l_max} \sum_{m_val=-l_val}^{+l_val} .... ;
%  Ylm__(l_val;m_val)(polar_a,azimu_b) * a_k_Y_lm__(1+l_val,1+l_max+m_val), ;
% Where polar_a = polar_a_(npolar_a), and azimu_b = azimu_b_(nazimu_b), ;
% and a_k_Y_lm__(1+l_val,1+l_max+m_val) = a_k_Y_(1+(1+(l_val-1))^2 + l_val + m_val) ;
% = a_k_Y_( 1 + l_val^2 + l_val + m_val ). ;
% ;
% Note that Ylm__(l_val;m_val)(polar_a,azimu_b) can be decomposed as: ;
% Ylm__(l_val;m_val) = ... ;
% legendre_normalization(l_val;m_val) ... ;
% * legendre_evaluate(l_val;m_val)(cos(polar_a_(npolar_a))) ... ;
% * exp(+i*m_val*azimu_b_(nazimu_b)). ;
% ;
% We will use the ifft by first calculating: ;
% spherical_harmonic_unphased__(1+l_max+m_val,npolar_a)
% \sum_{l_val=0}^{l_val=l_max} ... ;
%  legendre_normalization(l_val;m_val) ... ;
%  * legendre_evaluate(l_val;m_val;cos_polar_a_(npolar_a))) ... ;
%  * a_k_Y_ml__(1+l_max+m_val,1+l_val);
% ;
% And then calculating: ;
% a_k_p__(1+npolar_a,1+nazimu_b) = ;
% \sum_{m_val=-l_max}^{m_val=+l_max} ... ;
% spherical_harmonic_unphased__(1+l_max+m_val,npolar_a) ... ;
% * exp(+i*m_val*azimu_b_(nazimu_b)). ;
%%%%%%%%;

%%%%%%%%;
% First sum over l_val for each m_val ;
% Note that legendre_evaluate_ljm___ already accounts for the normalization. ;
%%%%%%%%;
spherical_harmonic_unphased__ = zeros(n_m_val,n_polar_a);
for m_val=-l_max:+l_max;
spherical_harmonic_unphased__(1+l_max+m_val,:) = a_k_Y_ml__(1 + l_max + m_val,:) * legendre_evaluate_ljm___(:,:,1 + l_max + m_val);
end;%for m_val=-l_max:+l_max;

%%%%%%%%;
% Now sum over m_val ;
% Note that IFFT computes: ;
%                    N                                                  ;
%      x(n) = (1/N) sum  X(k)*exp( j*2*pi*(k-1)*(n-1)/N), 1 <= n <= N.  ;
%                   k=1                                                 ;
% Whereas we would like to compute: ;
% a_k_p__(1+npolar_a,1+nazimu_b) = ;
% \sum_{m_val=-l_max}^{m_val=+l_max} ... ;
% spherical_harmonic_unphased__(1+l_max+m_val,npolar_a) ... ;
% * exp(+i*m_val*azimu_b_(nazimu_b)). ;
% ;
% Noting that: m_val = -l_max + nm_val, ;
% where nm_val ranges across [0:(2*l_max)] ;
% and that: azimu_b_(nazimu_b) = 2*pi*nazimu_b/n_azimu_b, ;
% We can rewrite this sum as: ;
% 
% a_k_p__(1+npolar_a,1+nazimu_b) = ;
% \sum_{nm_val=0}^{nm_val=n_m_val-1} ... ;
% spherical_harmonic_unphased__(1+nm_val,npolar_a) ... ;
% * exp(+i*2*pi*(nm_val-l_max)*nazimu_b/n_azimu_b). ;
% which equals: ;
% a_k_p__(1+npolar_a,1+nazimu_b) = ;
% exp(-i*2*pi*l_max/n_azimu_b)^nazimu_b * ... ;
% \sum_{nm_val=0}^{nm_val=n_m_val-1} ... ;
% spherical_harmonic_unphased__(1+nm_val,npolar_a) ... ;
% * exp(+i*2*pi*nm_val*nazimu_b/n_azimu_b). ;
% where nazimu_b ranges across [0:n_azimu_b-1]. ;
% ;
% Thus, assuming that n_azimu_b >= n_m_val, ;
% the entries of a_k_p__(1+npolar_a,:) should be equal to ;
% (exp(-i*2*pi*l_max/n_azimu_b).^[0:n_azimu_b-1]) .* tmp_ifft_out_, ;
% where tmp_ifft_out_ = n_azimu_b * ifft(tmp_ifft_0in_), ;
% where tmp_ifft_0in_ has been padded as: ;
% tmp_ifft_0in_ = [ spherical_harmonic_unphased__(:,npolar_a) ; zeros(n_azimu_b - n_m_val,1) ];
%%%%%%%%;
assert(n_azimu_b>=n_m_val);
a_k_p__ = zeros(n_polar_a,n_azimu_b);
tmp_ifft_0in__ = [ spherical_harmonic_unphased__(:,:) ; zeros(n_azimu_b-n_m_val,n_polar_a) ];
tmp_ifft_out__ = n_azimu_b * ifft(tmp_ifft_0in__);
expi = exp(-i*2*pi*l_max/n_azimu_b);
expi_ = expi.^transpose([0:n_azimu_b-1]);
a_k_p__ = permute(sparse(1:n_azimu_b,1:n_azimu_b,expi_,n_azimu_b,n_azimu_b)*tmp_ifft_out__,[2,1]);





