%%%%%%%%;
% Calculate derivative using ssnll_from_a_k_p_15. ;
%%%%%%%%;
if ~exist('S_q2d_k_p_wkS__','var'); S_q2d_k_p_wkS__=[]; end;
dvol_S_q2d_k_p_wkS__=[];
dtau_S_q2d_k_p_wkS3___=[];
dtau_dvol_S_q2d_k_p_wkS3___=[];
dtau_dtau_S_q2d_k_p_wkS33____=[];
%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('n_R','var'); n_R = []; end;
if ~exist('R_use_R___','var'); R_use_R___ = []; end;
if ~exist('a_R_k_p_Rqk__','var'); a_R_k_p_Rqk__=[]; end;
if ~exist('dvol_a_R_k_p_Rqk__','var'); dvol_a_R_k_p_Rqk__=[]; end;
if ~exist('ba_from_single_shell_Rbaba___','var'); ba_from_single_shell_Rbaba___=[]; end;
if ~exist('wS_from_R_single_shell_Rsba___','var'); wS_from_R_single_shell_Rsba___=[]; end;
if ~exist('dwSda_from_R_single_shell_Rsba___','var'); dwSda_from_R_single_shell_Rsba___=[]; end;
if ~exist('dwSdb_from_R_single_shell_Rsba___','var'); dwSdb_from_R_single_shell_Rsba___=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_Rsba___','var'); ddwSdaa_from_R_single_shell_Rsba___=[]; end;
if ~exist('ddwSdab_from_R_single_shell_Rsba___','var'); ddwSdab_from_R_single_shell_Rsba___=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_Rsba___','var'); ddwSdbb_from_R_single_shell_Rsba___=[]; end;
parameter_ssnll = struct('type','parameter');
parameter_ssnll.flag_verbose = 0*flag_verbose;
parameter_ssnll.tolerance_master = tolerance_master;
parameter_ssnll.tolerance_pinv = tolerance_pinv;
parameter_ssnll.viewing_k_eq_d = viewing_k_eq_d;
parameter_ssnll.template_k_eq_d = template_k_eq_d;
parameter_ssnll.n_order = n_order;
[ ...
 parameter_ssnll ...
,ssnll_q2d_M_ ...
,ssnll_q2d ...
,S_q2d_k_p_wkS__ ...
,dvol_ssnll_q2d_M_ ...
,dvol_ssnll_q2d ...
,dvol_S_q2d_k_p_wkS__ ...
,dvol_dvol_ssnll_q2d ...
,dtau_ssnll_q2d_M3__ ...
,dtau_ssnll_q2d ...
,dtau_S_q2d_k_p_wkS3___ ...
,dtau_dvol_ssnll_q2d_M3__ ...
,dtau_dvol_ssnll_q2d ...
,dtau_dvol_S_q2d_k_p_wkS3___ ...
,dtau_dtau_ssnll_q2d_M33___ ...
,dtau_dtau_ssnll_q2d ...
,dtau_dtau_S_q2d_k_p_wkS33____ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,n_S_sub ...
,index_nS_from_nS_sub_ ...
,n_R ...
,R_use_R___ ...
,viewing_R_polar_a_mod_S_subR__ ...
,viewing_R_azimu_b_mod_S_subR__ ...
,nR_from_nS_sub_ ...
,a_R_k_p_Rqk__ ...
,dvol_a_R_k_p_Rqk__ ...
,ba_from_single_shell_Rbaba___ ...
,wS_from_R_single_shell_Rsba___ ...
,dwSda_from_R_single_shell_Rsba___ ...
,dwSdb_from_R_single_shell_Rsba___ ...
,ddwSdaa_from_R_single_shell_Rsba___ ...
,ddwSdab_from_R_single_shell_Rsba___ ...
,ddwSdbb_from_R_single_shell_Rsba___ ...
] = ...
ssnll_from_a_k_p_15( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_qk_ ...
,dvol_a_k_p_qk_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,S_q2d_k_p_wkS__ ...
,dvol_S_q2d_k_p_wkS__ ...
,dtau_S_q2d_k_p_wkS3___ ...
,dtau_dvol_S_q2d_k_p_wkS3___ ...
,dtau_dtau_S_q2d_k_p_wkS33____ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,n_R ...
,R_use_R___ ...
,a_R_k_p_Rqk__ ...
,dvol_a_R_k_p_Rqk__ ...
,ba_from_single_shell_Rbaba___ ...
,wS_from_R_single_shell_Rsba___ ...
,dwSda_from_R_single_shell_Rsba___ ...
,dwSdb_from_R_single_shell_Rsba___ ...
,ddwSdaa_from_R_single_shell_Rsba___ ...
,ddwSdab_from_R_single_shell_Rsba___ ...
,ddwSdbb_from_R_single_shell_Rsba___ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_15: time %0.2fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%%%%%%%%%;
if flag_check & flag_pwe2;
%%%%%%%%%%%%%%%%;

%%%%%%%%%%%%%%%%;
tmp_t = tic();
[ ...
 ~ ...
,ssnll_pw2_M_ ...
,ssnll_pw2 ...
,S_pw2_k_p_wkS__ ...
,dvol_ssnll_pw2_M_ ...
,dvol_ssnll_pw2 ...
,dvol_S_pw2_k_p_wkS__ ...
,dvol_dvol_ssnll_pw2 ...
,dtau_ssnll_pw2_M3__ ...
,dtau_ssnll_pw2 ...
,dtau_S_pw2_k_p_wkS3___ ...
,dtau_dvol_ssnll_pw2_M3__ ...
,dtau_dvol_ssnll_pw2 ...
,dtau_dvol_S_pw2_k_p_wkS3___ ...
,dtau_dtau_ssnll_pw2_M33___ ...
,dtau_dtau_ssnll_pw2 ...
,dtau_dtau_S_pw2_k_p_wkS33____ ...
] = ...
ssnll_from_plane_wave_expansion_2( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_phi_C_ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,weight_imagecount_M_ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,fromb_polar_a_M_ ...
,fromb_azimu_b_M_ ...
,fromb_gamma_z_M_ ...
,M_phi_M_ ...
,n_S ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_plane_wave_expansion_2: time %0.2fs',tmp_t)); end;
%%%%;

fnorm_disp(flag_verbose,'ssnll_pw2_M_',ssnll_pw2_M_,'ssnll_q2d_M_',ssnll_q2d_M_);
fnorm_disp(flag_verbose,'ssnll_pw2',ssnll_pw2,'ssnll_q2d',ssnll_q2d);
fnorm_disp(flag_verbose,'S_pw2_k_p_wkS__',S_pw2_k_p_wkS__,'S_q2d_k_p_wkS__',S_q2d_k_p_wkS__);
fnorm_disp(flag_verbose,'dvol_ssnll_pw2_M_',dvol_ssnll_pw2_M_,'dvol_ssnll_q2d_M_',dvol_ssnll_q2d_M_);
fnorm_disp(flag_verbose,'dvol_ssnll_pw2',dvol_ssnll_pw2,'dvol_ssnll_q2d',dvol_ssnll_q2d);
fnorm_disp(flag_verbose,'dvol_S_pw2_k_p_wkS__',dvol_S_pw2_k_p_wkS__,'dvol_S_q2d_k_p_wkS__',dvol_S_q2d_k_p_wkS__);
fnorm_disp(flag_verbose,'dvol_dvol_ssnll_pw2',dvol_dvol_ssnll_pw2,'dvol_dvol_ssnll_q2d',dvol_dvol_ssnll_q2d);
fnorm_disp(flag_verbose,'dtau_ssnll_pw2_M3__',dtau_ssnll_pw2_M3__,'dtau_ssnll_q2d_M3__',dtau_ssnll_q2d_M3__);
fnorm_disp(flag_verbose,'dtau_ssnll_pw2',dtau_ssnll_pw2,'dtau_ssnll_q2d',dtau_ssnll_q2d);
fnorm_disp(flag_verbose,'dtau_S_pw2_k_p_wkS3___',dtau_S_pw2_k_p_wkS3___,'dtau_S_q2d_k_p_wkS3___',dtau_S_q2d_k_p_wkS3___);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pw2_M3__',dtau_dvol_ssnll_pw2_M3__,'dtau_dvol_ssnll_q2d_M3__',dtau_dvol_ssnll_q2d_M3__);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pw2',dtau_dvol_ssnll_pw2,'dtau_dvol_ssnll_q2d',dtau_dvol_ssnll_q2d);
fnorm_disp(flag_verbose,'dtau_dvol_S_pw2_k_p_wkS3___',dtau_dvol_S_pw2_k_p_wkS3___,'dtau_dvol_S_q2d_k_p_wkS3___',dtau_dvol_S_q2d_k_p_wkS3___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pw2_M33___',dtau_dtau_ssnll_pw2_M33___,'dtau_dtau_ssnll_q2d_M33___',dtau_dtau_ssnll_q2d_M33___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pw2',dtau_dtau_ssnll_pw2,'dtau_dtau_ssnll_q2d',dtau_dtau_ssnll_q2d);
fnorm_disp(flag_verbose,'dtau_dtau_S_pw2_k_p_wkS33____',dtau_dtau_S_pw2_k_p_wkS33____,'dtau_dtau_S_q2d_k_p_wkS33____',dtau_dtau_S_q2d_k_p_wkS33____);

%%%%%%%%;
if ~isempty(dtau_euler_polar_a_M_) & ~isempty(dtau_euler_azimu_b_M_) & ~isempty(dtau_euler_gamma_z_M_) ;
dtau_M3__ = [ dtau_euler_polar_a_M_ , dtau_euler_azimu_b_M_ , dtau_euler_gamma_z_M_ ] ;
dtau_dtau_M33___ = bsxfun(@times,reshape(dtau_M3__,[n_M,n_3,n_1]),reshape(dtau_M3__,[n_M,n_1,n_3]));
end;%if ~isempty(dtau_euler_polar_a_M_) & ~isempty(dtau_euler_azimu_b_M_) & ~isempty(dtau_euler_gamma_z_M_) ;
if  isempty(dtau_euler_polar_a_M_) |  isempty(dtau_euler_azimu_b_M_) |  isempty(dtau_euler_gamma_z_M_) ;
dtau_M3__ = zeros(n_M,n_3);
dtau_dtau_M33___ = zeros(n_M,n_3,n_3);
end;%if  isempty(dtau_euler_polar_a_M_) |  isempty(dtau_euler_azimu_b_M_) |  isempty(dtau_euler_gamma_z_M_) ;
%%%%%%%%;
dtau_ssnll_q2d_M_ = sum(dtau_ssnll_q2d_M3__.*dtau_M3__,2);
dtau_dvol_ssnll_q2d_M_ = sum(dtau_dvol_ssnll_q2d_M3__.*dtau_M3__,2);
dtau_dtau_ssnll_q2d_M_ = sum(dtau_dtau_ssnll_q2d_M33___.*dtau_dtau_ssnll_q2d_M33___,[2,3]);
dtau_ssnll_pw2_M_ = sum(dtau_ssnll_pw2_M3__.*dtau_M3__,2);
dtau_dvol_ssnll_pw2_M_ = sum(dtau_dvol_ssnll_pw2_M3__.*dtau_M3__,2);
dtau_dtau_ssnll_pw2_M_ = sum(dtau_dtau_ssnll_pw2_M33___.*dtau_dtau_ssnll_pw2_M33___,[2,3]);
fnorm_disp(flag_verbose,'dtau_ssnll_pw2_M_',dtau_ssnll_pw2_M_,'dtau_ssnll_q2d_M_',dtau_ssnll_q2d_M_);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pw2_M_',dtau_dvol_ssnll_pw2_M_,'dtau_dvol_ssnll_q2d_M_',dtau_dvol_ssnll_q2d_M_);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pw2_M_',dtau_dtau_ssnll_pw2_M_,'dtau_dtau_ssnll_q2d_M_',dtau_dtau_ssnll_q2d_M_);
%%%%%%%%;

%%%%%%%%%%%%%%%%;
end;%if flag_check;
%%%%%%%%%%%%%%%%;

