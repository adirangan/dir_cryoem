%%%%%%%%;
% Derived from test_viewing_angle_distribution_0.m and test_viewing_angle_distribution_2.m ;
% Also tries to plot figures for relion, asp, rdn, etc. ;
%%%%%%%%;
platform = 'rusty';
if (exist('platform.type','file')); fp=fopen('platform.type'); platform = fscanf(fp,'%s'); fclose(fp); end;
if (strcmp(platform,'access1')); setup_access1; string_root = 'data'; end;
if (strcmp(platform,'OptiPlex')); setup_OptiPlex; string_root = 'home'; end;
if (strcmp(platform,'eval1')); setup_eval1; string_root = 'home'; end;
if (strcmp(platform,'rusty')); setup_rusty; string_root = 'mnt/home'; end;
%%%%%%%%;
dir_base = sprintf('/%s/rangan/dir_cryoem',string_root);
flag_recalc = 0;
flag_replot = 0;
flag_replot_vol = 0;
flag_verbose = 1; nf=0;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
table_data__ = { ...
%'p28hRPT1_x0' , 'p28hRP' , 0.98 , 'emd_8674.map' , 'T1.star' ; ...
'ISWINCP_x0' , 'ISWINCP' , 1.07 , 'emd_9718.map' , 'ADPBeF.star' ; ...
'trpv1_x0' , 'trpv1' , 1.2156 , 'emd_5778.mrc' , 'tv1_relion_data.star' ; ...
'rib80s_x0' , 'rib80s' , 1.34 , 'emd_2660.mrc' , 'shiny_2sets.star' ; ...
'MlaFEDB_x0' , 'MlaFEDB' , 0.832 , 'emd_22116.map' , 'Empiar_10536_00_to_23.star' ; ...
'LetB1_x0' , 'LetB1' , 1.31 , 'emd_20993.map' , 'job_569_model_1.star' ; ...
'TMEM16F_x0' , 'TMEM16F' , 1.059 , 'emd_20244.map' , 'All_8192.star' ; ...
'LSUbl17dep_x0' , 'LSUbl17dep' , 1.31 , 'emd_8434.map' , 'Parameters_negated.star' ; ...
'ps1_x0' , 'precatalytic_spliceosome' , 1.699 , 'consensus_half1_class001.mrc' , 'consensus_data.star' ; ...
};
n_experiment = size(table_data__,1);
ampm__ = cell(n_experiment,1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
tmp_ = clock;rng(tmp_(end));
for nexperiment=(randperm(n_experiment)-1);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
na=0;
fname_prefix = table_data__{1+nexperiment,1+na}; na=na+1;
dir_nopath_data_star = table_data__{1+nexperiment,1+na}; na=na+1;
Pixel_Spacing = table_data__{1+nexperiment,1+na}; na=na+1;
fname_nopath_volume = table_data__{1+nexperiment,1+na}; na=na+1;
fname_nopath_star = table_data__{1+nexperiment,1+na}; na=na+1;
if (flag_verbose); 
disp(sprintf(' %% nexperiment %d/%d: %16s %16s %0.3f %16s %32s' ...
	     ,nexperiment,n_experiment ...
	     ,fname_prefix,dir_nopath_data_star,Pixel_Spacing,fname_nopath_volume,fname_nopath_star ...
	     ));
end;%if (flag_verbose); 
global_parameter = struct('type','parameter');
global_parameter.flag_recalc=flag_recalc;
global_parameter.flag_replot=flag_replot;
global_parameter.flag_replot_vol=flag_replot_vol;
global_parameter.flag_invert=0;
global_parameter.flag_center_image=0;
global_parameter.tolerance_master = 1e-2;
if (strcmp(dir_nopath_data_star,'LSUbl17dep')); global_parameter.flag_invert = 0; end;
if (strcmp(dir_nopath_data_star,'LSUbl17dep')); global_parameter.flag_center_image = 1; end;
if (strcmp(dir_nopath_data_star,'precatalytic_spliceosome')); global_parameter.flag_center_image = 1; end;
dir_pm = sprintf('%s/dir_%s/dir_pm',dir_base,fname_prefix);
if (flag_verbose); disp(sprintf(' %% fname_prefix: %s',fname_prefix)); end;
[~,ampm_] = ampm_fromdisk_3([],dir_pm);
ampm__{1+nexperiment} = ampm_;

tolerance_master = global_parameter.tolerance_master;
flag_recalc = global_parameter.flag_recalc;
flag_replot = global_parameter.flag_replot;
flag_replot_vol = global_parameter.flag_replot_vol;
N_k_p_use__ = ampm_.M_k_p__; if (global_parameter.flag_center_image==1); N_k_p_use__ = ampm_.N_k_p__; end;
tmp_delta_r_max = 0.030;
tmp_delta_r_upb = 0.250;
n_S = ampm_.n_S; n_M = ampm_.n_M; 
n_iteration_seco = 6;

%%%%%%%%;
% sort. ;
%%%%%%%%;
[~,ij_X_best_ampm_srt_] = sort(ampm_.X_best_ampm_ia__(end,:),'descend'); index_X_best_ampm_srt_ = ij_X_best_ampm_srt_-1;
%%%%%%%%;
% Choose the na. ;
%%%%%%%%;
na_ = index_X_best_ampm_srt_([1,2,round(numel(ij_X_best_ampm_srt_)/2),round(numel(ij_X_best_ampm_srt_)/2)+1]); %<-- take top 2 best as well as 2 near the median. ;
%na_ = index_X_best_ampm_srt_([1:4]); %<-- take top 4 best. ;
n_na = numel(na_);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
for nna=0:n_na-1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
na = na_(1+nna);
str_fname_mat = ampm_.str_fname_mat_a_{1+na};
str_fname_mat_pre = str_fname_mat(1:strfind(str_fname_mat,'.mat')-1);
str_fname_mat_inf = str_fname_mat_pre(strfind(str_fname_mat_pre,'X_2d_xcor_d0'):end);
fname_prefix_str_fname_mat_inf = sprintf('%s_%s',fname_prefix,str_fname_mat_inf);
fname_pre = sprintf('%s_viewing_angle_distribution',str_fname_mat_pre);
fname_mat = sprintf('%s.mat',fname_pre);
if ~exist(fname_mat,'file'); disp(sprintf(' %% Warning, %s not found, run test_viewing_angle_distribution_0',fname_mat)); error('stopping'); end;
tmp_ = load(fname_mat);

flag_disp = 1;
if flag_disp;
%%%%%%%%;
fname_vol_pre = sprintf('%s_vol',str_fname_mat_pre);
fname_vol_fig_pre = sprintf('%s_FIGG',fname_vol_pre);
fname_vol_fig_jpg = sprintf('%s.jpg',fname_vol_fig_pre);
if (flag_replot_vol | ~exist(fname_vol_fig_jpg,'file'));
%%%%%%%%;
test_viewing_angle_distribution_vol_helper_0; %<-- construct a_x_u_ampm_. ;
%%%%%%%%;
if strfind(ampm_.dir_pm,'p28hRPT1');   percent_threshold_ = 97.50; tmp_nx = 15; end;
if strfind(ampm_.dir_pm,'ISWINCP');    percent_threshold_ = 94.50; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'trpv1');      percent_threshold_ = 91.25; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'rib80s');     percent_threshold_ = 86.25; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'MlaFEDB');    percent_threshold_ = 95.00; tmp_nx = 8; end;
if strfind(ampm_.dir_pm,'LetB1');      percent_threshold_ = 91.75; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'TMEM16F');    percent_threshold_ = 94.50; tmp_nx = 16; end;
if strfind(ampm_.dir_pm,'LSUbl17dep'); percent_threshold_ = 86.25; tmp_nx = 15; end;
if strfind(ampm_.dir_pm,'ps1');        percent_threshold_ = 96.00; tmp_nx = 11; end;
%percent_threshold_ = 85:1.25:97.5;
n_percent_threshold = numel(percent_threshold_);
%%%%;
n_x_u_pack = ampm_.n_x_u_pack;
tmp_window_ = zeros(n_x_u_pack,n_x_u_pack,n_x_u_pack);
tmp_index_ = tmp_nx:n_x_u_pack-1-tmp_nx;
tmp_window_(1+tmp_index_,1+tmp_index_,1+tmp_index_)=1;
tmp_index_ = efind(tmp_window_);
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;
fontsize_use = 32;
if (n_percent_threshold> 1); p_row = 5; p_col = n_percent_threshold; end;
if (n_percent_threshold==1); p_row = 1; p_col = 5; end;
for npt=0:n_percent_threshold-1;
tmp_percent_threshold = percent_threshold_(1+npt); tmp_parameter = struct('type','parameter','percent_threshold_',tmp_percent_threshold); nnp=0;
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,ampm_.a_x_u_base_(1+tmp_index_));
%title(sprintf('True %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('True')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,ampm_.a_x_u_0qbp_reco_(1+tmp_index_));
%title(sprintf('Oracle %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('Oracle')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,a_x_u_reco_stab_alig_(1+tmp_index_));
%title(sprintf('OAM %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('OAM')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
if exist('a_x_u_sher_from_quad_stab_alig_','var');
isosurface_f_x_u_1(tmp_parameter,a_x_u_sher_from_quad_stab_alig_(1+tmp_index_));
end;%if exist('a_x_u_sher_from_quad_stab_alig_','var');
%title(sprintf('OBI %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('OBI')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,a_x_u_ampm_alig_(1+tmp_index_));
%title(sprintf('EMPM %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('EMPM')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
end;%for npt=0:n_percent_threshold-1;
set(gcf,'Position',1+[0,0,512*5,512+64]);
sgtitle(fname_vol_fig_pre,'Interpreter','none');
print('-djpeg',fname_vol_fig_jpg);
sgtitle(sprintf('%s',fname_prefix(1:strfind(fname_prefix,'_')-1)),'Interpreter','none','FontSize',fontsize_use+16);
tmp_dir = sprintf('/%s/rangan/dir_cryoem/dir_ampm_manuscript/dir_ampm_fig_vol',string_root);
fname_fig_jpg_strip = sprintf('%s/%s_vol_FIGG_strip.jpg',tmp_dir,fname_prefix_str_fname_mat_inf);
disp(sprintf(' %% writing %s',fname_fig_jpg_strip));
print('-djpeg',sprintf('%s',fname_fig_jpg_strip));
close gcf;
%%%%%%%%;
end;%if (flag_replot_vol | ~exist(fname_vol_fig_jpg,'file'));
end;%if flag_disp;
%%%%%%%%;

flag_disp = 1;
if flag_disp;
%%%%%%%%;
fname_vol_pre = sprintf('%s_vol',str_fname_mat_pre);
fname_vol_fig_pre = sprintf('%s_FIGH',fname_vol_pre);
fname_vol_fig_jpg = sprintf('%s.jpg',fname_vol_fig_pre);
if (flag_replot_vol | ~exist(fname_vol_fig_jpg,'file'));
%%%%%%%%;
test_viewing_angle_distribution_vol_helper_0; %<-- construct a_x_u_ampm_. ;
%%%%%%%%;
if strfind(ampm_.dir_pm,'p28hRPT1');   percent_threshold_ = 97.50; tmp_nx = 15; end;
if strfind(ampm_.dir_pm,'ISWINCP');    percent_threshold_ = 94.50; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'trpv1');      percent_threshold_ = 91.25; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'rib80s');     percent_threshold_ = 86.25; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'MlaFEDB');    percent_threshold_ = 95.00; tmp_nx = 8; end;
if strfind(ampm_.dir_pm,'LetB1');      percent_threshold_ = 91.75; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'TMEM16F');    percent_threshold_ = 94.50; tmp_nx = 16; end;
if strfind(ampm_.dir_pm,'LSUbl17dep'); percent_threshold_ = 86.25; tmp_nx = 15; end;
if strfind(ampm_.dir_pm,'ps1');        percent_threshold_ = 96.00; tmp_nx = 11; end;
n_percent_threshold = numel(percent_threshold_);
%%%%;
n_x_u_pack = ampm_.n_x_u_pack;
tmp_window_ = zeros(n_x_u_pack,n_x_u_pack,n_x_u_pack);
tmp_index_ = tmp_nx:n_x_u_pack-1-tmp_nx;
tmp_window_(1+tmp_index_,1+tmp_index_,1+tmp_index_)=1;
tmp_index_ = efind(tmp_window_);
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;
fontsize_use = 32;
p_row = 1; p_col = 5;
tmp_percent_threshold = percent_threshold_(1+0); tmp_parameter = struct('type','parameter','percent_threshold_',tmp_percent_threshold); nnp=0;
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,ampm_.a_x_u_0qbp_reco_(1+tmp_index_));
%title(sprintf('Oracle %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('Oracle')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,a_x_u_ampm_alig_(1+tmp_index_));
%title(sprintf('EMPM %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('EMPM')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
%%%%%%%%;
for str_exte_type_ = {'DRG','ASP','RDN'};
%%%%%%%%;
str_exte_type = str_exte_type_{1};
%%%%;
if strcmp(str_exte_type,'ASP'); 
dir_exte = sprintf('/%s/rangan/dir_aspire/dir_%s/dir_pm_mat',string_root,dir_nopath_data_star); 
fname_exte_mrc = sprintf('%s/example1.mrc',dir_exte); 
end;%if strcmp(str_exte_type,'ASP');
%%%%;
if strcmp(str_exte_type,'DRG'); 
dir_exte = sprintf('/%s/rangan/cryodrgn/dir_%s/dir_job_3',string_root,dir_nopath_data_star);
if ~exist(sprintf('%s/test_viewing_angle_distribution_DRG.mat',dir_exte),'file'); dir_exte = sprintf('/%s/rangan/cryodrgn/dir_%s/dir_job_0',string_root,dir_nopath_data_star); end;
if strcmp(dir_nopath_data_star,'precatalytic_spliceosome');
tmp_jindex=0; dir_exte = sprintf('/%s/rangan/cryodrgn/dir_%s/dir_job_%d',string_root,'ps1',tmp_jindex);
end;%if strcmp(dir_nopath_data_star,'precatalytic_spliceosome');
fname_exte_mrc = sprintf('%s/reconstruct.mrc',dir_exte); 
end;%if strcmp(str_exte_type,'DRG');
%%%%;
if strcmp(str_exte_type,'RDN'); 
dir_exte = sprintf('%s/dir_%s/dir_relion_mat/job_1024',dir_base,dir_nopath_data_star); 
fname_exte_mrc = sprintf('%s/run_it300_class001.mrc',dir_exte); 
end;%if strcmp(str_exte_type,'RDN');
%%%%;
fname_exte_pre = sprintf('%s/test_viewing_angle_distribution_%s',dir_exte,str_exte_type);
fname_exte_mat = sprintf('%s.mat',fname_exte_pre);
if ~exist(fname_exte_mat,'file'); disp(sprintf(' %% Warning, %s not found',fname_exte_mat)); error('stopping'); end;
tmp_exte_ = load(fname_exte_mat);
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_1(tmp_parameter,tmp_exte_.a_x_u_exte_alig_(1+tmp_index_));
title(str_exte_type); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%%%%%;
end;%for str_exte_type_ = {'ASP','RDN','relion'};
%%%%%%%%;
set(gcf,'Position',1+[0,0,512*5,512+64]);
sgtitle(fname_vol_fig_pre,'Interpreter','none');
print('-djpeg',fname_vol_fig_jpg);
sgtitle(sprintf('%s',fname_prefix(1:strfind(fname_prefix,'_')-1)),'Interpreter','none','FontSize',fontsize_use+16);
tmp_dir = sprintf('/%s/rangan/dir_cryoem/dir_ampm_manuscript/dir_ampm_fig_vol',string_root);
fname_fig_jpg_strip = sprintf('%s/%s_vol_FIGH_strip.jpg',tmp_dir,fname_prefix_str_fname_mat_inf);
disp(sprintf(' %% writing %s',fname_fig_jpg_strip));
print('-djpeg',sprintf('%s',fname_fig_jpg_strip));
close gcf;
%%%%%%%%;
end;%if (flag_replot_vol | ~exist(fname_vol_fig_jpg,'file'));
end;%if flag_disp;
%%%%%%%%;

flag_disp = 1;
if flag_disp;
%%%%%%%%;
fname_vol_pre = sprintf('%s_vol',str_fname_mat_pre);
fname_vol_fig_pre = sprintf('%s_FIGJ',fname_vol_pre);
fname_vol_fig_jpg = sprintf('%s.jpg',fname_vol_fig_pre);
if (flag_replot_vol | ~exist(fname_vol_fig_jpg,'file'));
%%%%%%%%;
test_viewing_angle_distribution_vol_helper_0; %<-- construct a_x_u_ampm_. ;
%%%%%%%%;
if strfind(ampm_.dir_pm,'p28hRPT1');   percent_threshold_ = 97.50; tmp_nx = 15; end;
if strfind(ampm_.dir_pm,'ISWINCP');    percent_threshold_ = 94.50; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'trpv1');      percent_threshold_ = 91.25; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'rib80s');     percent_threshold_ = 86.25; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'MlaFEDB');    percent_threshold_ = 95.00; tmp_nx = 8; end;
if strfind(ampm_.dir_pm,'LetB1');      percent_threshold_ = 91.75; tmp_nx = 14; end;
if strfind(ampm_.dir_pm,'TMEM16F');    percent_threshold_ = 94.50; tmp_nx = 16; end;
if strfind(ampm_.dir_pm,'LSUbl17dep'); percent_threshold_ = 86.25; tmp_nx = 15; end;
if strfind(ampm_.dir_pm,'ps1');        percent_threshold_ = 96.00; tmp_nx = 11; end;
n_percent_threshold = numel(percent_threshold_);
%%%%;
n_x_u_pack = ampm_.n_x_u_pack;
tmp_window_ = zeros(n_x_u_pack,n_x_u_pack,n_x_u_pack);
tmp_index_ = tmp_nx:n_x_u_pack-1-tmp_nx;
tmp_window_(1+tmp_index_,1+tmp_index_,1+tmp_index_)=1;
tmp_index_ = efind(tmp_window_);
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;
fontsize_use = 32;
p_row = 1; p_col = 5;
tmp_percent_threshold = percent_threshold_(1+0); tmp_parameter = struct('type','parameter','percent_threshold_',tmp_percent_threshold); nnp=0;
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_0(ampm_.a_x_u_0qbp_reco_(1+tmp_index_),tmp_percent_threshold);
%title(sprintf('Oracle %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('Oracle')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_0(a_x_u_ampm_alig_(1+tmp_index_),tmp_percent_threshold);
%title(sprintf('EMPM %.3f',tmp_percent_threshold)); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
title(sprintf('EMPM')); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%;
%%%%%%%%;
for str_exte_type_ = {'DRG','ASP','RDN'};
%%%%%%%%;
str_exte_type = str_exte_type_{1};
%%%%;
if strcmp(str_exte_type,'ASP'); 
dir_exte = sprintf('/%s/rangan/dir_aspire/dir_%s/dir_pm_mat',string_root,dir_nopath_data_star); 
fname_exte_mrc = sprintf('%s/example1.mrc',dir_exte); 
end;%if strcmp(str_exte_type,'ASP');
%%%%;
if strcmp(str_exte_type,'DRG'); 
dir_exte = sprintf('/%s/rangan/cryodrgn/dir_%s/dir_job_3',string_root,dir_nopath_data_star);
if ~exist(sprintf('%s/test_viewing_angle_distribution_DRG.mat',dir_exte),'file'); dir_exte = sprintf('/%s/rangan/cryodrgn/dir_%s/dir_job_0',string_root,dir_nopath_data_star); end;
if strcmp(dir_nopath_data_star,'precatalytic_spliceosome');
tmp_jindex=0; dir_exte = sprintf('/%s/rangan/cryodrgn/dir_%s/dir_job_%d',string_root,'ps1',tmp_jindex);
end;%if strcmp(dir_nopath_data_star,'precatalytic_spliceosome');
fname_exte_mrc = sprintf('%s/reconstruct.mrc',dir_exte); 
end;%if strcmp(str_exte_type,'DRG');
%%%%;
if strcmp(str_exte_type,'RDN'); 
dir_exte = sprintf('%s/dir_%s/dir_relion_mat/job_1024',dir_base,dir_nopath_data_star); 
fname_exte_mrc = sprintf('%s/run_it300_class001.mrc',dir_exte); 
end;%if strcmp(str_exte_type,'RDN');
%%%%;
fname_exte_pre = sprintf('%s/test_viewing_angle_distribution_%s',dir_exte,str_exte_type);
fname_exte_mat = sprintf('%s.mat',fname_exte_pre);
if ~exist(fname_exte_mat,'file'); disp(sprintf(' %% Warning, %s not found',fname_exte_mat)); error('stopping'); end;
tmp_exte_ = load(fname_exte_mat);
subplot(p_row,p_col,1+npt+nnp*n_percent_threshold);nnp=nnp+1;
isosurface_f_x_u_0(tmp_exte_.a_x_u_exte_alig_(1+tmp_index_),tmp_percent_threshold);
title(str_exte_type); xlabel('');ylabel('');zlabel(''); set(gca,'FontSize',fontsize_use);
%%%%%%%%;
end;%for str_exte_type_ = {'ASP','RDN','relion'};
%%%%%%%%;
set(gcf,'Position',1+[0,0,512*5,512+64]);
sgtitle(fname_vol_fig_pre,'Interpreter','none');
print('-djpeg',fname_vol_fig_jpg);
sgtitle(sprintf('%s',fname_prefix(1:strfind(fname_prefix,'_')-1)),'Interpreter','none','FontSize',fontsize_use+16);
tmp_dir = sprintf('/%s/rangan/dir_cryoem/dir_ampm_manuscript/dir_ampm_fig_vol',string_root);
fname_fig_jpg_strip = sprintf('%s/%s_vol_FIGJ_strip.jpg',tmp_dir,fname_prefix_str_fname_mat_inf);
disp(sprintf(' %% writing %s',fname_fig_jpg_strip));
print('-djpeg',sprintf('%s',fname_fig_jpg_strip));
close gcf;
%%%%%%%%;
end;%if (flag_replot_vol | ~exist(fname_vol_fig_jpg,'file'));
end;%if flag_disp;
%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%for nna=0:n_na-1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%for nexperiment=0:n_experiment-1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;





