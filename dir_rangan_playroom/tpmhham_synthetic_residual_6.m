syn_infix = str_combine;
syn_n_order = 5;
syn_n_M = 1024*2;
syn_n_UX_rank = 4;
syn_n_iteration = 32;
syn_rseed_ = [0:1]; n_syn_rseed = numel(syn_rseed_);
syn_snr_ = [0 , 2.^[-1:-0.5:-5]]; n_syn_snr=numel(syn_snr_);
nsyn_rseed = 0; nsyn_snr = 5;
syn_rseed = syn_rseed_(1+nsyn_rseed);
syn_snr = syn_snr_(1+nsyn_snr);
%%%%%%%%;
n_lm_ = (l_max_+1).^2;
n_lm_max = max(n_lm_);
n_lm_sum = sum(n_lm_);
n_lm_csum_ = cumsum([0;n_lm_]);
l_max_max = max(l_max_); dWtdkd__l_max_max = 2*l_max_max;
m_max_ = -l_max_max : +l_max_max;
n_m_max = length(m_max_);
molecule_density_ = molecule_density_/sum(molecule_density_);
%%%%%%%%;
fname_mat = sprintf('%s_mat/tpmhham_synthetic_6_UX_%s_M_k_p___n%.3ds%.4dr%.3d.mat',dir_trunk,syn_infix,syn_n_M,floor(1000*syn_snr),syn_n_UX_rank);
if (~exist(fname_mat,'file')); disp(sprintf(' %% %s not found',fname_mat)); end;
if ( exist(fname_mat,'file')); disp(sprintf(' %% %s found',fname_mat)); load(fname_mat); end;
nUX_rank = 1;
fname_pre = sprintf('%s_mat/tpmhham_synthetic_6_UX_%s_Y_n%.3ds%.4dr%.3d_allshell_SM_rng%.3dnUX%.3d',dir_trunk,syn_infix,syn_n_M,floor(1000*syn_snr),syn_n_UX_rank,syn_rseed,nUX_rank);
fname_mat = sprintf('%s.mat',fname_pre);
if (~exist(fname_mat,'file')); disp(sprintf(' %% %s not found',fname_mat)); end;
if ( exist(fname_mat,'file')); disp(sprintf(' %% %s found',fname_mat)); tmp_ = load(fname_mat); end;
disp(sprintf(' %% syn_X_best_allshell_SM_: %0.3f',tmp_.syn_X_best_allshell_SM_(end)));

%%%%%%%%;
% Solve full lsq with estimated viewing angles and original images. ;
%%%%%%%%;
a_k_Y_quad_mavg_ = zeros(n_lm_sum,1);
for nmolecule=0:n_molecule-1;
a_k_Y_quad_mavg_ = a_k_Y_quad_mavg_ + molecule_density_(1+nmolecule)*a_k_Y_quad__(:,1+nmolecule);
end;%for nmolecule=0:n_molecule-1;
%%%%%%%%;
tmp_n_order = 5; tmp_n_M = syn_n_M;
tmp_euler_polar_a_ = tmp_.euler_polar_a_SM__(:,end);
tmp_euler_azimu_b_ = tmp_.euler_azimu_b_SM__(:,end);
tmp_euler_gamma_z_ = tmp_.euler_gamma_z_SM__(:,end);
%%%%%%%%;
tmp_t = tic;
syn_c_k_Y_reco_ = cg_lsq_3(tmp_n_order,n_k_p_r,l_max_,n_w_,tmp_n_M,syn_M_k_p__,1,[],tmp_euler_polar_a_,tmp_euler_azimu_b_,tmp_euler_gamma_z_);
tmp_t = toc(tmp_t); disp(sprintf(' %% M_k_p__ --> syn_c_k_Y_reco_ time %0.2fs',tmp_t));
[tmp_X_best_orig,~,~,~,~,~,~] = register_spharm_to_spharm_wigner_0(n_k_p_r,k_p_r_,k_p_r_max,weight_k_p_r_,0,l_max_,a_k_Y_quad_mavg_,syn_c_k_Y_reco_);
[tmp_X_best_flip,~,~,~,~,~,~] = register_spharm_to_spharm_wigner_0(n_k_p_r,k_p_r_,k_p_r_max,weight_k_p_r_,0,l_max_,a_k_Y_quad_mavg_,flipY(n_k_p_r,l_max_,syn_c_k_Y_reco_));
X_best_reco = max(tmp_X_best_orig,tmp_X_best_flip);
disp(sprintf(' %% X_best_reco %0.3f',X_best_reco));
%%%%%%%%;
tmp_t = tic;
[syn_c_k_p_reco_] = convert_spharm_to_k_p_1(verbose,n_k_all,n_k_all_csum_,k_p_r_all_,k_p_azimu_b_all_,k_p_polar_a_all_,weight_k_all_,weight_shell_k_,n_k_p_r,k_p_r_,weight_k_p_r_,l_max_,syn_c_k_Y_reco_);
tmp_t = toc(tmp_t); disp(sprintf(' %% syn_c_k_Y_reco_ --> syn_c_k_p_reco_ time %0.2fs',tmp_t));
%%%%%%%%;
tmp_t = tic;
eta = pi/k_p_r_max; 
syn_c_x_u_reco_ = nufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,syn_c_k_p_reco_.*(2*pi)^3.*weight_k_all_,+1,1e-12,n_X_u,X_u_0_(:)/eta,X_u_1_(:)/eta,X_u_2_(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% nufft3d3: syn_c_x_u_reco_ time %0.2fs',tmp_t));
%%%%%%%%;
fname_fig = sprintf('%s_jpg/tpmhham_synthetic_6_manual_FIGD',dir_trunk);
if (~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
clf;
isosurface_f_x_u_0(reshape(real(syn_c_x_u_reco_),x_u_res,x_u_res,x_u_res),[99]);
title('syn_c_x_u_','Interpreter','none');
figbig;
disp(sprintf(' %% writing %s',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
%%%%%%%%;

%%%%%%%%;
% Solve lsq with estimated viewing angles. ;
%%%%%%%%;
tmp_n_k_p_r = 1+nUX_rank;
tmp_k_p_r_ = ones(1+nUX_rank,1); tmp_k_p_r_max = 1;
tmp_n_w_ = n_w_max*ones(1+nUX_rank,1); tmp_n_w_max = max(tmp_n_w_); tmp_n_w_sum = sum(tmp_n_w_); 
tmp_weight_k_p_r_ = ones(1+nUX_rank,1); tmp_weight_2d_k_p_r_ = ones(1+nUX_rank,1);
tmp_l_max_ = l_max_max*ones(1+nUX_rank,1);
tmp_n_lm_ = (1+tmp_l_max_).^2; tmp_n_lm_sum = sum(tmp_n_lm_);
tmp_a_k_Y_quad_mavg_ = reshape(a_UX_Y_quad_mavg__(:,1+(0:nUX_rank)),[tmp_n_lm_sum,1]); %<-- use as ground truth for this set of principled-image-rings. ;
tmp_M_k_p__ = reshape(permute(syn_UX_M_k_p___(:,:,1+(0:nUX_rank)),[1,3,2]),[tmp_n_w_sum,syn_n_M]);
tmp_M_k_q__ = reshape(permute(syn_UX_M_k_q___(:,:,1+(0:nUX_rank)),[1,3,2]),[tmp_n_w_sum,syn_n_M]);
%%%%%%%%;
tmp_euler_polar_a_ = tmp_.euler_polar_a_SM__(:,end);
tmp_euler_azimu_b_ = tmp_.euler_azimu_b_SM__(:,end);
tmp_euler_gamma_z_ = tmp_.euler_gamma_z_SM__(:,end);
tmp_t = tic();
syn_a_k_Y_0lsq_ = cg_lsq_3(syn_n_order,tmp_n_k_p_r,tmp_l_max_,tmp_n_w_,syn_n_M,tmp_M_k_p__,1,ones(tmp_n_w_sum,1),tmp_euler_polar_a_,tmp_euler_azimu_b_,tmp_euler_gamma_z_);
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% syn_a_k_Y_0lsq_: %0.3fs',tmp_t)); end;
%%%%%%%%;
% check correlation with ground truth. ;
%%%%%%%%;
tmp_t = tic();
[tmp_X_best_orig,~,~,~,~,~,~] = register_spharm_to_spharm_wigner_0(tmp_n_k_p_r,tmp_k_p_r_,tmp_k_p_r_max,tmp_weight_k_p_r_,0,tmp_l_max_,tmp_a_k_Y_quad_mavg_,syn_a_k_Y_0lsq_);
[tmp_X_best_flip,~,~,~,~,~,~] = register_spharm_to_spharm_wigner_0(tmp_n_k_p_r,tmp_k_p_r_,tmp_k_p_r_max,tmp_weight_k_p_r_,0,tmp_l_max_,tmp_a_k_Y_quad_mavg_,flipY(tmp_n_k_p_r,tmp_l_max_,syn_a_k_Y_0lsq_));
tmp_X_best = max(real(tmp_X_best_orig),real(tmp_X_best_flip));
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% register_spharm_to_spharm_wigner_0: %0.3fs',tmp_t)); end;
disp(sprintf(' %% tmp_a_k_Y_quad_mavg_ vs syn_a_k_Y_lsq0_: correlation %+0.6f',tmp_X_best));
tmp_n_residual_loading = 3; tmp_n_residual_iteration = 32;

%%%%%%%%;
% now try to run get_loading_0bp to calculate loadings. ;
%%%%%%%%;
tmp_M_loading_0bp__ = get_loading_0bp(tmp_n_residual_loading,tmp_n_residual_iteration,syn_n_order,tmp_n_k_p_r,tmp_weight_k_p_r_,tmp_l_max_,tmp_n_w_,syn_n_M,tmp_M_k_p__,tmp_euler_polar_a_,tmp_euler_azimu_b_,tmp_euler_gamma_z_);
flag_plot=1;
if flag_plot;
fname_fig = sprintf('%s_jpg/tpmhham_synthetic_6_manual_FIGE',dir_trunk);
if (~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
clf;
c_ = colormap_beach(); n_c = size(c_,1);
nc_ = max(0,min(n_c-1,floor(n_c*syn_M_molecule_type_/n_molecule)));
if (0 & tmp_n_residual_loading==3);
scatter3(tmp_M_loading_0bp__(1,:),tmp_M_loading_0bp__(2,:),tmp_M_loading_0bp__(3,:),15,c_(1+nc_,:),'filled','MarkerEdgeColor','k'); 
axisnotick; axis vis3d; 
end;%if tmp_n_residual_loading==3;
if (1  | tmp_n_residual_loading==2);
scatter(tmp_M_loading_0bp__(1,:),tmp_M_loading_0bp__(2,:),64,c_(1+nc_,:),'filled','MarkerEdgeColor','k'); 
axisnotick;
end;%if tmp_n_residual_loading==2;
figbig;
disp(sprintf(' %% writing %s',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
end;%if flag_plot;
%%%%%%%%;
% now try to run get_loading_lsq to calculate loadings. ;
%%%%%%%%;
tmp_M_loading_lsq__ = get_loading_lsq(tmp_n_residual_loading,tmp_n_residual_iteration,syn_n_order,tmp_n_k_p_r,tmp_weight_k_p_r_,tmp_weight_2d_k_p_r_,tmp_l_max_,tmp_n_w_,syn_n_M,tmp_M_k_p__,tmp_euler_polar_a_,tmp_euler_azimu_b_,tmp_euler_gamma_z_,tmp_.syn_M_molecule_type_);
flag_plot=1;
if flag_plot;
fname_fig = sprintf('%s_jpg/tpmhham_synthetic_6_manual_FIGG',dir_trunk);
if (~exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s not found, creating',fname_fig));
clf;
c_ = colormap_beach(); n_c = size(c_,1);
nc_ = max(0,min(n_c-1,floor(n_c*syn_M_molecule_type_/n_molecule)));
if (0 & tmp_n_residual_loading==3);
scatter3(tmp_M_loading_lsq__(1,:),tmp_M_loading_lsq__(2,:),tmp_M_loading_lsq__(3,:),15,c_(1+nc_,:),'filled','MarkerEdgeColor','k'); 
axisnotick; axis vis3d; 
end;%if tmp_n_residual_loading==3;
if (1  | tmp_n_residual_loading==2);
scatter(tmp_M_loading_lsq__(1,:),tmp_M_loading_lsq__(2,:),64,c_(1+nc_,:),'filled','MarkerEdgeColor','k'); 
axisnotick;
end;%if tmp_n_residual_loading==2;
figbig;
disp(sprintf(' %% writing %s',fname_fig));
print('-djpeg',sprintf('%s.jpg',fname_fig));
print('-depsc',sprintf('%s.eps',fname_fig));
end;%if (~exist(sprintf('%s.jpg',fname_fig),'file'));
if ( exist(sprintf('%s.jpg',fname_fig),'file'));
disp(sprintf(' %% %s found, not creating',fname_fig));
end;%if ( exist(sprintf('%s.jpg',fname_fig),'file'));
end;%if flag_plot;
