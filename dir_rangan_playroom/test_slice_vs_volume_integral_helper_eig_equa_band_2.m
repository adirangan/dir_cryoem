%%%%%%%%;
% Warning, double check to see if KAPPA needs to be updated if the viewing-angles change. ;
%%%%%%%%;

n_3 = 3;
if ~exist('KAPPA','var'); KAPPA=[]; end;
if ~exist('Ylm_uklma___','var'); Ylm_uklma___=[]; end;
if ~exist('k_p_azimu_b_sub_uka__','var'); k_p_azimu_b_sub_uka__=[]; end;
if ~exist('k_p_polar_a_sub_uka__','var'); k_p_polar_a_sub_uka__=[]; end;
if ~exist('l_max_uk_','var'); l_max_uk_=[]; end;
if ~exist('index_nu_n_k_per_shell_from_nk_p_r_','var'); index_nu_n_k_per_shell_from_nk_p_r_=[]; end;
if ~exist('index_k_per_shell_uka__','var'); index_k_per_shell_uka__=[]; end;
if ~exist('V_lmm___','var'); V_lmm___=[]; end;
if ~exist('L_lm__','var'); L_lm__=[]; end;
if ~exist('d0W_betazeta_mlma____','var'); d0W_betazeta_mlma____=[]; end;
if ~exist('d1W_betazeta_mlma____','var'); d1W_betazeta_mlma____=[]; end;
if ~exist('d2W_betazeta_mlma____','var'); d2W_betazeta_mlma____=[]; end;

%%%%%%%%;
% a_original_qbp_k_Y_yk_. ;
% Note that the templates may have been generated on a tensor grid. ;
% in which case the template-distribution will not be uniform. ;
%%%%%%%%;
parameter_KAPPA = struct('type','parameter');
parameter_KAPPA.flag_verbose = flag_verbose;
parameter_KAPPA.flag_check = 0;
parameter_KAPPA.flag_disp = 0;
parameter_KAPPA.flag_kernel_qpro_d0 = 1;
parameter_KAPPA.flag_kernel_qpro_d1 = 1;
parameter_KAPPA.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_KAPPA.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_KAPPA.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_KAPPA.kernel_qpro_l_max_use = l_max;
if ~exist('KAPPA','var'); KAPPA=[]; end;
viewing_gamma_z_S_ = zeros(n_S,1);
[ ...
 parameter_KAPPA ...
,KAPPA ...
,a_original_C2M0_k_Y_yk__ ...
,a_original_C1M1_k_Y_yk__ ...
,a_original_C0M2_k_Y_yk__ ...
] = ...
kappa_qpro_apply_2( ...
 parameter_KAPPA ...
,KAPPA ...
,n_w_max ...
,n_S ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,S_k_p_wkS__ ...
,[] ...
,[] ...
,[] ...
);
%%%%%%%%;
tmp_t = tic;
[ ...
 a_original_C2M0_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_original_C2M0_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_original_C2M0_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
tmp_t = tic;
[ ...
 a_original_C1M1_k_p_reco_ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_original_C1M1_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_original_C1M1_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
a_original_qbp_k_p_reco_ = a_original_C1M1_k_p_reco_./max(1e-12,abs(a_original_C2M0_k_p_reco_));
tmp_t = tic();
a_original_qbp_k_Y_yk_ = ...
convert_k_p_to_spharm_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_original_qbp_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_original_qbp_k_Y_yk_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_original_qbp_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_original_qbp_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_original_qbp_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_original_C2M0_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_original_C2M0_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_original_C2M0_x_u_reco_ time %0.2fs',tmp_t));
%%%%%%%%;
[ ...
 ~ ...
,ssnll_original_qbp_M_ ...
,ssnll_original_qbp ...
] = ...
ssnll_from_a_k_Y_12( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_original_qbp_k_Y_yk_ ... %,a_k_Y_quad_yk_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_S ...
,S_k_p_wkS__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
,[] ...
,[] ...
,[] ...
);
%%%%%%%%;

%%%%%%%%;
% Now construct equa_band. ;
%%%%%%%%;
n_synth_M = 1024;
equa_band_width = 0*pi/8;
euler_polar_a_synth_M_ = (pi/2)*ones(n_synth_M,1) + equa_band_width*0.5*(2*rand(n_synth_M,1)-1);
euler_azimu_b_synth_M_ = linspace(0,2*pi,n_synth_M+1); euler_azimu_b_synth_M_ = transpose(euler_azimu_b_synth_M_(1:n_synth_M));
[euler_polar_a_synth_M_,euler_azimu_b_synth_M_] = periodize_polar_a_azimu_b_0(euler_polar_a_synth_M_,euler_azimu_b_synth_M_);
tmp_index_nS_from_nM_ = ...
knnsearch( ...
 [hist2dab_polar_a_S_,hist2dab_azimu_b_S_] ...
,[euler_polar_a_synth_M_,euler_azimu_b_synth_M_] ...
,'K',1)-1;
M_synth_k_p_wkM__ = hist2dab_S_k_p_wkS__(:,1+tmp_index_nS_from_nM_);
euler_polar_a_synth_M_ = hist2dab_polar_a_S_(1+tmp_index_nS_from_nM_);
euler_azimu_b_synth_M_ = hist2dab_azimu_b_S_(1+tmp_index_nS_from_nM_);
euler_gamma_z_synth_M_ = zeros(n_synth_M,1);
%%%%%%%%;
% a_equaband_qbp_k_Y_yk_. ;
%%%%%%%%;
parameter_KAPPA = struct('type','parameter');
parameter_KAPPA.flag_verbose = flag_verbose;
parameter_KAPPA.flag_check = 0;
parameter_KAPPA.flag_disp = 0;
parameter_KAPPA.flag_kernel_qpro_d0 = 1;
parameter_KAPPA.flag_kernel_qpro_d1 = 1;
parameter_KAPPA.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_KAPPA.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_KAPPA.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_KAPPA.kernel_qpro_l_max_use = l_max;
if ~exist('KAPPA','var'); KAPPA=[]; end;
[ ...
 parameter_KAPPA ...
,KAPPA ...
,a_equaband_C2M0_k_Y_yk__ ...
,a_equaband_C1M1_k_Y_yk__ ...
,a_equaband_C0M2_k_Y_yk__ ...
] = ...
kappa_qpro_apply_2( ...
 parameter_KAPPA ...
,KAPPA ...
,n_w_max ...
,n_synth_M ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
);
%%%%%%%%;
if ~exist('Ylm_uklma___','var'); Ylm_uklma___=[]; end;
if ~exist('k_p_azimu_b_sub_uka__','var'); k_p_azimu_b_sub_uka__=[]; end;
if ~exist('k_p_polar_a_sub_uka__','var'); k_p_polar_a_sub_uka__=[]; end;
if ~exist('l_max_uk_','var'); l_max_uk_=[]; end;
if ~exist('index_nu_n_k_per_shell_from_nk_p_r_','var'); index_nu_n_k_per_shell_from_nk_p_r_=[]; end;
if ~exist('index_k_per_shell_uka__','var'); index_k_per_shell_uka__=[]; end;
tmp_t = tic;
[ ...
 a_equaband_C2M0_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_equaband_C2M0_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equaband_C2M0_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
tmp_t = tic;
[ ...
 a_equaband_C1M1_k_p_reco_ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_equaband_C1M1_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equaband_C1M1_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
a_equaband_qbp_k_p_reco_ = a_equaband_C1M1_k_p_reco_./max(1e-12,abs(a_equaband_C2M0_k_p_reco_));
tmp_t = tic();
a_equaband_qbp_k_Y_yk_ = ...
convert_k_p_to_spharm_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_equaband_qbp_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equaband_qbp_k_Y_yk_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_equaband_qbp_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_equaband_qbp_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_equaband_qbp_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_equaband_C2M0_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_equaband_C2M0_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_equaband_C2M0_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
[ ...
 ~ ...
,ssnll_equaband_qbp_M_ ...
,ssnll_equaband_qbp ...
] = ...
ssnll_from_a_k_Y_12( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equaband_qbp_k_Y_yk_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,[] ...
,[] ...
,[] ...
);
%%%%%%%%;

%%%%%%%%;
% a_equappos_qbp_k_Y_yk_. ;
% a_equapneg_qbp_k_Y_yk_. ;
%%%%%%%%;
dtau = 1e-2;
tmp_delta_azimu_b = @(azimu_b) sin(azimu_b);
equappos_euler_azimu_b_synth_M_ = euler_azimu_b_synth_M_ + dtau*tmp_delta_azimu_b(euler_azimu_b_synth_M_);
equapneg_euler_azimu_b_synth_M_ = euler_azimu_b_synth_M_ - dtau*tmp_delta_azimu_b(euler_azimu_b_synth_M_);
%%%%%%%%;
parameter_KAPPA = struct('type','parameter');
parameter_KAPPA.flag_verbose = flag_verbose;
parameter_KAPPA.flag_check = 0;
parameter_KAPPA.flag_disp = 0;
parameter_KAPPA.flag_kernel_qpro_d0 = 1;
parameter_KAPPA.flag_kernel_qpro_d1 = 1;
parameter_KAPPA.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_KAPPA.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_KAPPA.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_KAPPA.kernel_qpro_l_max_use = l_max;
if ~exist('KAPPA','var'); KAPPA=[]; end;
[ ...
 parameter_KAPPA ...
,KAPPA ...
,a_equappos_C2M0_k_Y_yk__ ...
,a_equappos_C1M1_k_Y_yk__ ...
,a_equappos_C0M2_k_Y_yk__ ...
] = ...
kappa_qpro_apply_2( ...
 parameter_KAPPA ...
,KAPPA ...
,n_w_max ...
,n_synth_M ...
,euler_polar_a_synth_M_ ...
,equappos_euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
);
%%%%;
if ~exist('Ylm_uklma___','var'); Ylm_uklma___=[]; end;
if ~exist('k_p_azimu_b_sub_uka__','var'); k_p_azimu_b_sub_uka__=[]; end;
if ~exist('k_p_polar_a_sub_uka__','var'); k_p_polar_a_sub_uka__=[]; end;
if ~exist('l_max_uk_','var'); l_max_uk_=[]; end;
if ~exist('index_nu_n_k_per_shell_from_nk_p_r_','var'); index_nu_n_k_per_shell_from_nk_p_r_=[]; end;
if ~exist('index_k_per_shell_uka__','var'); index_k_per_shell_uka__=[]; end;
tmp_t = tic;
[ ...
 a_equappos_C2M0_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_equappos_C2M0_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equappos_C2M0_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
tmp_t = tic;
[ ...
 a_equappos_C1M1_k_p_reco_ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_equappos_C1M1_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equappos_C1M1_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
a_equappos_qbp_k_p_reco_ = a_equappos_C1M1_k_p_reco_./max(1e-12,abs(a_equappos_C2M0_k_p_reco_));
tmp_t = tic();
a_equappos_qbp_k_Y_yk_ = ...
convert_k_p_to_spharm_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_equappos_qbp_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equappos_qbp_k_Y_yk_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_equappos_qbp_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_equappos_qbp_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_equappos_qbp_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_equappos_C2M0_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_equappos_C2M0_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_equappos_C2M0_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
[ ...
 ~ ...
,ssnll_equappos_qbp_M_ ...
,ssnll_equappos_qbp ...
] = ...
ssnll_from_a_k_Y_12( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equappos_qbp_k_Y_yk_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,equappos_euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,[] ...
,[] ...
,[] ...
);
%%%%%%%%;
parameter_KAPPA = struct('type','parameter');
parameter_KAPPA.flag_verbose = flag_verbose;
parameter_KAPPA.flag_check = 0;
parameter_KAPPA.flag_disp = 0;
parameter_KAPPA.flag_kernel_qpro_d0 = 1;
parameter_KAPPA.flag_kernel_qpro_d1 = 1;
parameter_KAPPA.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_KAPPA.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_KAPPA.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_KAPPA.kernel_qpro_l_max_use = l_max;
if ~exist('KAPPA','var'); KAPPA=[]; end;
[ ...
 parameter_KAPPA ...
,KAPPA ...
,a_equapneg_C2M0_k_Y_yk__ ...
,a_equapneg_C1M1_k_Y_yk__ ...
,a_equapneg_C0M2_k_Y_yk__ ...
] = ...
kappa_qpro_apply_2( ...
 parameter_KAPPA ...
,KAPPA ...
,n_w_max ...
,n_synth_M ...
,euler_polar_a_synth_M_ ...
,equapneg_euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
);
%%%%;
if ~exist('Ylm_uklma___','var'); Ylm_uklma___=[]; end;
if ~exist('k_p_azimu_b_sub_uka__','var'); k_p_azimu_b_sub_uka__=[]; end;
if ~exist('k_p_polar_a_sub_uka__','var'); k_p_polar_a_sub_uka__=[]; end;
if ~exist('l_max_uk_','var'); l_max_uk_=[]; end;
if ~exist('index_nu_n_k_per_shell_from_nk_p_r_','var'); index_nu_n_k_per_shell_from_nk_p_r_=[]; end;
if ~exist('index_k_per_shell_uka__','var'); index_k_per_shell_uka__=[]; end;
tmp_t = tic;
[ ...
 a_equapneg_C2M0_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_equapneg_C2M0_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equapneg_C2M0_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
tmp_t = tic;
[ ...
 a_equapneg_C1M1_k_p_reco_ ...
] = ...
convert_spharm_to_k_p_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,local_yk_from_yk__(n_k_p_r,l_max_,a_equapneg_C1M1_k_Y_yk__) ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equapneg_C1M1_k_p_reco_ time %0.2fs',tmp_t));
%%%%;
a_equapneg_qbp_k_p_reco_ = a_equapneg_C1M1_k_p_reco_./max(1e-12,abs(a_equapneg_C2M0_k_p_reco_));
tmp_t = tic();
a_equapneg_qbp_k_Y_yk_ = ...
convert_k_p_to_spharm_4( ...
 0*flag_verbose ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_equapneg_qbp_k_p_reco_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
tmp_t = toc(tmp_t); disp(sprintf(' %% a_equapneg_qbp_k_Y_yk_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_equapneg_qbp_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_equapneg_qbp_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_equapneg_qbp_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
eta = pi/k_p_r_max; tmp_t = tic;
a_equapneg_C2M0_x_u_reco_ = xxnufft3d3(n_k_all,2*pi*k_c_0_all_*eta,2*pi*k_c_1_all_*eta,2*pi*k_c_2_all_*eta,a_equapneg_C2M0_k_p_reco_.*(2*pi)^3.*weight_3d_k_all_,+1,1e-12,n_xxx_u,x_u_0___(:)/eta,x_u_1___(:)/eta,x_u_2___(:)/eta)/sqrt(2*pi)/sqrt(2*pi)/sqrt(2*pi);
tmp_t = toc(tmp_t); disp(sprintf(' %% xxnufft3d3: a_equapneg_C2M0_x_u_reco_ time %0.2fs',tmp_t));
%%%%;
[ ...
 ~ ...
,ssnll_equapneg_qbp_M_ ...
,ssnll_equapneg_qbp ...
] = ...
ssnll_from_a_k_Y_12( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equapneg_qbp_k_Y_yk_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,equapneg_euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,[] ...
,[] ...
,[] ...
);

%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figmed;
markersize_use = 12;
subplot(1,2,1);
hold on;
plot(ssnll_equaband_qbp_M_,ssnll_equappos_qbp_M_,'ko','MarkerFaceColor','m','MarkerSize',markersize_use);
plot(ssnll_equaband_qbp_M_,ssnll_equapneg_qbp_M_,'ko','MarkerFaceColor','c','MarkerSize',markersize_use);
hold off;
xlabel('ssnll_equaband_qbp_M_','Interpreter','none');
ylabel('ssnll_equapxxx_qbp_M_','Interpreter','none');
legend({'pos','neg'},'Location','NorthWest');
subplot(1,2,2);
hold on;
plot(ssnll_equaband_qbp_M_,(ssnll_equappos_qbp_M_ - ssnll_equaband_qbp_M_)/max(1e-12,dtau),'ko','MarkerFaceColor','m','MarkerSize',markersize_use);
plot(ssnll_equaband_qbp_M_,(ssnll_equapneg_qbp_M_ - ssnll_equaband_qbp_M_)/max(1e-12,dtau),'ko','MarkerFaceColor','c','MarkerSize',markersize_use);
hold off;
xlabel('ssnll_equappos_qbp_M_','Interpreter','none');
ylabel('diff','Interpreter','none');
legend({'pos','neg'},'Location','NorthWest');
%%%%%%%%;

%%%%%%%%;
% illustrate information density in k_p_. ;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;
p_row = 4; p_col = 4; np=0;
for ntype=0:4-1;
if ntype==0; tmp_k_p_ = a_original_C2M0_k_p_reco_; tmp_str = 'original'; end;
if ntype==1; tmp_k_p_ = a_equaband_C2M0_k_p_reco_; tmp_str = 'equaband'; end;
if ntype==2; tmp_k_p_ = a_equappos_C2M0_k_p_reco_; tmp_str = 'equappos'; end;
if ntype==3; tmp_k_p_ = a_equapneg_C2M0_k_p_reco_; tmp_str = 'equapneg'; end;
tmp_abs_k_p_ = abs(tmp_k_p_).*sqrt(weight_3d_riesz_k_all_);
flag_2d_vs_3d = 0; c_use__ = colormap_81s;
for nk_p_r = floor(linspace(2,n_k_p_r-2,p_col));
tmp_index_ = n_k_all_csum_(1+nk_p_r+0):n_k_all_csum_(1+nk_p_r+1)-1;
lim_ = prctile(tmp_abs_k_p_(1+tmp_index_),[ 5,95]);
subplot(p_row,p_col,1+np);np=np+1;
imagesc_polar_a_azimu_b_0( ...
 k_p_polar_a_all_(1+tmp_index_) ...
,k_p_azimu_b_all_(1+tmp_index_) ...
,tmp_abs_k_p_(1+tmp_index_) ... 
,lim_ ... 
,c_use__ ... 
,flag_2d_vs_3d ...
,k_p_r_max ...
);
axis equal; axis vis3d; axisnotick3d;
title(sprintf('nk_p_r %.2d, [%+0.6f,%+0.6f]',nk_p_r,lim_),'Interpreter','none');
end;%for nk_p_r = floor(linspace(2,n_k_p_r-2,p_col));
end;%for ntype=0:3-1;

%%%%%%%%;
% illustrate information density in x_u_. ;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;
p_row = 4; p_col = 4; np=0;
for ntype=0:4-1;
if ntype==0; tmp_x_u_ = a_original_C2M0_x_u_reco_; tmp_str = 'original'; end;
if ntype==1; tmp_x_u_ = a_equaband_C2M0_x_u_reco_; tmp_str = 'equaband'; end;
if ntype==2; tmp_x_u_ = a_equappos_C2M0_x_u_reco_; tmp_str = 'equappos'; end;
if ntype==3; tmp_x_u_ = a_equapneg_C2M0_x_u_reco_; tmp_str = 'equapneg'; end;
tmp_x_u___  = reshape(tmp_x_u_,[n_x_u_pack,n_x_u_pack,n_x_u_pack]);
subplot(p_row,p_col,1+np);np=np+1;
isosurface_f_x_u_1([],tmp_x_u_);
title(sprintf('%s 98.5%%',tmp_str));
subplot(p_row,p_col,1+np);np=np+1;
imagesc(squeeze(abs(tmp_x_u___(:,:,end/2)))); colorbar; axis image;
title(sprintf('%s slice: (0,1)',tmp_str));
subplot(p_row,p_col,1+np);np=np+1;
imagesc(squeeze(abs(tmp_x_u___(:,end/2,:)))); colorbar; axis image;
title(sprintf('%s slice: (0,2)',tmp_str));
subplot(p_row,p_col,1+np);np=np+1;
imagesc(squeeze(abs(tmp_x_u___(end/2,:,:)))); colorbar; axis image;
title(sprintf('%s slice: (1,2)',tmp_str));
end;%for ntype=0:3-1;

%%%%%%%%;
% Now extract perturbation. ;
%%%%%%%%;
dvol_equaband_qbp_k_Y_yk_ = (a_equappos_qbp_k_Y_yk_ - a_equapneg_qbp_k_Y_yk_)/max(1e-12,2*dtau);
dtau_equaband_qbp_a_M_ = zeros(n_synth_M,1);
dtau_equaband_qbp_b_M_ = (equappos_euler_azimu_b_synth_M_ - equapneg_euler_azimu_b_synth_M_)/max(1e-12,2*dtau);
dtau_equaband_qbp_c_M_ = zeros(n_synth_M,1);
delta_equaband_qbp_ykabc_ = local_ykabc_from_yk_a_b_c_(n_k_p_r,l_max_,n_synth_M,dvol_equaband_qbp_k_Y_yk_,dtau_equaband_qbp_a_M_,dtau_equaband_qbp_b_M_,dtau_equaband_qbp_c_M_);
delta_equaband_qbp_ykabc_ = local_normalize_f_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_synth_M,delta_equaband_qbp_ykabc_);
[tmp_ww,tmp_ww_dvol,tmp_ww_a,tmp_ww_b,tmp_ww_c] = local_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_synth_M,delta_equaband_qbp_ykabc_,delta_equaband_qbp_ykabc_);
if (flag_verbose>0); disp(sprintf(' %% tmp_ww %0.2f tmp_ww_dvol %0.2f tmp_ww_a %0.2f tmp_ww_b %0.2f tmp_ww_c %0.2f',tmp_ww,tmp_ww_dvol,tmp_ww_a,tmp_ww_b,tmp_ww_c)); end;
[dvol_equaband_qbp_k_Y_yk_,dtau_equaband_qbp_a_M_,dtau_equaband_qbp_b_M_,dtau_equaband_qbp_c_M_] = local_yk_a_b_c_from_ykabc_(n_k_p_r,l_max_,n_synth_M,delta_equaband_qbp_ykabc_);
%%%%;
parameter_ddssnll = struct('type','eig');
parameter_ddssnll.flag_verbose = flag_verbose;
parameter_ddssnll.flag_check = 1;
parameter_ddssnll.flag_disp = 1;
parameter_ddssnll.flag_kernel_qpro_d0 = 1;
parameter_ddssnll.flag_kernel_qpro_d1 = 1;
parameter_ddssnll.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_ddssnll.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_ddssnll.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_ddssnll.kernel_qpro_l_max_use = l_max;
[ ...
 parameter_ddssnll ...
,equaband_Hvt_ykabc_ ...
] = ...
ddssnll_1( ...
 parameter_ddssnll ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equaband_qbp_k_Y_yk_ ...
,[] ...
,dvol_equaband_qbp_k_Y_yk_ ...
,[] ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,weight_3d_k_p_r_ ...
,[] ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,dtau_equaband_qbp_a_M_ ...
,dtau_equaband_qbp_b_M_ ...
,dtau_equaband_qbp_c_M_ ...
,KAPPA ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
,V_lmm___ ...
,L_lm__ ...
,d0W_betazeta_mlma____ ...
,d1W_betazeta_mlma____ ...
,d2W_betazeta_mlma____ ...
);
%%%%;
ddssnll_equaband_qbp = local_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_synth_M,equaband_Hvt_ykabc_,delta_equaband_qbp_ykabc_);
if (flag_verbose>0); disp(sprintf(' %% ddssnll_equaband_qbp: %0.6f',abs(ddssnll_equaband_qbp))); end;

%%%%%%%%;
% Now attempt random perturbation. ;
%%%%%%%%;
rseed = 0;
rng(rseed);
dvol_randomiz_qbp_k_Y_yk_ = local_rand_f_dvol_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,rseed);
dtau_randomiz_qbp_a_M_ = randn(n_synth_M,1);
dtau_randomiz_qbp_b_M_ = randn(n_synth_M,1);
dtau_randomiz_qbp_c_M_ = randn(n_synth_M,1);
delta_randomiz_qbp_ykabc_ = local_ykabc_from_yk_a_b_c_(n_k_p_r,l_max_,n_synth_M,dvol_randomiz_qbp_k_Y_yk_,dtau_randomiz_qbp_a_M_,dtau_randomiz_qbp_b_M_,dtau_randomiz_qbp_c_M_);
delta_randomiz_qbp_ykabc_ = local_normalize_f_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_synth_M,delta_randomiz_qbp_ykabc_);
[tmp_ww,tmp_ww_dvol,tmp_ww_a,tmp_ww_b,tmp_ww_c] = local_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_synth_M,delta_randomiz_qbp_ykabc_,delta_randomiz_qbp_ykabc_);
if (flag_verbose>0); disp(sprintf(' %% tmp_ww %0.2f tmp_ww_dvol %0.2f tmp_ww_a %0.2f tmp_ww_b %0.2f tmp_ww_c %0.2f',tmp_ww,tmp_ww_dvol,tmp_ww_a,tmp_ww_b,tmp_ww_c)); end;
[dvol_randomiz_qbp_k_Y_yk_,dtau_randomiz_qbp_a_M_,dtau_randomiz_qbp_b_M_,dtau_randomiz_qbp_c_M_] = local_yk_a_b_c_from_ykabc_(n_k_p_r,l_max_,n_synth_M,delta_randomiz_qbp_ykabc_);
%%%%;
parameter_ddssnll = struct('type','eig');
parameter_ddssnll.flag_verbose = flag_verbose;
parameter_ddssnll.flag_check = 1;
parameter_ddssnll.flag_disp = 1;
parameter_ddssnll.flag_kernel_qpro_d0 = 1;
parameter_ddssnll.flag_kernel_qpro_d1 = 1;
parameter_ddssnll.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_ddssnll.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_ddssnll.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_ddssnll.kernel_qpro_l_max_use = l_max;
[ ...
 parameter_ddssnll ...
,randomiz_Hvt_ykabc_ ...
] = ...
ddssnll_1( ...
 parameter_ddssnll ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equaband_qbp_k_Y_yk_ ...
,[] ...
,dvol_randomiz_qbp_k_Y_yk_ ...
,[] ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,weight_3d_k_p_r_ ...
,[] ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,dtau_randomiz_qbp_a_M_ ...
,dtau_randomiz_qbp_b_M_ ...
,dtau_randomiz_qbp_c_M_ ...
,KAPPA ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
,V_lmm___ ...
,L_lm__ ...
,d0W_betazeta_mlma____ ...
,d1W_betazeta_mlma____ ...
,d2W_betazeta_mlma____ ...
);
%%%%;
ddssnll_randomiz_qbp = local_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_synth_M,randomiz_Hvt_ykabc_,delta_randomiz_qbp_ykabc_);
if (flag_verbose>0); disp(sprintf(' %% ddssnll_randomiz_qbp: %0.6f',abs(ddssnll_randomiz_qbp))); end;

%%%%%%%%;
% Now look at the Htt component of the hessian. ;
%%%%%%%%;
parameter_polish = parameter;
parameter_polish.flag_verbose = 1;
parameter_polish.flag_kernel_qpro_d0 = parameter_KAPPA.flag_kernel_qpro_d0;
parameter_polish.flag_kernel_qpro_d1 = parameter_KAPPA.flag_kernel_qpro_d1;
parameter_polish.kernel_qpro_polar_a_pole_north = parameter_KAPPA.kernel_qpro_polar_a_pole_north;
parameter_polish.kernel_qpro_polar_a_pole_south = parameter_KAPPA.kernel_qpro_polar_a_pole_south;
parameter_polish.kernel_qpro_l_max_use = parameter_KAPPA.kernel_qpro_l_max_use;
parameter_polish.kernel_qpro_qref_k_eq_d_double = parameter_KAPPA.kernel_qpro_qref_k_eq_d_double;
parameter_polish.flag_kernel_full = parameter_KAPPA.flag_kernel_full;
parameter_polish.flag_polish_update_volume = 0;
parameter_polish.polish_dssnll_fpi_tolerance = 1e-6;
parameter_polish.polish_dssnll_fpi_stepsize = 1e-1;
parameter_polish.polish_dssnll_fpi_n_iteration = 16;
[ ...
 parameter_polish ...
,~ ...
,equaband_euler_polar_a_crit_synth_M_ ...
,equaband_euler_azimu_b_crit_synth_M_ ...
,equaband_euler_gamma_z_crit_synth_M_ ...
,equaband_G_fnorm_crit ...
] = ...
polish_dssnll_fpi_0( ...
 parameter_polish ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equaband_qbp_k_Y_yk_ ...
,[] ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,weight_3d_k_p_r_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,KAPPA ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
,V_lmm___ ...
,L_lm__ ...
,d0W_betazeta_mlma____ ...
,d1W_betazeta_mlma____ ...
,d2W_betazeta_mlma____ ...
);

parameter_ssnll = parameter;
[ ...
 parameter_ssnll ...
,equaband_ssnll_M_ ...
,equaband_ssnll ...
,equaband_S_k_p_wkS__ ...
,dvol_equaband_ssnll_M_ ...
,dvol_equaband_ssnll ...
,dvol_equaband_S_k_p_wkS__ ...
,dvol_dvol_equaband_ssnll ...
,dtau_equaband_ssnll_M3__ ...
,dtau_equaband_ssnll ...
,dtau_equaband_S_k_p_wkS3___ ...
,dtau_dvol_equaband_ssnll_M3__ ...
,dtau_dvol_equaband_ssnll ...
,dtau_dvol_equaband_S_k_p_wkS3___ ...
,dtau_dtau_equaband_ssnll_M33___ ...
,dtau_dtau_equaband_ssnll ...
,dtau_dtau_equaband_S_k_p_wkS33____ ...
,V_lmm___ ...
,L_lm__ ...
,d0W_betazeta_mlma____ ...
,d1W_betazeta_mlma____ ...
,d2W_betazeta_mlma____ ...
] = ...
ssnll_from_a_k_Y_12( ...
 parameter_ssnll ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_equaband_qbp_k_Y_yk_ ...
,0*dvol_equaband_qbp_k_Y_yk_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,dtau_equaband_qbp_a_M_ ...
,dtau_equaband_qbp_b_M_ ...
,dtau_equaband_qbp_c_M_ ...
,V_lmm___ ...
,L_lm__ ...
,d0W_betazeta_mlma____ ...
,d1W_betazeta_mlma____ ...
,d2W_betazeta_mlma____ ...
);
%%%%;

dtau_dtau_equaband_ssnll_fi_S_M3__ = zeros(n_synth_M,n_3);
dtau_dtau_equaband_ssnll_fi_U_M3__ = zeros(n_synth_M,n_3);
for nsynth_M=0:n_synth_M-1;
[tmp_U__,tmp_S__] = eigs(real(squeeze(dtau_dtau_equaband_ssnll_M33___(1+nsynth_M,:,:))),n_3);
tmp_S_ = diag(tmp_S__);
[~,tmp_ij_] = sort(tmp_S_,'ascend');
dtau_dtau_equaband_ssnll_fi_S_M3__(1+nsynth_M,:) = tmp_S_(tmp_ij_);
dtau_dtau_equaband_ssnll_fi_U_M3__(1+nsynth_M,:) = tmp_U__(:,tmp_ij_(1+0));
end;%for nsynth_M=0:n_synth_M-1;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

%{
flag_calc=0;
if flag_calc;
tmp_lanczos_n_iteration_max = 0;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
% Now try an eigenvalue estimate with noiseless images and equa-band viewing-angles. ;
%%%%%%%%;
fname_mat = sprintf('%s_mat/eig_from_synth_equa_band.mat',dir_ssnll);
if ( exist(fname_mat,'file'));
tmp_ = load(fname_mat); tmp_lanczos_n_iteration_max = numel(tmp_.alph_i_); clear tmp_;
disp(sprintf(' %% %s found, tmp_lanczos_n_iteration_max %.2d',fname_mat,tmp_lanczos_n_iteration_max));
end;%if ( exist(fname_mat,'file'));
if (flag_recalc | ~exist(fname_mat,'file') | tmp_lanczos_n_iteration_max< lanczos_n_iteration_max);
disp(sprintf(' %% %s not complete, calculating',fname_mat));
parameter_eig = struct('type','eig');
parameter_eig.flag_verbose = flag_verbose;
parameter_eig.flag_check = 0;
parameter_eig.flag_disp = 0;
parameter_eig.flag_kernel_qpro_d0 = 1;
parameter_eig.flag_kernel_qpro_d1 = 1;
parameter_eig.kernel_qpro_polar_a_pole_north=KAPPA_pole_north_double;
parameter_eig.kernel_qpro_polar_a_pole_south=KAPPA_pole_south_double;
parameter_eig.kernel_qpro_qref_k_eq_d_double=KAPPA_qref_k_eq_d_double;
parameter_eig.kernel_qpro_l_max_use = l_max;
parameter_eig.lanczos_n_iteration_max = lanczos_n_iteration_max;
U_SmallRotation_Delta_ykabc3__ = []; %<-- construct internally. ;
U_tilde_SmallRotation_Delta_ykabc3__ = []; %<-- construct internally. ;
S_k_p_q2d_wkS__ = S_k_p_wkS__;
%%%%;
if (~exist(fname_mat,'file'));
tmp_lanczos_n_iteration_max = 0;
rng(0);
euler_polar_a_synth_M_ = (pi/2)*ones(n_synth_M,1) + equa_band_width*0.5*(2*rand(n_synth_M,1)-1);
euler_azimu_b_synth_M_ = 2*pi*rand(n_synth_M,1);
[euler_polar_a_synth_M_,euler_azimu_b_synth_M_] = periodize_polar_a_azimu_b_0(euler_polar_a_synth_M_,euler_azimu_b_synth_M_);
tmp_index_nS_from_nM_ = ...
knnsearch( ...
 [hist2dab_polar_a_S_,hist2dab_azimu_b_S_] ...
,[euler_polar_a_synth_M_,euler_azimu_b_synth_M_] ...
,'K',1)-1;
M_synth_k_p_wkM__ = hist2dab_S_k_p_wkS__(:,1+tmp_index_nS_from_nM_);
euler_polar_a_synth_M_ = hist2dab_polar_a_S_(1+tmp_index_nS_from_nM_);
euler_azimu_b_synth_M_ = hist2dab_azimu_b_S_(1+tmp_index_nS_from_nM_);
euler_gamma_z_synth_M_ = zeros(n_synth_M,1);
v_tilde_ykabci__=[];
w_tilde_ykabc_=[];
alph_tilde_i_=[];
beta_tilde_i_=[];
end;%if (~exist(fname_mat,'file'));
%%%%;
if ( exist(fname_mat,'file'));
tmp_ = load(fname_mat);
tmp_lanczos_n_iteration_max = numel(tmp_.alph_tilde_i_);
tmp_index_nS_from_nM_ = tmp_.tmp_index_nS_from_nM_;
M_synth_k_p_wkM__ = hist2dab_S_k_p_wkS__(:,1+tmp_index_nS_from_nM_);
euler_polar_a_synth_M_ = tmp_.euler_polar_a_synth_M_;
euler_azimu_b_synth_M_ = tmp_.euler_azimu_b_synth_M_;
euler_gamma_z_synth_M_ = tmp_.euler_gamma_z_synth_M_;
U_tilde_SmallRotation_Delta_ykabc3__ = tmp_.U_tilde_SmallRotation_Delta_ykabc3__;
v_tilde_ykabci__ = tmp_.v_tilde_ykabci__;
w_tilde_ykabc_ = tmp_.w_tilde_ykabc_;
alph_tilde_i_ = tmp_.alph_tilde_i_;
beta_tilde_i_ = tmp_.beta_tilde_i_;
clear tmp_;
end;%if ( exist(fname_mat,'file'));
%%%%;
if ~exist('KAPPA','var'); KAPPA=[]; end;
if ~exist('Ylm_uklma___','var'); Ylm_uklma___=[]; end;
if ~exist('k_p_azimu_b_sub_uka__','var'); k_p_azimu_b_sub_uka__=[]; end;
if ~exist('k_p_polar_a_sub_uka__','var'); k_p_polar_a_sub_uka__=[]; end;
if ~exist('l_max_uk_','var'); l_max_uk_=[]; end;
if ~exist('index_nu_n_k_per_shell_from_nk_p_r_','var'); index_nu_n_k_per_shell_from_nk_p_r_=[]; end;
if ~exist('index_k_per_shell_uka__','var'); index_k_per_shell_uka__=[]; end;
if ~exist('V_lmm___','var'); V_lmm___=[]; end;
if ~exist('L_lm__','var'); L_lm__=[]; end;
if ~exist('d0W_betazeta_mlma____','var'); d0W_betazeta_mlma____=[]; end;
if ~exist('d1W_betazeta_mlma____','var'); d1W_betazeta_mlma____=[]; end;
if ~exist('d2W_betazeta_mlma____','var'); d2W_betazeta_mlma____=[]; end;
if ~exist('U_tilde_SmallRotation_Delta_ykabc3__','var'); U_tilde_SmallRotation_Delta_ykabc3__=[]; end;
%%%%;
%if ~exist('v_tilde_ykabci__ ','var'); v_tilde_ykabci__ =[]; end;
%if ~exist('w_tilde_ykabc_ ','var'); w_tilde_ykabc_ =[]; end;
%if ~exist('alph_tilde_i_','var'); alph_tilde_i_=[]; end;
%if ~exist('beta_tilde_i_ ','var'); beta_tilde_i_ =[]; end;
%%%%;
[ ...
 parameter_eig ...
,U_tilde_SmallRotation_Delta_ykabc3__ ...
,v_tilde_ykabci__  ...
,w_tilde_ykabc_  ...
,alph_tilde_i_ ...
,beta_tilde_i_ ... 
] = ...
eig_ddssnll_lanczos_1( ...
 parameter_eig ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_k_Y_quad_yk_ ...
,n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,weight_3d_k_p_r_ ...
,a_k_p_quad_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,S_k_p_q2d_wkS__ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_synth_M ...
,M_synth_k_p_wkM__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,euler_polar_a_synth_M_ ...
,euler_azimu_b_synth_M_ ...
,euler_gamma_z_synth_M_ ...
,KAPPA ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
,V_lmm___ ...
,L_lm__ ...
,d0W_betazeta_mlma____ ...
,d1W_betazeta_mlma____ ...
,d2W_betazeta_mlma____ ...
,U_tilde_SmallRotation_Delta_ykabc3__ ...
,v_tilde_ykabci__  ...
,w_tilde_ykabc_  ...
,alph_tilde_i_ ...
,beta_tilde_i_ ... 
);
save(fname_mat ...
     ,'parameter' ...
     ,'parameter_eig' ...
     ,'n_k_p_r' ...
     ,'k_p_r_' ...
     ,'k_p_r_max' ...
     ,'l_max_' ...
     ,'n_k_all' ...
     ,'n_k_all_csum_' ...
     ,'k_p_r_all_' ...
     ,'k_p_azimu_b_all_' ...
     ,'k_p_polar_a_all_' ...
     ,'weight_3d_k_all_' ...
     ,'weight_shell_k_' ...
     ,'weight_3d_k_p_r_' ...
     ,'weight_3d_riesz_k_p_r_' ...
     ,'weight_3d_riesz_k_all_' ...
     ,'n_w_' ...
     ,'weight_2d_k_p_r_' ...
     ,'weight_2d_wk_' ...
     ,'n_S' ...
     ,'viewing_polar_a_S_' ...
     ,'viewing_azimu_b_S_' ...
     ,'viewing_weight_S_' ...
     ,'n_viewing_polar_a' ...
     ,'viewing_polar_a_' ...
     ,'n_viewing_azimu_b_' ...
     ,'U_tilde_SmallRotation_Delta_ykabc3__' ...
     ,'v_tilde_ykabci__'  ...
     ,'w_tilde_ykabc_' ...
     ,'alph_tilde_i_' ...
     ,'beta_tilde_i_' ... 
     ,'n_synth_M' ...
     ,'euler_polar_a_synth_M_' ...
     ,'euler_azimu_b_synth_M_' ...
     ,'euler_gamma_z_synth_M_' ...
     ,'tmp_index_nS_from_nM_' ...
     );
%%%%%%%%;
end;%if (flag_recalc | ~exist(fname_mat,'file') | tmp_lanczos_n_iteration_max< lanczos_n_iteration_max);
if ( exist(fname_mat,'file'));
disp(sprintf(' %% %s found, not creating',fname_mat));
end;%if ( exist(fname_mat,'file'));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%if flag_calc;
%}
