syn_infix = str_combine;
syn_n_order = 5;
syn_n_M = 1024*2;
syn_n_UX_rank = 16;
syn_n_iteration = 32;
syn_rseed_ = [0:1]; n_syn_rseed = numel(syn_rseed_);
syn_snr_ = [0 , 2.^[-1:-0.5:-5]]; n_syn_snr=numel(syn_snr_);
nsyn_rseed = 0; nsyn_snr = 3;
syn_rseed = syn_rseed_(1+nsyn_rseed);
syn_snr = syn_snr_(1+nsyn_snr);
%%%%%%%%;
n_lm_ = (l_max_+1).^2;
n_lm_max = max(n_lm_);
n_lm_sum = sum(n_lm_);
n_lm_csum_ = cumsum([0;n_lm_]);
l_max_max = max(l_max_); dWtdkd__l_max_max = 2*l_max_max;
m_max_ = -l_max_max : +l_max_max;
n_m_max = length(m_max_);
molecule_density_ = molecule_density_/sum(molecule_density_);
%%%%%%%%;
fname_mat = sprintf('%s_mat/tpmhham_synthetic_5_UX_%s_M_k_p___n%.3ds%.4dr%.3d.mat',dir_trunk,syn_infix,syn_n_M,floor(1000*syn_snr),syn_n_UX_rank);
if (~exist(fname_mat,'file')); disp(sprintf(' %% %s not found',fname_mat)); end;
if ( exist(fname_mat,'file')); disp(sprintf(' %% %s found',fname_mat)); load(fname_mat); end;
nUX_rank = 1;
fname_pre = sprintf('%s_mat/tpmhham_synthetic_5_UX_%s_Y_n%.3ds%.4dr%.3d_allshell_rng%.3dnUX%.3d',dir_trunk,syn_infix,syn_n_M,floor(1000*syn_snr),syn_n_UX_rank,syn_rseed,nUX_rank);
fname_mat = sprintf('%s.mat',fname_pre);
if (~exist(fname_mat,'file')); disp(sprintf(' %% %s not found',fname_mat)); end;
if ( exist(fname_mat,'file')); disp(sprintf(' %% %s found',fname_mat)); tmp_ = load(fname_mat); end;
disp(sprintf(' %% syn_X_best_allshell_: %0.3f',tmp_.syn_X_best_allshell_(end)));
%%%%%%%%;
% Solve lsq with estimated viewing angles. ;
%%%%%%%%;
tmp_n_k_p_r = 1+nUX_rank;
tmp_k_p_r_ = ones(1+nUX_rank,1); tmp_k_p_r_max = 1;
tmp_n_w_ = n_w_max*ones(1+nUX_rank,1); tmp_n_w_max = max(tmp_n_w_); tmp_n_w_sum = sum(tmp_n_w_); 
tmp_weight_k_p_r_ = ones(1+nUX_rank,1); tmp_weight_2d_k_p_r_ = ones(1+nUX_rank,1);
tmp_l_max_ = l_max_max*ones(1+nUX_rank,1);
tmp_n_lm_ = (1+tmp_l_max_).^2; tmp_n_lm_sum = sum(tmp_n_lm_);
tmp_a_k_Y_quad_mavg_ = reshape(a_UX_Y_quad_mavg__(:,1+(0:nUX_rank)),[tmp_n_lm_sum,1]); %<-- use as ground truth for this set of principled-image-rings. ;
tmp_M_k_p__ = reshape(permute(syn_UX_M_k_p___(:,:,1+(0:nUX_rank)),[1,3,2]),[tmp_n_w_sum,syn_n_M]);
tmp_M_k_q__ = reshape(permute(syn_UX_M_k_q___(:,:,1+(0:nUX_rank)),[1,3,2]),[tmp_n_w_sum,syn_n_M]);
%%%%%%%%;
tmp_euler_polar_a_ = tmp_.euler_polar_a__(:,end);
tmp_euler_azimu_b_ = tmp_.euler_azimu_b__(:,end);
tmp_euler_gamma_z_ = tmp_.euler_gamma_z__(:,end);
tmp_t = tic();
syn_a_k_Y_0lsq_ = cg_lsq_3(syn_n_order,tmp_n_k_p_r,tmp_l_max_,tmp_n_w_,syn_n_M,tmp_M_k_p__,1,ones(tmp_n_w_sum,1),tmp_euler_polar_a_,tmp_euler_azimu_b_,tmp_euler_gamma_z_);
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% syn_a_k_Y_0lsq_: %0.3fs',tmp_t)); end;
%%%%%%%%;
% check correlation with ground truth. ;
%%%%%%%%;
tmp_t = tic();
[tmp_X_best_orig,~,~,~,~,~,~] = register_spharm_to_spharm_wigner_0(tmp_n_k_p_r,tmp_k_p_r_,tmp_k_p_r_max,tmp_weight_k_p_r_,0,tmp_l_max_,tmp_a_k_Y_quad_mavg_,syn_a_k_Y_0lsq_);
[tmp_X_best_flip,~,~,~,~,~,~] = register_spharm_to_spharm_wigner_0(tmp_n_k_p_r,tmp_k_p_r_,tmp_k_p_r_max,tmp_weight_k_p_r_,0,tmp_l_max_,tmp_a_k_Y_quad_mavg_,flipY(tmp_n_k_p_r,tmp_l_max_,syn_a_k_Y_0lsq_));
tmp_X_best = max(real(tmp_X_best_orig),real(tmp_X_best_flip));
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% register_spharm_to_spharm_wigner_0: %0.3fs',tmp_t)); end;
disp(sprintf(' %% tmp_a_k_Y_quad_mavg_ vs syn_a_k_Y_lsq0_: correlation %+0.6f',tmp_X_best));
%%%%%%%%;
% calculate residual from lsq. ;
%%%%%%%%;
tmp_t = tic();
tmp_n_lm_max = max(tmp_n_lm_); tmp_n_lm_csum_ = cumsum([0;tmp_n_lm_]);
tmp_n_w_csum_ = cumsum([0;tmp_n_w_]);
tmp_CTF_index_ = 1; tmp_CTF_k_p__ = ones(tmp_n_w_sum,1); %<-- no CTF necessary. ;
%a_k_Y_ = zeros(n_lm_sum,1);
tmp_S_k_p__ = zeros(tmp_n_w_sum,syn_n_M);
for nk_p_r=0:tmp_n_k_p_r-1;
tmp_l_max = tmp_l_max_(1+nk_p_r);
tmp_Y_ij_ = tmp_n_lm_csum_(1+nk_p_r) + (0:tmp_n_lm_(1+nk_p_r)-1);
tmp_n_w = tmp_n_w_(1+nk_p_r);
tmp_M_ij_ = tmp_n_w_csum_(1+nk_p_r) + (0:tmp_n_w_(1+nk_p_r)-1);
if (isempty(tmp_CTF_index_) | numel(tmp_CTF_index_)==1);
tmp_CTF_k_p_ = reshape(repmat(tmp_CTF_k_p__(1+tmp_M_ij_),[1,syn_n_M]),[tmp_n_w*syn_n_M,1]);
 else;
tmp_CTF_k_p_ = reshape(tmp_CTF_k_p__(1+tmp_M_ij_,tmp_CTF_index_(1:syn_n_M)),[tmp_n_w*syn_n_M,1]);
end;%if (isempty(tmp_CTF_index_) | numel(tmp_CTF_index_)==1);
[tmp_k_p_polar_a__,tmp_k_p_azimu_b__] = cg_rhs_1(syn_n_M,tmp_n_w,tmp_euler_polar_a_,tmp_euler_azimu_b_,+tmp_euler_gamma_z_);
tmp_n_polar_a = ceil(tmp_n_w/2);
tmp_n_azimu_b = max(1+2*tmp_l_max,2*tmp_n_polar_a);
[tmp_legendre_evaluate_ljm___,tmp_legendre_evaluate_mlj___,tmp_expil__,tmp_expi__] = legendre_evaluate_ljm___0(tmp_l_max,cos(linspace(0,pi,tmp_n_polar_a)),tmp_n_azimu_b);
tmp_tensor_to_scatter__ = cg_interpolate_n_1(syn_n_order,tmp_n_polar_a,tmp_n_azimu_b,tmp_n_w*syn_n_M,tmp_k_p_polar_a__(:),tmp_k_p_azimu_b__(:));
tmp_scatter_to_tensor__ = ctranspose(tmp_tensor_to_scatter__); %<-- this conjugation is not necessary, since the matrix should be real. ;
An__ = @(a_k_Y_) tmp_CTF_k_p_.*(tmp_tensor_to_scatter__*reshape(cg_evaluate_n_1(tmp_l_max,convert_spharm_to_spharm__0(tmp_l_max,a_k_Y_),tmp_n_polar_a,tmp_n_azimu_b,tmp_legendre_evaluate_ljm___),[tmp_n_polar_a*tmp_n_azimu_b,1]));
At__ = @(a_k_X_) convert_spharm__to_spharm_0(tmp_l_max,cg_evaluate_t_1(tmp_n_polar_a,tmp_n_azimu_b,reshape(tmp_scatter_to_tensor__*(conj(tmp_CTF_k_p_).*a_k_X_),[tmp_n_polar_a,tmp_n_azimu_b]),tmp_l_max,tmp_legendre_evaluate_mlj___,tmp_expil__,tmp_expi__));
AtAn__ = @(a_k_Y_) At__(An__(a_k_Y_));
%[a_k_Y_(1+tmp_Y_ij_),~] = pcg(AtAn__,At__(reshape(tmp_M_k_p__(1+tmp_M_ij_,:),[tmp_n_w*syn_n_M,1])));
tmp_S_k_p__(1+tmp_M_ij_,:) = reshape(An__(syn_a_k_Y_0lsq_(1+tmp_Y_ij_)),[tmp_n_w_(1+nk_p_r),syn_n_M]);
end;%for nk_p_r=0:n_k_p_r-1;
tmp_R_k_p__ = tmp_M_k_p__ - tmp_S_k_p__;
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% tmp_R_k_p__: %0.3fs',tmp_t)); end;
%%%%%%%%;
flag_plot=0;
if flag_plot;
clf;
subplot(3,1,1); imagesc(abs(tmp_M_k_p__),[-0.03,+0.03]); colormap(colormap_beach()); axisnotick;
subplot(3,1,2); imagesc(abs(tmp_S_k_p__),[-0.03,+0.03]); colormap(colormap_beach()); axisnotick;
subplot(3,1,3); imagesc(abs(tmp_R_k_p__),[-0.03,+0.03]); colormap(colormap_beach()); axisnotick;
figbig;
end;%if flag_plot;
%%%%%%%%;
% Initialize residual clustering. ;
%%%%%%%%;
tmp_t = tic();
tmp_H__ = zeros(tmp_n_lm_sum,syn_n_M);
for nk_p_r=0:tmp_n_k_p_r-1;
tmp_l_max = tmp_l_max_(1+nk_p_r);
tmp_Y_ij_ = tmp_n_lm_csum_(1+nk_p_r) + (0:tmp_n_lm_(1+nk_p_r)-1);
tmp_n_w = tmp_n_w_(1+nk_p_r);
tmp_M_ij_ = tmp_n_w_csum_(1+nk_p_r) + (0:tmp_n_w_(1+nk_p_r)-1);
tmp_n_polar_a = ceil(tmp_n_w/2);
tmp_n_azimu_b = max(1+2*tmp_l_max,2*tmp_n_polar_a);
[tmp_legendre_evaluate_ljm___,tmp_legendre_evaluate_mlj___,tmp_expil__,tmp_expi__] = legendre_evaluate_ljm___0(tmp_l_max,cos(linspace(0,pi,tmp_n_polar_a)),tmp_n_azimu_b);
for nM=0:syn_n_M-1;
if (isempty(tmp_CTF_index_) | numel(tmp_CTF_index_)==1);
tmp_CTF_k_p_ = reshape(repmat(tmp_CTF_k_p__(1+tmp_M_ij_),[1,1]),[tmp_n_w*1,1]);
 else;
tmp_CTF_k_p_ = reshape(tmp_CTF_k_p__(1+tmp_M_ij_,tmp_CTF_index_(1+nM)),[tmp_n_w*1,1]);
end;%if (isempty(tmp_CTF_index_) | numel(tmp_CTF_index_)==1);
[tmp_k_p_polar_a__,tmp_k_p_azimu_b__] = cg_rhs_1(1,tmp_n_w,tmp_euler_polar_a_(1+nM),tmp_euler_azimu_b_(1+nM),+tmp_euler_gamma_z_(1+nM));
tmp_tensor_to_scatter__ = cg_interpolate_n_1(syn_n_order,tmp_n_polar_a,tmp_n_azimu_b,tmp_n_w*1,tmp_k_p_polar_a__(:),tmp_k_p_azimu_b__(:));
tmp_scatter_to_tensor__ = ctranspose(tmp_tensor_to_scatter__); %<-- this conjugation is not necessary, since the matrix should be real. ;
At__ = @(a_k_X_) convert_spharm__to_spharm_0(tmp_l_max,cg_evaluate_t_1(tmp_n_polar_a,tmp_n_azimu_b,reshape(tmp_scatter_to_tensor__*(conj(tmp_CTF_k_p_).*a_k_X_),[tmp_n_polar_a,tmp_n_azimu_b]),tmp_l_max,tmp_legendre_evaluate_mlj___,tmp_expil__,tmp_expi__));
tmp_H__(1+tmp_Y_ij_,1+nM) = At__(tmp_R_k_p__(1+tmp_M_ij_,1+nM));
end;%for nM=0:syn_n_M-1;
end;%for nk_p_r=0:tmp_n_k_p_r-1;
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% tmp_H__: %0.3fs',tmp_t)); end;
%%%%%%%%;
tmp_t = tic();
tmp_HH_ = zeros(syn_n_M,1);
for nM=0:syn_n_M-1;
tmp_HH_(1+nM) = 0;
for nk_p_r=0:tmp_n_k_p_r-1;
tmp_l_max = tmp_l_max_(1+nk_p_r);
tmp_Y_ij_ = tmp_n_lm_csum_(1+nk_p_r) + (0:tmp_n_lm_(1+nk_p_r)-1);
tmp_HH_(1+nM) = tmp_HH_(1+nM) + sum(abs(tmp_H__(1+tmp_Y_ij_,1+nM)).^2)*tmp_weight_k_p_r_(1+nk_p_r);
end;%for nk_p_r=0:tmp_n_k_p_r-1;
end;%for nM=0:syn_n_M-1;
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% tmp_HH_: %0.3fs',tmp_t)); end;
%%%%%%%%;
% Iterate to cluster residuals. ;
%%%%%%%%;
tmp_t = tic();
tmp_n_residual_loading = 2;
tmp_M_loading__ = randn(tmp_n_residual_loading,syn_n_M);
tmp_G_ = randn(tmp_n_lm_sum,tmp_n_residual_loading); 
for nloading=0:tmp_n_residual_loading-1; 
tmp_G_(:,1+nloading) = tmp_G_(:,1+nloading)/fnorm(tmp_G_(:,1+nloading));
end;%for nloading=0:tmp_n_residual_loading-1; 
tmp_n_residual_iteration = 32;
for niteration=0:tmp_n_residual_iteration-1;
%%%%;
if (niteration==0);
% do nothing;
end;%if (niteration==0);
if (niteration>0);
tmp_G_ = zeros(tmp_n_lm_sum,tmp_n_residual_loading);
for nM=0:syn_n_M-1;
for nloading=0:tmp_n_residual_loading-1;
tmp_G_(:,1+nloading) = tmp_G_(:,1+nloading) + tmp_M_loading__(1+nloading,1+nM)*tmp_H__(:,1+nM);
end;%for nloading=0:tmp_n_residual_loading-1;
end;%for nM=0:syn_n_M-1;
for nloading_0=0:tmp_n_residual_loading-1;
tmp_G_(:,1+nloading_0) = tmp_G_(:,1+nloading_0)/fnorm(tmp_G_(:,1+nloading_0));
for nloading_1=nloading_0+1:tmp_n_residual_loading-1;
tmp_G_(:,1+nloading_1) = tmp_G_(:,1+nloading_1) - (ctranspose(tmp_G_(:,1+nloading_0))*tmp_G_(:,1+nloading_1))*tmp_G_(:,1+nloading_0);
end;%for nloading_1=nloading_0+1:tmp_n_residual_loading-1;
end;%for nloading_0=0:tmp_n_residual_loading-1;
end;%if (niteration>0);
%%%%;
for nM=0:syn_n_M-1;
tmp_HH = tmp_HH_(1+nM);
for nloading=0:tmp_n_residual_loading-1;
tmp_HG = 0;
for nk_p_r=0:tmp_n_k_p_r-1;
tmp_l_max = tmp_l_max_(1+nk_p_r);
tmp_Y_ij_ = tmp_n_lm_csum_(1+nk_p_r) + (0:tmp_n_lm_(1+nk_p_r)-1);
tmp_HG = tmp_HG + sum(conj(tmp_H__(1+tmp_Y_ij_,1+nM)).*tmp_G_(1+tmp_Y_ij_,1+nloading))*tmp_weight_k_p_r_(1+nk_p_r);
end;%for nk_p_r=0:tmp_n_k_p_r-1;
tmp_M_loading__(1+nloading,1+nM) = real(tmp_HG)/max(1e-12,real(tmp_HH));
end;%for nloading=0:tmp_n_residual_loading-1;
end;%for nM=0:syn_n_M-1;
%%%%;
%%%%%%%%;
% Now plot scatterplot .;
%%%%%%%%;
flag_plot=1;
if flag_plot;
clf;
c_ = colormap_beach(); n_c = size(c_,1);
nc_ = max(0,min(n_c-1,floor(n_c*syn_M_molecule_type_/n_molecule)));
if tmp_n_residual_loading==3;
scatter3(tmp_M_loading__(1,:),tmp_M_loading__(2,:),tmp_M_loading__(3,:),15,c_(1+nc_,:),'filled','MarkerEdgeColor','k'); 
axisnotick; axis vis3d; 
end;%if tmp_n_residual_loading==3;
if tmp_n_residual_loading==2;
scatter(tmp_M_loading__(1,:),tmp_M_loading__(2,:),15,c_(1+nc_,:),'filled','MarkerEdgeColor','k'); 
axisnotick; axis vis3d; 
end;%if tmp_n_residual_loading==2;
figbig;
title(sprintf('%d',niteration));
drawnow();
end;%if flag_plot;
%%%%;
end;%for niteration=0:tmp_n_residual_iteration-1;
tmp_t = toc(tmp_t); if (verbose); disp(sprintf(' %% tmp_M_loading__: %0.3fs',tmp_t)); end;

%{
%%%%%%%%;
% calculate common-line matrix: too slow ;
%%%%%%%%;
ER__ = zeros(syn_n_M,syn_n_M);
for nM_0=0:syn_n_M-1;
if (mod(nM_0,100)==0); disp(sprintf(' %% nM %d/%d',nM_0,syn_n_M)); end;
for nM_1=nM_0:syn_n_M-1;
ER__(1+nM_0,1+nM_1) = common_line_0(tmp_n_k_p_r,tmp_weight_k_p_r_,tmp_n_w_,tmp_R_k_p__(:,1+nM_0),tmp_euler_polar_a_(1+nM_0),tmp_euler_azimu_b_(1+nM_0),tmp_euler_gamma_z_(1+nM_0),tmp_R_k_p__(:,1+nM_1),tmp_euler_polar_a_(1+nM_1),tmp_euler_azimu_b_(1+nM_1),tmp_euler_gamma_z_(1+nM_1));
ER__(1+nM_1,1+nM_0) = conj(ER__(1+nM_0,1+nM_1));
end;%for nM_1=nM_0:syn_n_M-1;
end;%for nM_0=0:syn_n_M-1;
 %}
