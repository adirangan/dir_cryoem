function ...
[ ...
 parameter ...
,a_k_Y_yk_ ...
,sqrt_2lp1_ ...
,sqrt_2mp1_ ...
,sqrt_rat0_m_ ...
,sqrt_rat3_lm__ ...
,sqrt_rat4_lm__ ...
] = ...
plane_wave_expansion_2( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,n_x ...
,x_3x__ ...
,l_max_ ...
,sqrt_2lp1_ ...
,sqrt_2mp1_ ...
,sqrt_rat0_m_ ...
,sqrt_rat3_lm__ ...
,sqrt_rat4_lm__ ...
);
%%%%%%%%;
% Plane-wave expansion in terms of spherical-bessel-functions and spherical-harmonics. ;
% We assume each plane-wave is of the form exp( +i * < 2*pi*k_ , x_ > ), with x_:=x_3x__(:,1+nx). ;
% Here we assume that the individual points x_3x__(:,1+nx) are relatively small in number, ;
% and (collectively) do not have any special structure. ;
% Thus, for example, we do not group their polar_a values when calling ylgndr_2. ;
%%%%%%%%;

str_thisfunction = 'plane_wave_expansion_2';

if (nargin<1);
flag_verbose=1;
if (flag_verbose>0); disp(sprintf(' %% testing %s',str_thisfunction)); end;
parameter = struct('type','parameter');
parameter.flag_verbose = 1;
n_k_p_r = 49; k_p_r_ = sort(rand(n_k_p_r,1)); n_3 = 3; n_x = 256; x_3x__ = randn(n_3,n_x); x_3x__(:,1+max(0,min(n_x-1,17))) = [0;0;0];
l_max_ = 2+transpose([0:n_k_p_r-1]);
l_max_max = max(l_max_);
n_y_ = (1+l_max_).^2;
n_y_sum = sum(n_y_);
tmp_t=tic();
[~,b_k_Y_yk_] = plane_wave_expansion_2(parameter,n_k_p_r,k_p_r_,n_x,x_3x__,l_max_);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% plane_wave_expansion_2: time %0.6fs',tmp_t)); end;
tmp_t=tic();
a_k_Y_yk_ = zeros(n_y_sum,1);
for nx=0:n_x-1;
a_k_Y_yk_ = a_k_Y_yk_ + plane_wave_expansion_1(n_k_p_r,k_p_r_,x_3x__(:,1+nx),l_max_);
end;%for nx=0:n_x-1;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% plane_wave_expansion_1: time %0.6fs',tmp_t)); end;
fnorm_disp(flag_verbose,'a_k_Y_yk_',a_k_Y_yk_,'b_k_Y_yk_',b_k_Y_yk_,' %%<-- should be zero');
disp('returning'); return;
end;%if (nargin<1);

na=0;
if (nargin<1+na); parameter = []; end; na=na+1;
if (nargin<1+na); n_k_p_r = []; end; na=na+1;
if (nargin<1+na); k_p_r_ = []; end; na=na+1;
if (nargin<1+na); n_x = []; end; na=na+1;
if (nargin<1+na); x_3x__ = []; end; na=na+1;
if (nargin<1+na); l_max_ = []; end; na=na+1;
if (nargin<1+na); sqrt_2lp1_ = []; end; na=na+1;
if (nargin<1+na); sqrt_2mp1_ = []; end; na=na+1;
if (nargin<1+na); sqrt_rat0_m_ = []; end; na=na+1;
if (nargin<1+na); sqrt_rat3_lm__ = []; end; na=na+1;
if (nargin<1+na); sqrt_rat4_lm__ = []; end; na=na+1;

if isempty(parameter); parameter=struct('type','parameter'); end;
if ~isfield(parameter,'flag_verbose'); parameter.flag_verbose=0; end;
flag_verbose=parameter.flag_verbose;

if (flag_verbose>0); disp(sprintf(' %% [entering %s]',str_thisfunction)); end;

l_max_max = max(l_max_);
n_y_ = (1+l_max_).^2;
n_y_sum = sum(n_y_);
n_y_csum_ = cumsum([0;n_y_]);

x_0_x_ = reshape(x_3x__(1+0,:),[n_x,1]);
x_1_x_ = reshape(x_3x__(1+1,:),[n_x,1]);
x_2_x_ = reshape(x_3x__(1+2,:),[n_x,1]);
x_p_r_x_ = sqrt(x_0_x_.^2 + x_1_x_.^2 + x_2_x_.^2);
x_p_r01_x_ = sqrt(x_0_x_.^2 + x_1_x_.^2);
x_p_azimu_b_x_ = atan2(x_1_x_,x_0_x_);
x_p_polar_a_x_ = atan2(x_p_r01_x_,x_2_x_); %<-- assumed to have no special clustered structure. ;

tmp_t=tic();
parameter_ylgndr = parameter;
parameter_ylgndr.flag_verbose = 0;
parameter_ylgndr.flag_d = 0;
parameter_ylgndr.flag_dd = 0;
[ ...
 parameter_ylgndr ...
,d0y_xlm___ ...
,~ ...
,~ ...
,sqrt_2lp1_ ...
,sqrt_2mp1_ ...
,sqrt_rat0_m_ ...
,sqrt_rat3_lm__ ...
,sqrt_rat4_lm__ ...
] = ...
ylgndr_2( ...
 parameter_ylgndr ...
,l_max_max ...
,cos(x_p_polar_a_x_) ...
,sqrt_2lp1_ ...
,sqrt_2mp1_ ...
,sqrt_rat0_m_ ...
,sqrt_rat3_lm__ ...
,sqrt_rat4_lm__ ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ylgndr_2: time %0.6fs',tmp_t)); end;

tmp_t=tic();
t_p_kx__ = 2*pi*bsxfun(@times,reshape(k_p_r_,[n_k_p_r,1]),reshape(x_p_r_x_,[1,n_x]));
tmp_index_big_ = efind(abs(t_p_kx__)>=1e-12);
t_p_kx_big_ = t_p_kx__(1+tmp_index_big_);
tmp_index_sml_ = efind(abs(t_p_kx__)< 1e-12);
jl_kxl___ = zeros(n_k_p_r,n_x,1+l_max_max);
for l_val=0:l_max_max;
tmp_jl_kx__ = zeros(n_k_p_r,n_x) + 1*(l_val==0);
tmp_jl_kx__(1+tmp_index_big_) = besselj(l_val+0.5,t_p_kx_big_).*sqrt(pi./(2*t_p_kx_big_));
jl_kxl___(:,:,1+l_val) = tmp_jl_kx__;
end;%for l_val=0:l_max_max;
jl_xlk___ = permute(jl_kxl___,1+[1,2,0]);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% jl_xlk__: time %0.6fs',tmp_t)); end;

tmp_t=tic();
m_val_ = transpose(-l_max_max:+l_max_max);
%expimb_xm__ = exp(+i*bsxfun(@times,reshape(x_p_azimu_b_x_,[n_x,1]),reshape(m_val_,[1,1+2*l_max_max])));
exnimb_xm__ = exp(-i*bsxfun(@times,reshape(x_p_azimu_b_x_,[n_x,1]),reshape(m_val_,[1,1+2*l_max_max])));
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% exnimb_xm__: time %0.6fs',tmp_t)); end;

tmp_t=tic();
n_1 = 1;
a_k_Y_lmk___ = zeros(1+l_max_max,1+2*l_max_max,n_k_p_r);
a_k_Y_lmk___ = ...
reshape( ...
	 sum( 4*pi * ...
	      bsxfun(@times ...
		     ,reshape(i.^[0:l_max_max],[n_1,1+l_max_max,n_1,n_1]) ...
		     ,bsxfun(@times ...
			     ,reshape(jl_xlk___,[n_x,1+l_max_max,n_1,n_k_p_r]) ...
			     ,bsxfun(@times ...
				     ,reshape(d0y_xlm___(:,:,1+abs(-l_max_max:+l_max_max)),[n_x,1+l_max_max,1+2*l_max_max,n_1]) ...
				     ,reshape(exnimb_xm__,[n_x,n_1,1+2*l_max_max,n_1]) ...
				    ) ...
			    ) ...
		    ) ...
	      / sqrt(4*pi) ...
	      , 1+0 ...
	    ) ...
	 ,[1+l_max_max,1+2*l_max_max,n_k_p_r] ...
       );
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% a_k_Y_lmk___: time %0.6fs',tmp_t)); end;

tmp_t=tic();
a_k_Y_yk_ = zeros(n_y_sum,1);
na=0;
for nk_p_r=0:n_k_p_r-1;
l_max = l_max_(1+nk_p_r);
for l_val=0:l_max;
m_val_ = -l_val:+l_val;
a_k_Y_yk_(1+na+l_val+m_val_) = a_k_Y_lmk___(1+l_val,1+l_max_max+m_val_,1+nk_p_r);
na=na+1+2*l_val;
end;%for l_val=0:l_max;
end;%for nk_p_r=0:n_k_p_r-1;
assert(na==n_y_sum);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% a_k_Y_yk_: time %0.6fs',tmp_t)); end;

if (flag_verbose>0); disp(sprintf(' %% [finished %s]',str_thisfunction)); end;
