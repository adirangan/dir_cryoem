%{
  % test nufft1d3;
  clear;
  res = 255;
  x_p_r_max = +1.00d0; x_0_ = linspace(-x_p_r_max,+x_p_r_max,res); [X_0_] = x_0_;
  n_x_c = numel(X_0_);
  k_all_max = 15; n_all = 143;
  [k_all_,weight_all_] = chebpts(n_all); k_all_ = k_all_*k_all_max; weight_all_ = weight_all_*k_all_max;
  %%%%%%%%;
  x_0 = -0.15; x_s = 0.25; x_r = 1.0d0/x_s;
  g_x_c_ = 1/sqrt(2*pi)^1 * 1/x_s^1 * exp(-( (X_0_ - x_0).^2 ) / (2*x_s^2) );
  h_all_ = exp(-i*2*pi*k_all_*x_0) .* exp(-( (2*pi*k_all_).^2 ) / (2*x_r^2) );
  weight_x_c = 2.0d0 * x_p_r_max / (n_x_c) ;
  g_all_ = nufft1d3(n_x_c,pi*X_0_(:),g_x_c_(:)*weight_x_c,-1,1e-12,n_all,2*pi*k_all_/pi);
  %%%%%%%%;
  k_z = pi/max(2*pi*k_all_max/pi);
  b_x_c_ = nufft1d3(n_all,k_z*2*pi*k_all_/pi,g_all_(:).*weight_all_(:),+1,1e-12,n_x_c,pi*X_0_(:)/k_z);
  b_x_c_ = reshape(b_x_c_,size(g_x_c_));
  %%%%%%%%;
  disp(sprintf(' %% error %0.16f',fnorm(g_x_c_-b_x_c_)/fnorm(g_x_c_)));
  clf; 
  subplot(1,2,1);
  hold on; 
  plot(k_all_,real(h_all_),'ro-',k_all_,real(g_all_),'rx-');
  plot(k_all_,imag(h_all_),'bo-',k_all_,imag(g_all_),'bx-');
  hold off;
  xlabel('k'); ylabel('h(k) vs g(k)');
  subplot(1,2,2);
  hold on; 
  plot(X_0_,real(g_x_c_),'ro-',X_0_,real(b_x_c_),'rx-');
  plot(X_0_,imag(g_x_c_),'bo-',X_0_,imag(b_x_c_),'bx-');
  hold off;
  xlabel('x'); ylabel('g(x) vs b(x)');
  figbig;
  %}

%{
  % test nufft1d3;
  clear;
  res = 163; eps_nufft = 1e-3;
  x_p_r_max = +1.00d0; 
  [x_c_0_,w_x_c_0_] = chebpts(res); n_x_c_0 = numel(x_c_0_);
  [X_c_0_] = x_c_0_;
  w_x_c_ = w_x_c_0_;
  k_p_r_max = +15.0d0;
  [k_c_0_,w_k_c_0_] = chebpts(res+2); n_k_c_0 = numel(k_c_0_); k_c_0_ = k_p_r_max*k_c_0_; w_k_c_0_ = k_p_r_max*w_k_c_0_;
  [K_c_0_] = k_c_0_;
  w_k_c_ = w_k_c_0_;
  %%%%%%%%;
  x_c_0 = -0.15; x_s = 0.25; x_r = 1.0d0/x_s;
  g_x_c_ = 1/sqrt(2*pi)^1 * 1/x_s^1 * exp(-( (X_c_0_ - x_c_0).^2 ) / (2*x_s^2) );
  h_k_c_ = exp(-i*2*pi*K_c_0_*x_c_0) .* exp(-( (2*pi*K_c_0_).^2 ) / (2*x_r^2) );
  f_k_c_ = nufft1d3(n_x_c_0,pi*X_c_0_(:),g_x_c_(:).*w_x_c_(:),-1,eps_nufft,n_k_c_0,2*pi*K_c_0_(:)/pi);
  %%%%%%%%;
  k_z = pi/max(2*pi*k_p_r_max/pi);
  f_x_c_ = nufft1d3(n_k_c_0,k_z*2*pi*K_c_0_(:)/pi,f_k_c_(:).*w_k_c_(:),+1,eps_nufft,n_x_c_0,pi*X_c_0_(:)/k_z);
  f_x_c_ = reshape(f_x_c_,size(g_x_c_));
  %%%%%%%%;
  disp(sprintf(' %% error %0.16f',fnorm(g_x_c_-f_x_c_)/fnorm(g_x_c_)));
  clf; 
  subplot(1,2,1);
  hold on; 
  plot(k_c_0_,real(h_k_c_),'ro-',k_c_0_,real(f_k_c_),'rx-');
  plot(k_c_0_,imag(h_k_c_),'bo-',k_c_0_,imag(f_k_c_),'bx-');
  hold off;
  xlabel('k'); ylabel('h(k) vs f(k)');
  subplot(1,2,2);
  hold on; 
  plot(x_c_0_,real(g_x_c_),'ro-',x_c_0_,real(f_x_c_),'rx-');
  plot(x_c_0_,imag(g_x_c_),'bo-',x_c_0_,imag(f_x_c_),'bx-');
  hold off;
  xlabel('x'); ylabel('g(x) vs f(x)');
  figbig;
  %}

%{
  % test nufft3d3 with tensor product grid. ;
  clear;
  res = 163; eps_nufft = 1e-3;
  x_p_r_max = +1.00d0; 
  [x_c_0_,w_x_c_0_] = chebpts(res+0); n_x_c_0 = numel(x_c_0_);
  [x_c_1_,w_x_c_1_] = chebpts(res+1); n_x_c_1 = numel(x_c_1_);
  [x_c_2_,w_x_c_2_] = chebpts(res+2); n_x_c_2 = numel(x_c_2_);
  [X_c_0_,X_c_1_,X_c_2_] = meshgrid(x_c_0_,x_c_1_,x_c_2_);
  [W_x_c_0_,W_x_c_1_,W_x_c_2_] = meshgrid(w_x_c_0_,w_x_c_1_,w_x_c_2_);
  W_x_c_ = W_x_c_0_.*W_x_c_1_.*W_x_c_2_;
  k_p_r_max = +15.0d0; 
  [k_c_0_,w_k_c_0_] = chebpts(res+3); n_k_c_0 = numel(k_c_0_); k_c_0_ = k_p_r_max*k_c_0_; w_k_c_0_ = k_p_r_max*w_k_c_0_;
  [k_c_1_,w_k_c_1_] = chebpts(res+4); n_k_c_1 = numel(k_c_1_); k_c_1_ = k_p_r_max*k_c_1_; w_k_c_1_ = k_p_r_max*w_k_c_1_;
  [k_c_2_,w_k_c_2_] = chebpts(res+5); n_k_c_2 = numel(k_c_2_); k_c_2_ = k_p_r_max*k_c_2_; w_k_c_2_ = k_p_r_max*w_k_c_2_;
  [K_c_0_,K_c_1_,K_c_2_] = meshgrid(k_c_0_,k_c_1_,k_c_2_);
  [W_k_c_0_,W_k_c_1_,W_k_c_2_] = meshgrid(w_k_c_0_,w_k_c_1_,w_k_c_2_);
  W_k_c_ = W_k_c_0_.*W_k_c_1_.*W_k_c_2_;
  %%%%%%%%;
  x_c_0 = +0.15; x_c_1 = -0.25; x_c_2 = +0.35; x_s = 0.25; x_r = 1.0d0/x_s;
  g_x_c_ = 1/sqrt(2*pi)^3 * 1/x_s^3 * exp(-( (X_c_0_ - x_c_0).^2 + (X_c_1_ - x_c_1).^2 + (X_c_2_ - x_c_2).^2 ) / (2*x_s^2) );
  h_k_c_ = exp(-i*2*pi*(K_c_0_*x_c_0 + K_c_1_*x_c_1 + K_c_2_*x_c_2)) .* exp(-( (2*pi*K_c_0_).^2 + (2*pi*K_c_1_).^2 + (2*pi*K_c_2_).^2 ) / (2*x_r^2) );
  f_k_c_ = nufft3d3(n_x_c_0*n_x_c_1*n_x_c_2,pi*X_c_0_(:),pi*X_c_1_(:),pi*X_c_2_(:),g_x_c_(:).*W_x_c_(:),-1,eps_nufft,n_k_c_0*n_k_c_1*n_k_c_2,2*pi*K_c_0_(:)/pi,2*pi*K_c_1_(:)/pi,2*pi*K_c_2_(:)/pi);
  %%%%%%%%;
  k_z = pi/max(2*pi*k_p_r_max/pi);
  f_x_c_ = nufft3d3(n_k_c_0*n_k_c_1*n_k_c_2,k_z*2*pi*K_c_0_(:)/pi,k_z*2*pi*K_c_1_(:)/pi,k_z*2*pi*K_c_2_(:)/pi,f_k_c_(:).*W_k_c_(:),+1,eps_nufft,n_x_c_0*n_x_c_1*n_x_c_2,pi*X_c_0_(:)/k_z,pi*X_c_1_(:)/k_z,pi*X_c_2_(:)/k_z);
  f_x_c_ = reshape(f_x_c_,size(g_x_c_));
  %%%%%%%%;
  disp(sprintf(' %% error %0.16f',fnorm(g_x_c_-f_x_c_)/fnorm(g_x_c_)));  
  %}

%{
  % test nufft3d3 with spherical grid. ; 
  clear;
  eq_d = 1/32; eps_nufft = 1e-6;
  x_p_r_max = +1.00d0; [n_x,n_x_sub_,x_p_r_,x_p_azimu_b_,x_p_polar_a_,weight_x_,~,~,~,X_c_0_,X_c_1_,X_c_2_] = sample_sphere_5(0,x_p_r_max,eq_d,'L') ;
  k_p_r_max = +15.0d0; [n_k,n_k_sub_,k_p_r_,k_p_azimu_b_,k_p_polar_a_,weight_k_,~,~,~,K_c_0_,K_c_1_,K_c_2_] = sample_sphere_5(0,k_p_r_max,eq_d*k_p_r_max*0.95,'L') ;
  flag_plot=0;
  if flag_plot;
  scatter3(K_c_0_,K_c_1_,K_c_2_,2); 
  xlim([-k_p_r_max,+k_p_r_max]); 
  ylim([-k_p_r_max,+k_p_r_max]); 
  zlim([-k_p_r_max,+k_p_r_max]); 
  axis vis3d;
  end;%if flag_plot;
  %%%%%%%%;
  x_c_0 = +0.15; x_c_1 = -0.25; x_c_2 = +0.35; x_s = 0.125; x_r = 1.0d0/x_s;
  delta_p_r = sqrt(x_c_0^2 + x_c_1^2 + x_c_2^2);
  disp(sprintf(' %% 2*pi*k_p_r_max*delta_p_r = %0.2f',2*pi*k_p_r_max*delta_p_r));
  g_x_c_ = 1/sqrt(2*pi)^3 * 1/x_s^3 * exp(-( (X_c_0_ - x_c_0).^2 + (X_c_1_ - x_c_1).^2 + (X_c_2_ - x_c_2).^2 ) / (2*x_s^2) );
  h_k_c_ = exp(-i*2*pi*(K_c_0_*x_c_0 + K_c_1_*x_c_1 + K_c_2_*x_c_2)) .* exp(-( (2*pi*K_c_0_).^2 + (2*pi*K_c_1_).^2 + (2*pi*K_c_2_).^2 ) / (2*x_r^2) );
  f_k_c_ = nufft3d3(n_x,pi*X_c_0_(:),pi*X_c_1_(:),pi*X_c_2_(:),g_x_c_(:).*weight_x_(:),-1,eps_nufft,n_k,2*pi*K_c_0_(:)/pi,2*pi*K_c_1_(:)/pi,2*pi*K_c_2_(:)/pi);
  disp(sprintf(' %% h_k_c_ vs f_k_c_ error %0.16f',fnorm(h_k_c_-f_k_c_)/fnorm(h_k_c_)));
  %%%%%%%%;
  k_z = pi/max(2*pi*k_p_r_max/pi);
  f_x_c_ = nufft3d3(n_k,k_z*2*pi*K_c_0_(:)/pi,k_z*2*pi*K_c_1_(:)/pi,k_z*2*pi*K_c_2_(:)/pi,f_k_c_(:).*weight_k_(:),+1,eps_nufft,n_x,pi*X_c_0_(:)/k_z,pi*X_c_1_(:)/k_z,pi*X_c_2_(:)/k_z);
  f_x_c_ = reshape(f_x_c_,size(g_x_c_));
  %%%%%%%%;
  disp(sprintf(' %% g_x_c_ vs f_x_c_ error %0.16f',fnorm(g_x_c_-f_x_c_)/fnorm(g_x_c_)));  
  %}

% now finally test convert_spharm_to_x_c;
clear;
verbose=0;
eps_nufft = 1e-6;
k_p_r_max = 9.0d0; k_eq_d = (1/32)*k_p_r_max*0.95;
tmp_t = tic;
[n_k_all,n_k_all_csum_,k_p_r_all_,k_p_azimu_b_all_,k_p_polar_a_all_,weight_k_all_,weight_shell_k_,n_k_p_r,k_p_r_,weight_k_p_r_,k_c_0_all_,k_c_1_all_,k_c_2_all_] = sample_sphere_6(verbose,k_p_r_max,k_eq_d,'L') ;
x_p_r_max = 1.00d0; x_eq_d = (1/32)*x_p_r_max*1.00;
[n_x_all,n_x_all_csum_,x_p_r_all_,x_p_azimu_b_all_,x_p_polar_a_all_,weight_x_all_,weight_x_shell_,n_x_p_r,x_p_r_,weight_x_p_r_,x_c_0_all_,x_c_1_all_,x_c_2_all_] = sample_sphere_6(verbose,x_p_r_max,x_eq_d,'L') ;
tmp_t = toc(tmp_t); tmp_g = (n_x_all+n_k_all)/tmp_t/1e6;
disp(sprintf(' %% generating grids... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
%%%%%%%%;
delta_c_0 = +0.15; delta_c_1 = -0.25; delta_c_2 = +0.35; x_s = 0.125; x_r = 1.0d0/x_s;
delta_p_r = sqrt(delta_c_0^2 + delta_c_1^2 + delta_c_2^2);
disp(sprintf(' %% 2*pi*k_p_r_max*delta_p_r = %0.2f',2*pi*k_p_r_max*delta_p_r));
a_x_all_form_ = 1/sqrt(2*pi)^3 * 1/x_s^3 * exp(-( (x_c_0_all_ - delta_c_0).^2 + (x_c_1_all_ - delta_c_1).^2 + (x_c_2_all_ - delta_c_2).^2 ) / (2*x_s^2) );
a_k_all_form_ = exp(-i*2*pi*(k_c_0_all_*delta_c_0 + k_c_1_all_*delta_c_1 + k_c_2_all_*delta_c_2)) .* exp(-( (2*pi*k_c_0_all_).^2 + (2*pi*k_c_1_all_).^2 + (2*pi*k_c_2_all_).^2 ) / (2*x_r^2) );
tmp_t = tic;
a_k_all_quad_ = nufft3d3(n_x_all,pi*x_c_0_all_(:),pi*x_c_1_all_(:),pi*x_c_2_all_(:),a_x_all_form_(:).*weight_x_all_(:),-1,eps_nufft,n_k_all,2*pi*k_c_0_all_(:)/pi,2*pi*k_c_1_all_(:)/pi,2*pi*k_c_2_all_(:)/pi);
tmp_t = toc(tmp_t); tmp_g = n_k_all*log(n_k_all)/tmp_t/1e6;
disp(sprintf(' %% use nufft3d3 to form a_k_all_quad_... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
disp(sprintf(' %% a_k_all_form_ vs a_k_all_quad_ error %0.16f',fnorm(a_k_all_form_ - a_k_all_quad_)/fnorm(a_k_all_form_)));
disp(sprintf(' %% at this point one should ensure that a_k_all_ on the outer shells (i.e., near k_p_r_max) has decayed to the desired precision.'));
disp(sprintf(' %% Setting l_val_ = 1+ceil(2*pi*k_p_r_). Note that this should be limited by the sampling density at each k_p_r!'));
l_val_ = 1+ceil(2*pi*k_p_r_); n_lm_ = (l_val_+1).^2; n_lm_sum = sum(n_lm_); a_k_Y_quad_ = zeros(n_lm_sum,1);
tmp_t = tic;
[a_k_Y_quad_] = convert_k_p_to_spharm_1(verbose,n_k_all,n_k_all_csum_,k_p_r_all_,k_p_azimu_b_all_,k_p_polar_a_all_,weight_k_all_,weight_shell_k_,n_k_p_r,k_p_r_,weight_k_p_r_,l_val_,a_k_all_form_);
tmp_t = toc(tmp_t); tmp_g = n_lm_sum/tmp_t/1e6;
disp(sprintf(' %% use convert_k_p_to_spharm_1 to form a_k_Y_quad_... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
disp(sprintf(' %% Again, here we should ensure that a_k_Y_ on the outer shells has decayed to the desired precision.'));
disp(sprintf(' %% Moreover, we should ensure that a_k_Y_(l,m) has decayed for large l,m at each shell.'));
flag_plot=0;
if flag_plot;
imagesc_Y(k_p_r_max,n_k_p_r,k_p_r_,l_val_,real(a_k_Y_quad_),[],colormap_beach());
end;%if flag_plot;
tmp_t = tic;
a_k_all_quad_ = convert_spharm_to_k_p_1(verbose,n_k_all,n_k_all_csum_,k_p_r_all_,k_p_azimu_b_all_,k_p_polar_a_all_,weight_k_all_,weight_shell_k_,n_k_p_r,k_p_r_,weight_k_p_r_,l_val_,a_k_Y_quad_);
tmp_t = toc(tmp_t); tmp_n = dot( (l_val_+1).^2 , diff([n_k_all_csum_;n_k_all]) ); tmp_g = tmp_n/tmp_t/1e6;
disp(sprintf(' %% use convert_spharm_to_k_p_1 to form a_k_all_quad_... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
disp(sprintf(' %% a_k_all_form_ vs a_k_all_quad_ error %0.16f',fnorm(a_k_all_form_ - a_k_all_quad_)/fnorm(a_k_all_form_)));
k_z = pi/max(2*pi*k_p_r_max/pi); eps_nufft = 1e-3;
tmp_t = tic;
a_x_all_quad_ = nufft3d3(n_k_all,k_z*2*pi*k_c_0_all_(:)/pi,k_z*2*pi*k_c_1_all_(:)/pi,k_z*2*pi*k_c_2_all_(:)/pi,a_k_all_form_(:).*weight_k_all_(:),+1,eps_nufft,n_x_all,pi*x_c_0_all_(:)/k_z,pi*x_c_1_all_(:)/k_z,pi*x_c_2_all_(:)/k_z);
tmp_t = toc(tmp_t); tmp_g = n_x_all*log(n_x_all)/tmp_t/1e6;
disp(sprintf(' %% use nufft3d3 to form a_x_all_quad_... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
disp(sprintf(' %% a_x_all_form_ vs a_x_all_quad_ error %0.16f',fnorm(a_x_all_form_ - a_x_all_quad_)/fnorm(a_x_all_form_)));
p_sub_ = randperm(n_x_all); p_sub_ = p_sub_(1:1000); n_x_sub = numel(p_sub_);
a_x_sub_form_ = a_x_all_form_(p_sub_);
tmp_t = tic;
a_x_sub_quad_ = convert_spharm_to_x_p_2(verbose,n_k_p_r,k_p_r_,weight_k_p_r_,l_val_,a_k_Y_quad_,n_x_sub,x_p_r_all_(p_sub_),x_p_azimu_b_all_(p_sub_),x_p_polar_a_all_(p_sub_));
tmp_t = toc(tmp_t); tmp_n = n_x_sub*sum((l_val_+1).^2); tmp_g = tmp_n/tmp_t/1e6;
disp(sprintf(' %% use convert_spharm_to_x_p_2 to form a_x_sub_quad_... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
disp(sprintf(' %% convert_spharm_to_x_p_: a_x_sub_form_ vs a_x_sub_quad_ error %0.16f',fnorm(a_x_sub_form_ - a_x_sub_quad_)/fnorm(a_x_sub_form_)));
tmp_t = tic;
a_x_sub_quad_ = convert_spharm_to_x_c_2(verbose,n_k_p_r,k_p_r_,weight_k_p_r_,l_val_,a_k_Y_quad_,n_x_sub,x_c_0_all_(p_sub_),x_c_1_all_(p_sub_),x_c_2_all_(p_sub_));
tmp_t = toc(tmp_t); tmp_n = n_x_sub*sum((l_val_+1).^2); tmp_g = tmp_n/tmp_t/1e6;
disp(sprintf(' %% use convert_spharm_to_x_c_2 to form a_x_sub_quad_... time %0.6fs (%0.6f Mnumps)',tmp_t,tmp_g));
disp(sprintf(' %% convert_spharm_to_x_c_: a_x_sub_form_ vs a_x_sub_quad_ error %0.16f',fnorm(a_x_sub_form_ - a_x_sub_quad_)/fnorm(a_x_sub_form_)));

