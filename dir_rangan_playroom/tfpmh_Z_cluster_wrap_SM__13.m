function ...
[ ...
 parameter ...
,Z_SM__ ...
,UX_CTF_R_S_l2_SM__ ...
,UX_T_M_l2_SM__ ...
,X_SM__ ...
,delta_x_SM__ ...
,delta_y_SM__ ...
,gamma_z_SM__ ...
,index_sub_SM__ ...
,index_nM_from_ncluster__ ...
,n_index_nM_from_ncluster_ ...
,M_k_q_wkM__ ...
,UX_T_M_l2_dM__ ...
,UX_M_l2_M_ ...
,CTF_M_k_q_wkM__ ...
,CTF_k_q_wkM__ ...
,UX_CC_k_q_wnM__ ...
,svd_V_UX_CTF_M_lwnM____ ...
,svd_V_UX_M_lwnM____ ...
,UX_S_k_q_wnS__ ...
,UX_SS_k_q_wnS__ ...
] = ...
tfpmh_Z_cluster_wrap_SM__13( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_S ...
,S_k_p_wkS__ ...
,n_CTF ...
,CTF_k_p_wkC__ ...
,index_nCTF_from_nM_ ...
,n_M ...
,M_k_p_wkM__ ...
,n_cluster ...
,index_ncluster_from_nCTF_ ...
,pm_n_UX_rank_c_ ...
,pm_UX_knc___ ...
,pm_X_weight_rc__ ...
,FTK ...
,index_nM_to_update_ ...
,M_k_q_wkM__ ...
,UX_T_M_l2_dM__ ...
,UX_M_l2_M_ ...
,CTF_M_k_q_wkM__ ...
,CTF_k_q_wkM__ ...
,UX_CC_k_q_wnM__ ...
,svd_V_UX_CTF_M_lwnM____ ...
,svd_V_UX_M_lwnM____ ...
,index_nS_to_update_ ...
,UX_S_k_q_wnS__ ...
,UX_SS_k_q_wnS__ ...
);
%%%%%%%%;
% wrapper for tfpmh_Z_wSM___13. ;
% Note that the radial compression is applied here, but is not structured to align with the canonical innerproduct. ;
% (i.e., only use radial compression when the loss is low). ;
%%%%%%%%;

str_thisfunction = 'tfpmh_Z_cluster_wrap_SM__13';

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
if nargin<1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
test_tfpmh_Z_cluster_wrap_SM__13;
disp('returning'); return;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%if nargin<1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

na=0;
if (nargin<1+na); parameter=[]; end; na=na+1;
if (nargin<1+na); n_k_p_r=[]; end; na=na+1;
if (nargin<1+na); k_p_r_=[]; end; na=na+1;
if (nargin<1+na); k_p_r_max=[]; end; na=na+1;
if (nargin<1+na); n_w_=[]; end; na=na+1;
if (nargin<1+na); weight_2d_k_p_r_=[]; end; na=na+1;
if (nargin<1+na); weight_2d_k_p_wk_=[]; end; na=na+1;
if (nargin<1+na); n_S=[]; end; na=na+1;
if (nargin<1+na); S_k_p_wkS__=[]; end; na=na+1;
if (nargin<1+na); n_CTF=[]; end; na=na+1;
if (nargin<1+na); CTF_k_p_wkC__=[]; end; na=na+1;
if (nargin<1+na); index_nCTF_from_nM_=[]; end; na=na+1;
if (nargin<1+na); n_M=[]; end; na=na+1;
if (nargin<1+na); M_k_p_wkM__=[]; end; na=na+1;
if (nargin<1+na); n_cluster=[]; end; na=na+1;
if (nargin<1+na); index_ncluster_from_nCTF_=[]; end; na=na+1;
if (nargin<1+na); pm_n_UX_rank_c_=[]; end; na=na+1;
if (nargin<1+na); pm_UX_knc___=[]; end; na=na+1;
if (nargin<1+na); pm_X_weight_rc__=[]; end; na=na+1;
if (nargin<1+na); FTK=[]; end; na=na+1;
if (nargin<1+na); index_nM_to_update_=[]; end; na=na+1;
if (nargin<1+na); M_k_q_wkM__=[]; end; na=na+1;
if (nargin<1+na); UX_T_M_l2_dM__=[]; end; na=na+1;
if (nargin<1+na); UX_M_l2_M_=[]; end; na=na+1;
if (nargin<1+na); CTF_M_k_q_wkM__=[]; end; na=na+1;
if (nargin<1+na); CTF_k_q_wkM__=[]; end; na=na+1;
if (nargin<1+na); UX_CC_k_q_wnM__=[]; end; na=na+1;
if (nargin<1+na); svd_V_UX_CTF_M_lwnM____=[]; end; na=na+1;
if (nargin<1+na); svd_V_UX_M_lwnM____=[]; end; na=na+1;
if (nargin<1+na); index_nS_to_update_=[]; end; na=na+1;
if (nargin<1+na); UX_S_k_q_wnS__=[]; end; na=na+1;
if (nargin<1+na); UX_SS_k_q_wnS__=[]; end; na=na+1;

%%%%%%%%;
if isempty(parameter); parameter = struct('type','parameter'); end;%if isempty(parameter);
if ~isfield(parameter,'flag_verbose'); parameter.flag_verbose=0; end;
flag_verbose = parameter.flag_verbose;
%%%%%%%%;
if ~isfield(parameter,'flag_precompute_M_k_q_wkM__'); parameter.flag_precompute_M_k_q_wkM__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_M_k_q_wkM__ = parameter.flag_precompute_M_k_q_wkM__;
if ~isfield(parameter,'flag_precompute_UX_T_M_l2_dM__'); parameter.flag_precompute_UX_T_M_l2_dM__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_UX_T_M_l2_dM__ = parameter.flag_precompute_UX_T_M_l2_dM__;
if ~isfield(parameter,'flag_precompute_UX_M_l2_M_'); parameter.flag_precompute_UX_M_l2_M_ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_UX_M_l2_M_ = parameter.flag_precompute_UX_M_l2_M_;
if ~isfield(parameter,'flag_precompute_CTF_M_k_q_wkM__'); parameter.flag_precompute_CTF_M_k_q_wkM__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_CTF_M_k_q_wkM__ = parameter.flag_precompute_CTF_M_k_q_wkM__;
if ~isfield(parameter,'flag_precompute_CTF_k_q_wkM__'); parameter.flag_precompute_CTF_k_q_wkM__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_CTF_k_q_wkM__ = parameter.flag_precompute_CTF_k_q_wkM__;
if ~isfield(parameter,'flag_precompute_UX_CC_k_q_wnM__'); parameter.flag_precompute_UX_CC_k_q_wnM__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_UX_CC_k_q_wnM__ = parameter.flag_precompute_UX_CC_k_q_wnM__;
if ~isfield(parameter,'flag_precompute_svd_V_UX_CTF_M_lwnM____'); parameter.flag_precompute_svd_V_UX_CTF_M_lwnM____ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_svd_V_UX_CTF_M_lwnM____ = parameter.flag_precompute_svd_V_UX_CTF_M_lwnM____;
if ~isfield(parameter,'flag_precompute_svd_V_UX_M_lwnM____'); parameter.flag_precompute_svd_V_UX_M_lwnM____ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_svd_V_UX_M_lwnM____ = parameter.flag_precompute_svd_V_UX_M_lwnM____;
if ~isfield(parameter,'flag_precompute_UX_S_k_q_wnS__'); parameter.flag_precompute_UX_S_k_q_wnS__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_UX_S_k_q_wnS__ = parameter.flag_precompute_UX_S_k_q_wnS__;
if ~isfield(parameter,'flag_precompute_UX_SS_k_q_wnS__'); parameter.flag_precompute_UX_SS_k_q_wnS__ = 0; end; %<-- parameter_bookmark. ;
flag_precompute_UX_SS_k_q_wnS__ = parameter.flag_precompute_UX_SS_k_q_wnS__;
%%%%%%%%;

if (flag_verbose>0); disp(sprintf(' %% [entering tfpmh_Z_cluster_wrap_SM__13]')); end;

n_byte_per_float32 = 4; n_byte_per_float64 = 8;
n_byte_per_complex64 = 8; n_byte_per_complex128 = 16;

n_w_ = n_w_(:);
n_w_max = max(n_w_);
n_w_sum = sum(n_w_);
n_w_csum_ = cumsum([0;n_w_]);
if (n_w_sum~=n_w_max*n_k_p_r); disp(sprintf(' %% Warning, n_w_sum %d ~= n_w_max*n_k_p_r %d*%d in %s',n_w_sum,n_w_max,n_k_p_r,str_thisfunction)); end;
if mod(n_w_max,2)~=0; disp(sprintf(' %% Warning, n_w_max %d in %s',n_w_max,str_thisfunction)); end;
n_delta_v = FTK.n_delta_v;
n_svd_l = FTK.n_svd_l;

%%%%%%%%;
% group images by cluster. ;
%%%%%%%%;
n_cluster = 1+max(index_ncluster_from_nCTF_);
index_ncluster_from_nM_ = index_ncluster_from_nCTF_(1+index_nCTF_from_nM_);
index_nM_from_ncluster__ = cell(n_cluster,1);
n_index_nM_from_ncluster_ = zeros(n_cluster,1);
for ncluster=0:n_cluster-1;
index_nM_from_ncluster__{1+ncluster} = efind(index_ncluster_from_nM_==ncluster);
n_index_nM_from_ncluster_(1+ncluster) = numel(index_nM_from_ncluster__{1+ncluster});
end;%for ncluster=0:n_cluster-1;
%%%%%%%%;
pm_n_UX_rank_max = max(pm_n_UX_rank_c_);
pm_n_w_sum_max = n_w_max*pm_n_UX_rank_max;
%%%%%%%%;
if isempty(M_k_q_wkM__); M_k_q_wkM__=zeros(n_w_sum,n_M); end;
if isempty(UX_T_M_l2_dM__); UX_T_M_l2_dM__=zeros(n_delta_v,n_M); end;
if isempty(UX_M_l2_M_); UX_M_l2_M_=zeros(n_M,1); end;
if isempty(CTF_M_k_q_wkM__); CTF_M_k_q_wkM__=zeros(n_w_sum,n_M); end;
if isempty(CTF_k_q_wkM__); CTF_k_q_wkM__=zeros(n_w_sum,n_M); end;
if isempty(UX_CC_k_q_wnM__); UX_CC_k_q_wnM__=zeros(pm_n_w_sum_max,n_M); end;
if isempty(svd_V_UX_CTF_M_lwnM____); svd_V_UX_CTF_M_lwnM____=zeros(n_svd_l,n_w_max,pm_n_UX_rank_max,n_M); end;
if isempty(svd_V_UX_M_lwnM____); svd_V_UX_M_lwnM____=zeros(n_svd_l,n_w_max,pm_n_UX_rank_max,n_M); end;
if isempty(UX_S_k_q_wnS__); UX_S_k_q_wnS__=zeros(pm_n_w_sum_max,n_S); end;
if isempty(UX_SS_k_q_wnS__); UX_SS_k_q_wnS__=zeros(pm_n_w_sum_max,n_S); end;

Z_SM__ = zeros(n_S,n_M);
UX_CTF_R_S_l2_SM__ = zeros(n_S,n_M);
UX_T_M_l2_SM__ = zeros(n_S,n_M);
X_SM__ = zeros(n_S,n_M);
delta_x_SM__ = zeros(n_S,n_M);
delta_y_SM__ = zeros(n_S,n_M);
gamma_z_SM__ = zeros(n_S,n_M);
index_sub_SM__ = zeros(n_S,n_M);

for ncluster=0:n_cluster-1;
index_nM_from_ncluster_ = index_nM_from_ncluster__{1+ncluster};
n_M_from_ncluster = numel(index_nM_from_ncluster_); assert(n_M_from_ncluster==n_index_nM_from_ncluster_(1+ncluster));
if (n_M_from_ncluster>0);
%%%%%%%%;
tmp_t=tic();
CTF_k_p_wkM__ = CTF_k_p_wkC__(:,1+index_nCTF_from_nM_);
pm_n_UX_rank = pm_n_UX_rank_c_(1+ncluster); pm_n_w_sum = n_w_max*pm_n_UX_rank;
pm_UX_kn__ = pm_UX_knc___(:,1:pm_n_UX_rank,1+ncluster);
pm_X_weight_r_ = pm_X_weight_rc__(:,1+ncluster);
%%%%%%%%;
% precomputation. ;
%%%%%%%%;
[nM_cap_,ij_nM_to_update_from_nM_cap_,ij_nM_from_ncluster_from_nM_cap_] = intersect(index_nM_to_update_,index_nM_from_ncluster_);
index_nM_to_update_from_nM_cap_ = ij_nM_to_update_from_nM_cap_-1;
index_nM_from_ncluster_from_nM_cap_ = ij_nM_from_ncluster_from_nM_cap_-1;
if (flag_verbose>0); disp(sprintf(' %% ncluster %d/%d: n_M_from_ncluster %d %<-- precomputation for %d images, %d templates',ncluster,n_cluster,n_M_from_ncluster,numel(nM_cap_),numel(index_nS_to_update_))); end;
[ ...
 parameter ...
,M_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,UX_T_M_l2_dM__(:,1+index_nM_from_ncluster_) ...
,UX_M_l2_M_(1+index_nM_from_ncluster_) ...
,CTF_M_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,CTF_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,UX_CC_k_q_wnM__(1:pm_n_w_sum,1+index_nM_from_ncluster_) ...
,svd_V_UX_CTF_M_lwnM____(:,:,1:pm_n_UX_rank,1+index_nM_from_ncluster_) ...
,svd_V_UX_M_lwnM____(:,:,1:pm_n_UX_rank,1+index_nM_from_ncluster_) ...
,UX_S_k_q_wnS__(1:pm_n_w_sum,:) ...
,UX_SS_k_q_wnS__(1:pm_n_w_sum,:) ...
] = ...
tfpmhp_Z_wSM___13( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_M_from_ncluster ...
,M_k_p_wkM__(:,1+index_nM_from_ncluster_) ...
,CTF_k_p_wkM__(:,1+index_nM_from_ncluster_) ...
,n_S ...
,S_k_p_wkS__ ...
,pm_n_UX_rank ...
,pm_UX_kn__ ...
,pm_X_weight_r_ ...
,FTK ...
,index_nM_from_ncluster_from_nM_cap_ ...
,M_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,UX_T_M_l2_dM__(:,1+index_nM_from_ncluster_) ...
,UX_M_l2_M_(1+index_nM_from_ncluster_) ...
,CTF_M_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,CTF_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,UX_CC_k_q_wnM__(1:pm_n_w_sum,1+index_nM_from_ncluster_) ...
,svd_V_UX_CTF_M_lwnM____(:,:,1:pm_n_UX_rank,1+index_nM_from_ncluster_) ...
,svd_V_UX_M_lwnM____(:,:,1:pm_n_UX_rank,1+index_nM_from_ncluster_) ...
,index_nS_to_update_ ...
,UX_S_k_q_wnS__(1:pm_n_w_sum,:) ...
,UX_SS_k_q_wnS__(1:pm_n_w_sum,:) ...
);
%%%%%%%%;
% inner-product. ;
%%%%%%%%;
parameter.flag_optimize_over_gamma_z=1;
parameter.flag_dwSM=0;
[ ...
 parameter ...
,Z_SM__(:,1+index_nM_from_ncluster_) ...
,UX_CTF_R_S_l2_SM__(:,1+index_nM_from_ncluster_) ...
,UX_T_M_l2_dM__(:,1+index_nM_from_ncluster_) ...
,UX_M_l2_M_(1+index_nM_from_ncluster_) ...
,X_SM__(:,1+index_nM_from_ncluster_) ...
,delta_x_SM__(:,1+index_nM_from_ncluster_) ...
,delta_y_SM__(:,1+index_nM_from_ncluster_) ...
,gamma_z_SM__(:,1+index_nM_from_ncluster_) ...
,index_sub_SM__(:,1+index_nM_from_ncluster_) ...
] = ...
tfpmh_Z_wSM___13( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_M_from_ncluster ...
,M_k_p_wkM__(:,1+index_nM_from_ncluster_) ...
,CTF_k_p_wkM__(:,1+index_nM_from_ncluster_) ...
,n_S ...
,S_k_p_wkS__ ...
,pm_n_UX_rank ...
,pm_UX_kn__ ...
,pm_X_weight_r_ ...
,FTK ...
,M_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,UX_T_M_l2_dM__(:,1+index_nM_from_ncluster_) ...
,UX_M_l2_M_(1+index_nM_from_ncluster_) ...
,CTF_M_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,CTF_k_q_wkM__(:,1+index_nM_from_ncluster_) ...
,UX_CC_k_q_wnM__(1:pm_n_w_sum,1+index_nM_from_ncluster_) ...
,svd_V_UX_CTF_M_lwnM____(:,:,1:pm_n_UX_rank,1+index_nM_from_ncluster_) ...
,svd_V_UX_M_lwnM____(:,:,1:pm_n_UX_rank,1+index_nM_from_ncluster_) ...
,UX_S_k_q_wnS__(1:pm_n_w_sum,:) ...
,UX_SS_k_q_wnS__(1:pm_n_w_sum,:) ...
);
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% tfpmh_Z_wSM___13: %0.3fs',tmp_t)); end;
parameter = parameter_timing_update(parameter,'tfpmh_Z_wSM___13',tmp_t);
%%%%%%%%;
tmp_t=tic();
for nM_from_ncluster=0:n_M_from_ncluster-1;
nM = index_nM_from_ncluster_(1+nM_from_ncluster);
for nS=0:n_S-1;
tmp_delta_x = delta_x_SM__(1+nS,1+nM); tmp_delta_y = delta_y_SM__(1+nS,1+nM);
tmp_nd = efind( abs(FTK.delta_x_-tmp_delta_x)<1e-12 & abs(FTK.delta_y_-tmp_delta_y)<1e-12 );
UX_T_M_l2_SM__(1+nS,1+nM) = UX_T_M_l2_dM__(1+tmp_nd,1+nM);
end;%for nS=0:n_S-1;
end;%for nM_from_ncluster=0:n_M_from_ncluster-1;
tmp_t=toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% UX_M_l2_SM__: %0.3fs',tmp_t)); end;
%%%%%%%%;
end;%if (n_M_from_ncluster>0);
end;%for ncluster=0:n_cluster-1;

if (flag_verbose>0); disp(sprintf(' %% [finished tfpmh_Z_cluster_wrap_SM__13]')); end;
