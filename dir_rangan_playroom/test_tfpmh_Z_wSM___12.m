flag_verbose=1; flag_disp=0;nf=0;
disp(sprintf(' %% testing tfpmh_Z_wSM___12'));
k_p_r_max = 48/(2*pi); k_eq_d = 1.0/(2*pi); str_L = 'L';
[ ...
 n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
] = ...
get_weight_3d_1( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_L ...
);
%%%%;
n_w_int = 1;
l_max_upb = round(2*pi*k_p_r_max);
l_max_max = min(l_max_upb,1+ceil(2*pi*k_p_r_(end)));
n_w_max = n_w_int*2*(l_max_max+1); n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_0in_ ...
,weight_3d_k_p_r_ ...
);
n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
%%%%;
n_M = 17; n_2 = 2;
delta_2M__ = reshape(linspace(-0.05,+0.05,n_2*n_M),[n_2,n_M]);
M_k_p_wkM__ = zeros(n_w_sum,n_M);
for nM=0:n_M-1;
delta_0 = delta_2M__(1+0,1+nM); delta_1 = delta_2M__(1+1,1+nM);
M_k_p_wkM__(:,1+nM) = M_k_p_wkM__(:,1+nM) + 1*exp(+i*2*pi*(k_c_0_wk_*delta_0 + k_c_1_wk_*delta_1));
end;%for nM=0:n_M-1;
%%%%;
n_S = 19;
delta_2S__ = reshape(linspace(-0.07,+0.07,n_2*n_S),[n_2,n_S]);
S_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
delta_0 = delta_2S__(1+0,1+nS); delta_1 = delta_2S__(1+1,1+nS);
S_k_p_wkS__(:,1+nS) = S_k_p_wkS__(:,1+nS) + i*exp(+i*2*pi*(k_c_0_wk_*delta_0 + k_c_1_wk_*delta_1));
end;%for nM=0:n_M-1;
%%%%;
CTF_phi = 2*pi/3;
CTF_k_p_wk_ = zeros(n_w_sum,1);
CTF_k_p_wk_ = 2*k_p_r_wk_.*cos(k_p_w_wk_ - CTF_phi);
%%%%;
pm_n_UX_rank = n_k_p_r-1;
pm_UX_kn__ = eye(n_k_p_r,pm_n_UX_rank);
pm_X_weight_r_ = sqrt(weight_2d_k_p_r_);
%%%%;
delta_r_max = 0.5/max(1e-12,k_p_r_max); svd_eps = 1e-3; n_delta_v_requested = 7;
FTK = ampmh_FTK_2(n_k_p_r,k_p_r_,k_p_r_max,delta_r_max,svd_eps,n_delta_v_requested);
n_delta_v = FTK.n_delta_v;
n_svd_l = FTK.n_svd_l;
%%%%%%%%;
parameter=struct('type','parameter');
parameter.flag_verbose = 1;
parameter.flag_optimize_over_gamma_z = 0;
parameter.n_M_per_Mbatch = 3;
parameter.n_S_per_Sbatch = 5;
parameter.flag_dwSM = 1;
[ ...
 parameter ...
,tfpmh_Z_wSM___ ...
,tfpmh_UX_R_CTF_S_l2_wS__ ...
,tfpmh_R_CTF_S_l2_wS__ ...
,tfpmh_UX_T_M_l2_dM__ ...
,tfpmh_UX_M_l2_M_ ...
,tfpmh_X_wSM___ ...
,tfpmh_delta_x_wSM___ ...
,tfpmh_delta_y_wSM___ ...
,tfpmh_gamma_z_wSM___ ...
,tfpmh_index_sub_wSM___ ...
,tfpmh_Z_dwSM____ ...
,tfpmh_X_dwSM____ ...
] = ...
tfpmh_Z_wSM___12( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_M ...
,M_k_p_wkM__ ...
,CTF_k_p_wk_ ...
,n_S ...
,S_k_p_wkS__ ...
,pm_n_UX_rank ...
,pm_UX_kn__ ...
,pm_X_weight_r_ ...
,FTK ...
);
%%%%%%%%;
% compare to ../dir_rangan_python/dir_ascii/.ascii. ;
%%%%;
dir_ascii = '../dir_rangan_python/dir_ascii';
n_ascii = 12;
for nascii=0:n_ascii-1;
na=0;
if nascii==na; tmp_str_ascii = 'tfpmh_Z_wSM___'; tmp_local = tfpmh_Z_wSM___; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_UX_R_CTF_S_l2_wS__'; tmp_local = tfpmh_UX_R_CTF_S_l2_wS__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_R_CTF_S_l2_wS__'; tmp_local = tfpmh_R_CTF_S_l2_wS__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_UX_T_M_l2_dM__'; tmp_local = tfpmh_UX_T_M_l2_dM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_UX_M_l2_M_'; tmp_local = tfpmh_UX_M_l2_M_; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_X_wSM___'; tmp_local = tfpmh_X_wSM___; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_delta_x_wSM___'; tmp_local = tfpmh_delta_x_wSM___; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_delta_y_wSM___'; tmp_local = tfpmh_delta_y_wSM___; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_gamma_z_wSM___'; tmp_local = tfpmh_gamma_z_wSM___; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_index_sub_wSM___'; tmp_local = tfpmh_index_sub_wSM___; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_Z_dwSM____'; tmp_local = tfpmh_Z_dwSM____; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_X_dwSM____'; tmp_local = tfpmh_X_dwSM____; tab_p=0; end; na=na+1;
fname_ascii = sprintf('%s/%s.ascii',dir_ascii,tmp_str_ascii);
if ~exist(fname_ascii,'file'); disp(sprintf(' %% Warning, %s not found',fname_ascii)); end;
if  exist(fname_ascii,'file');
if (flag_verbose>1); disp(sprintf(' %% %s found, loading',fname_ascii)); end;
fid = fopen(fname_ascii,'r');
if tab_p==0; tmp_ascii = reshape(cell2mat(textscan(fid,'%f')),size(tmp_local)); end;
if tab_p==1; tmp_ascii = reshape(cell2mat(textscan(fid,'(%f)')),size(tmp_local)); end;
fclose(fid);
fnorm_disp(flag_verbose,tmp_str_ascii,tmp_local,'ascii',tmp_ascii,' %% <-- should be <1e-6');
end;%if  exist(fname_ascii,'file');
end;%for nascii=0:n_ascii-1;
%%%%;

%%%%%%%%;
parameter=struct('type','parameter');
parameter.flag_verbose = 1;
parameter.flag_optimize_over_gamma_z = 1;
parameter.n_M_per_Mbatch = 3;
parameter.n_S_per_Sbatch = 5;
parameter.flag_dwSM = 0;
[ ...
 parameter ...
,tfpmh_Z_SM__ ...
,tfpmh_UX_R_CTF_S_l2_wS__ ...
,tfpmh_R_CTF_S_l2_wS__ ...
,tfpmh_UX_T_M_l2_dM__ ...
,tfpmh_UX_M_l2_M_ ...
,tfpmh_X_SM__ ...
,tfpmh_delta_x_SM__ ...
,tfpmh_delta_y_SM__ ...
,tfpmh_gamma_z_SM__ ...
,tfpmh_index_sub_SM__ ...
] = ...
tfpmh_Z_wSM___12( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_M ...
,M_k_p_wkM__ ...
,CTF_k_p_wk_ ...
,n_S ...
,S_k_p_wkS__ ...
,pm_n_UX_rank ...
,pm_UX_kn__ ...
,pm_X_weight_r_ ...
,FTK ...
);
%%%%%%%%;
% compare to ../dir_rangan_python/dir_ascii/.ascii. ;
%%%%;
dir_ascii = '../dir_rangan_python/dir_ascii';
n_ascii = 10;
for nascii=0:n_ascii-1;
na=0;
if nascii==na; tmp_str_ascii = 'tfpmh_Z_SM__'; tmp_local = tfpmh_Z_SM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_UX_R_CTF_S_l2_wS__'; tmp_local = tfpmh_UX_R_CTF_S_l2_wS__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_R_CTF_S_l2_wS__'; tmp_local = tfpmh_R_CTF_S_l2_wS__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_UX_T_M_l2_dM__'; tmp_local = tfpmh_UX_T_M_l2_dM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_UX_M_l2_M_'; tmp_local = tfpmh_UX_M_l2_M_; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_X_SM__'; tmp_local = tfpmh_X_SM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_delta_x_SM__'; tmp_local = tfpmh_delta_x_SM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_delta_y_SM__'; tmp_local = tfpmh_delta_y_SM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_gamma_z_SM__'; tmp_local = tfpmh_gamma_z_SM__; tab_p=0; end; na=na+1;
if nascii==na; tmp_str_ascii = 'tfpmh_index_sub_SM__'; tmp_local = tfpmh_index_sub_SM__; tab_p=0; end; na=na+1;
fname_ascii = sprintf('%s/%s.ascii',dir_ascii,tmp_str_ascii);
if ~exist(fname_ascii,'file'); disp(sprintf(' %% Warning, %s not found',fname_ascii)); end;
if  exist(fname_ascii,'file');
if (flag_verbose>1); disp(sprintf(' %% %s found, loading',fname_ascii)); end;
fid = fopen(fname_ascii,'r');
if tab_p==0; tmp_ascii = reshape(cell2mat(textscan(fid,'%f')),size(tmp_local)); end;
if tab_p==1; tmp_ascii = reshape(cell2mat(textscan(fid,'(%f)')),size(tmp_local)); end;
fclose(fid);
fnorm_disp(flag_verbose,tmp_str_ascii,tmp_local,'ascii',tmp_ascii,' %% <-- should be <1e-6');
end;%if  exist(fname_ascii,'file');
end;%for nascii=0:n_ascii-1;
%%%%;


