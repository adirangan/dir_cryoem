%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
% Run relion with varying numbers of images. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

dir_home = '/mnt/home/rangan';
dir_trunk = sprintf('%s/dir_cryoem/dir_rangan_playroom/dir_principled_marching_rib80sc',dir_home);
dir_data = sprintf('%s/dir_cryoem/dir_rib80s/new_joakim_relion_run/subs128/data/',dir_home);
dir_relion_bin = sprintf('%s/relion/build/bin',dir_home);

%%%%%%%%;
% First write mrcs file containing image stack. ;
%%%%%%%%;
fname_image_mda = sprintf('%s/images_16384_mda',dir_data);
M_x_c___ = MDA_read_r8(fname_image_mda);
n_image = size(M_x_c___,3);
%%%%%%%%;
fname_mscope_params = sprintf('%s/mscope_params',dir_data);
mscope_params = textread(fname_mscope_params);
Voltage_kV = mscope_params(1);
SphericalAberration = mscope_params(2);
PixelSize = mscope_params(3);
AmplitudeContrast = mscope_params(4);
%%%%%%%%;
fname_image_mrcs = sprintf('%s_relion/test_pm_rib80s_16384.mrcs',dir_trunk);
fp = WriteMRCHeader(M_x_c___,PixelSize,fname_image_mrcs); fwrite(fp,M_x_c___,'float32'); fclose(fp);
%%%%%%%%;
n_x_u = size(M_x_c___,1);
assert(n_x_u == size(M_x_c___,2));

%%%%%%%%;
% Get CTF parameters. ;
%%%%%%%%;
fname_num_ctf = sprintf('%s/num_ctf',dir_data);
n_ctf = textread(fname_num_ctf);
fname_ctf_idx = sprintf('%s/ctf_idx',dir_data);
CTF_idx_ = textread(fname_ctf_idx)-1;
fname_mscope_params = sprintf('%s/mscope_params',dir_data);
mscope_params = textread(fname_mscope_params);
CTF_Voltage_kV_ = mscope_params(1)*ones(n_ctf,1);
CTF_Spherical_Aberration_ = mscope_params(2)*ones(n_ctf,1);
CTF_Detector_Pixel_Size_ = mscope_params(3)*ones(n_ctf,1);
CTF_Amplitude_Contrast_ = mscope_params(4)*ones(n_ctf,1);
fname_ctf_params = sprintf('%s/ctf_params',dir_data);
ctf_params_ = textread(fname_ctf_params);
CTF_Defocus_U_ = ctf_params_(:,1);
CTF_Defocus_V_ = ctf_params_(:,2);
CTF_Defocus_Angle_ = ctf_params_(:,3);
%%%%%%%%;

for n_image_sub = 2.^[10:14];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
disp(sprintf(' %% n_image_sub %d',n_image_sub));
%%%%%%%%;
% Now write star file linking to the mrcs image stack. ;
%%%%%%%%;
tmp_ImageName_list_ = cell(n_image_sub,1);
tmp_OpticsGroup_list_ = cell(n_image_sub,1);
tmp_DefocusU_list_ = cell(n_image_sub,1);
tmp_DefocusV_list_ = cell(n_image_sub,1);
tmp_DefocusAngle_list_ = cell(n_image_sub,1);
for nimage_sub=0:n_image_sub-1;
nctf = CTF_idx_(1+nimage_sub);
tmp_ImageName_list_{1+nimage_sub} = sprintf('%d@test_pm_rib80s_16384.mrcs',1+nimage_sub);
tmp_OpticsGroup_list_{1+nimage_sub} = sprintf('1');
tmp_DefocusU_list_{1+nimage_sub} = sprintf('%0.16f',CTF_Defocus_U_(1+nctf));
tmp_DefocusV_list_{1+nimage_sub} = sprintf('%0.16f',CTF_Defocus_V_(1+nctf));
tmp_DefocusAngle_list_{1+nimage_sub} = sprintf('%0.16f',CTF_Defocus_Angle_(1+nctf));
end;%for nimage_sub=0:n_image_sub-1;
fname_star = sprintf('%s_relion/test_pm_rib80s_%d.star',dir_trunk,n_image_sub);
fp = fopen(fname_star,'w');
fprintf(fp,'# version 30001\n');
fprintf(fp,'\n');
fprintf(fp,'data_optics\n');
fprintf(fp,'\n');
fprintf(fp,'loop_\n');
fprintf(fp,'_rlnOpticsGroupName #1\n');
fprintf(fp,'_rlnOpticsGroup #2\n');
fprintf(fp,'_rlnMtfFileName #3\n');
fprintf(fp,'_rlnVoltage #4\n');
fprintf(fp,'_rlnSphericalAberration #5\n');
fprintf(fp,'_rlnAmplitudeContrast #6\n');
fprintf(fp,'_rlnImagePixelSize #7\n');
fprintf(fp,'_rlnImageSize #8\n');
fprintf(fp,'_rlnImageDimensionality #9\n');
fprintf(fp,'opticsGroup1 1 mtf_k2_300kV.star %f %f %f %f %d 2\n',Voltage_kV,SphericalAberration,AmplitudeContrast,PixelSize,n_x_u);
fprintf(fp,'\n');
fprintf(fp,'# version 30001\n');
fprintf(fp,'\n');
fprintf(fp,'data_particles\n');
fprintf(fp,'\n');
fprintf(fp,'loop_\n');
fprintf(fp,'_rlnImageName #3\n');
fprintf(fp,'_rlnOpticsGroup #4\n');
fprintf(fp,'_rlnDefocusU #6\n');
fprintf(fp,'_rlnDefocusV #7\n');
fprintf(fp,'_rlnDefocusAngle #8\n');
for nimage=0:n_image_sub-1;
fprintf(fp,'%s %s %s %s %s\n',tmp_ImageName_list_{1+nimage_sub},tmp_OpticsGroup_list_{1+nimage_sub},tmp_DefocusU_list_{1+nimage_sub},tmp_DefocusV_list_{1+nimage_sub},tmp_DefocusAngle_list_{1+nimage_sub});
end;%for nimage=0:n_image_sub-1;
fclose(fp);

%%%%%%%%;
% Now write shell script to call command. ;
%%%%%%%%;
tmp_jname = sprintf('job_rib80s_%d_0',n_image_sub);
tmp_slash = '\';
dir_job = sprintf('%s_relion/%s',dir_trunk,tmp_jname);
if (~exist(dir_job,'dir')); sprintf(' %% mkdir %s',dir_job); mkdir(dir_job); end;
fname_command = sprintf('%s_relion/test_pm_rib80s_%d.sh',dir_trunk,n_image_sub);
fp = fopen(fname_command,'w');
fprintf(fp,'%s/relion_refine %s\n',dir_relion_bin,tmp_slash);
fprintf(fp,'--o %s/run %s\n',tmp_jname,tmp_slash);
fprintf(fp,'--sgd_ini_iter 50 %s\n',tmp_slash);
fprintf(fp,'--sgd_inbetween_iter 200 %s\n',tmp_slash);
fprintf(fp,'--sgd_fin_iter 50 %s\n',tmp_slash);
fprintf(fp,'--sgd_write_iter 20 %s\n',tmp_slash);
fprintf(fp,'--sgd_ini_resol 35 %s\n',tmp_slash);
fprintf(fp,'--sgd_fin_resol 15 %s\n',tmp_slash);
fprintf(fp,'--sgd_ini_subset 100 %s\n',tmp_slash);
fprintf(fp,'--sgd_fin_subset 500 %s\n',tmp_slash);
fprintf(fp,'--sgd %s\n',tmp_slash);
fprintf(fp,'--denovo_3dref %s\n',tmp_slash);
fprintf(fp,'--i %s %s\n',sprintf('test_pm_rib80s_%d.star',n_image_sub),tmp_slash);
fprintf(fp,'--ctf %s\n',tmp_slash);
fprintf(fp,'--K 1 %s\n',tmp_slash);
fprintf(fp,'--sym C1 %s\n',tmp_slash);
fprintf(fp,'--flatten_solvent %s\n',tmp_slash);
fprintf(fp,'--zero_mask %s\n',tmp_slash);
fprintf(fp,'--dont_combine_weights_via_disc %s\n',tmp_slash);
fprintf(fp,'--pool 3 %s\n',tmp_slash);
fprintf(fp,'--pad 2 %s\n',tmp_slash);
fprintf(fp,'--skip_gridding %s\n',tmp_slash);
fprintf(fp,'--particle_diameter 400 %s\n',tmp_slash);
fprintf(fp,'--oversampling 1 %s\n',tmp_slash);
fprintf(fp,'--healpix_order 1 %s\n',tmp_slash);
fprintf(fp,'--offset_range 6 %s\n',tmp_slash);
fprintf(fp,'--offset_step 4 %s\n',tmp_slash);
fprintf(fp,'--j 6 %s\n',tmp_slash);
fprintf(fp,'--pipeline_control %s %s\n',tmp_jname,tmp_slash);
fprintf(fp,';\n');
fprintf(fp,'\n');
fclose(fp);
disp(sprintf(' %% fname_command: %s',fname_command));
type(fname_command);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%for n_image_sub = 2.^[10:14];


disp('returning'); return;
