flag_verbose=1; flag_disp=1; nf=0;
str_thisfunction = 'test_ssnll_from_plane_wave_expansion_2';

k_int = 8;
k_eq_d_double = 0.250;
t_eq_d_double = 0.500;
n_order = 9;
n_w_int = 2;
KAPPA_basic_l_max_use = k_int;
KAPPA_basic_l_max_ext = ceil(1.25*KAPPA_basic_l_max_use);
KAPPA_basic_l_max_band = floor(KAPPA_basic_l_max_use/2);
KAPPA_qref_k_eq_d_double = k_eq_d_double;
%%%%;
KAPPA_flag_kernel_full = 1;
KAPPA_pole_north_double = 12*pi/24;
KAPPA_pole_south_double = 12*pi/24;

%%%%%%%%;
% First define integral of <f,f>. ;
%%%%%%%%;
h2d_ = @(kd) 4*pi^2*(besselj(0,kd) + besselj(2,kd)); % calculates <f_j,f_k>, normalized so that <f,f> = (4*pi^2);
dh2d_ = @(kd) 4*pi^3*(besselj(-1,kd) - besselj(+3,kd));
h3d_ = @(kd) 4*pi*( sin(kd) - (kd).*cos(kd) ) ./ kd.^3 ; % calculates <f_j,f_k>, normalized so that <f,f> = 4*pi/3;
dh3d_ = @(kd) 12*pi*( (kd.^2/3 - 1) .* sin(kd) + (kd).*cos(kd) ) ./ kd.^4 ;
%%%%%%%%;
% Now set up and test k-quadrature on sphere. ;
%%%%%%%%;
k_p_r_max = k_int/(2*pi); k_eq_d = k_eq_d_double/(2*pi); str_C2 = 'C2';
flag_uniform_over_n_k_p_r = 1;
flag_uniform_over_polar_a = 0; %<-- This is set to match test_ssnll_from_a_k_p_14 ;
[ ...
 n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,~ ...
,~ ...
,~ ...
,~ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
] = ...
sample_sphere_7( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_C2 ...
,flag_uniform_over_n_k_p_r ...
,flag_uniform_over_polar_a ...
) ;
%%%%;
% and generate consistant quadrature-grid on shell. ;
%%%%;
qref_k_eq_d = k_eq_d_double/(2*pi)/max(1e-12,k_p_r_max);
tmp_t = tic();
[ ...
 qref_n_shell ...
,qref_azimu_b_shell_ ...
,qref_polar_a_shell_ ...
,qref_weight_shell_ ...
,qref_k_c_0_shell_ ...
,qref_k_c_1_shell_ ...
,qref_k_c_2_shell_ ...
,qref_n_polar_a ...
,qref_polar_a_ ...
,qref_n_azimu_b_ ...
] = ...
sample_shell_6( ...
 1.0 ...
,qref_k_eq_d ...
,str_C2 ...
,flag_uniform_over_polar_a ...
) ;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% sample_shell_6: %0.2fs',tmp_t)); end;
assert(fnorm(qref_azimu_b_shell_-k_p_azimu_b_qk_(1:qref_n_shell))<1e-12);
assert(fnorm(qref_polar_a_shell_-k_p_polar_a_qk_(1:qref_n_shell))<1e-12);
assert(fnorm(sum(qref_weight_shell_)-4*pi)<1e-12);
n_q = qref_n_shell;
weight_3d_k_p_qk__ = reshape(weight_3d_k_p_qk_,[n_q,n_k_p_r]);
weight_shell_qk__ = reshape(weight_shell_qk_,[n_q,n_k_p_r]);
assert(fnorm(4*pi*weight_3d_k_p_r_ - reshape(sum(weight_3d_k_p_qk__,1),[1,n_k_p_r]))<1e-12);
%%%%%%%%;
if (flag_disp>1);
figure(1+nf);nf=nf+1;clf;figbig;
p_row = 2; p_col = 4; n_plot = p_row*p_col;
for nplot=0:n_plot-1;
nk_p_r = max(0,min(n_k_p_r-1,round(n_k_p_r*nplot/n_plot)));
tmp_index_ = n_qk_csum_(1+nk_p_r):n_qk_csum_(1+nk_p_r+1)-1;
subplot(p_row,p_col,1+nplot);
plot3(k_c_0_qk_(1+tmp_index_),k_c_1_qk_(1+tmp_index_),k_c_2_qk_(1+tmp_index_),'.');
axis equal; axis vis3d; axisnotick3d;
title(sprintf('nk_p_r %d/%d',nk_p_r,n_k_p_r),'Interpreter','none');
end;%for nplot=0:n_plot-1;
end;%if flag_disp;
%%%%%%%%;
% Now set up polar-quadrature-weights on disk. ;
%%%%%%%%;
l_max_upb = round(2*pi*k_p_r_max);
l_max_max = min(l_max_upb,1+ceil(2*pi*k_p_r_(end)));
n_w_max = n_w_int*2*(l_max_max+1); n_w_0in = n_w_max; n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_0in_ ...
);
n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
%%%%%%%%;

%%%%%%%%;
% Define rotation. ;
%%%%%%%%;
Rz = @(azimu_b) ...
[ +cos(azimu_b) -sin(azimu_b) 0 ; ...
  +sin(azimu_b) +cos(azimu_b) 0 ; ...
   0             0            1 ; ...
] ;
%%%%%%%%;
Ry = @(polar_a) ...
[ +cos(polar_a) 0 +sin(polar_a) ; ...
   0            1  0            ; ...
  -sin(polar_a) 0 +cos(polar_a) ; ...
];
%%%%%%%%;
polar_a_use = +1*pi/5;
azimu_b_use = +1*pi/7;
gamma_z_use = +1*pi/3;
euler_use_ = [gamma_z_use,polar_a_use,azimu_b_use];
R_use__ = Rz(azimu_b_use)*Ry(polar_a_use)*Rz(gamma_z_use);
fnorm_disp(flag_verbose,'R_use__',R_use__,'euler_to_R_0(euler_use_)',euler_to_R_0(euler_use_));
fnorm_disp(flag_verbose,'euler_use_',euler_use_,'R_to_euler_0(R_use__)',R_to_euler_0(R_use__));
%%%%%%%%;

%%%%%%%%;
% set up sources. ;
%%%%%%%%;
n_source_a = 4;
n_source_b = 3;
rng(0);
delta_a_c__ = zeros(3,n_source_a);
delta_b_c__ = zeros(3,n_source_b); %<-- just to check for dimension. ;
delta_dvol_a_c__ = zeros(3,n_source_a);
for nsource_a=0:n_source_a-1;
rng(1+nsource_a);
delta_a_c_ = 2*rand(3,1)-1; delta_a_c_ = delta_a_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_a_c_)); %<-- ensure small in magnitude. ;
delta_a_c__(:,1+nsource_a) = delta_a_c_;
delta_dvol_a_c_ = 2*rand(3,1)-1; delta_dvol_a_c_ = delta_dvol_a_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_dvol_a_c_)); %<-- ensure small in magnitude. ;
delta_dvol_a_c__(:,1+nsource_a) = delta_dvol_a_c_;
end;%for nsource_a=0:n_source_a-1;
for nsource_b=0:n_source_b-1;
rng(1+n_source_a+nsource_b);
delta_b_c_ = 2*rand(3,1)-1; delta_b_c_ = delta_b_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_b_c_)); %<-- ensure small in magnitude. ;
delta_b_c__(:,1+nsource_b) = delta_b_c_;
end;%for nsource_b=0:n_source_b-1;
%%%%%%%%;
v_source_a_ = 1 + rand(n_source_a,1);
v_source_b_ = 1 + rand(n_source_b,1);
v_source_dvol_a_ = 1 + rand(n_source_a,1);
%%%%%%%%;
inv_R_delta_a_c__ = zeros(3,n_source_a);
inv_R_delta_b_c__ = zeros(3,n_source_b);
inv_R_delta_dvol_a_c__ = zeros(3,n_source_a);
for nsource_a=0:n_source_a-1;
inv_R_delta_a_c__(:,1+nsource_a) = transpose(R_use__)*delta_a_c__(:,1+nsource_a);
inv_R_delta_dvol_a_c__(:,1+nsource_a) = transpose(R_use__)*delta_dvol_a_c__(:,1+nsource_a);
end;%for nsource_a=0:n_source_a-1;
for nsource_b=0:n_source_b-1;
inv_R_delta_b_c__(:,1+nsource_b) = transpose(R_use__)*delta_b_c__(:,1+nsource_b);
end;%for nsource_b=0:n_source_b-1;
%%%%%%%%;

%%%%%%%%;
% set up CTF and eta. ;
% This ignores eta. ;
%%%%%%%%;
n_CTF = 3;
rng(0);
CTF_phi_C_ = 2*pi*rand(n_CTF,1);
CTF_k_p_wkC__ = zeros(n_w_sum,n_CTF);
for nCTF=0:n_CTF-1;
CTF_phi = CTF_phi_C_(1+nCTF);
CTF_k_p_wkC__(:,1+nCTF) = 2*k_p_r_wk_.*cos(k_p_w_wk_-CTF_phi);
end;%for nCTF=0:n_CTF-1;
n_eta = 1;
eta_k_p_wke__ = ones(n_w_sum,n_eta);
%%%%%%%%;

%%%%%%%%;
% Now define a_k_p_form, as well as the rotated version a_R_k_p_form. ;
%%%%%%%%;
a_k_p_form_ = zeros(n_qk,1);
b_k_p_form_ = zeros(n_qk,1);
dvol_a_k_p_form_ = zeros(n_qk,1);
a_R_k_p_form_ = zeros(n_qk,1);
b_R_k_p_form_ = zeros(n_qk,1);
dvol_a_R_k_p_form_ = zeros(n_qk,1);
for nsource_a=0:n_source_a-1;
delta_a_c_ = delta_a_c__(:,1+nsource_a);
v_source_a = v_source_a_(1+nsource_a);
a_k_p_form_ = a_k_p_form_ + v_source_a*exp(+i*2*pi*(k_c_0_qk_*delta_a_c_(1+0) + k_c_1_qk_*delta_a_c_(1+1) + k_c_2_qk_*delta_a_c_(1+2)));
delta_dvol_a_c_ = delta_dvol_a_c__(:,1+nsource_a);
v_source_dvol_a = v_source_dvol_a_(1+nsource_a);
dvol_a_k_p_form_ = dvol_a_k_p_form_ + v_source_dvol_a*exp(+i*2*pi*(k_c_0_qk_*delta_dvol_a_c_(1+0) + k_c_1_qk_*delta_dvol_a_c_(1+1) + k_c_2_qk_*delta_dvol_a_c_(1+2)));
inv_R_delta_a_c_ = inv_R_delta_a_c__(:,1+nsource_a);
a_R_k_p_form_ = a_R_k_p_form_ + v_source_a*exp(+i*2*pi*(k_c_0_qk_*inv_R_delta_a_c_(1+0) + k_c_1_qk_*inv_R_delta_a_c_(1+1) + k_c_2_qk_*inv_R_delta_a_c_(1+2)));
inv_R_delta_dvol_a_c_ = inv_R_delta_dvol_a_c__(:,1+nsource_a);
dvol_a_R_k_p_form_ = dvol_a_R_k_p_form_ + v_source_dvol_a*exp(+i*2*pi*(k_c_0_qk_*inv_R_delta_dvol_a_c_(1+0) + k_c_1_qk_*inv_R_delta_dvol_a_c_(1+1) + k_c_2_qk_*inv_R_delta_dvol_a_c_(1+2)));
end;%for nsource_a=0:n_source_a-1;
for nsource_b=0:n_source_b-1;
delta_b_c_ = delta_b_c__(:,1+nsource_b);
v_source_b = v_source_b_(1+nsource_b);
b_k_p_form_ = b_k_p_form_ + v_source_b*exp(+i*2*pi*(k_c_0_qk_*delta_b_c_(1+0) + k_c_1_qk_*delta_b_c_(1+1) + k_c_2_qk_*delta_b_c_(1+2)));
inv_R_delta_b_c_ = inv_R_delta_b_c__(:,1+nsource_b);
b_R_k_p_form_ = b_R_k_p_form_ + v_source_b*exp(+i*2*pi*(k_c_0_qk_*inv_R_delta_b_c_(1+0) + k_c_1_qk_*inv_R_delta_b_c_(1+1) + k_c_2_qk_*inv_R_delta_b_c_(1+2)));
end;%for nsource_b=0:n_source_b-1;
%%%%;
I_a_quad = sum(a_k_p_form_.*weight_3d_k_p_qk_);
I_b_quad = sum(b_k_p_form_.*weight_3d_k_p_qk_);
I_dvol_a_quad = sum(dvol_a_k_p_form_.*weight_3d_k_p_qk_);
I_a_form = 0;
I_b_form = 0;
I_dvol_a_form = 0;
for nsource_a=0:n_source_a-1;
delta_a_c_ = delta_a_c__(:,1+nsource_a);
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_a_c_);
I_a_form = I_a_form + h3d_(tmp_kd)*k_p_r_max^3*v_source_a_(1+nsource_a);
delta_dvol_a_c_ = delta_dvol_a_c__(:,1+nsource_a);
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_dvol_a_c_);
I_dvol_a_form = I_dvol_a_form + h3d_(tmp_kd)*k_p_r_max^3*v_source_dvol_a_(1+nsource_a);
end;%for nsource_a=0:n_source_a-1;
for nsource_b=0:n_source_b-1;
delta_b_c_ = delta_b_c__(:,1+nsource_b);
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_b_c_);
I_b_form = I_b_form + h3d_(tmp_kd)*k_p_r_max^3*v_source_b_(1+nsource_b);
end;%for nsource_b=0:n_source_b-1;
fnorm_disp(flag_verbose,'I_a_form',I_a_form,'I_a_quad',I_a_quad,' %<-- should be <1e-6');
fnorm_disp(flag_verbose,'I_b_form',I_b_form,'I_b_quad',I_b_quad,' %<-- should be <1e-6');
fnorm_disp(flag_verbose,'I_dvol_a_form',I_dvol_a_form,'I_dvol_a_quad',I_dvol_a_quad,' %<-- should be <1e-6');
%%%%%%%%;

%%%%%%%%;
% test quadrature on disk. ;
%%%%%%%%;
S_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
S_k_p_wk_ = S_k_p_wk_ + v_source_a_(1+nsource_a)*exp(+2*pi*i*(k_c_0_wk_*delta_a_c__(1+0,1+nsource_a) + k_c_1_wk_*delta_a_c__(1+1,1+nsource_a)));
end;%for nsource_a=0:n_source_a-1;
T_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source_b-1;
T_k_p_wk_ = T_k_p_wk_ + v_source_b_(1+nsource_b)*exp(+2*pi*i*(k_c_0_wk_*delta_b_c__(1+0,1+nsource_b) + k_c_1_wk_*delta_b_c__(1+1,1+nsource_b)));
end;%for nsource_b=0:n_source_b-1;
I_quad = sum(conj(S_k_p_wk_).*T_k_p_wk_.*weight_2d_wk_)*(4*pi^2);
I_form = 0;
for nsource_a=0:n_source_a-1;
for nsource_b=0:n_source_b-1;
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_a_c__(1:2,1+nsource_a) - delta_b_c__(1:2,1+nsource_b));
I_form = I_form + h2d_(tmp_kd)/(4*pi^2) * (pi*k_p_r_max^2) * v_source_a_(1+nsource_a) * v_source_b_(1+nsource_b) ;
end;%for nsource_b=0:n_source_b-1;
end;%for nsource_a=0:n_source_a-1;
fnorm_disp(flag_verbose,'I_form',I_form,'I_quad',I_quad,' %<-- should be <1e-6');
%%%%;
if (flag_disp>1);
figure(1+nf);nf=nf+1;clf;figmed;
Slim_ = n_source_a*[-1,+1];
subplot(1,2,1);
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,real(S_k_p_wk_),Slim_,colormap_beach());
axis image; axisnotick; title('real(S_k_p_wk_)','Interpreter','none');
subplot(1,2,2);
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,real(T_k_p_wk_),Slim_,colormap_beach());
axis image; axisnotick; title('real(T_k_p_wk_)','Interpreter','none');
end;% if flag_disp;
%%%%%%%%;

%%%%%%%%;
% generate template-grids. ;
%%%%%%%%;
tmp_t = tic();
viewing_k_eq_d = t_eq_d_double/k_p_r_max;
template_k_eq_d = t_eq_d_double/k_p_r_max;
str_L = 'L'; %<-- Use C2 to allow for off-grid interpolation. ;
flag_tensor_vs_adap = 0; %<-- use adaptive grid for ddssnll_from_a_k_p, but need tensor grid for ddsssnll_3. ;
[ ...
 n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,viewing_k_c_0_qk_ ...
,viewing_k_c_1_qk_ ...
,viewing_k_c_2_qk_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
] = ...
sample_shell_6( ...
 1.0 ...
,template_k_eq_d ...
,str_C2 ...
,flag_tensor_vs_adap ...
) ;
n_S = n_viewing_S;
viewing_gamma_z_S_ = zeros(n_S,1);
if (flag_verbose>0); disp(sprintf(' %% n_S %d, n_viewing_polar_a %d, n_viewing_azimu_b [%d,..,%d]',n_S,n_viewing_polar_a,n_viewing_azimu_b_(1+0),n_viewing_azimu_b_(end))); end;
%%%%;

a_k_p_qk_ = a_k_p_form_ ;
a_R_k_p_qk_ = a_R_k_p_form_ ;
dvol_a_k_p_qk_ = dvol_a_k_p_form_ ;
dvol_a_R_k_p_qk_ = dvol_a_R_k_p_form_ ;
b_k_p_qk_ = b_k_p_form_ ;
b_R_k_p_qk_ = b_R_k_p_form_ ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
% generate templates. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
parameter_interpolate = struct('type','parameter');
parameter_interpolate.flag_verbose = 1;
parameter_interpolate.tolerance_pinv = 1e-6;
parameter_interpolate.flag_check = 0;
parameter_interpolate.flag_parsimonious = 1;
[ ...
 parameter_interpolate ...
,template_from_a_k_p_wkS__ ...
,n_w ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dtemplateda_from_a_k_p_wkS__ ...
,dtemplatedb_from_a_k_p_wkS__ ...
,dtemplatedc_from_a_k_p_wkS__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,dtemplateda_rec_wkS__ ...
,dtemplatedb_rec_wkS__ ...
,dtemplatedc_rec_wkS__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddtemplatedaa_from_a_k_p_wkS__ ...
,ddtemplatedab_from_a_k_p_wkS__ ...
,ddtemplatedac_from_a_k_p_wkS__ ...
,ddtemplatedbb_from_a_k_p_wkS__ ...
,ddtemplatedbc_from_a_k_p_wkS__ ...
,ddtemplatedcc_from_a_k_p_wkS__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,ddtemplatedaa_rec_wkS__ ...
,ddtemplatedab_rec_wkS__ ...
,ddtemplatedac_rec_wkS__ ...
,ddtemplatedbb_rec_wkS__ ...
,ddtemplatedbc_rec_wkS__ ...
,ddtemplatedcc_rec_wkS__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
interpolate_template_6( ...
 parameter_interpolate ...
,n_order ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_qk_ ...
,viewing_k_eq_d ...
,-1 ...
,n_w_0in ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
S_k_p_wkS__ = template_from_a_k_p_wkS__;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% S_k_p_wkS__ (interpolate_template_6): time %0.6fs',tmp_t)); end;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
parameter_interpolate = struct('type','parameter');
parameter_interpolate.flag_verbose = 1;
parameter_interpolate.tolerance_pinv = 1e-6;
parameter_interpolate.flag_check = 0;
parameter_interpolate.flag_parsimonious = 1;
[ ...
 parameter_interpolate ...
,template_from_dvol_a_k_p_wkS__ ...
] = ...
interpolate_template_6( ...
 parameter_interpolate ...
,n_order ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,dvol_a_k_p_qk_ ...
,viewing_k_eq_d ...
,-1 ...
,n_w_0in ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
dvol_S_k_p_wkS__ = template_from_dvol_a_k_p_wkS__;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% dvol_S_k_p_wkS__ (interpolate_template_6): time %0.6fs',tmp_t)); end;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('b_R_k_p_qk_','var'); b_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
parameter_interpolate = struct('type','parameter');
parameter_interpolate.flag_verbose = 1;
parameter_interpolate.tolerance_pinv = 1e-6;
parameter_interpolate.flag_check = 0;
parameter_interpolate.flag_parsimonious = 1;
[ ...
 parameter_interpolate ...
,template_from_b_k_p_wkS__ ...
] = ...
interpolate_template_6( ...
 parameter_interpolate ...
,n_order ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,b_k_p_qk_ ...
,viewing_k_eq_d ...
,-1 ...
,n_w_0in ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,b_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
T_k_p_wkS__ = template_from_b_k_p_wkS__;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% T_k_p_wkS__ (interpolate_template_6): time %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% Now step through and reconstitute the templates. ;
%%%%%%%%;
R_k_p_wkS__ = zeros(n_w_sum,n_S);
dvol_R_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
R_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
tmp_delta_ = tmp_R__*delta_a_c__(:,1+nsource_a);
R_k_p_wk_ = R_k_p_wk_ + v_source_a_(1+nsource_a)*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_(1+0) + k_c_1_wk_*tmp_delta_(1+1)));
end;%for nsource_a=0:n_source_a-1;
R_k_p_wkS__(:,1+nS) = R_k_p_wk_;
dvol_R_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
tmp_delta_ = tmp_R__*delta_dvol_a_c__(:,1+nsource_a);
dvol_R_k_p_wk_ = dvol_R_k_p_wk_ + v_source_dvol_a_(1+nsource_a)*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_(1+0) + k_c_1_wk_*tmp_delta_(1+1)));
end;%for nsource_a=0:n_source_a-1;
dvol_R_k_p_wkS__(:,1+nS) = dvol_R_k_p_wk_;
end;%for nS=0:n_S-1;
fnorm_disp(flag_verbose,'R_k_p_wkS__',R_k_p_wkS__,'S_k_p_wkS__',S_k_p_wkS__,' %<-- should be <1e-6');
fnorm_disp(flag_verbose,'dvol_R_k_p_wkS__',dvol_R_k_p_wkS__,'dvol_S_k_p_wkS__',dvol_S_k_p_wkS__,' %<-- should be <1e-6');
%%%%%%%%;
R_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
R_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source_b-1;
tmp_delta_ = tmp_R__*delta_b_c__(:,1+nsource_b);
R_k_p_wk_ = R_k_p_wk_ + v_source_b_(1+nsource_b)*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_(1+0) + k_c_1_wk_*tmp_delta_(1+1)));
end;%for nsource_b=0:n_source_b-1;
R_k_p_wkS__(:,1+nS) = R_k_p_wk_;
end;%for nS=0:n_S-1;
fnorm_disp(flag_verbose,'R_k_p_wkS__',R_k_p_wkS__,'T_k_p_wkS__',T_k_p_wkS__,' %<-- should be <1e-6');
%%%%%%%%;

%%%%%%%%;
% Set up test with some 'on-grid' images. ;
% Note that these are on the tensor grid from sample_shell above. ;
% For this test we explicitly *exclude* those templates near the pole. ;
% This is because we have difficulty interpolating across the poles. ;
%%%%%%%%;
n_M = 64;
index_nCTF_from_nM_ = transpose(mod(0:n_M-1,n_CTF));
rng(0); M_phi_M_ = 2*pi*rand(n_M,1);
index_neta_from_nM_ = transpose(mod(0:n_M-1,n_eta));
nS_pole_south = max(efind(abs(viewing_polar_a_S_-1*pi)<1e-12)) + 1; if isempty(nS_pole_south); nS_pole_south = n_S-1; end;
nS_pole_north = min(efind(abs(viewing_polar_a_S_-0*pi)<1e-12)) - 1; if isempty(nS_pole_north); nS_pole_north = 0; end;
index_nS_from_nM_ = transpose(round(linspace(nS_pole_south,nS_pole_north,n_M)));
M_k_p_wkM__ = zeros(n_w_sum,n_M);
fromb_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_);
fromb_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_);
fromb_gamma_z_M_ = reshape(2*pi .* (mod(0:n_M-1,19))/max(1,19),[n_M,1]);
for nM=0:n_M-1;
M_k_p_wkM__(:,1+nM) = 2*k_p_r_wk_.*cos(k_p_w_wk_-M_phi_M_(1+nM)) .* rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,T_k_p_wkS__(:,1+index_nS_from_nM_(1+nM)),+fromb_gamma_z_M_(1+nM));
end;%for nM=0:n_M-1;
%%%%;
rng(0); rand_p = randperm(n_M);
euler_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_(rand_p));
euler_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_(rand_p));
euler_gamma_z_M_ = fromb_gamma_z_M_(rand_p);
%%%%;
rng(7);
dtau_euler_polar_a_M_ = 2*pi*rand(n_M,1);
dtau_euler_azimu_b_M_ = 2*pi*rand(n_M,1);
dtau_euler_gamma_z_M_ = 2*pi*rand(n_M,1);
dtau_M3__ = [ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
] ;
dtau = 1e-3;
%%%%;
ssnll_frm = 0.0d0;
ssnll_qua = 0.0d0;
U_vs_S_errrel_sum = 0.0d0;
V_vs_T_errrel_sum = 0.0d0;
M_vs_V_errrel_sum = 0.0d0;
for nM=0:n_M-1;
M_phi = M_phi_M_(1+nM);
nT = index_nS_from_nM_(1+nM); %<-- on grid. ;
T_k_p_wk_ = T_k_p_wkS__(:,1+nT);
nCTF = index_nCTF_from_nM_(1+nM);
CTF_phi = CTF_phi_C_(1+nCTF);
CTF_k_p_wk_ = CTF_k_p_wkC__(:,1+nCTF);
neta = index_neta_from_nM_(1+nM);
eta_k_p_wk_ = eta_k_p_wke__(:,1+neta);
tmp_euler_polar_a = +euler_polar_a_M_(1+nM);
tmp_euler_azimu_b = +euler_azimu_b_M_(1+nM);
tmp_euler_gamma_z = -euler_gamma_z_M_(1+nM);
tmp_R_a__ = Rz(-tmp_euler_gamma_z)*Ry(-tmp_euler_polar_a)*Rz(-tmp_euler_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1); tmp_delta_U_a_ = zeros(n_source_a,1); tmp_omega_U_a_ = zeros(n_source_a,1);
for nsource_a=0:n_source_a-1;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a); tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1])); tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
tmp_delta_U_a_(1+nsource_a) = tmp_delta_U; tmp_omega_U_a_(1+nsource_a) = tmp_omega_U;
U_k_p_wk_ = U_k_p_wk_ + v_source_a_(1+nsource_a)*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
end;%for nsource_a=0:n_source_a-1;
nS = efind( abs(viewing_polar_a_S_-tmp_euler_polar_a)<1e-6 & abs(viewing_azimu_b_S_-tmp_euler_azimu_b)<1e-6 ); %<-- on grid. ;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
U_vs_S_errrel_sum = U_vs_S_errrel_sum + fnorm(S_k_p_wk_ - rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,U_k_p_wk_,+tmp_euler_gamma_z))/max(1e-12,fnorm(U_k_p_wk_));
tmp_fromb_polar_a = +fromb_polar_a_M_(1+nM);
tmp_fromb_azimu_b = +fromb_azimu_b_M_(1+nM);
tmp_fromb_gamma_z = -fromb_gamma_z_M_(1+nM);
tmp_R_b__ = Rz(-tmp_fromb_gamma_z)*Ry(-tmp_fromb_polar_a)*Rz(-tmp_fromb_azimu_b);
V_k_p_wk_ = zeros(n_w_sum,1); tmp_delta_V_b_ = zeros(n_source_b,1); tmp_omega_V_b_ = zeros(n_source_b,1);
for nsource_b=0:n_source_b-1;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b); tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1])); tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
tmp_delta_V_b_(1+nsource_b) = tmp_delta_V; tmp_omega_V_b_(1+nsource_b) = tmp_omega_V;
V_k_p_wk_ = V_k_p_wk_ + v_source_b_(1+nsource_b)*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
end;%for nsource_b=0:n_source_b-1;
V_vs_T_errrel_sum = V_vs_T_errrel_sum + fnorm(T_k_p_wk_ - rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,V_k_p_wk_,+tmp_fromb_gamma_z))/max(1e-12,fnorm(V_k_p_wk_));
M_k_p_wk_ = M_k_p_wkM__(:,1+nM);
M_vs_V_errrel_sum = M_vs_V_errrel_sum + fnorm(M_k_p_wk_ - 2*k_p_r_wk_.*cos(k_p_w_wk_-M_phi) .* V_k_p_wk_)/max(1e-12,fnorm(M_k_p_wk_));
ssnll_qua = ssnll_qua + 0.5*sum(abs(U_k_p_wk_.*CTF_k_p_wk_ - M_k_p_wk_).^2.*eta_k_p_wk_.*weight_2d_wk_,'all')*(2*pi)^2;
for nsource_a0=0:n_source_a-1; for nsource_a1=0:n_source_a-1;
tmp_delta_0 = tmp_delta_U_a_(1+nsource_a0); tmp_omega_0 = tmp_omega_U_a_(1+nsource_a0);
tmp_delta_1 = tmp_delta_U_a_(1+nsource_a1); tmp_omega_1 = tmp_omega_U_a_(1+nsource_a1);
ssnll_frm = ssnll_frm + 0.5*1*I_PxxP(k_p_r_max,CTF_phi,tmp_delta_1,tmp_omega_1,CTF_phi,tmp_delta_0,tmp_omega_0) * v_source_a_(1+nsource_a0) * v_source_a_(1+nsource_a1) ;
end;end;%for nsource_a0=0:n_source_a-1; for nsource_a1=0:n_source_a-1;
for nsource_a0=0:n_source_a-1; for nsource_b1=0:n_source_b-1;
tmp_delta_0 = tmp_delta_U_a_(1+nsource_a0); tmp_omega_0 = tmp_omega_U_a_(1+nsource_a0);
tmp_delta_1 = tmp_delta_V_b_(1+nsource_b1); tmp_omega_1 = tmp_omega_V_b_(1+nsource_b1);
ssnll_frm = ssnll_frm - 0.5*2*I_PxxP(k_p_r_max,  M_phi,tmp_delta_1,tmp_omega_1,CTF_phi,tmp_delta_0,tmp_omega_0) * v_source_a_(1+nsource_a0) * v_source_b_(1+nsource_b1) ;
end;end;%for nsource_a0=0:n_source_a-1; for nsource_b1=0:n_source_b-1;
for nsource_b0=0:n_source_b-1; for nsource_b1=0:n_source_b-1;
tmp_delta_0 = tmp_delta_V_b_(1+nsource_b0); tmp_omega_0 = tmp_omega_V_b_(1+nsource_b0);
tmp_delta_1 = tmp_delta_V_b_(1+nsource_b1); tmp_omega_1 = tmp_omega_V_b_(1+nsource_b1);
ssnll_frm = ssnll_frm + 0.5*1*I_PxxP(k_p_r_max,  M_phi,tmp_delta_1,tmp_omega_1,  M_phi,tmp_delta_0,tmp_omega_0) * v_source_b_(1+nsource_b0) * v_source_b_(1+nsource_b1) ;
end;end;%for nsource_b0=0:n_source_b-1; for nsource_b1=0:n_source_b-1;
end;%for nM=0:n_M-1;
if (flag_verbose>0); disp(sprintf(' %% U_vs_S_errrel_sum: %0.16f',U_vs_S_errrel_sum)); end;
if (flag_verbose>0); disp(sprintf(' %% V_vs_T_errrel_sum: %0.16f',V_vs_T_errrel_sum)); end;
if (flag_verbose>0); disp(sprintf(' %% M_vs_V_errrel_sum: %0.16f',M_vs_V_errrel_sum)); end;
fnorm_disp(flag_verbose,'ssnll_frm',ssnll_frm,'ssnll_qua',ssnll_qua,' %<-- should be <1e-6');
%%%%%%%%;

disp('returning'); return;

n_source_dvol_a = n_source_a;
%%%%;
[ ...
 ~ ...
,ssnll_pw1_M_ ...
,ssnll_pw1 ...
,S_pw1_k_p_wkS__ ...
,dvol_ssnll_pw1_M_ ...
,dvol_ssnll_pw1 ...
,dvol_S_pw1_k_p_wkS__ ...
,dvol_dvol_ssnll_pw1 ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
] = ...
ssnll_from_plane_wave_expansion_2( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_phi_C_ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,fromb_polar_a_M_ ...
,fromb_azimu_b_M_ ...
,fromb_gamma_z_M_ ...
,M_phi_M_ ...
,n_S ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%;
fnorm_disp(flag_verbose,'ssnll_frm',ssnll_frm,'ssnll_pw1',ssnll_pw1,' %<-- should be <1e-6');

%%%%;
tmp_t = tic();
parameter_ssnll = struct('type','parameter');
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
[ ...
 parameter_ssnll ...
,ssnll_q2d_M_ ...
,ssnll_q2d ...
,S_k_p_q2d_wkS__ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,~ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_qk_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_viewing_S ...
,S_k_p_wkS__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,[] ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,[] ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: time %0.6fs',tmp_t)); end;
%%%%;
fnorm_disp(flag_verbose,'ssnll_frm',ssnll_frm,'ssnll_q2d',ssnll_q2d);
%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;


%%%%%%%%;
% set up templates. ;
%%%%%%%%;
template_k_eq_d = 1.0/k_p_r_max;
flag_tensor_vs_adap = 1; %<-- tensor grid. ;
[ ...
 n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,viewing_k_c_0_all_ ...
,viewing_k_c_1_all_ ...
,viewing_k_c_2_all_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
] = ...
sample_shell_6( ...
 1.0 ...
,template_k_eq_d ...
,str_T_vs_L ...
,flag_tensor_vs_adap ...
) ;
n_S = n_viewing_S;
viewing_gamma_z_S_ = zeros(n_S,1);
%%%%%%%%;

%%%%%%%%;
% set up images. ;
%%%%%%%%;
n_M = 2;
index_nCTF_from_nM_ = [1;0];
index_neta_from_nM_ = [1;0];
index_nS_from_nM_ = [128;512];
euler_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_);
euler_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_);
%euler_gamma_z_M_ = zeros(n_M,1); %<-- not in-plane rotation. ;
euler_gamma_z_M_ = 2*pi*transpose([0:n_M-1])/max(1,n_M); %<-- yes in-plane rotation. ;
%nM = 0; euler_polar_a_M_(1+nM) = +5*pi/17; euler_azimu_b_M_(1+nM) = -17*pi/11; %<-- arbitrary off-grid viewing-angle. ;
nM = 1; euler_polar_a_M_(1+nM) = +2*pi/17; euler_azimu_b_M_(1+nM) = +19*pi/11; %<-- arbitrary off-grid viewing-angle. ;
%%%%%%%%;

%%%%%%%%;
% calculate ssnll. ;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_M_ ...
,ssnll ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;

%%%%%%%%;
% testing dvol_ssnll. ;
%%%%%%%%;
dvol = 1e-4;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,dvol_ssnll_mid_M_ ...
,dvol_ssnll_mid ...
,dvol_S_k_p_mid_wkS__ ...
,dvol_dvol_ssnll_mid ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_M_ ...
,ssnll_pos ...
,S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a + n_source_dvol_a ...
,[v_source_a_;+1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_M_ ...
,ssnll_neg ...
,S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a + n_source_dvol_a ...
,[v_source_a_;-1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dvol_ssnll_dif = (ssnll_pos - ssnll_neg)/max(1e-12,2*dvol);
if (flag_verbose>0); disp(sprintf(' %% dvol_ssnll_dif vs dvol_ssnll_mid: %0.16f',fnorm(dvol_ssnll_dif - dvol_ssnll_mid)/max(1e-12,fnorm(dvol_ssnll_dif)))); end;
dvol_S_k_p_dif_wkS__ = (S_k_p_pos_wkS__ - S_k_p_neg_wkS__)/max(1e-12,2*dvol);
if (flag_verbose>0); disp(sprintf(' %% dvol_S_k_p_dif_wkS__ vs dvol_S_k_p_mid_wkS__: %0.16f',fnorm(dvol_S_k_p_dif_wkS__ - dvol_S_k_p_mid_wkS__)/max(1e-12,fnorm(dvol_S_k_p_dif_wkS__)))); end;
dvol_dvol_ssnll_dif = (ssnll_pos -2*ssnll_mid + ssnll_neg)/max(1e-12,dvol*dvol);
if (flag_verbose>0); disp(sprintf(' %% dvol_dvol_ssnll_dif vs dvol_dvol_ssnll_mid: %0.16f',fnorm(dvol_dvol_ssnll_dif - dvol_dvol_ssnll_mid)/max(1e-12,fnorm(dvol_dvol_ssnll_dif)))); end;
%%%%%%%%;

%%%%%%%%;
% testing dtau_ssnll. ;
%%%%%%%%;
rng(7);
dtau_euler_polar_a_M_ = 2*pi*rand(n_M,1);
dtau_euler_azimu_b_M_ = 2*pi*rand(n_M,1);
dtau_euler_gamma_z_M_ = 2*pi*rand(n_M,1);
%dtau_fnorm = fnorm([dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_]);
%dtau_euler_polar_a_M_ = dtau_euler_polar_a_M_/max(1e-12,dtau_fnorm);
%dtau_euler_azimu_b_M_ = dtau_euler_azimu_b_M_/max(1e-12,dtau_fnorm);
%dtau_euler_gamma_z_M_ = dtau_euler_gamma_z_M_/max(1e-12,dtau_fnorm);
%%%%;
dtau_viewing_polar_a_S_ = 2*pi*rand(n_S,1);
dtau_viewing_azimu_b_S_ = 2*pi*rand(n_S,1);
dtau_viewing_gamma_z_S_ = 2*pi*rand(n_S,1);
%dtau_fnorm = fnorm([dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_]);
%dtau_viewing_polar_a_S_ = dtau_viewing_polar_a_S_/max(1e-12,dtau_fnorm);
%dtau_viewing_azimu_b_S_ = dtau_viewing_azimu_b_S_/max(1e-12,dtau_fnorm);
%dtau_viewing_gamma_z_S_ = dtau_viewing_gamma_z_S_/max(1e-12,dtau_fnorm);
%%%%;
dtau = 1e-5;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,~ ...
,~ ...
,~ ...
,~ ...
,dtau_ssnll_mid_M3__ ...
,dtau_ssnll_mid ...
,dtau_S_k_p_mid_wkS3___ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_M_ ...
,ssnll_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_M_ ...
,ssnll_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_ssnll_dif = (ssnll_pos - ssnll_neg)/max(1e-12,2*dtau);
if (flag_verbose>0); disp(sprintf(' %% dtau_ssnll_dif vs dtau_ssnll_mid: %0.16f',fnorm(dtau_ssnll_dif - dtau_ssnll_mid)/max(1e-12,fnorm(dtau_ssnll_dif)))); end;
dtau_ssnll_dif = sum(bsxfun(@times,dtau_ssnll_mid_M3__,[dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_]),[1,2]);
if (flag_verbose>0); disp(sprintf(' %% dtau_ssnll_dif vs dtau_ssnll_mid: %0.16f',fnorm(dtau_ssnll_dif - dtau_ssnll_mid)/max(1e-12,fnorm(dtau_ssnll_dif)))); end;
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ + 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ + 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ + 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ - 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ - 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ - 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_S_k_p_dif_wkS__ = (S_k_p_pos_wkS__ - S_k_p_neg_wkS__)/max(1e-12,2*dtau);
dtau_S_k_p_mid_wkS__ = sum(bsxfun(@times,dtau_S_k_p_mid_wkS3___,reshape([dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_],[1,n_S,3])),3);
if (flag_verbose>0); disp(sprintf(' %% dtau_S_k_p_dif_wkS__ vs dtau_S_k_p_mid_wkS__: %0.16f',fnorm(dtau_S_k_p_dif_wkS__ - dtau_S_k_p_mid_wkS__)/max(1e-12,fnorm(dtau_S_k_p_dif_wkS__)))); end;
%%%%%%%%;

%%%%%%%%;
% testing dtau_dvol_ssnll. ;
%%%%%%%%;
dvol = 1e-4;
dtau = 1e-5;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,dvol_ssnll_mid_M_ ...
,dvol_ssnll_mid ...
,dvol_S_k_p_mid_wkS__ ...
,dvol_dvol_ssnll_mid ...
,dtau_ssnll_mid_M3__ ...
,dtau_ssnll_mid ...
,dtau_S_k_p_mid_wkS3___ ...
,dtau_dvol_ssnll_mid_M3__ ...
,dtau_dvol_ssnll_mid ...
,dtau_dvol_S_k_p_mid_wkS3___ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_pos_M_ ...
,ssnll_pos_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;+1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_neg_M_ ...
,ssnll_pos_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;-1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_pos_M_ ...
,ssnll_neg_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;+1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_neg_M_ ...
,ssnll_neg_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;-1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dvol_ssnll_dif = ( + ssnll_pos_pos - ssnll_neg_pos + ssnll_neg_neg - ssnll_pos_neg )/max(1e-12,4*dtau*dvol);
if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_ssnll_dif vs dtau_dvol_ssnll_mid: %0.16f',fnorm(dtau_dvol_ssnll_dif - dtau_dvol_ssnll_mid)/max(1e-12,fnorm(dtau_dvol_ssnll_dif)))); end;
dtau_dvol_ssnll_dif = sum(bsxfun(@times,dtau_dvol_ssnll_mid_M3__,[dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_]),[1,2]);
if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_ssnll_dif vs dtau_dvol_ssnll_mid: %0.16f',fnorm(dtau_dvol_ssnll_dif - dtau_dvol_ssnll_mid)/max(1e-12,fnorm(dtau_dvol_ssnll_dif)))); end;
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,dvol_S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ + 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ + 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ + 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,dvol_S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ - 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ - 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ - 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dvol_S_k_p_dif_wkS__ = (dvol_S_k_p_pos_wkS__ - dvol_S_k_p_neg_wkS__)/max(1e-12,2*dtau);
dtau_dvol_S_k_p_mid_wkS__ = sum(bsxfun(@times,dtau_dvol_S_k_p_mid_wkS3___,reshape([dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_],[1,n_S,3])),3);
if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_S_k_p_dif_wkS__ vs dtau_dvol_S_k_p_mid_wkS__: %0.16f',fnorm(dtau_dvol_S_k_p_dif_wkS__ - dtau_dvol_S_k_p_mid_wkS__)/max(1e-12,fnorm(dtau_dvol_S_k_p_dif_wkS__)))); end;
%%%%%%%%;

%%%%%%%%;
% testing dtau_dtau_ssnll. ;
%%%%%%%%;
dtau = 1e-5;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,dvol_ssnll_mid_M_ ...
,dvol_ssnll_mid ...
,dvol_S_k_p_mid_wkS__ ...
,dvol_dvol_ssnll_mid ...
,dtau_ssnll_mid_M3__ ...
,dtau_ssnll_mid ...
,dtau_S_k_p_mid_wkS3___ ...
,dtau_dvol_ssnll_mid_M3__ ...
,dtau_dvol_ssnll_mid ...
,dtau_dvol_S_k_p_mid_wkS3___ ...
,dtau_dtau_ssnll_mid_M33___ ...
,dtau_dtau_ssnll_mid ...
,dtau_dtau_S_k_p_mid_wkS33____ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_M_ ...
,ssnll_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_M_ ...
,ssnll_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dtau_ssnll_dif = (ssnll_pos - 2*ssnll_mid + ssnll_neg)/max(1e-12,dtau*dtau);
if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_ssnll_dif vs dtau_dtau_ssnll_mid: %0.16f',fnorm(dtau_dtau_ssnll_dif - dtau_dtau_ssnll_mid)/max(1e-12,fnorm(dtau_dtau_ssnll_dif)))); end;
dtau_M3__ = [dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_];
dtau_M33___ = bsxfun(@times,reshape(dtau_M3__,[n_M,3,1]),reshape(dtau_M3__,[n_M,1,3]));
dtau_dtau_ssnll_dif = sum(bsxfun(@times,dtau_dtau_ssnll_mid_M33___,dtau_M33___),[1,2,3]);
if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_ssnll_dif vs dtau_dtau_ssnll_mid: %0.16f',fnorm(dtau_dtau_ssnll_dif - dtau_dtau_ssnll_mid)/max(1e-12,fnorm(dtau_dtau_ssnll_dif)))); end;
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ + 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ + 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ + 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ - 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ - 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ - 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dtau_S_k_p_dif_wkS__ = (S_k_p_pos_wkS__ - 2*S_k_p_mid_wkS__ + S_k_p_neg_wkS__)/max(1e-12,dtau*dtau);
dtau_S3__ = [dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_];
dtau_S33___ = bsxfun(@times,reshape(dtau_S3__,[n_S,3,1]),reshape(dtau_S3__,[n_S,1,3]));
dtau_dtau_S_k_p_mid_wkS__ = sum(bsxfun(@times,dtau_dtau_S_k_p_mid_wkS33____,reshape(dtau_S33___,[1,n_S,3,3])),[3,4]);
if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_S_k_p_dif_wkS__ vs dtau_dtau_S_k_p_mid_wkS__: %0.16f',fnorm(dtau_dtau_S_k_p_dif_wkS__ - dtau_dtau_S_k_p_mid_wkS__)/max(1e-12,fnorm(dtau_dtau_S_k_p_dif_wkS__)))); end;
%%%%%%%%;


