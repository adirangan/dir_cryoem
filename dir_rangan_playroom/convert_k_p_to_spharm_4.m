function ...
[ ...
 a_k_Y_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
] = ...
convert_k_p_to_spharm_4( ...
 flag_verbose ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,l_max_ ...
,a_k_p_qk_ ...
,Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
);
% reconstitutes spherical-harmonic-expansion a_k_Y_ from a collection of points on spherical shells determined by k_p_r_. ;
% We assume that the polar-representation and quadrature weights associated with these points have been previously calculated. ; 
% ;
% inputs: ;
% ;
% flag_verbose = integer verbosity_level. ;
% n_qk = integer total number of points. ;
% n_qk_csum_ = integer array of starting indices associated with each k-value. ;
% k_p_r_qk_ = real array of k-values for each point. ;
% k_p_azimu_b_qk_ = real array of azimu_b-values for each point. ;
% k_p_polar_a_qk_ = real array of polar_a-values for each point. ;
% weight_3d_k_p_qk_ = real array of quadrature weights for volume integral (for each point) (unused). ;
% weight_shell_qk_ = real array of quadrature weights for shell integral (for each point). ;
% n_k_p_r = integer maximum k. ;
% k_p_r_ = real array of length n_k_p_r; k_p_r_(nk_p_r) = k_p_r_value for shell nk_p_r. ;
% weight_3d_k_p_r_ = real array of length n_k_p_r; radial quadrature weights (already assumed to be a factor of weight_3d_k_p_qk_) (unused). ;
% l_max_ = integer array of length n_k_p_r; l_max_(nk_p_r) = spherical harmonic order on shell nk_p_r; l_max_(nk_p_r) corresponds to n_lm_(nk_p_r) = (l_max_(nk_p_r)+1)^2 coefficients. ;
% a_k_p_qk_ = complex array of a-values for each point. ;
% Ylm_klma___ = complex cell array of length n_k_p_r. ; Ylm_klma___{1+nk_p_r} holds the array Ylm_lma__. ;
% Ylm_lma__ = complex array of size (n_lm,n_sub), where n_lm record (l,m) pairs (m varying quickly), and n_sub records the ordered list of points on the shell at nk_p_r. ;
% See get_Ylm_condense_wrap_0 for additional outputs. ;
% ;
% outputs: ;
% ;
% a_k_Y_ = complex array of length \sum_{nk_p_r} (n_lm_(nk_p_r)+1)^2 ; coefficients are ordered in a row, with m varying quickly, l varying slowly and k varying most slowly. ;
% Ylm_klma___ = complex cell array of length n_k_p_r. ; Ylm_klma___{1+nk_p_r} holds the array Ylm_lma__. ;
% See get_Ylm_condense_wrap_0 for additional inputs. ;

str_thisfunction = 'convert_k_p_to_spharm_4';

na=0;
if (nargin<1+na); flag_verbose=[]; end; na=na+1;
if (nargin<1+na); n_qk=[]; end; na=na+1;
if (nargin<1+na); n_qk_csum_=[]; end; na=na+1;
if (nargin<1+na); k_p_r_qk_=[]; end; na=na+1;
if (nargin<1+na); k_p_azimu_b_qk_=[]; end; na=na+1;
if (nargin<1+na); k_p_polar_a_qk_=[]; end; na=na+1;
if (nargin<1+na); weight_3d_k_p_qk_=[]; end; na=na+1;
if (nargin<1+na); weight_shell_qk_=[]; end; na=na+1;
if (nargin<1+na); n_k_p_r=[]; end; na=na+1;
if (nargin<1+na); k_p_r_=[]; end; na=na+1;
if (nargin<1+na); weight_3d_k_p_r_=[]; end; na=na+1;
if (nargin<1+na); l_max_=[]; end; na=na+1;
if (nargin<1+na); a_k_p_qk_=[]; end; na=na+1;
if (nargin<1+na); Ylm_uklma___=[]; end; na=na+1;

flag_Ylm_create = 0; 
if isempty(Ylm_uklma___);
flag_Ylm_create=1;
[ ...
 Ylm_uklma___ ...
,k_p_azimu_b_sub_uka__ ...
,k_p_polar_a_sub_uka__ ...
,l_max_uk_ ...
,index_nu_n_k_per_shell_from_nk_p_r_ ...
,index_k_per_shell_uka__ ...
] = ...
get_Ylm_condense_wrap_0( ...
 flag_verbose ...
,n_qk ...
,n_qk_csum_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,n_k_p_r ...
,l_max_ ...
);
end;%if isempty(Ylm_uklma___);

n_lm_ = (l_max_+1).^2;
if (flag_verbose); disp(sprintf(' %% [entering %s] n_qk %d, n_lm_sum %d',str_thisfunction,n_qk,sum(n_lm_))); end;
a_k_Y_ = zeros(sum(n_lm_),1);
ix=0;
for nk_p_r=0:n_k_p_r-1;
k_p_r = k_p_r_(1+nk_p_r); 
n_qk_csum = n_qk_csum_(1+nk_p_r);
if (flag_verbose>1); disp(sprintf(' %% nk_p_r %d/%d k_p_r %0.2f, n_qk_csum %d --> %0.2f%%',nk_p_r,n_k_p_r,k_p_r,n_qk_csum,n_qk_csum/n_qk)); end;
if (nk_p_r<n_k_p_r-1); n_sub = n_qk_csum_(1+nk_p_r+1) - n_qk_csum_(1+nk_p_r); else n_sub = n_qk - n_qk_csum ; end;
index_sub_ = n_qk_csum + transpose(0:n_sub-1);
k_p_r_sub_ = k_p_r_qk_(1+index_sub_); 
assert(sum(k_p_r_sub_==k_p_r)==n_sub);
k_p_azimu_b_sub_ = k_p_azimu_b_qk_(1+index_sub_);
k_p_polar_a_sub_ = k_p_polar_a_qk_(1+index_sub_);
weight_shell_qk_sub_ = reshape(weight_shell_qk_(1+index_sub_)/max(1e-12,k_p_r^2),[n_sub,1]);
l_max = l_max_(1+nk_p_r);
n_l_max = l_max+1; flag_flip=0;
n_lm = n_lm_(1+nk_p_r);
%%%%;
nu_n_k_per_shell = index_nu_n_k_per_shell_from_nk_p_r_(1+nk_p_r);
tmp_k_p_azimu_b_sub_ = k_p_azimu_b_sub_uka__{1+nu_n_k_per_shell};
tmp_k_p_polar_a_sub_ = k_p_polar_a_sub_uka__{1+nu_n_k_per_shell};
if (fnorm(k_p_azimu_b_sub_-tmp_k_p_azimu_b_sub_)>1e-6);
disp(sprintf(' %% Warning, fnorm(k_p_azimu_b_sub_-tmp_k_p_azimu_b_sub_) %0.16f in %s',fnorm(k_p_azimu_b_sub_-tmp_k_p_azimu_b_sub_),str_thisfunction));
end;%if (fnorm(k_p_azimu_b_sub_-tmp_k_p_azimu_b_sub_)>1e-6);
if (fnorm(k_p_polar_a_sub_-tmp_k_p_polar_a_sub_)>1e-6);
disp(sprintf(' %% Warning, fnorm(k_p_polar_a_sub_-tmp_k_p_polar_a_sub_) %0.16f in %s',fnorm(k_p_polar_a_sub_-tmp_k_p_polar_a_sub_),str_thisfunction));
end;%if (fnorm(k_p_polar_a_sub_-tmp_k_p_polar_a_sub_)>1e-6);
Ylm_lma__ = Ylm_uklma___{1+nu_n_k_per_shell}(1:n_lm,:);
%%%%;
tmp_t = tic();
a_k_p_qk_sub_ = reshape(a_k_p_qk_(1+index_sub_),[n_sub,1]);
a_k_Y_sub_ = zeros(n_lm,1);
a_k_Y_sub_ = conj(Ylm_lma__)*(a_k_p_qk_sub_.*weight_shell_qk_sub_);
a_k_Y_(1+ix+[0:n_lm-1]) = a_k_Y_sub_;
ix = ix+n_lm;
clear Ylm_lma__;
tmp_t = toc(tmp_t); if (flag_verbose); disp(sprintf(' %% nk_p_r %d/%d a_k_p_qk_sub_: %0.6fs',nk_p_r,n_k_p_r,tmp_t)); end;
end;%for nk_p_r=0:n_k_p_r-1;
if (flag_verbose); disp(sprintf(' %% [finished %s] n_qk %d, n_lm_sum %d',str_thisfunction,n_qk,sum(n_lm_))); end;
