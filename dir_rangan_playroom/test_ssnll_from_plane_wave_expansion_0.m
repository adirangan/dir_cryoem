flag_verbose=1; flag_disp=1; nf=0;
str_thisfunction = 'test_ssnll_from_plane_wave_expansion_0';

%%%%%%%%;
% Now set up k-quadrature on sphere. ;
%%%%%%%%;
flag_verbose = 1;
k_p_r_max = 48.0/(2*pi); k_eq_d = 1.0/(2*pi); str_T_vs_L = 'C';
[ ...
 n_k_all ...
,n_k_all_csum_ ...
,k_p_r_all_ ...
,k_p_azimu_b_all_ ...
,k_p_polar_a_all_ ...
,weight_3d_k_all_ ...
,weight_shell_k_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,k_c_0_all_ ...
,k_c_1_all_ ...
,k_c_2_all_ ...
] = ...
sample_sphere_7( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_T_vs_L ...
) ;
%%%%%%%%;

%%%%%%%%;
% set up sources. ;
%%%%%%%%;
n_source = 4;
rng(0);
delta_a_c__ = zeros(3,n_source);
delta_b_c__ = zeros(3,n_source);
delta_dvol_a_c__ = zeros(3,n_source);
for nsource=0:n_source-1;
rng(1+nsource);
delta_a_c_ = 2*rand(3,1)-1; delta_a_c_ = delta_a_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_a_c_)); %<-- ensure small in magnitude. ;
delta_a_c__(:,1+nsource) = delta_a_c_;
delta_b_c_ = 2*rand(3,1)-1; delta_b_c_ = delta_b_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_b_c_)); %<-- ensure small in magnitude. ;
delta_b_c__(:,1+nsource) = delta_b_c_;
delta_dvol_a_c_ = 2*rand(3,1)-1; delta_dvol_a_c_ = delta_dvol_a_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_dvol_a_c_)); %<-- ensure small in magnitude. ;
delta_dvol_a_c__(:,1+nsource) = delta_dvol_a_c_;
end;%for nsource=0:n_source-1;
%%%%%%%%;
n_source_a = n_source;
v_source_a_ = ones(n_source_a,1);
n_source_b = n_source;
v_source_b_ = ones(n_source_b,1);
n_source_dvol_a = n_source;
v_source_dvol_a_ = ones(n_source_dvol_a,1);

%%%%%%%%;
% set up k-quadrature on disk. ;
%%%%%%%%;
l_max_upb = round(2*pi*k_p_r_max);
l_max_max = min(l_max_upb,1+ceil(2*pi*k_p_r_(end)));
n_w_max = 2*(l_max_max+1); n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_0in_ ...
);
n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
%%%%%%%%;

%%%%%%%%;
% set up CTF and eta. ;
% This does not test anisotropic CTF. ;
% Nor does this test anisotropic eta. ;
%%%%%%%%;
n_alpha = 3; CTF_alpha_ = [0.10;0.15;0.30];
n_power = 2; eta_power_ = [0.50;0.75];
n_CTF = n_alpha*n_power;
n_eta = n_alpha*n_power;
CTF_k_p_wkC__ = zeros(n_w_sum,n_CTF);
eta_k_p_wke__ = zeros(n_w_sum,n_eta);
for nalpha=0:n_alpha-1;
CTF_alpha = CTF_alpha_(1+nalpha);
for npower=0:n_power-1;
eta_power = eta_power_(1+npower);
nCTF = nalpha+npower*n_alpha;
neta = nalpha+npower*n_alpha;
CTF_k_p_wk_ = (reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1])).^(1-eta_power);
CTF_k_p_wkC__(:,1+nCTF) = CTF_k_p_wk_;
eta_k_p_wk_ = (reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1])).^(0+eta_power);
eta_k_p_wke__(:,1+neta) = eta_k_p_wk_;
end;%for npower=0:n_power-1;
end;%for nalpha=0:n_alpha-1;
%%%%%%%%;

%%%%%%%%;
% set up templates. ;
%%%%%%%%;
template_k_eq_d = 1.0/k_p_r_max;
flag_tensor_vs_adap = 1; %<-- tensor grid. ;
[ ...
 n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,viewing_k_c_0_all_ ...
,viewing_k_c_1_all_ ...
,viewing_k_c_2_all_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
] = ...
sample_shell_6( ...
 1.0 ...
,template_k_eq_d ...
,str_T_vs_L ...
,flag_tensor_vs_adap ...
) ;
n_S = n_viewing_S;
viewing_gamma_z_S_ = zeros(n_S,1);
%%%%%%%%;

%%%%%%%%;
% set up images. ;
%%%%%%%%;
n_M = 2;
index_nCTF_from_nM_ = [1;0];
index_neta_from_nM_ = [1;0];
index_nS_from_nM_ = [128;512];
euler_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_);
euler_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_);
euler_gamma_z_M_ = zeros(n_M,1);
%nM = 0; euler_polar_a_M_(1+nM) = +5*pi/17; euler_azimu_b_M_(1+nM) = -17*pi/11; %<-- arbitrary off-grid viewing-angle. ;
nM = 1; euler_polar_a_M_(1+nM) = +2*pi/17; euler_azimu_b_M_(1+nM) = +19*pi/11; %<-- arbitrary off-grid viewing-angle. ;
%%%%%%%%;

%%%%%%%%;
% calculate ssnll. ;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_M_ ...
,ssnll ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;

%%%%%%%%;
% testing dvol_ssnll. ;
%%%%%%%%;
dvol = 1e-4;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,dvol_ssnll_mid_M_ ...
,dvol_ssnll_mid ...
,dvol_S_k_p_mid_wkS__ ...
,dvol_dvol_ssnll_mid ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_M_ ...
,ssnll_pos ...
,S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a + n_source_dvol_a ...
,[v_source_a_;+1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_M_ ...
,ssnll_neg ...
,S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a + n_source_dvol_a ...
,[v_source_a_;-1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dvol_ssnll_dif = (ssnll_pos - ssnll_neg)/max(1e-12,2*dvol);
if (flag_verbose>0); disp(sprintf(' %% dvol_ssnll_dif vs dvol_ssnll_mid: %0.16f',fnorm(dvol_ssnll_dif - dvol_ssnll_mid)/max(1e-12,fnorm(dvol_ssnll_dif)))); end;
dvol_S_k_p_dif_wkS__ = (S_k_p_pos_wkS__ - S_k_p_neg_wkS__)/max(1e-12,2*dvol);
if (flag_verbose>0); disp(sprintf(' %% dvol_S_k_p_dif_wkS__ vs dvol_S_k_p_mid_wkS__: %0.16f',fnorm(dvol_S_k_p_dif_wkS__ - dvol_S_k_p_mid_wkS__)/max(1e-12,fnorm(dvol_S_k_p_dif_wkS__)))); end;
dvol_dvol_ssnll_dif = (ssnll_pos -2*ssnll_mid + ssnll_neg)/max(1e-12,dvol*dvol);
if (flag_verbose>0); disp(sprintf(' %% dvol_dvol_ssnll_dif vs dvol_dvol_ssnll_mid: %0.16f',fnorm(dvol_dvol_ssnll_dif - dvol_dvol_ssnll_mid)/max(1e-12,fnorm(dvol_dvol_ssnll_dif)))); end;
%%%%%%%%;

%%%%%%%%;
% testing dtau_ssnll. ;
%%%%%%%%;
rng(7);
dtau_euler_polar_a_M_ = 2*pi*rand(n_M,1);
dtau_euler_azimu_b_M_ = 2*pi*rand(n_M,1);
dtau_euler_gamma_z_M_ = 2*pi*rand(n_M,1);
%dtau_fnorm = fnorm([dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_]);
%dtau_euler_polar_a_M_ = dtau_euler_polar_a_M_/max(1e-12,dtau_fnorm);
%dtau_euler_azimu_b_M_ = dtau_euler_azimu_b_M_/max(1e-12,dtau_fnorm);
%dtau_euler_gamma_z_M_ = dtau_euler_gamma_z_M_/max(1e-12,dtau_fnorm);
%%%%;
dtau_viewing_polar_a_S_ = 2*pi*rand(n_S,1);
dtau_viewing_azimu_b_S_ = 2*pi*rand(n_S,1);
dtau_viewing_gamma_z_S_ = 2*pi*rand(n_S,1);
%dtau_fnorm = fnorm([dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_]);
%dtau_viewing_polar_a_S_ = dtau_viewing_polar_a_S_/max(1e-12,dtau_fnorm);
%dtau_viewing_azimu_b_S_ = dtau_viewing_azimu_b_S_/max(1e-12,dtau_fnorm);
%dtau_viewing_gamma_z_S_ = dtau_viewing_gamma_z_S_/max(1e-12,dtau_fnorm);
%%%%;
dtau = 1e-5;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,~ ...
,~ ...
,~ ...
,~ ...
,dtau_ssnll_mid_M3__ ...
,dtau_ssnll_mid ...
,dtau_S_k_p_mid_wkS3___ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_M_ ...
,ssnll_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_M_ ...
,ssnll_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_ssnll_dif = (ssnll_pos - ssnll_neg)/max(1e-12,2*dtau);
if (flag_verbose>0); disp(sprintf(' %% dtau_ssnll_dif vs dtau_ssnll_mid: %0.16f',fnorm(dtau_ssnll_dif - dtau_ssnll_mid)/max(1e-12,fnorm(dtau_ssnll_dif)))); end;
dtau_ssnll_dif = sum(bsxfun(@times,dtau_ssnll_mid_M3__,[dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_]),[1,2]);
if (flag_verbose>0); disp(sprintf(' %% dtau_ssnll_dif vs dtau_ssnll_mid: %0.16f',fnorm(dtau_ssnll_dif - dtau_ssnll_mid)/max(1e-12,fnorm(dtau_ssnll_dif)))); end;
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ + 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ + 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ + 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ - 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ - 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ - 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_S_k_p_dif_wkS__ = (S_k_p_pos_wkS__ - S_k_p_neg_wkS__)/max(1e-12,2*dtau);
dtau_S_k_p_mid_wkS__ = sum(bsxfun(@times,dtau_S_k_p_mid_wkS3___,reshape([dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_],[1,n_S,3])),3);
if (flag_verbose>0); disp(sprintf(' %% dtau_S_k_p_dif_wkS__ vs dtau_S_k_p_mid_wkS__: %0.16f',fnorm(dtau_S_k_p_dif_wkS__ - dtau_S_k_p_mid_wkS__)/max(1e-12,fnorm(dtau_S_k_p_dif_wkS__)))); end;
%%%%%%%%;

%%%%%%%%;
% testing dtau_dvol_ssnll. ;
%%%%%%%%;
dvol = 1e-4;
dtau = 1e-5;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,dvol_ssnll_mid_M_ ...
,dvol_ssnll_mid ...
,dvol_S_k_p_mid_wkS__ ...
,dvol_dvol_ssnll_mid ...
,dtau_ssnll_mid_M3__ ...
,dtau_ssnll_mid ...
,dtau_S_k_p_mid_wkS3___ ...
,dtau_dvol_ssnll_mid_M3__ ...
,dtau_dvol_ssnll_mid ...
,dtau_dvol_S_k_p_mid_wkS3___ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_pos_M_ ...
,ssnll_pos_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;+1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_neg_M_ ...
,ssnll_pos_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;-1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_pos_M_ ...
,ssnll_neg_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;+1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_neg_M_ ...
,ssnll_neg_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a+n_source_dvol_a ...
,[v_source_a_;-1*dvol*v_source_dvol_a_] ...
,[delta_a_c__,delta_dvol_a_c__] ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dvol_ssnll_dif = ( + ssnll_pos_pos - ssnll_neg_pos + ssnll_neg_neg - ssnll_pos_neg )/max(1e-12,4*dtau*dvol);
if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_ssnll_dif vs dtau_dvol_ssnll_mid: %0.16f',fnorm(dtau_dvol_ssnll_dif - dtau_dvol_ssnll_mid)/max(1e-12,fnorm(dtau_dvol_ssnll_dif)))); end;
dtau_dvol_ssnll_dif = sum(bsxfun(@times,dtau_dvol_ssnll_mid_M3__,[dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_]),[1,2]);
if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_ssnll_dif vs dtau_dvol_ssnll_mid: %0.16f',fnorm(dtau_dvol_ssnll_dif - dtau_dvol_ssnll_mid)/max(1e-12,fnorm(dtau_dvol_ssnll_dif)))); end;
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,dvol_S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ + 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ + 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ + 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,dvol_S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ - 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ - 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ - 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dvol_S_k_p_dif_wkS__ = (dvol_S_k_p_pos_wkS__ - dvol_S_k_p_neg_wkS__)/max(1e-12,2*dtau);
dtau_dvol_S_k_p_mid_wkS__ = sum(bsxfun(@times,dtau_dvol_S_k_p_mid_wkS3___,reshape([dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_],[1,n_S,3])),3);
if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_S_k_p_dif_wkS__ vs dtau_dvol_S_k_p_mid_wkS__: %0.16f',fnorm(dtau_dvol_S_k_p_dif_wkS__ - dtau_dvol_S_k_p_mid_wkS__)/max(1e-12,fnorm(dtau_dvol_S_k_p_dif_wkS__)))); end;
%%%%%%%%;

%%%%%%%%;
% testing dtau_dtau_ssnll. ;
%%%%%%%%;
dtau = 1e-5;
%%%%%%%%;
[ ...
 ~ ...
,ssnll_mid_M_ ...
,ssnll_mid ...
,S_k_p_mid_wkS__ ...
,dvol_ssnll_mid_M_ ...
,dvol_ssnll_mid ...
,dvol_S_k_p_mid_wkS__ ...
,dvol_dvol_ssnll_mid ...
,dtau_ssnll_mid_M3__ ...
,dtau_ssnll_mid ...
,dtau_S_k_p_mid_wkS3___ ...
,dtau_dvol_ssnll_mid_M3__ ...
,dtau_dvol_ssnll_mid ...
,dtau_dvol_S_k_p_mid_wkS3___ ...
,dtau_dtau_ssnll_mid_M33___ ...
,dtau_dtau_ssnll_mid ...
,dtau_dtau_S_k_p_mid_wkS33____ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 struct('type','parameter','flag_verbose',flag_verbose) ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_pos_M_ ...
,ssnll_pos ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ + 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ + 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ + 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,ssnll_neg_M_ ...
,ssnll_neg ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ - 1*dtau*dtau_euler_polar_a_M_ ...
,euler_azimu_b_M_ - 1*dtau*dtau_euler_azimu_b_M_ ...
,euler_gamma_z_M_ - 1*dtau*dtau_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dtau_ssnll_dif = (ssnll_pos - 2*ssnll_mid + ssnll_neg)/max(1e-12,dtau*dtau);
if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_ssnll_dif vs dtau_dtau_ssnll_mid: %0.16f',fnorm(dtau_dtau_ssnll_dif - dtau_dtau_ssnll_mid)/max(1e-12,fnorm(dtau_dtau_ssnll_dif)))); end;
dtau_M3__ = [dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_];
dtau_M33___ = bsxfun(@times,reshape(dtau_M3__,[n_M,3,1]),reshape(dtau_M3__,[n_M,1,3]));
dtau_dtau_ssnll_dif = sum(bsxfun(@times,dtau_dtau_ssnll_mid_M33___,dtau_M33___),[1,2,3]);
if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_ssnll_dif vs dtau_dtau_ssnll_mid: %0.16f',fnorm(dtau_dtau_ssnll_dif - dtau_dtau_ssnll_mid)/max(1e-12,fnorm(dtau_dtau_ssnll_dif)))); end;
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_pos_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ + 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ + 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ + 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
[ ...
 ~ ...
,~ ...
,~ ...
,S_k_p_neg_wkS__ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 [] ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,[] ...
,[] ...
,[] ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ - 1*dtau*dtau_viewing_polar_a_S_ ...
,viewing_azimu_b_S_ - 1*dtau*dtau_viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ - 1*dtau*dtau_viewing_gamma_z_S_ ...
);
%%%%%%%%;
dtau_dtau_S_k_p_dif_wkS__ = (S_k_p_pos_wkS__ - 2*S_k_p_mid_wkS__ + S_k_p_neg_wkS__)/max(1e-12,dtau*dtau);
dtau_S3__ = [dtau_viewing_polar_a_S_,dtau_viewing_azimu_b_S_,dtau_viewing_gamma_z_S_];
dtau_S33___ = bsxfun(@times,reshape(dtau_S3__,[n_S,3,1]),reshape(dtau_S3__,[n_S,1,3]));
dtau_dtau_S_k_p_mid_wkS__ = sum(bsxfun(@times,dtau_dtau_S_k_p_mid_wkS33____,reshape(dtau_S33___,[1,n_S,3,3])),[3,4]);
if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_S_k_p_dif_wkS__ vs dtau_dtau_S_k_p_mid_wkS__: %0.16f',fnorm(dtau_dtau_S_k_p_dif_wkS__ - dtau_dtau_S_k_p_mid_wkS__)/max(1e-12,fnorm(dtau_dtau_S_k_p_dif_wkS__)))); end;
%%%%%%%%;


