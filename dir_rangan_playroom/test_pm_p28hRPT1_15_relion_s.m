n_M_relion_ = 1024*[1]; n_n_M_relion = numel(n_M_relion_);
fname_star = sprintf('%s/%s',dir_data_star,fname_nopath_star);
[star_blockNames,star_blockData,ok]=ReadStarFile_0(fname_star,max(n_M_relion_)+1024 + 1024*16);
n_rlnImageName = numel(star_blockData{1}.rlnImageName);
tab_s = 3;
rng(tab_s*1024); index_p_ = randperm(n_rlnImageName-1024) - 1 + 1024;
for nn_M_relion=0:n_n_M_relion-1;
%%%%%%%%%%%%%%%%;
n_M_relion = n_M_relion_(1+nn_M_relion);
jname = sprintf('job_%d_s%d',n_M_relion,tab_s);
tmp_slash = '\';
dir_job = sprintf('%s_mat/%s',dir_relion,jname);
if (~exist(dir_job,'dir')); sprintf(' %% mkdir %s',dir_job); mkdir(dir_job); end;
%%%%%%%%;
% Now write star file linking to the mrcs image stack. ;
%%%%%%%%;
tmp_ImageName_list_ = cell(n_M_relion,1);
tmp_OpticsGroup_list_ = cell(n_M_relion,1);
tmp_DefocusU_list_ = cell(n_M_relion,1);
tmp_DefocusV_list_ = cell(n_M_relion,1);
tmp_DefocusAngle_list_ = cell(n_M_relion,1);
for nM=0:n_M_relion-1;
nM_use = index_p_(1+nM);
tmp_rlnImageName = star_blockData{1}.rlnImageName{1+nM_use};
tmp_ij = strfind(tmp_rlnImageName,'@');
tmp_Frame = tmp_rlnImageName(1:tmp_ij-1);
tmp_Path = tmp_rlnImageName(tmp_ij+1:end);
tmp_ImageName_list_{1+nM} = sprintf('%s@../%s',tmp_Frame,tmp_Path);
tmp_OpticsGroup_list_{1+nM} = sprintf('1');
tmp_DefocusU_list_{1+nM} = num2str(star_blockData{1}.rlnDefocusU(1+nM_use));
tmp_DefocusV_list_{1+nM} = num2str(star_blockData{1}.rlnDefocusV(1+nM_use));
tmp_DefocusAngle_list_{1+nM} = num2str(star_blockData{1}.rlnDefocusAngle(1+nM_use));
end;%for nM=0:n_M_relion-1;
tmp_Voltage = mode(star_blockData{1}.rlnVoltage);
tmp_SphericalAberration = mode(star_blockData{1}.rlnSphericalAberration);
tmp_AmplitudeContrast = mode(star_blockData{1}.rlnAmplitudeContrast);
fname_star = sprintf('%s_mat/relion_%s.star',dir_relion,jname);
fp = fopen(fname_star,'w');
fprintf(fp,'# version 30001\n');
fprintf(fp,'\n');
fprintf(fp,'data_optics\n');
fprintf(fp,'\n');
fprintf(fp,'loop_\n');
fprintf(fp,'_rlnOpticsGroupName #1\n');
fprintf(fp,'_rlnOpticsGroup #2\n');
fprintf(fp,'_rlnMtfFileName #3\n');
fprintf(fp,'_rlnVoltage #4\n');
fprintf(fp,'_rlnSphericalAberration #5\n');
fprintf(fp,'_rlnAmplitudeContrast #6\n');
fprintf(fp,'_rlnImagePixelSize #7\n');
fprintf(fp,'_rlnImageSize #8\n');
fprintf(fp,'_rlnImageDimensionality #9\n');
fprintf(fp,'opticsGroup1 1 mtf_k2_%dkV.star %f %f %f %f %d 2\n',tmp_Voltage,tmp_Voltage,tmp_SphericalAberration,tmp_AmplitudeContrast,Pixel_Spacing,n_x_u);
fprintf(fp,'\n');
fprintf(fp,'# version 30001\n');
fprintf(fp,'\n');
fprintf(fp,'data_particles\n');
fprintf(fp,'\n');
fprintf(fp,'loop_\n');
fprintf(fp,'_rlnImageName #3\n');
fprintf(fp,'_rlnOpticsGroup #4\n');
fprintf(fp,'_rlnDefocusU #6\n');
fprintf(fp,'_rlnDefocusV #7\n');
fprintf(fp,'_rlnDefocusAngle #8\n');
for nM=0:n_M_relion-1;
fprintf(fp,'%s %s %s %s %s\n',tmp_ImageName_list_{1+nM},tmp_OpticsGroup_list_{1+nM},tmp_DefocusU_list_{1+nM},tmp_DefocusV_list_{1+nM},tmp_DefocusAngle_list_{1+nM});
end;%for nM=0:n_M_relion-1;
fclose(fp);
%%%%%%%%;
% Now write shell script to call command. ;
%%%%%%%%;
fname_command = sprintf('%s_mat/relion_%s.sh',dir_relion,jname);
fp = fopen(fname_command,'w');
fprintf(fp,'%s/relion_refine %s\n',dir_relion_bin,tmp_slash);
fprintf(fp,'--o %s/run %s\n',jname,tmp_slash);
fprintf(fp,'--sgd_ini_iter 50 %s\n',tmp_slash);
fprintf(fp,'--sgd_inbetween_iter 200 %s\n',tmp_slash);
fprintf(fp,'--sgd_fin_iter 50 %s\n',tmp_slash);
fprintf(fp,'--sgd_write_iter 20 %s\n',tmp_slash);
fprintf(fp,'--sgd_ini_resol 35 %s\n',tmp_slash);
fprintf(fp,'--sgd_fin_resol 15 %s\n',tmp_slash);
fprintf(fp,'--sgd_ini_subset 100 %s\n',tmp_slash);
fprintf(fp,'--sgd_fin_subset 500 %s\n',tmp_slash);
fprintf(fp,'--sgd %s\n',tmp_slash);
fprintf(fp,'--denovo_3dref %s\n',tmp_slash);
fprintf(fp,'--i %s %s\n',sprintf('relion_%s.star',jname),tmp_slash);
fprintf(fp,'--ctf %s\n',tmp_slash);
fprintf(fp,'--K 1 %s\n',tmp_slash);
fprintf(fp,'--sym C1 %s\n',tmp_slash);
fprintf(fp,'--flatten_solvent %s\n',tmp_slash);
fprintf(fp,'--zero_mask %s\n',tmp_slash);
fprintf(fp,'--dont_combine_weights_via_disc %s\n',tmp_slash);
fprintf(fp,'--pool 3 %s\n',tmp_slash);
fprintf(fp,'--pad 1 %s\n',tmp_slash);
fprintf(fp,'--skip_gridding %s\n',tmp_slash);
fprintf(fp,'--particle_diameter 300 %s\n',tmp_slash);
fprintf(fp,'--oversampling 1 %s\n',tmp_slash);
fprintf(fp,'--healpix_order 1 %s\n',tmp_slash);
fprintf(fp,'--offset_range 8 %s\n',tmp_slash);
fprintf(fp,'--offset_step 2 %s\n',tmp_slash);
fprintf(fp,'--j 6 %s\n',tmp_slash);
fprintf(fp,'--pipeline_control %s %s\n',jname,tmp_slash);
fprintf(fp,';\n');
fprintf(fp,'\n');
fclose(fp);
disp(sprintf(' %% fname_command: %s',fname_command));
type(fname_command);
%%%%%%%%%%%%%%%%;
end;%for nn_M_relion=0:n_n_M_relion-1;
