load('ampmh_X_wSM___5_debug.mat');
if (verbose); disp(sprintf(' %% [entering ampmh_X_wSM___5_experiment_4]')); end;

%%%%%%%%;
% check shift_z. ;
%%%%%%%%;
l_val_threshold=6;
a_CTF_UX_Y_reduced_yn_ = a_UCTF_UX_Y_0lsq_ync__(:,1); %<-- only use dominant CTF-mode.; 
ix=0;
for pm_nk_p_r = 0:pm_n_k_p_r-1;
pm_l_max = pm_l_max_(1+pm_nk_p_r);
for l_val=0:pm_l_max;
for m_val=-l_val:+l_val;
if (l_val>l_val_threshold); a_CTF_UX_Y_reduced_yn_(1+ix) = 0; end;
ix = ix+1;
end;%for m_val=-l_val:+l_val;
end;%for l_val=0:pm_l_max;
end;%for pm_nk_p_r = 0:pm_n_k_p_r-1;
assert(ix==sum((1 + pm_l_max_).^2));
%%%%%%%%;
flag_plot=0;
if flag_plot;
imagesc_Y( ...
 pm_k_p_r_max ...
,pm_n_k_p_r ...
,1:pm_n_k_p_r ...
,pm_l_max_ ...
,abs(a_CTF_UX_Y_reduced_yn_) ...
,[] ...
,[] ...
);
end;%if flag_plot;
%%%%%%%%;
[ ...
 CTF_UX_S_k_p_reduced_wnS__ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
] = ...
get_template_1( ...
 tmp_verbose ...
,pm_n_k_p_r ...
,pm_k_p_r_ ...
,pm_k_p_r_max ...
,pm_weight_k_p_r_ ...
,pm_l_max_ ...
,a_CTF_UX_Y_reduced_yn_ ...
,viewing_k_eq_d ...
,-1 ...
,pm_n_w_ ...
);
%%%%%%%%;
CTF_UX_S_reduced_l2_ = zeros(n_S,1);
for nS=0:n_S-1;
CTF_UX_S_reduced_l2_(1+nS) = ...
innerproduct_p_quad( ...
 pm_n_k_p_r ...
,pm_k_p_r_ ...
,pm_weight_2d_k_p_r_/(2*pi) ...
,pm_n_w_ ...
,pm_n_w_sum ...
,CTF_UX_S_k_p_reduced_wnS__(:,1+nS) ...
,CTF_UX_S_k_p_reduced_wnS__(:,1+nS) ...
);
end;%for nS=0:n_S-1;
%%%%%%%%;
CTF_UX_S_k_q_reduced_wnS__ = zeros(pm_n_w_sum,n_S);
for nS=0:n_S-1;
CTF_UX_S_k_q_reduced_wnS__(:,1+nS) = ...
interp_p_to_q( ...
 pm_n_k_p_r ...
,pm_n_w_ ...
,pm_n_w_sum ...
,CTF_UX_S_k_p_reduced_wnS__(:,1+nS) ...
); 
end;%for nS=0:n_S-1; 
%%%%%%%%;
svd_VUXM_reduced_lwnM____ = svd_VUXM_lwnM____;
index_q_ = 0:n_w_max-1;
index_q_ = periodize(index_q_,-floor(n_w_max/2),floor(n_w_max/2));
svd_VUXM_reduced_lwnM____(:,find(abs(index_q_)>15),:,:) = 0;
%%%%%%%%;
tmp_t = tic();
UX_M_reduced_l2_dM__ = ampmh_UX_M_l2_dM__1(FTK,pm_n_w_,n_M,pm_n_UX_rank,svd_VUXM_reduced_lwnM____);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% UX_M_l2_dM__: %0.3fs',tmp_t)); end;
%%%%%%%%;
X_wSM_reduced_1ndv___ = zeros(n_w_max,n_S,tmp_n_M);
delta_x_wSM_reduced_1ndv___ = zeros(n_w_max,n_S,tmp_n_M);
delta_y_wSM_reduced_1ndv___ = zeros(n_w_max,n_S,tmp_n_M);
gamma_z_wSM_reduced_1ndv___ = zeros(n_w_max,n_S,tmp_n_M);
I_value_wSM_reduced_1ndv___ = zeros(n_w_max,n_S,tmp_n_M);
parameter = struct('type','parameter');
parameter.n_delta_v_use = 1;
n_M_per_Mbatch = 24;
n_S_per_Sbatch = 24;
tmp_t = tic();
[ ...
 X_wSM_reduced_1ndv___ ...
,delta_x_wSM_reduced_1ndv___ ...
,delta_y_wSM_reduced_1ndv___ ...
,gamma_z_wSM_reduced_1ndv___ ...
,~ ...
] = ...
ampmh_X_wSM___6( ...
 FTK ...
,n_w_max ...
,pm_n_UX_rank ...
,n_S ...
,n_S_per_Sbatch ...
,CTF_UX_S_k_q_reduced_wnS__ ...
,CTF_UX_S_reduced_l2_ ...
,tmp_n_M ...
,n_M_per_Mbatch ...
,svd_VUXM_reduced_lwnM____(:,:,:,1+tmp_index_M_) ...
,UX_M_reduced_l2_dM__(:,1+tmp_index_M_) ...
,parameter ...
);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% X_wSM_reduced_1ndv___: %0.3fs',tmp_t)); end;
t_1ndv = tmp_t;
%%%%%%%%;
tmp_t = tic();
shift_z__ = get_template_inplane_shift_0(n_viewing_all,viewing_polar_a_all_,viewing_azimu_b_all_);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% shift_z__: %0.3fs',tmp_t)); end;
%%%%%%%%;
viewing_pole_k_c_0_all_ = cos(viewing_azimu_b_all_).*sin(viewing_polar_a_all_);
viewing_pole_k_c_1_all_ = sin(viewing_azimu_b_all_).*sin(viewing_polar_a_all_);
viewing_pole_k_c_2_all_ = cos(viewing_polar_a_all_);
viewing_pole_k_c_Sd__ = [viewing_pole_k_c_0_all_ , viewing_pole_k_c_1_all_ , viewing_pole_k_c_2_all_];
[ij_knn__,d_knn__] = knnsearch(viewing_pole_k_c_Sd__,viewing_pole_k_c_Sd__,'K',2);
index_knn_ = ij_knn__(:,2) - 1;
d_knn_ = d_knn__(:,2);
%%%%%%%%;
flag_plot=0;
if flag_plot;
nM=0;
figure(1);figbig;clf;
gamma_z_1_ = 2*pi*(0:n_w_max-1)/n_w_max;
prows=3;pcols=5;np=0;
for nS0=0:prows*pcols-1;
nS1 = index_knn_(1+nS0); %<-- nearest neighbor to nS0. ;
[tmp_X_1,tmp_ij_1] = max(X_wSM_reduced_1ndv___(:,1+nS1,1+nM));
[tmp_X_0,tmp_ij_0] = max(X_wSM_reduced_1ndv___(:,1+nS0,1+nM));
shift_z_p = shift_z__(1+nS0,1+nS1); %<-- shift applied to nS0. ;
gamma_z_0_0_ = periodize(2*pi*[0:n_w_max-1]/n_w_max +  0*shift_z_p,0,2*pi);
gamma_z_0_p_ = periodize(2*pi*[0:n_w_max-1]/n_w_max + -1*shift_z_p,0,2*pi);
gamma_z_0_n_ = periodize(2*pi*[0:n_w_max-1]/n_w_max + +1*shift_z_p,0,2*pi);
subplot(prows,pcols,1+np); np = periodize(1+np,0,prows*pcols);
cla;
hold on;
plot(gamma_z_1_,X_wSM_reduced_1ndv___(:,1+nS1,1+nM),'k-');
plot(gamma_z_1_(tmp_ij_1),tmp_X_1,'ko');
plot(gamma_z_0_p_,X_wSM_reduced_1ndv___(:,1+nS0,1+nM),'r-');
plot(gamma_z_0_p_(tmp_ij_0),tmp_X_0,'ro');
plot(gamma_z_0_0_,X_wSM_reduced_1ndv___(:,1+nS0,1+nM),'g-');
plot(gamma_z_0_0_(tmp_ij_0),tmp_X_0,'go');
plot(gamma_z_0_n_,X_wSM_reduced_1ndv___(:,1+nS0,1+nM),'b-');
plot(gamma_z_0_n_(tmp_ij_0),tmp_X_0,'bo');
hold off;
xlim([0,2*pi]); axisnotick;
title(sprintf('%d,%d d%0.3f z%0.3f',nS0,nS1,d_knn_(1+nS0),shift_z_p));
drawnow;
end;%for nS0=0:n_S-1;
end;%if flag_plot;
%%%%%%%%;
flag_p__ = zeros(n_S,tmp_n_M);
flag_n__ = zeros(n_S,tmp_n_M);
flag_0__ = zeros(n_S,tmp_n_M);
for nM=0:tmp_n_M-1;
for nS0=0:n_S-1;
nS1 = index_knn_(1+nS0); %<-- nearest neighbor to nS0. ;
[tmp_X_1,tmp_ij_1] = max(X_wSM_reduced_1ndv___(:,1+nS1,1+nM));
[tmp_X_0,tmp_ij_0] = max(X_wSM_reduced_1ndv___(:,1+nS0,1+nM));
shift_z_p = shift_z__(1+nS0,1+nS1); %<-- shift applied to nS0. ;
gamma_z_1 = 2*pi*(tmp_ij_1-1)/n_w_max;
gamma_z_0_0 = periodize(2*pi*(tmp_ij_0-1)/n_w_max +  0*shift_z_p,0,2*pi);
gamma_z_0_p = periodize(2*pi*(tmp_ij_0-1)/n_w_max + -1*shift_z_p,0,2*pi);
gamma_z_0_n = periodize(2*pi*(tmp_ij_0-1)/n_w_max + +1*shift_z_p,0,2*pi);
d_g_0 = abs(periodize(gamma_z_1 - gamma_z_0_0,-pi,+pi));
d_g_p = abs(periodize(gamma_z_1 - gamma_z_0_p,-pi,+pi));
d_g_n = abs(periodize(gamma_z_1 - gamma_z_0_n,-pi,+pi));
if (d_g_p< d_g_n & d_g_p< d_g_0); flag_p__(1+nS0,1+nM) = 1; end;
if (d_g_n< d_g_p & d_g_n< d_g_0); flag_n__(1+nS0,1+nM) = 1; end;
if (d_g_0< d_g_p & d_g_0< d_g_n); flag_0__(1+nS0,1+nM) = 1; end;
end;%for nS0=0:n_S-1;
end;%for nM=0:tmp_n_M-1;
%%%%%%%%;
figure(1);clf;
hold on;
plot(d_knn_,sum(flag_p__,2),'ro');
plot(d_knn_,sum(flag_n__,2),'bx');
plot(d_knn_,sum(flag_0__,2),'k.');
hold off;
%%%%%%%%;
% verdict, use p-shift, that is, subtract shift_z__(nS0,nS1) from the gamma of nS0 to match the gamma of nS1. ;
%%%%%%%%;

if (verbose); disp(sprintf(' %% [finished ampmh_X_wSM___5_experiment_4]')); end;

return;
