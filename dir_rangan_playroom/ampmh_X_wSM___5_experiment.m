if (verbose); disp(sprintf(' %% [entering ampmh_X_wSM___5_experiment]')); end;

%load('ampmh_X_wSM___5_debug.mat');

tmp_index_M_ = 0:n_M-1; %<-- consider all images. ;

%%%%%%%%;
% Find CTF-averaged templates.; 
%%%%%%%%;
tmp_t = tic();
VSCTF_avg_ = mean(VSCTF_Mc__(1+tmp_index_M_,:),1);
VSCTF_std_ = std(VSCTF_Mc__(1+tmp_index_M_,:),1,1);
disp(sprintf(' %% VSCTF std/avg:')); disp(num2str(VSCTF_std_./max(1e-12,abs(VSCTF_avg_))));
CTF_UX_S_k_p_wS__ = zeros(pm_n_w_sum,n_S);
for nCTF_rank=0:n_CTF_rank-1;
CTF_UX_S_k_p_wS__ = CTF_UX_S_k_p_wS__ + UCTF_UX_S_k_p_wSc___(:,:,1+nCTF_rank) * VSCTF_avg_(1+nCTF_rank);
end;%for nCTF_rank=0:n_CTF_rank-1;
%%%%%%%%;
CTF_UX_S_l2_ = zeros(n_S,1);
for nS=0:n_S-1;
CTF_UX_S_l2_(1+nS) = ...
innerproduct_p_quad( ...
 pm_n_k_p_r ...
,pm_k_p_r_ ...
,pm_weight_2d_k_p_r_/(2*pi) ...
,pm_n_w_ ...
,pm_n_w_sum ...
,CTF_UX_S_k_p_wS__(:,1+nS) ...
,CTF_UX_S_k_p_wS__(:,1+nS) ...
);
end;%for nS=0:n_S-1;
%%%%%%%%;
CTF_UX_S_k_q_wS__ = zeros(pm_n_w_sum,n_S);
for nS=0:n_S-1;
CTF_UX_S_k_q_wS__(:,1+nS) = ...
interp_p_to_q( ...
 pm_n_k_p_r ...
,pm_n_w_ ...
,pm_n_w_sum ...
,CTF_UX_S_k_p_wS__(:,1+nS) ...
); 
end;%for nS=0:n_S-1; 
%%%%%%%%;
% Now take svd of principal-templates. ;
%%%%%%%%;
SS_k_q_ = svd(CTF_UX_S_k_q_wS__);
n_S_rank = min(find(SS_k_q_/SS_k_q_(1)<1e-3)); if isempty(n_S_rank); n_S_rank = min(size(CTF_UX_S_k_q_wS__)); end;
[US_k_q__,SS_k_q__,VS_k_q__] = svds(CTF_UX_S_k_q_wS__,n_S_rank);
if (verbose>1); disp(sprintf(' %% n_S %d --> n_S_rank %d',n_S,n_S_rank)); end;
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% combining UCTF_UX_S_k_p_wSc___ to form templates: %0.3fs',tmp_t)); end;
%%%%%%%%;

tmp_index_M_ = [1,3]; %<-- take the second and fourth images. ;
tmp_n_M = numel(tmp_index_M_);
nf=0;

%%%%%%%%;
X_SM_full__ = zeros(n_S,tmp_n_M);
delta_x_SM_full__ = zeros(n_S,tmp_n_M);
delta_y_SM_full__ = zeros(n_S,tmp_n_M);
gamma_z_SM_full__ = zeros(n_S,tmp_n_M);
I_value_SM_full__ = zeros(n_S,tmp_n_M);
parameter = struct('type','parameter');
parameter.svd_eps_use = 0;
parameter.n_svd_l_use = 0;
parameter.n_delta_v_use = 0;
parameter.pm_n_UX_rank_use = 0;
parameter.flag_optimize_over_gamma_z = 1;
n_M_per_Mbatch = 24;
n_S_per_Sbatch = 24;
tmp_t = tic();
[ ...
 X_SM_full__ ...
,delta_x_SM_full__ ...
,delta_y_SM_full__ ...
,gamma_z_SM_full__ ...
,~ ...
] = ...
ampmh_X_wSM___6( ...
 FTK ...
,n_w_max ...
,pm_n_UX_rank ...
,n_S ...
,n_S_per_Sbatch ...
,CTF_UX_S_k_q_wS__ ...
,CTF_UX_S_l2_ ...
,tmp_n_M ...
,n_M_per_Mbatch ...
,svd_VUXM_lwnM____(:,:,:,1+tmp_index_M_) ...
,UX_M_l2_dM__(:,1+tmp_index_M_) ...
,parameter ...
);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% X_SM_full__: %0.3fs',tmp_t)); end;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;figbeach(); np=0;
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_full__(:,1+0),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_full__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_full__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_full__(:,1+0),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_full__(:,1+1),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_full__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_full__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_full__(:,1+1),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 1');
sgtitle(sprintf('full time: %0.3f',tmp_t));
%%%%%%%%;

%%%%%%%%;
X_SM_rsvd__ = zeros(n_S,tmp_n_M);
delta_x_SM_rsvd__ = zeros(n_S,tmp_n_M);
delta_y_SM_rsvd__ = zeros(n_S,tmp_n_M);
gamma_z_SM_rsvd__ = zeros(n_S,tmp_n_M);
I_value_SM_rsvd__ = zeros(n_S,tmp_n_M);
parameter = struct('type','parameter');
parameter.svd_eps_use = 0.1;
parameter.n_svd_l_use = 0;
parameter.n_delta_v_use = 0;
parameter.pm_n_UX_rank_use = 0;
parameter.flag_optimize_over_gamma_z = 1;
n_M_per_Mbatch = 24;
n_S_per_Sbatch = 24;
tmp_t = tic();
[ ...
 X_SM_rsvd__ ...
,delta_x_SM_rsvd__ ...
,delta_y_SM_rsvd__ ...
,gamma_z_SM_rsvd__ ...
,~ ...
] = ...
ampmh_X_wSM___6( ...
 FTK ...
,n_w_max ...
,pm_n_UX_rank ...
,n_S ...
,n_S_per_Sbatch ...
,CTF_UX_S_k_q_wS__ ...
,CTF_UX_S_l2_ ...
,tmp_n_M ...
,n_M_per_Mbatch ...
,svd_VUXM_lwnM____(:,:,:,1+tmp_index_M_) ...
,UX_M_l2_dM__(:,1+tmp_index_M_) ...
,parameter ...
);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% X_SM_rsvd__: %0.3fs',tmp_t)); end;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;figbeach(); np=0;
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_rsvd__(:,1+0),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_rsvd__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_rsvd__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_rsvd__(:,1+0),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_rsvd__(:,1+1),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_rsvd__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_rsvd__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_rsvd__(:,1+1),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 1');
sgtitle(sprintf('rsvd time: %0.3f',tmp_t));
%%%%%%%%;

%%%%%%%%;
X_SM_rdvu__ = zeros(n_S,tmp_n_M);
delta_x_SM_rdvu__ = zeros(n_S,tmp_n_M);
delta_y_SM_rdvu__ = zeros(n_S,tmp_n_M);
gamma_z_SM_rdvu__ = zeros(n_S,tmp_n_M);
I_value_SM_rdvu__ = zeros(n_S,tmp_n_M);
parameter = struct('type','parameter');
parameter.svd_eps_use = 0;
parameter.n_svd_l_use = 0;
parameter.n_delta_v_use = 41;
parameter.pm_n_UX_rank_use = 0;
parameter.flag_optimize_over_gamma_z = 1;
n_M_per_Mbatch = 24;
n_S_per_Sbatch = 24;
tmp_t = tic();
[ ...
 X_SM_rdvu__ ...
,delta_x_SM_rdvu__ ...
,delta_y_SM_rdvu__ ...
,gamma_z_SM_rdvu__ ...
,~ ...
] = ...
ampmh_X_wSM___6( ...
 FTK ...
,n_w_max ...
,pm_n_UX_rank ...
,n_S ...
,n_S_per_Sbatch ...
,CTF_UX_S_k_q_wS__ ...
,CTF_UX_S_l2_ ...
,tmp_n_M ...
,n_M_per_Mbatch ...
,svd_VUXM_lwnM____(:,:,:,1+tmp_index_M_) ...
,UX_M_l2_dM__(:,1+tmp_index_M_) ...
,parameter ...
);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% X_SM_rdvu__: %0.3fs',tmp_t)); end;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;figbeach(); np=0;
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_rdvu__(:,1+0),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_rdvu__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_rdvu__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_rdvu__(:,1+0),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_rdvu__(:,1+1),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_rdvu__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_rdvu__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_rdvu__(:,1+1),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 1');
sgtitle(sprintf('rdvu time: %0.3f',tmp_t));
%%%%%%%%;

%%%%%%%%;
X_SM_rpmn__ = zeros(n_S,tmp_n_M);
delta_x_SM_rpmn__ = zeros(n_S,tmp_n_M);
delta_y_SM_rpmn__ = zeros(n_S,tmp_n_M);
gamma_z_SM_rpmn__ = zeros(n_S,tmp_n_M);
I_value_SM_rpmn__ = zeros(n_S,tmp_n_M);
parameter = struct('type','parameter');
parameter.svd_eps_use = 0;
parameter.n_svd_l_use = 0;
parameter.n_delta_v_use = 0;
parameter.pm_n_UX_rank_use = 6;
parameter.flag_optimize_over_gamma_z = 1;
n_M_per_Mbatch = 24;
n_S_per_Sbatch = 24;
tmp_t = tic();
[ ...
 X_SM_rpmn__ ...
,delta_x_SM_rpmn__ ...
,delta_y_SM_rpmn__ ...
,gamma_z_SM_rpmn__ ...
,~ ...
] = ...
ampmh_X_wSM___6( ...
 FTK ...
,n_w_max ...
,pm_n_UX_rank ...
,n_S ...
,n_S_per_Sbatch ...
,CTF_UX_S_k_q_wS__ ...
,CTF_UX_S_l2_ ...
,tmp_n_M ...
,n_M_per_Mbatch ...
,svd_VUXM_lwnM____(:,:,:,1+tmp_index_M_) ...
,UX_M_l2_dM__(:,1+tmp_index_M_) ...
,parameter ...
);
tmp_t = toc(tmp_t); if (verbose>1); disp(sprintf(' %% X_SM_rpmn__: %0.3fs',tmp_t)); end;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;figbeach(); np=0;
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_rpmn__(:,1+0),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_rpmn__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_rpmn__(:,1+0),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_rpmn__(:,1+0),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 0');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,X_SM_rpmn__(:,1+1),[],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('X 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_x_SM_rpmn__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_x 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,delta_y_SM_rpmn__(:,1+1),FTK.svd_d_max*[-1,+1],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('delta_y 1');
subplot(2,4,1+np); np=np+1; imagesc_polar_a_azimu_b_0(viewing_polar_a_all_,viewing_azimu_b_all_,gamma_z_SM_rpmn__(:,1+1),[0,2*pi],colormap_beach());
xlim([0,2*pi]); ylim([0,pi]); axis tight; axisnotick; title('gamma_z 1');
sgtitle(sprintf('rpmn time: %0.3f',tmp_t));
%%%%%%%%;

if (verbose); disp(sprintf(' %% [finished ampmh_X_wSM___5_experiment]')); end;

return;
