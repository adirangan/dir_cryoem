flag_verbose=1; flag_disp=0;nf=0;
flag_speed_vs_error = 0;

disp(sprintf(' %% testing tfpmh_Z_wSM___14: flag_speed_vs_error %d',flag_speed_vs_error));
n_1 = 1; n_2 = 2;
k_p_r_max = 48/(2*pi); k_eq_d = 1.0/(2*pi); str_L = 'L';
[ ...
 n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
] = ...
get_weight_3d_1( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_L ...
);
%%%%;
n_w_int = 1;
l_max_upb = round(2*pi*k_p_r_max);
l_max_max = min(l_max_upb,1+ceil(2*pi*k_p_r_(end)));
n_w_max = n_w_int*2*(l_max_max+1); n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_0in_ ...
,weight_3d_k_p_r_ ...
);
n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
%%%%;
if flag_speed_vs_error==0; n_M = 17; end;
if flag_speed_vs_error==1; n_M = 1024; end;
n_source = 3;
delta_2sM___ = permute(reshape(linspace(-0.05,+0.05,n_2*n_source*n_M),[n_M,n_2,n_source]),1+[1,2,0]);
M_k_p_wkM__ = zeros(n_w_sum,n_M);
for nM=0:n_M-1;
for nsource=0:n_source-1;
delta_0 = delta_2sM___(1+0,1+nsource,1+nM); delta_1 = delta_2sM___(1+1,1+nsource,1+nM);
M_k_p_wkM__(:,1+nM) = M_k_p_wkM__(:,1+nM) + 1*exp(+i*2*pi*(k_c_0_wk_*delta_0 + k_c_1_wk_*delta_1));
end;%for nsource=0:n_source-1;
end;%for nM=0:n_M-1;
%%%%;
if flag_speed_vs_error==0; n_S = 19; end;
if flag_speed_vs_error==1; n_S = 993; end;
n_source = 3;
delta_2sS___ = permute(reshape(linspace(-0.07,+0.07,n_2*n_source*n_S),[n_S,n_2,n_source]),1+[1,2,0]);
S_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
for nsource=0:n_source-1;
delta_0 = delta_2sS___(1+0,1+nsource,1+nS); delta_1 = delta_2sS___(1+1,1+nsource,1+nS);
S_k_p_wkS__(:,1+nS) = S_k_p_wkS__(:,1+nS) + 1*exp(+i*2*pi*(k_c_0_wk_*delta_0 + k_c_1_wk_*delta_1));
end;%for nsource=0:n_source-1;
end;%for nM=0:n_M-1;
%%%%;
n_CTF = 1;
CTF_k_p_r_k_ = 0.5 + 1.0*cos(2*pi*k_p_r_);
%%%%;
[ ...
 X_kk__ ...
,X_weight_r_ ...
] = ...
principled_marching_empirical_cost_matrix_1( ...
 n_k_p_r ...
,k_p_r_ ...
,weight_2d_k_p_r_ ...
,n_w_ ...
,n_M ...
,M_k_p_wkM__ ...
);
if flag_speed_vs_error==0; pm_n_UX_rank = min(2,n_k_p_r-1); end; %<-- should be accurate even when radial-compression is lossy. ;
if flag_speed_vs_error==1; pm_n_UX_rank = 17; end;
[tmp_UX_kn__,tmp_SX_k__,tmp_VX_kn__] = svds(X_kk__,pm_n_UX_rank);
pm_UX_kn__(:,1:pm_n_UX_rank) = tmp_UX_kn__(:,1:pm_n_UX_rank);
pm_X_weight_r_ = sqrt(weight_2d_k_p_r_);
%%%%;
delta_r_max = 0.5/max(1e-12,k_p_r_max); 
if flag_speed_vs_error==0; svd_eps = 1e-9; n_delta_v_requested =  9; end;
if flag_speed_vs_error==1; svd_eps = 1e-2; n_delta_v_requested = 32; end;

FTK = tfh_FTK_2(n_k_p_r,k_p_r_,k_p_r_max,delta_r_max,svd_eps,n_delta_v_requested);
n_delta_v = FTK.n_delta_v;
n_svd_l = FTK.n_svd_l;
%%%%%%%%;
if (flag_verbose>0); disp(sprintf(' %% n_k_p_r %d n_w_max %d pm_n_UX_rank %d n_delta_v %d n_svd_l %d n_M %d n_S %d',n_k_p_r,n_w_max,pm_n_UX_rank,n_delta_v,n_svd_l,n_M,n_S)); end;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
if flag_speed_vs_error==1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
tmp_t = tic();
parameter=struct('type','parameter');
parameter.flag_verbose = 1;
parameter.n_M_per_Mbatch = 24;
parameter.n_S_per_Sbatch = 24;
parameter.flag_dwSM = 0;
parameter.flag_optimize_over_gamma_z = 1;
[ ...
 parameter ...
,tfpmh_Z_wSM___ ...
,tfpmh_UX_T_M_l2_dM__ ...
,tfpmh_UX_M_l2_M_ ...
,tfpmh_UX_CTF_S_l2_S_ ...
,tfpmh_X_wSM___ ...
,tfpmh_delta_x_wSM___ ...
,tfpmh_delta_y_wSM___ ...
,tfpmh_gamma_z_wSM___ ...
,tfpmh_index_sub_wSM___ ...
,tfpmh_Z_dwSM____ ...
,tfpmh_X_dwSM____ ...
] = ...
tfpmh_Z_wSM___14( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_M ...
,M_k_p_wkM__ ...
,CTF_k_p_r_k_ ...
,n_S ...
,S_k_p_wkS__ ...
,pm_n_UX_rank ...
,pm_UX_kn__ ...
,pm_X_weight_r_ ...
,FTK ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% tfpmh_Z_wSM___14: %0.6f',tmp_t)); end;
parameter_timing_printf(parameter);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%if flag_speed_vs_error==1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
if flag_speed_vs_error==0;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
n_type = 2;
%%%%%%%%%%%%%%%%;
for ntype=0:n_type-1;
%%%%%%%%%%%%%%%%;
parameter=struct('type','parameter');
parameter.flag_verbose = 1;
if ntype==0; parameter.flag_optimize_over_gamma_z = 0; end;
if ntype==2; parameter.flag_optimize_over_gamma_z = 1; end;
parameter.n_M_per_Mbatch = 3;
parameter.n_S_per_Sbatch = 5;
parameter.flag_dwSM = 1;
parameter.flag_verbose = max(0,flag_verbose-1);
[ ...
 parameter ...
,tfpmh_Z_wSM___ ...
,tfpmh_UX_T_M_l2_dM__ ...
,tfpmh_UX_M_l2_M_ ...
,tfpmh_UX_CTF_S_l2_S_ ...
,tfpmh_X_wSM___ ...
,tfpmh_delta_x_wSM___ ...
,tfpmh_delta_y_wSM___ ...
,tfpmh_gamma_z_wSM___ ...
,tfpmh_index_sub_wSM___ ...
,tfpmh_Z_dwSM____ ...
,tfpmh_X_dwSM____ ...
] = ...
tfpmh_Z_wSM___14( ...
 parameter ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_k_p_wk_ ...
,n_M ...
,M_k_p_wkM__ ...
,CTF_k_p_r_k_ ...
,n_S ...
,S_k_p_wkS__ ...
,pm_n_UX_rank ...
,pm_UX_kn__ ...
,pm_X_weight_r_ ...
,FTK ...
);
%%%%%%%%;
% compare to ../dir_rangan_python/dir_pymat/test_tfpmh_Z_wSM___14.mat. ;
%%%%;
dir_pymat = '../dir_rangan_python/dir_pymat';
fname_pymat = sprintf('%s/test_tfpmh_Z_wSM___14.mat',dir_pymat);
if ~exist(fname_pymat,'file'); disp(sprintf(' %% Warning, %s not found',fname_pymat)); end;
if  exist(fname_pymat,'file');
disp(sprintf(' %% %s found, loading',fname_pymat));
tmp_ = load(fname_pymat);
fnorm_disp(flag_verbose,'tfpmh_Z_wSM___',tfpmh_Z_wSM___,'tmp_.tfpmh_Z_wSM___',tmp_.tfpmh_Z_wSM___,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_UX_T_M_l2_dM__',tfpmh_UX_T_M_l2_dM__,'tmp_.tfpmh_UX_T_M_l2_dM__',tmp_.tfpmh_UX_T_M_l2_dM__,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_UX_M_l2_M_',tfpmh_UX_M_l2_M_,'tmp_.tfpmh_UX_M_l2_M_',tmp_.tfpmh_UX_M_l2_M_,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_UX_CTF_S_l2_S_',tfpmh_UX_CTF_S_l2_S_,'tmp_.tfpmh_UX_CTF_S_l2_S_',tmp_.tfpmh_UX_CTF_S_l2_S_,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_X_wSM___',tfpmh_X_wSM___,'tmp_.tfpmh_X_wSM___',tmp_.tfpmh_X_wSM___,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_delta_x_wSM___',tfpmh_delta_x_wSM___,'tmp_.tfpmh_delta_x_wSM___',tmp_.tfpmh_delta_x_wSM___,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_delta_y_wSM___',tfpmh_delta_y_wSM___,'tmp_.tfpmh_delta_y_wSM___',tmp_.tfpmh_delta_y_wSM___,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_gamma_z_wSM___',tfpmh_gamma_z_wSM___,'tmp_.tfpmh_gamma_z_wSM___',tmp_.tfpmh_gamma_z_wSM___,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_index_sub_wSM___',tfpmh_index_sub_wSM___,'double(tmp_.tfpmh_index_sub_wSM___)',double(tmp_.tfpmh_index_sub_wSM___),' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_Z_dwSM____',tfpmh_Z_dwSM____,'tmp_.tfpmh_Z_dwSM____',tmp_.tfpmh_Z_dwSM____,' %%<-- should be <1e-6');
fnorm_disp(flag_verbose,'tfpmh_X_dwSM____',tfpmh_X_dwSM____,'tmp_.tfpmh_X_dwSM____',tmp_.tfpmh_X_dwSM____,' %%<-- should be <1e-6');
end;%if  exist(fname_pymat,'file');
%%%%%%%%;
% check. ;
%%%%%%%%;
gamma_z_ = linspace(0,2*pi,1+n_w_max); gamma_z_ = transpose(gamma_z_(1:n_w_max));
pm_n_k_p_r = pm_n_UX_rank; pm_n_w_max = n_w_max;
pm_n_w_ = pm_n_w_max*ones(pm_n_k_p_r,1);
pm_n_w_sum = pm_n_k_p_r*pm_n_w_max;
pm_wUX_kn__ = diag(pm_X_weight_r_)*pm_UX_kn__;
tmp_Z_errrel = 0.0;
tmp_X_errrel = 0.0;
for nS=0:n_S-1;
for nM=0:n_M-1;
%%%%;
if parameter.flag_optimize_over_gamma_z==0;
nw = max(0,min(n_w_max-1,floor(n_w_max*rand()))); gamma_z = (2*pi*nw)/max(1,n_w_max);
delta_x = tfpmh_delta_x_wSM___(1+nw,1+nS,1+nM); delta_y = tfpmh_delta_y_wSM___(1+nw,1+nS,1+nM);
Z_tfpm = tfpmh_Z_wSM___(1+nw,1+nS,1+nM);
X_tfpm = tfpmh_X_wSM___(1+nw,1+nS,1+nM);
end;%if parameter.flag_optimize_over_gamma_z==0;
%%%%;
if parameter.flag_optimize_over_gamma_z==1;
gamma_z = tfpmh_gamma_z_wSM___(1+nS,1+nM);
delta_x = tfpmh_delta_x_wSM___(1+nS,1+nM); delta_y = tfpmh_delta_y_wSM___(1+nS,1+nM);
Z_tfpm = tfpmh_Z_wSM___(1+nS,1+nM);
X_tfpm = tfpmh_X_wSM___(1+nS,1+nM);
end;%if parameter.flag_optimize_over_gamma_z==1;
%%%%;
ndelta_v = intersect(efind(abs(FTK.delta_x_-delta_x)<1e-6),efind(abs(FTK.delta_y_-delta_y)<1e-6));
nw = efind(abs(gamma_z_-gamma_z)<1e-6);
Z_tens = tfpmh_Z_dwSM____(1+ndelta_v,1+nw,1+nS,1+nM);
X_tens = tfpmh_X_dwSM____(1+ndelta_v,1+nw,1+nS,1+nM);
%%%%;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
M_k_p_wk_ = M_k_p_wkM__(:,1+nM);
CTF_k_p_wk_ = reshape(repmat(reshape(CTF_k_p_r_k_,[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1]);
gamma_z = (2*pi*nw)/max(1,n_w_max);
CTF_S_k_p_wk_ = CTF_k_p_wk_.*S_k_p_wk_;
UX_CTF_S_k_p_wn_ = reshape(reshape(CTF_S_k_p_wk_,[n_w_max,n_k_p_r])*pm_wUX_kn__,[pm_n_w_sum,1]);
UX_CTF_S_l2 = sum(conj(UX_CTF_S_k_p_wn_).*UX_CTF_S_k_p_wn_) / max(1,pm_n_w_max) ;
RS_k_p_wk_ = rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,S_k_p_wk_,+gamma_z);
CTF_RS_k_p_wk_ = RS_k_p_wk_.*CTF_k_p_wk_;
UX_CTF_RS_k_p_wn_ = reshape(reshape(CTF_RS_k_p_wk_,[n_w_max,n_k_p_r])*pm_wUX_kn__,[pm_n_w_sum,1]);
UX_CTF_RS_l2 = sum(conj(UX_CTF_RS_k_p_wn_).*UX_CTF_RS_k_p_wn_) / max(1,pm_n_w_max) ;
TM_k_p_wk_ = transf_p_to_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,M_k_p_wk_,+delta_x,+delta_y);
UX_TM_k_p_wn_ = reshape(reshape(TM_k_p_wk_,[n_w_max,n_k_p_r])*pm_wUX_kn__,[pm_n_w_sum,1]);
UX_TM_l2 = sum(conj(UX_TM_k_p_wn_).*UX_TM_k_p_wn_) / max(1,pm_n_w_max) ;
UX_CTF_RS_k_p_UX_TM_k_p = sum(conj(UX_CTF_RS_k_p_wn_).*UX_TM_k_p_wn_) / max(1,pm_n_w_max) ;
Z_quad = UX_CTF_RS_k_p_UX_TM_k_p;
X_quad = Z_quad / max(1e-12,sqrt(UX_CTF_RS_l2)) / max(1e-12,sqrt(UX_TM_l2));
%%%%;
if (flag_verbose>2); disp(sprintf(' %% nS %.2d/%.2d nM %.2d/%.2d',nS,n_S,nM,n_M)); end;
tmp_Z_errrel = tmp_Z_errrel + fnorm_disp(max(0,flag_verbose-1),'Z_quad',Z_quad,'Z_tfpm',Z_tfpm,' %%<-- should be zero');
tmp_Z_errrel = tmp_Z_errrel + fnorm_disp(max(0,flag_verbose-1),'Z_quad',Z_quad,'Z_tens',Z_tens,' %%<-- should be zero');
tmp_Z_errrel = tmp_Z_errrel + fnorm_disp(max(0,flag_verbose-1),'Z_tfpm',Z_tfpm,'Z_tens',Z_tens,' %%<-- should be zero');
tmp_X_errrel = tmp_X_errrel + fnorm_disp(max(0,flag_verbose-1),'X_quad',X_quad,'X_tfpm',X_tfpm,' %%<-- should be zero');
tmp_X_errrel = tmp_X_errrel + fnorm_disp(max(0,flag_verbose-1),'X_quad',X_quad,'X_tens',X_tens,' %%<-- should be zero');
tmp_X_errrel = tmp_X_errrel + fnorm_disp(max(0,flag_verbose-1),'X_tfpm',X_tfpm,'X_tens',X_tens,' %%<-- should be zero');
%%%%;
end;%for nM=0:n_M-1;
end;%for nS=0:n_S-1;
if (flag_verbose>0); disp(sprintf(' %% parameter.flag_optimize_over_gamma_z = %d; tmp_Z_errrel: %0.16f',parameter.flag_optimize_over_gamma_z,tmp_Z_errrel)); end;
if (flag_verbose>0); disp(sprintf(' %% parameter.flag_optimize_over_gamma_z = %d; tmp_X_errrel: %0.16f',parameter.flag_optimize_over_gamma_z,tmp_X_errrel)); end;
%%%%%%%%%%%%%%%%;
end;%for ntype=0:n_type-1;
%%%%%%%%%%%%%%%%;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
end;%if flag_speed_vs_error==0;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
