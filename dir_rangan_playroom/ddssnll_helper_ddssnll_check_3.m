%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
if flag_check;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
dvt = dvt_check;
%%%%%%%%;
% Calculate the gradient: ;
%%%%%%%%;
dvol_ssnll_q3d_k_p_quad_ = + 1.0 * ( conj(a_k_p_quad_) .* (a_restore_C2M0_k_p_quad_) - conj(a_restore_C1M1_k_p_quad_) );
dvol_ssnll_q3d_k_Y_quad_yk__ = + 1.0 * ( conj(a_times_a_restore_C2M0_k_Y_quad_yk__) - conj(a_restore_C1M1_k_Y_quad_yk__) );
dtau_ssnll_q2d_M3__ = dtau_ssnll_q2d_M3__ ;
%%%%%%%%;
dvol_ssnll_q3d_k_Y_quad_yk_ = local_yk_from_yk__(n_k_p_r,l_max_,dvol_ssnll_q3d_k_Y_quad_yk__);
%%%%%%%%;
G_ykabc_ = cat(1,dvol_ssnll_q3d_k_Y_quad_yk_,dtau_ssnll_q2d_M3__(:,1+0),dtau_ssnll_q2d_M3__(:,1+1),dtau_ssnll_q2d_M3__(:,1+2));
G_bar_ykabc_ = conj(G_ykabc_); %<-- note here we take a conjugate to allow for standard dot-product. ;
%%%%%%%%;
% Now calculate the difference-quotient and compare. ;
%%%%%%%%;
dvt_ykabc_ = local_ykabc_from_yk_a_b_c_(n_k_p_r,l_max_,n_M,dvol_a_k_Y_quad_yk_,dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_);
dvt_ykabc_l2 = local_imagecount_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_M,weight_imagecount_M_,dvt_ykabc_,dvt_ykabc_);
dssnll_mid_q2d = local_imagecount_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_M,weight_imagecount_M_,G_bar_ykabc_,dvt_ykabc_);
%%%%;
dvt_ = transpose(-8:+8);
n_dvt = numel(dvt_);
ssnll_tmp_q2d_dvt_ = zeros(n_dvt,1);
%%%%;
for ndvt=0:n_dvt-1;
if (flag_verbose>0); disp(sprintf(' %% ndvt %d/%d',ndvt,n_dvt)); end;
tmp_euler_polar_a_M_ = euler_polar_a_M_ + 1.0*dvt*dvt_(1+ndvt)*dtau_euler_polar_a_M_;
tmp_euler_azimu_b_M_ = euler_azimu_b_M_ + 1.0*dvt*dvt_(1+ndvt)*dtau_euler_azimu_b_M_;
tmp_euler_gamma_z_M_ = euler_gamma_z_M_ + 1.0*dvt*dvt_(1+ndvt)*dtau_euler_gamma_z_M_;
[tmp_euler_polar_a_M_,tmp_euler_azimu_b_M_] = periodize_polar_a_azimu_b_0(tmp_euler_polar_a_M_,tmp_euler_azimu_b_M_);
tmp_euler_gamma_z_M_ = periodize(tmp_euler_gamma_z_M_,0,2*pi);
[ ...
 ~ ...
,~ ...
,ssnll_tmp_q2d_dvt_(1+ndvt) ...
] = ...
ssnll_from_a_k_Y_13( ...
 parameter_ssnll ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,l_max_ ...
,a_k_Y_quad_yk__ + 1.0*dvt*dvt_(1+ndvt)*dvol_a_k_Y_quad_yk__...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,tmp_euler_polar_a_M_ ...
,tmp_euler_azimu_b_M_ ...
,tmp_euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
);
end;%for ndvt=0:n_dvt-1;
%%%%;
ssnll_mid_q2d = ssnll_tmp_q2d_dvt_((1+n_dvt)/2);
ssnll_pos_q2d = ssnll_tmp_q2d_dvt_((1+n_dvt)/2+1);
ssnll_neg_q2d = ssnll_tmp_q2d_dvt_((1+n_dvt)/2-1);
dssnll_dif_q2d = (ssnll_pos_q2d - ssnll_neg_q2d)/max(1e-12,2*dvt);
fnorm_disp(flag_verbose,'dssnll_dif_q2d',dssnll_dif_q2d,'dssnll_mid_q2d',dssnll_mid_q2d);
%%%%;
tmp_x_ = dvt*dvt_;
tmp_y_ = real(ssnll_tmp_q2d_dvt_);
tmp_x4 = sum(tmp_x_.^4);
tmp_x3 = sum(tmp_x_.^3);
tmp_x2 = sum(tmp_x_.^2);
tmp_x1 = sum(tmp_x_.^1);
tmp_x0 = sum(tmp_x_.^0);
tmp_yx2 = sum(tmp_y_.*tmp_x_.^2);
tmp_yx1 = sum(tmp_y_.*tmp_x_.^1);
tmp_yx0 = sum(tmp_y_.*tmp_x_.^0);
tmp_lhs_ = [ ...
 tmp_x4 tmp_x3 tmp_x2 ...
;tmp_x3 tmp_x2 tmp_x1 ...
;tmp_x2 tmp_x1 tmp_x0 ...
];
tmp_rhs_ = [ tmp_yx2 ; tmp_yx1 ; tmp_yx0 ];
tmp_p_ = tmp_lhs_\tmp_rhs_;
tmp_p_x_ = polyval(tmp_p_,tmp_x_);
%%%%;
if (flag_disp>1);
figure(1+nf);nf=nf+1;clf;figsml;
markersize_use = 12;
linewidth_use = 2;
hold on;
plot(tmp_x_,tmp_p_x_,'k-','LineWidth',linewidth_use);
plot(tmp_x_,ssnll_tmp_q2d_dvt_,'ko','MarkerSize',markersize_use,'MarkerFaceColor','c');
xlabel('dvt_','Interpreter','none');
ylabel('ssnll_tmp_q2d_dvt_','Interpreter','none');
end;%if (flag_disp>1);
%%%%;
dssnll_lsq_q2d = 1.0*tmp_p_(1+1);
fnorm_disp(flag_verbose,'dssnll_lsq_q2d',dssnll_lsq_q2d,'dssnll_mid_q2d',dssnll_mid_q2d);
%%%%%%%%;
% Estimate the second-derivative. ;
%%%%%%%%;
ddssnll_mid_q2d = local_imagecount_f_bar_dot_g_(n_k_p_r,weight_3d_riesz_k_p_r_,l_max_,n_M,weight_imagecount_M_,Hvt_ykabc_,dvt_ykabc_);
%%%%;
ssnll_mid_q2d = ssnll_tmp_q2d_dvt_((1+n_dvt)/2);
ssnll_pos_q2d = ssnll_tmp_q2d_dvt_((1+n_dvt)/2+1);
ssnll_neg_q2d = ssnll_tmp_q2d_dvt_((1+n_dvt)/2-1);
ddssnll_dif_q2d = (ssnll_pos_q2d - 2*ssnll_mid_q2d + ssnll_neg_q2d)/max(1e-12,dvt^2);
fnorm_disp(flag_verbose,'ddssnll_dif_q2d',ddssnll_dif_q2d,'ddssnll_mid_q2d',ddssnll_mid_q2d);
%%%%;
ddssnll_lsq_q2d = 2.0*tmp_p_(1+0);
fnorm_disp(flag_verbose,'ddssnll_lsq_q2d',ddssnll_lsq_q2d,'ddssnll_mid_q2d',ddssnll_mid_q2d);
%%%%;
if (flag_verbose>2);
disp(sprintf(' %% dssnll_mid_q2d:  %+0.16f',dssnll_mid_q2d));
disp(sprintf(' %% dssnll_dif_q2d:  %+0.16f',dssnll_dif_q2d));
disp(sprintf(' %% dssnll_lsq_q2d:  %+0.16f',dssnll_lsq_q2d));
disp(sprintf(' %% ddssnll_mid_q2d: %+0.16f',ddssnll_mid_q2d));
disp(sprintf(' %% ddssnll_dif_q2d: %+0.16f',ddssnll_dif_q2d));
disp(sprintf(' %% ddssnll_lsq_q2d: %+0.16f',ddssnll_lsq_q2d));
end;%if (flag_verbose>2);
%%%%%%%%;
end;%if flag_check;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;
