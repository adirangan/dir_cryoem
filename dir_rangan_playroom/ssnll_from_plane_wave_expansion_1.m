function ...
[ ...
 parameter ...
,ssnll_M_ ...
,ssnll ...
,S_k_p_wkS__ ...
,dvol_ssnll_M_ ...
,dvol_ssnll ...
,dvol_S_k_p_wkS__ ...
,dvol_dvol_ssnll ...
,dtau_ssnll_M3__ ...
,dtau_ssnll ...
,dtau_S_k_p_wkS3___ ...
,dtau_dvol_ssnll_M3__ ...
,dtau_dvol_ssnll ...
,dtau_dvol_S_k_p_wkS3___ ...
,dtau_dtau_ssnll_M33___ ...
,dtau_dtau_ssnll ...
,dtau_dtau_S_k_p_wkS33____ ...
] = ...
ssnll_from_plane_wave_expansion_1( ...
 parameter ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,fromb_polar_a_M_ ...
,fromb_azimu_b_M_ ...
,fromb_gamma_z_M_ ...
,n_S ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);

str_thisfunction = 'ssnll_from_plane_wave_expansion_1';

if nargin<1;
disp(sprintf(' %% testing %s',str_thisfunction));
test_ssnll_from_plane_wave_expansion_0;
disp('returning'); return;
end;%if nargin<1;

na=0;
if (nargin<1+na); parameter=[]; end; na=na+1;
if (nargin<1+na); n_source_a=[]; end; na=na+1;
if (nargin<1+na); v_source_a_=[]; end; na=na+1;
if (nargin<1+na); delta_a_c__=[]; end; na=na+1;
if (nargin<1+na); n_source_b=[]; end; na=na+1;
if (nargin<1+na); v_source_b_=[]; end; na=na+1;
if (nargin<1+na); delta_b_c__=[]; end; na=na+1;
if (nargin<1+na); n_source_dvol_a=[]; end; na=na+1;
if (nargin<1+na); v_source_dvol_a_=[]; end; na=na+1;
if (nargin<1+na); delta_dvol_a_c__=[]; end; na=na+1;
if (nargin<1+na); n_k_p_r=[]; end; na=na+1;
if (nargin<1+na); k_p_r_=[]; end; na=na+1;
if (nargin<1+na); n_w_max=[]; end; na=na+1;
if (nargin<1+na); weight_2d_wk_=[]; end; na=na+1;
if (nargin<1+na); n_CTF=[]; end; na=na+1;
if (nargin<1+na); index_nCTF_from_nM_=[]; end; na=na+1;
if (nargin<1+na); CTF_k_p_wkC__=[]; end; na=na+1;
if (nargin<1+na); n_eta=[]; end; na=na+1;
if (nargin<1+na); index_neta_from_nM_=[]; end; na=na+1;
if (nargin<1+na); eta_k_p_wke__=[]; end; na=na+1;
if (nargin<1+na); n_M=[]; end; na=na+1;
if (nargin<1+na); euler_polar_a_M_=[]; end; na=na+1;
if (nargin<1+na); euler_azimu_b_M_=[]; end; na=na+1;
if (nargin<1+na); euler_gamma_z_M_=[]; end; na=na+1;
if (nargin<1+na); dtau_euler_polar_a_M_=[]; end; na=na+1;
if (nargin<1+na); dtau_euler_azimu_b_M_=[]; end; na=na+1;
if (nargin<1+na); dtau_euler_gamma_z_M_=[]; end; na=na+1;
if (nargin<1+na); fromb_polar_a_M_=[]; end; na=na+1;
if (nargin<1+na); fromb_azimu_b_M_=[]; end; na=na+1;
if (nargin<1+na); fromb_gamma_z_M_=[]; end; na=na+1;
if (nargin<1+na); n_S=[]; end; na=na+1;
if (nargin<1+na); viewing_polar_a_S_=[]; end; na=na+1;
if (nargin<1+na); viewing_azimu_b_S_=[]; end; na=na+1;
if (nargin<1+na); viewing_gamma_z_S_=[]; end; na=na+1;

if isempty(parameter); parameter=struct('type','parameter'); end;
if ~isfield(parameter,'flag_verbose'); parameter.flag_verbose=0; end;
flag_verbose=parameter.flag_verbose;

if (flag_verbose> 0); disp(sprintf(' %% [entering %s]',str_thisfunction)); end;

%%%%%%%%;
% define rotations. ;
%%%%%%%%;
Rz = @(azimu_b) ...
[ +cos(azimu_b) -sin(azimu_b) 0 ; ...
  +sin(azimu_b) +cos(azimu_b) 0 ; ...
   0             0            1 ; ...
] ;
%%%%%%%%;
Ry = @(polar_a) ...
[ +cos(polar_a) 0 +sin(polar_a) ; ...
   0            1  0            ; ...
  -sin(polar_a) 0 +cos(polar_a) ; ...
];
%%%%%%%%;
dRz = @(azimu_b) ...
[ -sin(azimu_b) -cos(azimu_b) 0 ; ...
  +cos(azimu_b) -sin(azimu_b) 0 ; ...
   0             0            0 ; ...
] ;
%%%%%%%%;
dRy = @(polar_a) ...
[ -sin(polar_a) 0 +cos(polar_a) ; ...
   0            0  0            ; ...
  -cos(polar_a) 0 -sin(polar_a) ; ...
];
%%%%%%%%;
ddRz = @(azimu_b) ...
[ -cos(azimu_b) +sin(azimu_b) 0 ; ...
  -sin(azimu_b) -cos(azimu_b) 0 ; ...
   0             0            0 ; ...
] ;
%%%%%%%%;
ddRy = @(polar_a) ...
[ -cos(polar_a) 0 -sin(polar_a) ; ...
   0            0  0            ; ...
  +sin(polar_a) 0 -cos(polar_a) ; ...
];
%%%%%%%%;

n_w_sum = n_w_max*n_k_p_r;
psi_z_ = transpose((2*pi)*[0:n_w_max-1]/max(1,n_w_max));
k_c_0_wk_ = reshape(cos(psi_z_)*reshape(k_p_r_,[1,n_k_p_r]),[n_w_sum,1]);
k_c_1_wk_ = reshape(sin(psi_z_)*reshape(k_p_r_,[1,n_k_p_r]),[n_w_sum,1]);

if  isempty(v_source_a_); v_source_a_ = ones(n_source_a,1); end;
if  isempty(v_source_b_); v_source_b_ = ones(n_source_b,1); end;
if  isempty(v_source_dvol_a_); v_source_dvol_a_ = ones(n_source_dvol_a,1); end;
if  isempty(euler_gamma_z_M_); euler_gamma_z_M_ = zeros(n_M,1); end;
if  isempty(viewing_gamma_z_S_); viewing_gamma_z_S_ = zeros(n_S,1); end;
if  isempty(dtau_euler_polar_a_M_); dtau_euler_polar_a_M_ = zeros(n_M,1); end;
if  isempty(dtau_euler_azimu_b_M_); dtau_euler_azimu_b_M_ = zeros(n_M,1); end;
if  isempty(dtau_euler_gamma_z_M_); dtau_euler_gamma_z_M_ = zeros(n_M,1); end;

flag_ssnll = 1;
flag_dvol_ssnll = 0; if (nargout>=1+4); flag_dvol_ssnll = 1; end;
flag_dtau_ssnll = 0; if (nargout>=1+8); flag_dtau_ssnll = 1; end;
flag_dvol_dvol_ssnll = 0; if (nargout>=1+7); flag_dvol_dvol_ssnll = 1; end;
flag_dtau_dvol_ssnll = 0; if (nargout>=1+11); flag_dtau_dvol_ssnll = 1; end;
flag_dtau_dtau_ssnll = 0; if (nargout>=1+14); flag_dtau_dtau_ssnll = 1; end;

if flag_ssnll;
tmp_t = tic();
S_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
tmp_polar_a = +viewing_polar_a_S_(1+nS);
tmp_azimu_b = +viewing_azimu_b_S_(1+nS);
tmp_gamma_z = -viewing_gamma_z_S_(1+nS);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
tmp_va = v_source_a_(1+nsource_a);
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
U_k_p_wk_ = U_k_p_wk_ + tmp_va*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
end;%for nsource_a=0:n_source_a-1;
S_k_p_wkS__(:,1+nS) = U_k_p_wk_;
end;%for nS=0:n_S-1;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% S_k_p_wkS__: %0.6fs',tmp_t)); end;
end;%if flag_ssnll;

if flag_dtau_ssnll;
tmp_t = tic();
dtau_S_k_p_wkS3___ = zeros(n_w_sum,n_S,3);
for nS=0:n_S-1;
tmp_polar_a = +viewing_polar_a_S_(1+nS);
tmp_azimu_b = +viewing_azimu_b_S_(1+nS);
tmp_gamma_z = -viewing_gamma_z_S_(1+nS);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_da_R_a__ = -Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_db_R_a__ = -Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dc_R_a__ = +dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
da_U_k_p_wk_ = zeros(n_w_sum,1);
db_U_k_p_wk_ = zeros(n_w_sum,1);
dc_U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
tmp_va = v_source_a_(1+nsource_a);
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_da_delta_U_ = tmp_da_R_a__*delta_a_c__(:,1+nsource_a);
tmp_db_delta_U_ = tmp_db_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dc_delta_U_ = tmp_dc_R_a__*delta_a_c__(:,1+nsource_a);
planewave_wk_ = exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
U_k_p_wk_ = U_k_p_wk_ + tmp_va*planewave_wk_;
da_U_k_p_wk_ = da_U_k_p_wk_ + tmp_va*planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_da_delta_U_(1+0) + k_c_1_wk_*tmp_da_delta_U_(1+1)));
db_U_k_p_wk_ = db_U_k_p_wk_ + tmp_va*planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_db_delta_U_(1+0) + k_c_1_wk_*tmp_db_delta_U_(1+1)));
dc_U_k_p_wk_ = dc_U_k_p_wk_ + tmp_va*planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_dc_delta_U_(1+0) + k_c_1_wk_*tmp_dc_delta_U_(1+1)));
end;%for nsource_a=0:n_source_a-1;
dtau_S_k_p_wkS3___(:,1+nS,1+0) = da_U_k_p_wk_;
dtau_S_k_p_wkS3___(:,1+nS,1+1) = db_U_k_p_wk_;
dtau_S_k_p_wkS3___(:,1+nS,1+2) = dc_U_k_p_wk_;
end;%for nS=0:n_S-1;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% dtau_S_k_p_wkS3___: %0.6fs',tmp_t)); end;
end;%if flag_dtau_ssnll;

if flag_dtau_dtau_ssnll;
tmp_t = tic();
dtau_dtau_S_k_p_wkS33____ = zeros(n_w_sum,n_S,3,3);
for nS=0:n_S-1;
tmp_polar_a = +viewing_polar_a_S_(1+nS);
tmp_azimu_b = +viewing_azimu_b_S_(1+nS);
tmp_gamma_z = -viewing_gamma_z_S_(1+nS);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_da_R_a__ = -Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_db_R_a__ = -Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dc_R_a__ = +dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_daa_R_a__ = +Rz(-tmp_gamma_z)*ddRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_dab_R_a__ = +Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dac_R_a__ = -dRz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_dba_R_a__ = +Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dbb_R_a__ = +Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*ddRz(-tmp_azimu_b);
tmp_dbc_R_a__ = -dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dca_R_a__ = -dRz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_dcb_R_a__ = -dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dcc_R_a__ = +ddRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
da_U_k_p_wk_ = zeros(n_w_sum,1);
db_U_k_p_wk_ = zeros(n_w_sum,1);
dc_U_k_p_wk_ = zeros(n_w_sum,1);
daa_U_k_p_wk_ = zeros(n_w_sum,1);
dab_U_k_p_wk_ = zeros(n_w_sum,1);
dac_U_k_p_wk_ = zeros(n_w_sum,1);
dba_U_k_p_wk_ = zeros(n_w_sum,1);
dbb_U_k_p_wk_ = zeros(n_w_sum,1);
dbc_U_k_p_wk_ = zeros(n_w_sum,1);
dca_U_k_p_wk_ = zeros(n_w_sum,1);
dcb_U_k_p_wk_ = zeros(n_w_sum,1);
dcc_U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
tmp_va = v_source_a_(1+nsource_a);
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_da_delta_U_ = tmp_da_R_a__*delta_a_c__(:,1+nsource_a);
tmp_db_delta_U_ = tmp_db_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dc_delta_U_ = tmp_dc_R_a__*delta_a_c__(:,1+nsource_a);
tmp_daa_delta_U_ = tmp_daa_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dab_delta_U_ = tmp_dab_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dac_delta_U_ = tmp_dac_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dba_delta_U_ = tmp_dba_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dbb_delta_U_ = tmp_dbb_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dbc_delta_U_ = tmp_dbc_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dca_delta_U_ = tmp_dca_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dcb_delta_U_ = tmp_dcb_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dcc_delta_U_ = tmp_dcc_R_a__*delta_a_c__(:,1+nsource_a);
planewave_wk_ = tmp_va*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
da_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_da_delta_U_(1+0) + k_c_1_wk_*tmp_da_delta_U_(1+1)));
db_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_db_delta_U_(1+0) + k_c_1_wk_*tmp_db_delta_U_(1+1)));
dc_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dc_delta_U_(1+0) + k_c_1_wk_*tmp_dc_delta_U_(1+1)));
daa_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_daa_delta_U_(1+0) + k_c_1_wk_*tmp_daa_delta_U_(1+1)));
dab_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dab_delta_U_(1+0) + k_c_1_wk_*tmp_dab_delta_U_(1+1)));
dac_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dac_delta_U_(1+0) + k_c_1_wk_*tmp_dac_delta_U_(1+1)));
dba_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dba_delta_U_(1+0) + k_c_1_wk_*tmp_dba_delta_U_(1+1)));
dbb_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dbb_delta_U_(1+0) + k_c_1_wk_*tmp_dbb_delta_U_(1+1)));
dbc_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dbc_delta_U_(1+0) + k_c_1_wk_*tmp_dbc_delta_U_(1+1)));
dca_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dca_delta_U_(1+0) + k_c_1_wk_*tmp_dca_delta_U_(1+1)));
dcb_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dcb_delta_U_(1+0) + k_c_1_wk_*tmp_dcb_delta_U_(1+1)));
dcc_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dcc_delta_U_(1+0) + k_c_1_wk_*tmp_dcc_delta_U_(1+1)));
daa_U_k_p_wk_ = daa_U_k_p_wk_ + tmp_va*planewave_wk_.*(da_factor_wk_.*da_factor_wk_ + daa_factor_wk_);
dab_U_k_p_wk_ = dab_U_k_p_wk_ + tmp_va*planewave_wk_.*(da_factor_wk_.*db_factor_wk_ + dab_factor_wk_);
dac_U_k_p_wk_ = dac_U_k_p_wk_ + tmp_va*planewave_wk_.*(da_factor_wk_.*dc_factor_wk_ + dac_factor_wk_);
dba_U_k_p_wk_ = dba_U_k_p_wk_ + tmp_va*planewave_wk_.*(db_factor_wk_.*da_factor_wk_ + dba_factor_wk_);
dbb_U_k_p_wk_ = dbb_U_k_p_wk_ + tmp_va*planewave_wk_.*(db_factor_wk_.*db_factor_wk_ + dbb_factor_wk_);
dbc_U_k_p_wk_ = dbc_U_k_p_wk_ + tmp_va*planewave_wk_.*(db_factor_wk_.*dc_factor_wk_ + dbc_factor_wk_);
dca_U_k_p_wk_ = dca_U_k_p_wk_ + tmp_va*planewave_wk_.*(dc_factor_wk_.*da_factor_wk_ + dca_factor_wk_);
dcb_U_k_p_wk_ = dcb_U_k_p_wk_ + tmp_va*planewave_wk_.*(dc_factor_wk_.*db_factor_wk_ + dcb_factor_wk_);
dcc_U_k_p_wk_ = dcc_U_k_p_wk_ + tmp_va*planewave_wk_.*(dc_factor_wk_.*dc_factor_wk_ + dcc_factor_wk_);
end;%for nsource_a=0:n_source_a-1;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+0,1+0) = daa_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+0,1+1) = dab_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+0,1+2) = dac_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+1,1+0) = dba_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+1,1+1) = dbb_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+1,1+2) = dbc_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+2,1+0) = dca_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+2,1+1) = dcb_U_k_p_wk_;
dtau_dtau_S_k_p_wkS33____(:,1+nS,1+2,1+2) = dcc_U_k_p_wk_;
end;%for nS=0:n_S-1;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% dtau_dtau_S_k_p_wkS33____: %0.6fs',tmp_t)); end;
end;%if flag_dtau_dtau_ssnll;

if flag_dvol_ssnll;
tmp_t = tic();
dvol_S_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
tmp_polar_a = +viewing_polar_a_S_(1+nS);
tmp_azimu_b = +viewing_azimu_b_S_(1+nS);
tmp_gamma_z = -viewing_gamma_z_S_(1+nS);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
dvol_U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_dvol_a=0:n_source_dvol_a-1;
tmp_va = v_source_dvol_a_(1+nsource_dvol_a);
tmp_delta_dvol_U_ = tmp_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
dvol_U_k_p_wk_ = dvol_U_k_p_wk_ + tmp_va*exp(+i*2*pi*(k_c_0_wk_*tmp_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_delta_dvol_U_(1+1)));
end;%for nsource_dvol_a=0:n_source_dvol_a-1;
dvol_S_k_p_wkS__(:,1+nS) = dvol_U_k_p_wk_;
end;%for nS=0:n_S-1;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% dvol_S_k_p_wkS__: %0.6fs',tmp_t)); end;
end;%if flag_dvol_ssnll;

if flag_dtau_dvol_ssnll;
tmp_t = tic();
dtau_dvol_S_k_p_wkS3___ = zeros(n_w_sum,n_S,3);
for nS=0:n_S-1;
tmp_polar_a = +viewing_polar_a_S_(1+nS);
tmp_azimu_b = +viewing_azimu_b_S_(1+nS);
tmp_gamma_z = -viewing_gamma_z_S_(1+nS);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_da_R_a__ = -Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_db_R_a__ = -Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dc_R_a__ = +dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
dvol_U_k_p_wk_ = zeros(n_w_sum,1);
da_dvol_U_k_p_wk_ = zeros(n_w_sum,1);
db_dvol_U_k_p_wk_ = zeros(n_w_sum,1);
dc_dvol_U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_dvol_a=0:n_source_dvol_a-1;
tmp_va = v_source_dvol_a_(1+nsource_dvol_a);
tmp_delta_dvol_U_ = tmp_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
tmp_da_delta_dvol_U_ = tmp_da_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
tmp_db_delta_dvol_U_ = tmp_db_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
tmp_dc_delta_dvol_U_ = tmp_dc_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
dvol_planewave_wk_ = exp(+i*2*pi*(k_c_0_wk_*tmp_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_delta_dvol_U_(1+1)));
dvol_U_k_p_wk_ = dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_;
da_dvol_U_k_p_wk_ = da_dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_da_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_da_delta_dvol_U_(1+1)));
db_dvol_U_k_p_wk_ = db_dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_db_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_db_delta_dvol_U_(1+1)));
dc_dvol_U_k_p_wk_ = dc_dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_dc_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_dc_delta_dvol_U_(1+1)));
end;%for nsource_dvol_a=0:n_source_dvol_a-1;
dtau_dvol_S_k_p_wkS3___(:,1+nS,1+0) = da_dvol_U_k_p_wk_;
dtau_dvol_S_k_p_wkS3___(:,1+nS,1+1) = db_dvol_U_k_p_wk_;
dtau_dvol_S_k_p_wkS3___(:,1+nS,1+2) = dc_dvol_U_k_p_wk_;
end;%for nS=0:n_S-1;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% dtau_dvol_S_k_p_wkS3___: %0.6fs',tmp_t)); end;
end;%if flag_dtau_dvol_ssnll;

tmp_t = tic();
ssnll_M_ = zeros(n_M,1);
ssnll = 0.0d0;
dvol_ssnll_M_ = zeros(n_M,1);
dvol_ssnll = 0.0d0;
dvol_dvol_ssnll = 0.0d0;
dtau_ssnll_M3__ = zeros(n_M,3);
dtau_ssnll = 0.0d0;
dtau_dvol_ssnll_M3__ = zeros(n_M,3);
dtau_dvol_ssnll = 0.0d0;
dtau_dtau_ssnll_M33___ = zeros(n_M,3,3);
dtau_dtau_ssnll = 0.0d0;
for nM=0:n_M-1;
nCTF = index_nCTF_from_nM_(1+nM);
CTF_k_p_wk_ = CTF_k_p_wkC__(:,1+nCTF);
neta = index_neta_from_nM_(1+nM);
eta_k_p_wk_ = eta_k_p_wke__(:,1+neta);
%%%%;
% the template U_k_p_wk_ (from volume a) is associated with [ euler_azimu_b_M_(1+nM) , euler_polar_a_M_(1+nM) , euler_gamma_z_M_(1+nM) ] ;
% the image    V_k_p_wk_ (from volume b) is associated with [ fromb_azimu_b_M_(1+nM) , fromb_polar_a_M_(1+nM) , fromb_gamma_z_M_(1+nM) ] ;
%%%%;
tmp_polar_a = +euler_polar_a_M_(1+nM);
tmp_azimu_b = +euler_azimu_b_M_(1+nM);
tmp_gamma_z = -euler_gamma_z_M_(1+nM);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_da_R_a__ = -Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_db_R_a__ = -Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dc_R_a__ = +dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_daa_R_a__ = +Rz(-tmp_gamma_z)*ddRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_dab_R_a__ = +Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dac_R_a__ = -dRz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_dba_R_a__ = +Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dbb_R_a__ = +Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*ddRz(-tmp_azimu_b);
tmp_dbc_R_a__ = -dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dca_R_a__ = -dRz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_dcb_R_a__ = -dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dcc_R_a__ = +ddRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
da_U_k_p_wk_ = zeros(n_w_sum,1);
db_U_k_p_wk_ = zeros(n_w_sum,1);
dc_U_k_p_wk_ = zeros(n_w_sum,1);
dtau_U_k_p_wk3__ = zeros(n_w_sum,3);
daa_U_k_p_wk_ = zeros(n_w_sum,1);
dab_U_k_p_wk_ = zeros(n_w_sum,1);
dac_U_k_p_wk_ = zeros(n_w_sum,1);
dba_U_k_p_wk_ = zeros(n_w_sum,1);
dbb_U_k_p_wk_ = zeros(n_w_sum,1);
dbc_U_k_p_wk_ = zeros(n_w_sum,1);
dca_U_k_p_wk_ = zeros(n_w_sum,1);
dcb_U_k_p_wk_ = zeros(n_w_sum,1);
dcc_U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source_a-1;
tmp_va = v_source_a_(1+nsource_a);
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_da_delta_U_ = tmp_da_R_a__*delta_a_c__(:,1+nsource_a);
tmp_db_delta_U_ = tmp_db_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dc_delta_U_ = tmp_dc_R_a__*delta_a_c__(:,1+nsource_a);
tmp_daa_delta_U_ = tmp_daa_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dab_delta_U_ = tmp_dab_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dac_delta_U_ = tmp_dac_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dba_delta_U_ = tmp_dba_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dbb_delta_U_ = tmp_dbb_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dbc_delta_U_ = tmp_dbc_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dca_delta_U_ = tmp_dca_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dcb_delta_U_ = tmp_dcb_R_a__*delta_a_c__(:,1+nsource_a);
tmp_dcc_delta_U_ = tmp_dcc_R_a__*delta_a_c__(:,1+nsource_a);
planewave_wk_ = exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
da_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_da_delta_U_(1+0) + k_c_1_wk_*tmp_da_delta_U_(1+1)));
db_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_db_delta_U_(1+0) + k_c_1_wk_*tmp_db_delta_U_(1+1)));
dc_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dc_delta_U_(1+0) + k_c_1_wk_*tmp_dc_delta_U_(1+1)));
daa_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_daa_delta_U_(1+0) + k_c_1_wk_*tmp_daa_delta_U_(1+1)));
dab_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dab_delta_U_(1+0) + k_c_1_wk_*tmp_dab_delta_U_(1+1)));
dac_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dac_delta_U_(1+0) + k_c_1_wk_*tmp_dac_delta_U_(1+1)));
dba_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dba_delta_U_(1+0) + k_c_1_wk_*tmp_dba_delta_U_(1+1)));
dbb_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dbb_delta_U_(1+0) + k_c_1_wk_*tmp_dbb_delta_U_(1+1)));
dbc_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dbc_delta_U_(1+0) + k_c_1_wk_*tmp_dbc_delta_U_(1+1)));
dca_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dca_delta_U_(1+0) + k_c_1_wk_*tmp_dca_delta_U_(1+1)));
dcb_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dcb_delta_U_(1+0) + k_c_1_wk_*tmp_dcb_delta_U_(1+1)));
dcc_factor_wk_ = (+i*2*pi*(k_c_0_wk_*tmp_dcc_delta_U_(1+0) + k_c_1_wk_*tmp_dcc_delta_U_(1+1)));
U_k_p_wk_ = U_k_p_wk_ + tmp_va*planewave_wk_;
da_U_k_p_wk_ = da_U_k_p_wk_ + tmp_va*planewave_wk_.*da_factor_wk_;
db_U_k_p_wk_ = db_U_k_p_wk_ + tmp_va*planewave_wk_.*db_factor_wk_;
dc_U_k_p_wk_ = dc_U_k_p_wk_ + tmp_va*planewave_wk_.*dc_factor_wk_;
daa_U_k_p_wk_ = daa_U_k_p_wk_ + tmp_va*planewave_wk_.*(da_factor_wk_.*da_factor_wk_ + daa_factor_wk_);
dab_U_k_p_wk_ = dab_U_k_p_wk_ + tmp_va*planewave_wk_.*(da_factor_wk_.*db_factor_wk_ + dab_factor_wk_);
dac_U_k_p_wk_ = dac_U_k_p_wk_ + tmp_va*planewave_wk_.*(da_factor_wk_.*dc_factor_wk_ + dac_factor_wk_);
dba_U_k_p_wk_ = dba_U_k_p_wk_ + tmp_va*planewave_wk_.*(db_factor_wk_.*da_factor_wk_ + dba_factor_wk_);
dbb_U_k_p_wk_ = dbb_U_k_p_wk_ + tmp_va*planewave_wk_.*(db_factor_wk_.*db_factor_wk_ + dbb_factor_wk_);
dbc_U_k_p_wk_ = dbc_U_k_p_wk_ + tmp_va*planewave_wk_.*(db_factor_wk_.*dc_factor_wk_ + dbc_factor_wk_);
dca_U_k_p_wk_ = dca_U_k_p_wk_ + tmp_va*planewave_wk_.*(dc_factor_wk_.*da_factor_wk_ + dca_factor_wk_);
dcb_U_k_p_wk_ = dcb_U_k_p_wk_ + tmp_va*planewave_wk_.*(dc_factor_wk_.*db_factor_wk_ + dcb_factor_wk_);
dcc_U_k_p_wk_ = dcc_U_k_p_wk_ + tmp_va*planewave_wk_.*(dc_factor_wk_.*dc_factor_wk_ + dcc_factor_wk_);
end;%for nsource_a=0:n_source_a-1;
dtau_U_k_p_wk3__ = [da_U_k_p_wk_,db_U_k_p_wk_,dc_U_k_p_wk_];
dtau_dtau_U_k_p_wk33___(:,1+0,1+0) = daa_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+0,1+1) = dab_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+0,1+2) = dac_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+1,1+0) = dba_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+1,1+1) = dbb_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+1,1+2) = dbc_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+2,1+0) = dca_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+2,1+1) = dcb_U_k_p_wk_;
dtau_dtau_U_k_p_wk33___(:,1+2,1+2) = dcc_U_k_p_wk_;
%%%%;
% repeat for the perturbed volume. ;
%%%%;
if flag_dvol_ssnll;
tmp_polar_a = +euler_polar_a_M_(1+nM);
tmp_azimu_b = +euler_azimu_b_M_(1+nM);
tmp_gamma_z = -euler_gamma_z_M_(1+nM);
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_da_R_a__ = -Rz(-tmp_gamma_z)*dRy(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_db_R_a__ = -Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*dRz(-tmp_azimu_b);
tmp_dc_R_a__ = +dRz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
dvol_U_k_p_wk_ = zeros(n_w_sum,1);
da_dvol_U_k_p_wk_ = zeros(n_w_sum,1);
db_dvol_U_k_p_wk_ = zeros(n_w_sum,1);
dc_dvol_U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_dvol_a=0:n_source_dvol_a-1;
tmp_va = v_source_dvol_a_(1+nsource_dvol_a);
tmp_delta_dvol_U_ = tmp_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
tmp_da_delta_dvol_U_ = tmp_da_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
tmp_db_delta_dvol_U_ = tmp_db_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
tmp_dc_delta_dvol_U_ = tmp_dc_R_a__*delta_dvol_a_c__(:,1+nsource_dvol_a);
dvol_planewave_wk_ = exp(+i*2*pi*(k_c_0_wk_*tmp_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_delta_dvol_U_(1+1)));
dvol_U_k_p_wk_ = dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_;
da_dvol_U_k_p_wk_ = da_dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_da_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_da_delta_dvol_U_(1+1)));
db_dvol_U_k_p_wk_ = db_dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_db_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_db_delta_dvol_U_(1+1)));
dc_dvol_U_k_p_wk_ = dc_dvol_U_k_p_wk_ + tmp_va*dvol_planewave_wk_.*(+i*2*pi*(k_c_0_wk_*tmp_dc_delta_dvol_U_(1+0) + k_c_1_wk_*tmp_dc_delta_dvol_U_(1+1)));
end;%for nsource_dvol_a=0:n_source_dvol_a-1;
dtau_dvol_U_k_p_wk3__ = [da_dvol_U_k_p_wk_,db_dvol_U_k_p_wk_,dc_dvol_U_k_p_wk_];
end;%if flag_dvol_ssnll;
%%%%;
% the nM image V_k_p_wk_ is assumed to come from volume b. ;
%%%%;
tmp_polar_a = +fromb_polar_a_M_(1+nM);
tmp_azimu_b = +fromb_azimu_b_M_(1+nM);
tmp_gamma_z = -fromb_gamma_z_M_(1+nM);
tmp_R_b__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
V_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source_b-1;
tmp_vb = v_source_b_(1+nsource_b);
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
planewave_wk_ = exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
V_k_p_wk_ = V_k_p_wk_ + tmp_vb*planewave_wk_;
end;%for nsource_b=0:n_source_b-1;
%%%%;
%ssnll = ssnll + 0.5*sum(abs(U_k_p_wk_.*CTF_k_p_wk_ - V_k_p_wk_).^2.*eta_k_p_wk_.*weight_2d_wk_,'all')*(4*pi^2);
ssnll_M_(1+nM) = ssnll_M_(1+nM) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_) ...
			       ,bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_ ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  ;
%%%%;
if flag_dvol_ssnll;
dvol_ssnll_M_(1+nM) = dvol_ssnll_M_(1+nM) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dvol_U_k_p_wk_,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_ ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_) ...
			       ,bsxfun(@times,dvol_U_k_p_wk_,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  ;
end;%if flag_dvol_ssnll;
%%%%;
if flag_dvol_dvol_ssnll;
dvol_dvol_ssnll = dvol_dvol_ssnll ...
  + 1.0 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dvol_U_k_p_wk_,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,dvol_U_k_p_wk_,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  ;
end;%if flag_dvol_dvol_ssnll;
%%%%;
if flag_dtau_ssnll;
dtau_ssnll_M3__(1+nM,:) = dtau_ssnll_M3__(1+nM,:) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_ ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_) ...
			       ,bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  ;
end;%if flag_dtau_ssnll;
%%%%;
if flag_dtau_dvol_ssnll;
dtau_dvol_ssnll_M3__(1+nM,:) = dtau_dvol_ssnll_M3__(1+nM,:) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dtau_dvol_U_k_p_wk3__,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_ ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,dvol_U_k_p_wk_,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dvol_U_k_p_wk_,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_) ...
			       ,bsxfun(@times,dtau_dvol_U_k_p_wk3__,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  ;
end;%if flag_dtau_dvol_ssnll;
%%%%;
if flag_dtau_dtau_ssnll;
dtau_dtau_ssnll_M33___(1+nM,:,:) = dtau_dtau_ssnll_M33___(1+nM,:,:) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,dtau_dtau_U_k_p_wk33___,CTF_k_p_wk_)) ...
			       ,bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_ ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,reshape(conj(bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_)),[n_w_sum,3,1]) ...
			       ,reshape(bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_),[n_w_sum,1,3]) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,reshape(conj(bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_)),[n_w_sum,3,1]) ...
			       ,reshape(bsxfun(@times,dtau_U_k_p_wk3__,CTF_k_p_wk_),[n_w_sum,1,3]) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  + 0.5 ...
  *sum( ...
	bsxfun(@times ...
	       ,bsxfun(@times ...
		       ,bsxfun(@times ...
			       ,conj(bsxfun(@times,U_k_p_wk_,CTF_k_p_wk_) - V_k_p_wk_) ...
			       ,bsxfun(@times,dtau_dtau_U_k_p_wk33___,CTF_k_p_wk_) ...
			       ) ...
		       ,eta_k_p_wk_ ...
		       ) ...
	       ,weight_2d_wk_ ...
	       ) ...
	,[1] ...
	) ...
  *(4*pi^2) ...
  ;
end;%if flag_dtau_dtau_ssnll;
%%%%;
end;%for nM=0:n_M-1;
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll: %0.6fs',tmp_t)); end;
%%%%%%%%;
ssnll = sum(ssnll_M_,[1]);
dvol_ssnll = sum(dvol_ssnll_M_,[1]);
dtau_M3__ = [dtau_euler_polar_a_M_,dtau_euler_azimu_b_M_,dtau_euler_gamma_z_M_];
dtau_ssnll = sum(bsxfun(@times,dtau_ssnll_M3__,dtau_M3__),[1,2]);
dtau_dvol_ssnll = sum(bsxfun(@times,dtau_dvol_ssnll_M3__,dtau_M3__),[1,2]);
dtau_M33___ = bsxfun(@times,reshape(dtau_M3__,[n_M,3,1]),reshape(dtau_M3__,[n_M,1,3]));
dtau_dtau_ssnll = sum(bsxfun(@times,dtau_dtau_ssnll_M33___,dtau_M33___),[1,2,3]);

if (flag_verbose> 0); disp(sprintf(' %% [finished %s]',str_thisfunction)); end;

