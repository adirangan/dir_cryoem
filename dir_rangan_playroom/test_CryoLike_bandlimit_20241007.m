%%%%%%%%;
% Quick test of rescaled plancherel. ;
%%%%%%%%;
n_order = 1024;
x_max = 7.0;
[x_c_,x_w_] = chebpts(1*n_order+1,[-x_max,+x_max]); %<-- choose different order just to check dimension. ;
k_max = 24.0;
[k_c_,k_w_] = chebpts(2*n_order+2,[-k_max,+k_max]); %<-- choose different order just to check dimension. ;
%%%%;
sigma_x_c = x_max/12;
b_x_c_equ_ = 1/(sqrt(2*pi)*sigma_x_c) * exp(-x_c_.^2/(2*sigma_x_c^2));
b_x_c_equ_l1 = x_w_*b_x_c_equ_;
disp(sprintf(' %% b_x_c_equ_l1: %0.16f',b_x_c_equ_l1));
b_x_c_equ_l2 = x_w_*abs(b_x_c_equ_).^2;
disp(sprintf(' %% b_x_c_equ_l2: %0.16f',b_x_c_equ_l2));
%%%%%%%%;
disp(sprintf(' %% Quick test of original plancherel.'));
%%%%%%%%;
b_k_c_fft_ = xxnufft1d3(n_order,x_c_,b_x_c_equ_.*transpose(x_w_),-1,1e-12,n_order,k_c_)/1.0; %<-- note 1/1.0;
b_k_c_fft_l2 = k_w_*abs(b_k_c_fft_).^2;
disp(sprintf(' %% b_k_c_fft_l2/(2*pi): %0.16f',b_k_c_fft_l2/(2*pi)));
%%%%;
b_x_c_rec_ = xxnufft1d3(n_order,k_c_,b_k_c_fft_.*transpose(k_w_),+1,1e-12,n_order,x_c_)/(2*pi); %<-- note 1/(2*pi);
b_x_c_rec_l2 = x_w_*abs(b_x_c_rec_).^2;
disp(sprintf(' %% b_x_c_rec_l2: %0.16f',b_x_c_rec_l2));
%%%%;
sigma_k_c = 1/max(1e-12,sigma_x_c);
b_k_c_equ_ = exp(-k_c_.^2/(2*sigma_k_c^2))/1.0;
b_k_c_equ_l2 = k_w_*abs(b_k_c_equ_).^2;
disp(sprintf(' %% b_k_c_equ_l2/(2*pi): %0.16f',b_k_c_equ_l2/(2*pi)));
%%%%;
b_x_c_fft_ = xxnufft1d3(n_order,k_c_,b_k_c_equ_.*transpose(k_w_),+1,1e-12,n_order,x_c_)/(2*pi); %<-- note 1/(2*pi);
b_x_c_fft_l2 = x_w_*abs(b_x_c_fft_).^2;
disp(sprintf(' %% b_x_c_fft_l2: %0.16f',b_x_c_fft_l2));
%%%%;
b_k_c_rec_ = xxnufft1d3(n_order,x_c_,b_x_c_fft_.*transpose(x_w_),-1,1e-12,n_order,k_c_)/1.0; %<-- note 1/1.0;
b_k_c_rec_l2 = k_w_*abs(b_k_c_rec_).^2;
disp(sprintf(' %% b_k_c_rec_l2/(2*pi): %0.16f',b_k_c_rec_l2/(2*pi)));
%%%%;

%%%%%%%%;
disp(sprintf(' %% Quick test of rescaled plancherel.'));
%%%%%%%%;
b_k_c_fft_ = xxnufft1d3(n_order,x_c_,b_x_c_equ_.*transpose(x_w_),-1,1e-12,n_order,k_c_)/sqrt(2*pi); %<-- note 1/sqrt(2*pi);
b_k_c_fft_l2 = k_w_*abs(b_k_c_fft_).^2;
disp(sprintf(' %% b_k_c_fft_l2: %0.16f',b_k_c_fft_l2));
%%%%;
b_x_c_rec_ = xxnufft1d3(n_order,k_c_,b_k_c_fft_.*transpose(k_w_),+1,1e-12,n_order,x_c_)/sqrt(2*pi); %<-- note 1/sqrt(2*pi);
b_x_c_rec_l2 = x_w_*abs(b_x_c_rec_).^2;
disp(sprintf(' %% b_x_c_rec_l2: %0.16f',b_x_c_rec_l2));
%%%%;
sigma_k_c = 1/max(1e-12,sigma_x_c);
b_k_c_equ_ = exp(-k_c_.^2/(2*sigma_k_c^2))/sqrt(2*pi);
b_k_c_equ_l2 = k_w_*abs(b_k_c_equ_).^2;
disp(sprintf(' %% b_k_c_equ_l2: %0.16f',b_k_c_equ_l2));
%%%%;
b_x_c_fft_ = xxnufft1d3(n_order,k_c_,b_k_c_equ_.*transpose(k_w_),+1,1e-12,n_order,x_c_)/sqrt(2*pi); %<-- note 1/sqrt(2*pi);
b_x_c_fft_l2 = x_w_*abs(b_x_c_fft_).^2;
disp(sprintf(' %% b_x_c_fft_l2: %0.16f',b_x_c_fft_l2));
%%%%;
b_k_c_rec_ = xxnufft1d3(n_order,x_c_,b_x_c_fft_.*transpose(x_w_),-1,1e-12,n_order,k_c_)/sqrt(2*pi); %<-- note 1/sqrt(2*pi);
b_k_c_rec_l2 = k_w_*abs(b_k_c_rec_).^2;
disp(sprintf(' %% b_k_c_rec_l2: %0.16f',b_k_c_rec_l2));
%%%%;

%%%%%%%%;
% Now construct a messy, but space-limited f(x). ;
%%%%%%%%;
x_env = 2.5;
f_env_x_c_ = exp(-1./(-(x_c_-x_env).*(x_c_+x_env)));
tmp_index_ = efind(abs(x_c_)>=x_env); f_env_x_c_(1+tmp_index_) = 0;
f_env_x_c_che_ = chebfun(f_env_x_c_,'chebkind',1); f_env_x_c_che_ = chebfun(@(x) f_env_x_c_che_(x/x_max),[-x_max,+x_max]);
g_osc_x_c_ = sin(4*x_env./(0.25 + x_c_.^2));
tmp_index_ = efind(~isfinite(g_osc_x_c_)); g_osc_x_c_(1+tmp_index_) = 0;
h_mes_x_c_ = f_env_x_c_;
%h_mes_x_c_ = g_osc_x_c_.*f_env_x_c_;
%h_mes_x_c_ = randn(size(x_c_)).*f_env_x_c_;
h_mes_x_c_l2 = x_w_*abs(h_mes_x_c_).^2;
h_mes_x_c_ = h_mes_x_c_./max(1e-12,sqrt(h_mes_x_c_l2));
h_mes_x_c_l2 = x_w_*abs(h_mes_x_c_).^2;
disp(sprintf(' %% h_mes_x_c_l2: %0.16f',h_mes_x_c_l2));
%%%%%%%%;
% Now construct fourier-transform. ;
%%%%%%%%;
h_mes_k_c_fft_ = xxnufft1d3(n_order,x_c_,h_mes_x_c_.*transpose(x_w_),-1,1e-12,n_order,k_c_)/sqrt(2*pi); %<-- note 1/sqrt(2*pi);
h_mes_k_c_che_ = chebfun(real(h_mes_k_c_fft_),'chebkind',1); h_mes_k_c_che_ = chebfun(@(k) h_mes_k_c_che_(k/k_max),[-k_max,+k_max]);
h_mes_k_c_fft_l2 = k_w_*abs(h_mes_k_c_fft_).^2;
disp(sprintf(' %% h_mes_k_c_fft_l2: %0.16f %%<-- energy loss',h_mes_k_c_fft_l2));
%%%%%%%%;
% and visualize. ;
%%%%%%%%;
figure(1);clf;figmed;
subplot(1,3,1);
hold on;
plot(x_c_,h_mes_x_c_,'r-');
plot(x_c_,+f_env_x_c_,'k-');
plot(x_c_,-f_env_x_c_,'k-');
plot(+f_env_x_c_che_,'g-');
plot(-f_env_x_c_che_,'g-');
hold off;
xlim([-x_max,+x_max]);
title('h_mes_x_c_','Interpreter','none');
subplot(1,3,2);
hold on;
plot(k_c_,h_mes_k_c_fft_,'r-');
plot(h_mes_k_c_che_,'g-');
hold off;
xlim([-k_max,+k_max]);
title('h_mes_k_c_fft_','Interpreter','none');
subplot(1,3,3);
plot(diff(h_mes_k_c_che_),'g-');
xlim([-k_max,+k_max]);
title('diff(h_mes_k_c_che_)','Interpreter','none');
%%%%%%%%;
% verdict: Use Cauchy-Shwarz to bound the magnitude of $\partial_{k}\hat{h}(k)$ in terms of x_env and h_mes_x_c_l2. ;
%%%%%%%%;



