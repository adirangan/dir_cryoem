flag_verbose=1; flag_disp=1; nf=0;
str_thisfunction = 'ssnll_from_a_k_p_14';
if (flag_verbose>0); disp(sprintf(' %% testing %s',str_thisfunction)); end;
n_order = 13;

%%%%%%%%;
% First define integral of <f,f>. ;
%%%%%%%%;
h2d_ = @(kd) 4*pi^2*(besselj(0,kd) + besselj(2,kd)); % calculates <f_j,f_k>, normalized so that <f,f> = (4*pi^2);
dh2d_ = @(kd) 4*pi^3*(besselj(-1,kd) - besselj(+3,kd));
h3d_ = @(kd) 4*pi*( sin(kd) - (kd).*cos(kd) ) ./ kd.^3 ; % calculates <f_j,f_k>, normalized so that <f,f> = 4*pi/3;
dh3d_ = @(kd) 12*pi*( (kd.^2/3 - 1) .* sin(kd) + (kd).*cos(kd) ) ./ kd.^4 ;
%%%%%%%%;
% Now set up and test k-quadrature on sphere. ;
%%%%%%%%;
k_p_r_max = 48.0/(2*pi); 
k_eq_d_double = 1.0/1.0;
k_eq_d = k_eq_d_double/(2*pi);
flag_uniform_over_n_k_p_r = 1;
flag_uniform_over_polar_a = 0;
str_C2 = 'C2';
[ ...
 n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,~ ...
,~ ...
,~ ...
,~ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
] = ...
sample_sphere_7( ...
 0*flag_verbose ...
,k_p_r_max ...
,k_eq_d ...
,str_C2 ...
,flag_uniform_over_n_k_p_r ...
,flag_uniform_over_polar_a ...
) ;
n_q = n_qk/n_k_p_r;
%%%%;
if flag_disp>1;
figure(1+nf);nf=nf+1;clf;figbig;
p_row = 2; p_col = 4; n_plot = p_row*p_col;
for nplot=0:n_plot-1;
nk_p_r = max(0,min(n_k_p_r-1,round(n_k_p_r*nplot/n_plot)));
tmp_index_ = n_qk_csum_(1+nk_p_r):n_qk_csum_(1+nk_p_r+1)-1;
subplot(p_row,p_col,1+nplot);
plot3(k_c_0_qk_(1+tmp_index_),k_c_1_qk_(1+tmp_index_),k_c_2_qk_(1+tmp_index_),'.');
axis equal; axis vis3d; axisnotick3d;
title(sprintf('nk_p_r %d/%d',nk_p_r,n_k_p_r),'Interpreter','none');
end;%for nplot=0:n_plot-1;
end;%if flag_disp;
%%%%;

%%%%%%%%;
% Define rotation. ;
%%%%%%%%;
Rz = @(azimu_b) ...
[ +cos(azimu_b) -sin(azimu_b) 0 ; ...
  +sin(azimu_b) +cos(azimu_b) 0 ; ...
   0             0            1 ; ...
] ;
%%%%%%%%;
Ry = @(polar_a) ...
[ +cos(polar_a) 0 +sin(polar_a) ; ...
   0            1  0            ; ...
  -sin(polar_a) 0 +cos(polar_a) ; ...
];
%%%%%%%%;
polar_a_use = +1*pi/5;
azimu_b_use = +1*pi/7;
gamma_z_use = +1*pi/3;
euler_use_ = [gamma_z_use,polar_a_use,azimu_b_use];
R_use__ = Rz(azimu_b_use)*Ry(polar_a_use)*Rz(gamma_z_use);
fnorm_disp(flag_verbose,'R_use__',R_use__,'euler_to_R_0(euler_use_)',euler_to_R_0(euler_use_));
fnorm_disp(flag_verbose,'euler_use_',euler_use_,'R_to_euler_0(R_use__)',R_to_euler_0(R_use__));
%%%%%%%%;

%%%%%%%%;
% Now define a_k_p_form, as well as the rotated version a_R_k_p_form. ;
%%%%%%%%;
n_source = 4;
rng(0);
delta_a_c__ = zeros(3,n_source);
delta_b_c__ = zeros(3,n_source);
inv_R_delta_a_c__ = zeros(3,n_source);
inv_R_delta_b_c__ = zeros(3,n_source);
for nsource=0:n_source-1;
rng(1+nsource);
delta_a_c_ = 2*rand(3,1)-1; delta_a_c_ = delta_a_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_a_c_)); %<-- ensure small in magnitude. ;
delta_a_c__(:,1+nsource) = delta_a_c_;
delta_b_c_ = 2*rand(3,1)-1; delta_b_c_ = delta_b_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_b_c_)); %<-- ensure small in magnitude. ;
delta_b_c__(:,1+nsource) = delta_b_c_;
inv_R_delta_a_c__(:,1+nsource) = transpose(R_use__)*delta_a_c__(:,1+nsource);
inv_R_delta_b_c__(:,1+nsource) = transpose(R_use__)*delta_b_c__(:,1+nsource);
end;%for nsource=0:n_source-1;
a_k_p_form_ = zeros(n_qk,1);
b_k_p_form_ = zeros(n_qk,1);
a_R_k_p_form_ = zeros(n_qk,1);
b_R_k_p_form_ = zeros(n_qk,1);
for nsource=0:n_source-1;
delta_a_c_ = delta_a_c__(:,1+nsource);
a_k_p_form_ = a_k_p_form_ + exp(+i*2*pi*(k_c_0_qk_*delta_a_c_(1+0) + k_c_1_qk_*delta_a_c_(1+1) + k_c_2_qk_*delta_a_c_(1+2)));
delta_b_c_ = delta_b_c__(:,1+nsource);
b_k_p_form_ = b_k_p_form_ + exp(+i*2*pi*(k_c_0_qk_*delta_b_c_(1+0) + k_c_1_qk_*delta_b_c_(1+1) + k_c_2_qk_*delta_b_c_(1+2)));
inv_R_delta_a_c_ = inv_R_delta_a_c__(:,1+nsource);
a_R_k_p_form_ = a_R_k_p_form_ + exp(+i*2*pi*(k_c_0_qk_*inv_R_delta_a_c_(1+0) + k_c_1_qk_*inv_R_delta_a_c_(1+1) + k_c_2_qk_*inv_R_delta_a_c_(1+2)));
inv_R_delta_b_c_ = inv_R_delta_b_c__(:,1+nsource);
b_R_k_p_form_ = b_R_k_p_form_ + exp(+i*2*pi*(k_c_0_qk_*inv_R_delta_b_c_(1+0) + k_c_1_qk_*inv_R_delta_b_c_(1+1) + k_c_2_qk_*inv_R_delta_b_c_(1+2)));
end;%for nsource=0:n_source-1;
%%%%;
I_a_quad = sum(a_k_p_form_.*weight_3d_k_p_qk_);
I_b_quad = sum(b_k_p_form_.*weight_3d_k_p_qk_);
I_a_form = 0;
I_b_form = 0;
for nsource=0:n_source-1;
delta_a_c_ = delta_a_c__(:,1+nsource);
delta_b_c_ = delta_b_c__(:,1+nsource);
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_a_c_);
I_a_form = I_a_form + h3d_(tmp_kd)*k_p_r_max^3;
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_b_c_);
I_b_form = I_b_form + h3d_(tmp_kd)*k_p_r_max^3;
end;%for nsource=0:n_source-1;
fnorm_disp(flag_verbose,'I_a_form',I_a_form,'I_a_quad',I_a_quad);
fnorm_disp(flag_verbose,'I_b_form',I_b_form,'I_b_quad',I_b_quad);
%%%%%%%%;
% Now set up and test polar-quadrature-weights on disk. ;
%%%%%%%%;
l_max_upb = round(2*pi*k_p_r_max);
l_max_max = min(l_max_upb,1+ceil(2*pi*k_p_r_(end)));
n_w_max = 2*(l_max_max+1); n_w_0in_ = n_w_max*ones(n_k_p_r,1);
[ ...
 n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,k_p_r_wk_ ...
,k_p_w_wk_ ...
,k_c_0_wk_ ...
,k_c_1_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_0in_ ...
);
n_w_sum = sum(n_w_); n_w_csum_ = cumsum([0;n_w_]);
%%%%;
S_k_p_wk_ = zeros(n_w_sum,1);
T_k_p_wk_ = zeros(n_w_sum,1);
for nsource=0:n_source-1;
S_k_p_wk_ = S_k_p_wk_ + exp(+2*pi*i*(k_c_0_wk_*delta_a_c__(1+0,1+nsource) + k_c_1_wk_*delta_a_c__(1+1,1+nsource)));
T_k_p_wk_ = T_k_p_wk_ + exp(+2*pi*i*(k_c_0_wk_*delta_b_c__(1+0,1+nsource) + k_c_1_wk_*delta_b_c__(1+1,1+nsource)));
end;%for nsource=0:n_source-1;
I_quad = sum(conj(S_k_p_wk_).*T_k_p_wk_.*weight_2d_wk_)*(4*pi^2);
I_form = 0;
for nsource0=0:n_source-1;
for nsource1=0:n_source-1;
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_a_c__(1:2,1+nsource0) - delta_b_c__(1:2,1+nsource1));
I_form = I_form + h2d_(tmp_kd)/(4*pi^2) * (pi*k_p_r_max^2);
end;%for nsource1=0:n_source-1;
end;%for nsource0=0:n_source-1;
fnorm_disp(flag_verbose,'I_form',I_form,'I_quad',I_quad);
%%%%%%%%;

%%%%%%%%;
% generate viewing-grid for templates. ;
%%%%%%%%;
tmp_t = tic();
viewing_k_eq_d = 1.0/k_p_r_max;
template_k_eq_d = 1.0/k_p_r_max;
flag_tensor_vs_adap = 0; %<-- adaptive-grid. ;
str_L = 'L'; %<-- Use C2 to allow for off-grid interpolation. ;
[ ...
 n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,viewing_k_c_0_qk_ ...
,viewing_k_c_1_qk_ ...
,viewing_k_c_2_qk_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
] = ...
sample_shell_6( ...
 1.0 ...
,template_k_eq_d ...
,str_C2 ...
,flag_tensor_vs_adap ...
) ;
n_S = n_viewing_S;
viewing_gamma_z_S_ = zeros(n_S,1);
if (flag_verbose>0); disp(sprintf(' %% n_S %d, n_viewing_polar_a %d, n_viewing_azimu_b [%d,..,%d]',n_S,n_viewing_polar_a,n_viewing_azimu_b_(1+0),n_viewing_azimu_b_(end))); end;
%%%%;
if flag_disp>1;
figure(1+nf);nf=nf+1;clf;figsml;
plot3(viewing_k_c_0_qk_,viewing_k_c_1_qk_,viewing_k_c_2_qk_,'.');
axis equal; axisnotick3d; axis vis3d;
end;%if flag_disp;
%%%%;
[ ...
 ~ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
] = ...
get_weight_2d_2( ...
 0*flag_verbose ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,-1 ...
,n_w_ ...
);
%%%%;
n_w_0in = n_w_max; n_w_0in_ = n_w_max*ones(n_k_p_r,1);
%%%%%%%%;

a_k_p_qk_ = a_k_p_form_ ;
a_R_k_p_qk_ = a_R_k_p_form_ ;
%%%%%%%%%%%%%%%%;
% Now generate templates from a_k_p_qk_. ;
%%%%%%%%%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
parameter_interpolate = struct('type','parameter');
parameter_interpolate.flag_verbose = 1;
parameter_interpolate.tolerance_pinv = 1e-6;
parameter_interpolate.flag_check = 0;
parameter_interpolate.flag_parsimonious = 1;
[ ...
 parameter_interpolate ...
,template_ori_wkS__ ...
,n_w ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dtemplateda_ori_wkS__ ...
,dtemplatedb_ori_wkS__ ...
,dtemplatedc_ori_wkS__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,dtemplateda_rec_wkS__ ...
,dtemplatedb_rec_wkS__ ...
,dtemplatedc_rec_wkS__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddtemplatedaa_ori_wkS__ ...
,ddtemplatedab_ori_wkS__ ...
,ddtemplatedac_ori_wkS__ ...
,ddtemplatedbb_ori_wkS__ ...
,ddtemplatedbc_ori_wkS__ ...
,ddtemplatedcc_ori_wkS__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,ddtemplatedaa_rec_wkS__ ...
,ddtemplatedab_rec_wkS__ ...
,ddtemplatedac_rec_wkS__ ...
,ddtemplatedbb_rec_wkS__ ...
,ddtemplatedbc_rec_wkS__ ...
,ddtemplatedcc_rec_wkS__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
interpolate_template_6( ...
 parameter_interpolate ...
,n_order ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_qk_ ...
,viewing_k_eq_d ...
,-1 ...
,n_w_0in ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
S_k_p_wkS__ = reshape(template_ori_wkS__,[n_w_sum,n_S]);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% interpolate_template_6 (S_k_p_wkS__): %0.6fs',tmp_t)); end;
%%%%%%%%;

n_wS = n_w_max*n_S;
n_k_each = n_qk/n_k_p_r;

%%%%%%%%;
% Now step through and reconstitute the templates. ;
%%%%%%%%;
R_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
R_k_p_wk_ = zeros(n_w_sum,1);
for nsource=0:n_source-1;
tmp_delta_ = tmp_R__*delta_a_c__(:,1+nsource);
R_k_p_wk_ = R_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_(1+0) + k_c_1_wk_*tmp_delta_(1+1)));
end;%for nsource=0:n_source-1;
R_k_p_wkS__(:,1+nS) = R_k_p_wk_;
end;%for nS=0:n_S-1;
fnorm_disp(flag_verbose,'R_k_p_wkS__',R_k_p_wkS__,'S_k_p_wkS__',S_k_p_wkS__);
%%%%%%%%;

%%%%%%%%;
% Now get templates for b_k_p_form. ;
%%%%%%%%;
tmp_t = tic();
T_k_p_wSk__ = zeros(n_wS,n_k_p_r);
for nk_p_r=0:n_k_p_r-1;
T_k_p_wSk__(:,1+nk_p_r) = wS_from_single_shell_sba__*b_k_p_form_(1+nk_p_r*n_k_each+[0:n_k_each-1]);
end;%for nk_p_r=0:n_k_p_r-1;
T_k_p_wkS__ = reshape(permute(reshape(T_k_p_wSk__,[n_w_max,n_S,n_k_p_r]),[1,3,2]),[n_w_sum,n_S]);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% T_k_p_wkS__: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% Now test integral. ;
%%%%%%%%;
CTF_alpha = 0.3;
CTF_k_p_wk_ = reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1]);
%%%%;
nS = 128;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
nsource_a = 0;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1]));
tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
U_k_p_wk_ = U_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
%%%%;
nT = 128;
T_k_p_wk_ = T_k_p_wkS__(:,1+nT);
tmp_azimu_b = viewing_azimu_b_S_(1+nT);
tmp_polar_a = viewing_polar_a_S_(1+nT);
tmp_gamma_z = 0.0;
tmp_R_b__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
V_k_p_wk_ = zeros(n_w_sum,1);
nsource_b = 0;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1]));
tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
V_k_p_wk_ = V_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
%%%%;
I_quad = sum(conj(U_k_p_wk_).*CTF_k_p_wk_.*V_k_p_wk_.*weight_2d_wk_,'all')*(4*pi^2);
I_form = ...
plane_bessel_plane_integral_0( ...
 k_p_r_max ...
,tmp_delta_U ...
,tmp_omega_U ...
,tmp_delta_V ...
,tmp_omega_V ...
,CTF_alpha ...
);
fnorm_disp(flag_verbose,'I_form',I_form,'I_quad',I_quad);
J_quad = 0.5 * sum(abs(U_k_p_wk_.*CTF_k_p_wk_ - V_k_p_wk_).^2.*weight_2d_wk_,'all')*(4*pi^2);
%%%%;
% Note that (Gradshteyn and Ryzhik 5.52.1): ;
% \int_{0}^{K} k besselj(0,alpha*k) dkdpsi = 2*pi*K*besselj(1,alpha*K)/alpha. ;
% and: \lim_{alpha\rightarrow 0} besselj(1,alpha*K)/alpha = K/2. ;
% i.e.: CTF_alpha = 0.2; integral2(@(k,psi) k.*besselj(0,CTF_alpha.*k),0,k_p_r_max,0,2*pi)*CTF_alpha/(2*pi*k_p_r_max*besselj(1,CTF_alpha.*k_p_r_max));
% Note also that (Gradshteyn and Ryzhik 5.54.2): ;
% \int_{0}^{k} k besselj(0,alpha*k)^2 dkdpsi = 2*pi* (K^2/2)*(besselj(0,alpha*K)^2 - besselj(-1,alpha*K)*besselj(+1,alpha*K)). ;
% i.e., ;
% nu = 0; CTF_alpha = 0.2;
% tmp_I = integral(@(k) k.*besselj(nu,CTF_alpha.*k).^2,0,k_p_r_max);
% tmp_J = (k_p_r_max^2/2)*(besselj(nu,CTF_alpha.*k_p_r_max)^2 - besselj(nu+1,CTF_alpha.*k_p_r_max)*besselj(nu-1,CTF_alpha.*k_p_r_max));
% disp(sprintf(' %% fnorm(tmp_I - tmp_J): %0.16f',fnorm(tmp_I-tmp_J)));
% CTF_alpha = 1e-4;
% tmp_J = (k_p_r_max^2/2)*(besselj(nu,CTF_alpha.*k_p_r_max)^2 - besselj(nu+1,CTF_alpha.*k_p_r_max)*besselj(nu-1,CTF_alpha.*k_p_r_max));
% disp(sprintf(' %% fnorm(tmp_J - k_p_r_max^2/2) %0.6f',fnorm(tmp_J - k_p_r_max^2/2)));
%%%%;
G_form = (2*pi)*k_p_r_max^2/2.0; if (CTF_alpha> 1e-12); G_form = (2*pi)*(k_p_r_max^2/2)*(besselj(0,CTF_alpha*k_p_r_max)^2 - besselj(-1,CTF_alpha*k_p_r_max)*besselj(+1,CTF_alpha*k_p_r_max)); end;
H_form = pi*k_p_r_max^2;
J_form = 0.5 * (G_form - 2*I_form + H_form);
%%%%;
n_nS_sub = 8; nS_sub_ = randperm(n_S,n_nS_sub)-1;
n_nT_sub = 10; nT_sub_ = randperm(n_S,n_nT_sub)-1;
I_quad_ST__ = zeros(n_nS_sub,n_nT_sub);
I_form_ST__ = zeros(n_nS_sub,n_nT_sub);
for nnS_sub=0:n_nS_sub-1;
nS_sub = nS_sub_(1+nnS_sub);
nS = nS_sub;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source-1;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1]));
tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
U_k_p_wk_ = U_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
end;%for nsource_a=0:n_source-1;
for nnT_sub=0:n_nT_sub-1;
nT_sub = nT_sub_(1+nnT_sub);
nT = nT_sub;
T_k_p_wk_ = T_k_p_wkS__(:,1+nT);
tmp_azimu_b = viewing_azimu_b_S_(1+nT);
tmp_polar_a = viewing_polar_a_S_(1+nT);
tmp_gamma_z = 0.0;
tmp_R_b__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
V_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source-1;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1]));
tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
V_k_p_wk_ = V_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
end;%for nsource_b=0:n_source-1;
I_quad = sum(conj(U_k_p_wk_).*CTF_k_p_wk_.*V_k_p_wk_.*weight_2d_wk_,'all')*(4*pi^2);
I_form = 0;
for nsource_a=0:n_source-1;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1]));
tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
for nsource_b=0:n_source-1;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1]));
tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
I_form_sub = ...
plane_bessel_plane_integral_0( ...
 k_p_r_max ...
,tmp_delta_U ...
,tmp_omega_U ...
,tmp_delta_V ...
,tmp_omega_V ...
,CTF_alpha ...
);
I_form = I_form + I_form_sub;
end;%for nsource_b=0:n_source-1;
end;%for nsource_a=0:n_source-1;
I_quad_ST__(1+nnS_sub,1+nnT_sub) = I_quad;
I_form_ST__(1+nnS_sub,1+nnT_sub) = I_form;
end;%for nnT_sub=0:n_nT_sub-1;
end;%for nnS_sub=0:n_nS_sub-1;
fnorm_disp(flag_verbose,'I_form_ST__',I_form_ST__,'I_quad_ST__',I_quad_ST__);
%%%%%%%%;
% set up CTF and eta. ;
% This does not test anisotropic CTF. ;
% Nor does this test anisotropic eta. ;
%%%%%%%%;
n_alpha = 3; CTF_alpha_ = [0.10;0.15;0.30];
n_power = 2; eta_power_ = [0.50;0.75];
n_CTF = n_alpha*n_power;
n_eta = n_alpha*n_power;
CTF_k_p_wkC__ = zeros(n_w_sum,n_CTF);
eta_k_p_wke__ = zeros(n_w_sum,n_eta);
for nalpha=0:n_alpha-1;
CTF_alpha = CTF_alpha_(1+nalpha);
for npower=0:n_power-1;
eta_power = eta_power_(1+npower);
nCTF = nalpha+npower*n_alpha;
neta = nalpha+npower*n_alpha;
CTF_k_p_wk_ = (reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1])).^(1-eta_power);
CTF_k_p_wkC__(:,1+nCTF) = CTF_k_p_wk_;
eta_k_p_wk_ = (reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1])).^(0+eta_power);
eta_k_p_wke__(:,1+neta) = eta_k_p_wk_;
end;%for npower=0:n_power-1;
end;%for nalpha=0:n_alpha-1;
%%%%;

%%%%%%%%;
% testing full on-grid ssnll. ;
%%%%%%%%;
n_M = n_S; M_k_p_wkM__ = T_k_p_wkS__ ;
index_nCTF_from_nM_ = zeros(n_M,1); for nM=0:n_M-1; index_nCTF_from_nM_(1+nM) = mod(nM,n_CTF); end;%for nM=0:n_M-1;
index_neta_from_nM_ = zeros(n_M,1); for nM=0:n_M-1; index_neta_from_nM_(1+nM) = mod(nM,n_eta); end;%for nM=0:n_M-1;
euler_polar_a_M_ = viewing_polar_a_S_;
euler_azimu_b_M_ = viewing_azimu_b_S_;
rng(0); euler_gamma_z_M_ = 2*pi*rand(n_M,1);
for nM=0:n_M-1;
M_k_p_wkM__(:,1+nM) = rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,T_k_p_wkS__(:,1+nM),+euler_gamma_z_M_(1+nM));
end;%for nM=0:n_M-1;
%%%%;
ssnll_0 = 0.0d0;
for nM=0:n_M-1;
nS = nM;
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
T_k_p_wk_ = T_k_p_wkS__(:,1+nM);
nCTF = index_nCTF_from_nM_(1+nM);
CTF_k_p_wk_ = CTF_k_p_wkC__(:,1+nCTF);
neta = index_neta_from_nM_(1+nM);
eta_k_p_wk_ = eta_k_p_wke__(:,1+neta);
tmp_polar_a = euler_polar_a_M_(1+nM);
tmp_azimu_b = euler_azimu_b_M_(1+nM);
tmp_gamma_z = 0.0;
tmp_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_R_a__ = tmp_R__; tmp_R_b__ = tmp_R__;
U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source-1;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1]));
tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
U_k_p_wk_ = U_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
end;%for nsource_a=0:n_source-1;
fnorm_disp(flag_verbose-1,'S_k_p_wk_',S_k_p_wk_,'U_k_p_wk_',U_k_p_wk_);
V_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source-1;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1]));
tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
V_k_p_wk_ = V_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
end;%for nsource_b=0:n_source-1;
fnorm_disp(flag_verbose-1,'T_k_p_wk_',T_k_p_wk_,'V_k_p_wk_',V_k_p_wk_);
ssnll_0 = ssnll_0 + 0.5*sum(abs(U_k_p_wk_.*CTF_k_p_wk_ - V_k_p_wk_).^2.*eta_k_p_wk_.*weight_2d_wk_,'all')*(4*pi^2);
end;%for nM=0:n_M-1;
%%%%;

%%%%%%%%;
tmp_t = tic();
parameter_ssnll = struct('type','parameter');
weight_imagecount_M_ = ones(n_M,1);
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
[ ...
 ~ ...
,ssnll_1_M_ ...
,ssnll_1 ...
] = ...
ssnll_from_a_k_p_14( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_form_ ...
,[] ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_viewing_S ...
,S_k_p_wkS__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,[] ...
,[] ...
,[] ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,[] ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14 (flag_ssnll): %0.6fs',tmp_t)); end;
%%%%;
fnorm_disp(flag_verbose,'ssnll_0',ssnll_0,'ssnll_1',ssnll_1);
%%%%%%%%;

%%%%%%%%;
% Now creating dvol_a_k_p_form_. ;
%%%%%%%%;
n_source = 4;
rng(1);
delta_dvol_a_c__ = zeros(3,n_source);
inv_R_delta_dvol_a_c__ = zeros(3,n_source);
for nsource=0:n_source-1;
rng(1+nsource);
delta_dvol_a_c_ = 2*rand(3,1)-1; delta_dvol_a_c_ = delta_dvol_a_c_*0.5/k_p_r_max/max(1e-12,fnorm(delta_dvol_a_c_)); %<-- ensure small in magnitude. ;
delta_dvol_a_c__(:,1+nsource) = delta_dvol_a_c_;
inv_R_delta_dvol_a_c__(:,1+nsource) = transpose(R_use__)*delta_dvol_a_c__(:,1+nsource);
end;%for nsource=0:n_source-1;
dvol_a_k_p_form_ = zeros(n_qk,1);
dvol_a_R_k_p_form_ = zeros(n_qk,1);
for nsource=0:n_source-1;
delta_dvol_a_c_ = delta_dvol_a_c__(:,1+nsource);
dvol_a_k_p_form_ = dvol_a_k_p_form_ + exp(+i*2*pi*(k_c_0_qk_*delta_dvol_a_c_(1+0) + k_c_1_qk_*delta_dvol_a_c_(1+1) + k_c_2_qk_*delta_dvol_a_c_(1+2)));
inv_R_delta_dvol_a_c_ = inv_R_delta_dvol_a_c__(:,1+nsource);
dvol_a_R_k_p_form_ = dvol_a_R_k_p_form_ + exp(+i*2*pi*(k_c_0_qk_*inv_R_delta_dvol_a_c_(1+0) + k_c_1_qk_*inv_R_delta_dvol_a_c_(1+1) + k_c_2_qk_*inv_R_delta_dvol_a_c_(1+2)));
end;%for nsource=0:n_source-1;
%%%%;
I_dvol_a_quad = sum(dvol_a_k_p_form_.*weight_3d_k_p_qk_);
I_dvol_a_form = 0;
for nsource=0:n_source-1;
delta_dvol_a_c_ = delta_dvol_a_c__(:,1+nsource);
tmp_kd = 2*pi*k_p_r_max*fnorm(delta_dvol_a_c_);
I_dvol_a_form = I_dvol_a_form + h3d_(tmp_kd)*k_p_r_max^3;
end;%for nsource=0:n_source-1;
fnorm_disp(flag_verbose,'I_a_form',I_a_form,'I_a_quad',I_a_quad);
%%%%%%%%;
% generate templates. ;
%%%%%%%%;

dvol_a_k_p_qk_ = dvol_a_k_p_form_ ;
dvol_a_R_k_p_qk_ = dvol_a_R_k_p_form_ ;
%%%%%%%%%%%%%%%%;
% Now generate templates from dvol_a_k_p_qk_. ;
%%%%%%%%%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
parameter_interpolate = struct('type','parameter');
parameter_interpolate.flag_verbose = 1;
parameter_interpolate.tolerance_pinv = 1e-6;
parameter_interpolate.flag_check = 0;
parameter_interpolate.flag_parsimonious = 1;
[ ...
 parameter_interpolate ...
,template_ori_wkS__ ...
,n_w ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,R_use__ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dtemplateda_ori_wkS__ ...
,dtemplatedb_ori_wkS__ ...
,dtemplatedc_ori_wkS__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,dtemplateda_rec_wkS__ ...
,dtemplatedb_rec_wkS__ ...
,dtemplatedc_rec_wkS__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddtemplatedaa_ori_wkS__ ...
,ddtemplatedab_ori_wkS__ ...
,ddtemplatedac_ori_wkS__ ...
,ddtemplatedbb_ori_wkS__ ...
,ddtemplatedbc_ori_wkS__ ...
,ddtemplatedcc_ori_wkS__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,ddtemplatedaa_rec_wkS__ ...
,ddtemplatedab_rec_wkS__ ...
,ddtemplatedac_rec_wkS__ ...
,ddtemplatedbb_rec_wkS__ ...
,ddtemplatedbc_rec_wkS__ ...
,ddtemplatedcc_rec_wkS__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
interpolate_template_6( ...
 parameter_interpolate ...
,n_order ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,dvol_a_k_p_qk_ ...
,viewing_k_eq_d ...
,-1 ...
,n_w_0in ...
,n_viewing_S ...
,viewing_azimu_b_S_ ...
,viewing_polar_a_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
dvol_S_k_p_wkS__ = reshape(template_ori_wkS__,[n_w_sum,n_S]);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% interpolate_template_6 (dvol_S_k_p_wkS__): %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% Now step through and reconstitute the templates. ;
%%%%%%%%;
dvol_R_k_p_wkS__ = zeros(n_w_sum,n_S);
for nS=0:n_S-1;
dvol_S_k_p_wk_ = dvol_S_k_p_wkS__(:,1+nS);
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_dvol_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
dvol_R_k_p_wk_ = zeros(n_w_sum,1);
for nsource=0:n_source-1;
tmp_delta_ = tmp_dvol_R__*delta_dvol_a_c__(:,1+nsource);
dvol_R_k_p_wk_ = dvol_R_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_(1+0) + k_c_1_wk_*tmp_delta_(1+1)));
end;%for nsource=0:n_source-1;
dvol_R_k_p_wkS__(:,1+nS) = dvol_R_k_p_wk_;
end;%for nS=0:n_S-1;
fnorm_disp(flag_verbose,'dvol_R_k_p_wkS__',dvol_R_k_p_wkS__,'dvol_S_k_p_wkS__',dvol_S_k_p_wkS__);
%%%%%%%%;

%%%%%%%%;
% Set up test with five 'on-grid' images. ;
%%%%%%%%;
n_M = 5;
index_nCTF_from_nM_ = [1;0;0;1;1];
index_neta_from_nM_ = [1;0;1;0;1];
index_nS_from_nM_ = [64;128;512;768;850];
M_k_p_wkM__ = zeros(n_w_sum,n_M);
euler_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_);
euler_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_);
euler_gamma_z_M_ = [pi/3;pi/4;pi/5;pi/6;pi/7];
for nM=0:n_M-1;
M_k_p_wkM__(:,1+nM) = rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,T_k_p_wkS__(:,1+index_nS_from_nM_(1+nM)),+euler_gamma_z_M_(1+nM));
end;%for nM=0:n_M-1;
%%%%;
rng(7);
dtau_euler_polar_a_M_ = 2*pi*rand(n_M,1);
dtau_euler_azimu_b_M_ = 2*pi*rand(n_M,1);
dtau_euler_gamma_z_M_ = 2*pi*rand(n_M,1);
%dtau_fnorm = fnorm([ dtau_euler_polar_a_M_ , dtau_euler_azimu_b_M_ , dtau_euler_gamma_z_M_ ]);
%dtau_euler_polar_a_M_ = dtau_euler_polar_a_M_/max(1e-12,dtau_fnorm);
%dtau_euler_azimu_b_M_ = dtau_euler_azimu_b_M_/max(1e-12,dtau_fnorm);
%dtau_euler_gamma_z_M_ = dtau_euler_gamma_z_M_/max(1e-12,dtau_fnorm);
dtau = 1e-5;
%%%%;
ssnll_0 = 0.0d0;
for nM=0:n_M-1;
nS = index_nS_from_nM_(1+nM);
S_k_p_wk_ = S_k_p_wkS__(:,1+nS);
T_k_p_wk_ = T_k_p_wkS__(:,1+nS);
nCTF = index_nCTF_from_nM_(1+nM);
CTF_k_p_wk_ = CTF_k_p_wkC__(:,1+nCTF);
neta = index_neta_from_nM_(1+nM);
eta_k_p_wk_ = eta_k_p_wke__(:,1+neta);
tmp_polar_a = euler_polar_a_M_(1+nM);
tmp_azimu_b = euler_azimu_b_M_(1+nM);
tmp_gamma_z = 0.0;
tmp_R__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
tmp_R_a__ = tmp_R__; tmp_R_b__ = tmp_R__;
U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source-1;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1]));
tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
U_k_p_wk_ = U_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
end;%for nsource_a=0:n_source-1;
fnorm_disp(flag_verbose-1,'S_k_p_wk_',S_k_p_wk_,'U_k_p_wk_',U_k_p_wk_);
V_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source-1;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1]));
tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
V_k_p_wk_ = V_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
end;%for nsource_b=0:n_source-1;
fnorm_disp(flag_verbose-1,'T_k_p_wk_',T_k_p_wk_,'V_k_p_wk_',V_k_p_wk_);
ssnll_0 = ssnll_0 + 0.5*sum(abs(U_k_p_wk_.*CTF_k_p_wk_ - V_k_p_wk_).^2.*eta_k_p_wk_.*weight_2d_wk_,'all')*(4*pi^2);
end;%for nM=0:n_M-1;

%%%%%%%%;
% Calculate derivative using ssnll_from_plane_wave_expansion_0. ;
%%%%%%%%;
n_source_a = n_source; v_source_a_ = ones(n_source_a,1);
n_source_b = n_source; v_source_b_ = ones(n_source_b,1);
n_source_dvol_a = n_source; v_source_dvol_a_ = ones(n_source_dvol_a,1);
viewing_gamma_z_S_ = zeros(n_S,1);
tmp_t = tic();
[ ...
 ~ ...
,ssnll_pwv_M_ ...
,ssnll_pwv ...
,S_k_p_pwv_wkS__ ...
,dvol_ssnll_pwv_M_ ...
,dvol_ssnll_pwv ...
,dvol_S_k_p_pwv_wkS__ ...
,dvol_dvol_ssnll_pwv ...
,dtau_ssnll_pwv_M3__ ...
,dtau_ssnll_pwv ...
,dtau_S_k_p_pwv_wkS3___ ...
,dtau_dvol_ssnll_pwv_M3__ ...
,dtau_dvol_ssnll_pwv ...
,dtau_dvol_S_k_p_pwv_wkS3___ ...
,dtau_dtau_ssnll_pwv_M33___ ...
,dtau_dtau_ssnll_pwv ...
,dtau_dtau_S_k_p_pwv_wkS33____ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 parameter_ssnll ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,0*euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_plane_wave_expansion_0: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% Calculate derivative using ssnll_from_a_k_p_14. ;
%%%%%%%%;
tmp_t = tic();
weight_imagecount_M_ = ones(n_M,1);
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
[ ...
 parameter_ssnll ...
,ssnll_tst_M_ ...
,ssnll_tst ...
,S_k_p_tst_wkS__ ...
,dvol_ssnll_tst_M_ ...
,dvol_ssnll_tst ...
,dvol_S_k_p_tst_wkS__ ...
,dvol_dvol_ssnll_tst ...
,dtau_ssnll_tst_M3__ ...
,dtau_ssnll_tst ...
,dtau_S_k_p_tst_wkS3___ ...
,dtau_dvol_ssnll_tst_M3__ ...
,dtau_dvol_ssnll_tst ...
,dtau_dvol_S_k_p_tst_wkS3___ ...
,dtau_dtau_ssnll_tst_M33___ ...
,dtau_dtau_ssnll_tst ...
,dtau_dtau_S_k_p_tst_wkS33____ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_form_ ...
,dvol_a_k_p_form_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_viewing_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% tabulate results. ;
%%%%%%%%;
if (flag_verbose>0); disp(sprintf(' %%%%%%%%%%%%%%%% : ')); end;
if (flag_verbose>0); disp(sprintf(' %% on-grid test: ')); end;
if (flag_verbose>0); disp(sprintf(' %%%%%%%%%%%%%%%% : ')); end;
fnorm_disp(flag_verbose,'ssnll_0',ssnll_0,'ssnll_pwv',ssnll_pwv);
fnorm_disp(flag_verbose,'ssnll_pwv_M_',ssnll_pwv_M_,'ssnll_tst_M_',ssnll_tst_M_);
fnorm_disp(flag_verbose,'ssnll_pwv',ssnll_pwv,'ssnll_tst',ssnll_tst);
fnorm_disp(flag_verbose,'S_k_p_pwv_wkS__',S_k_p_pwv_wkS__,'S_k_p_tst_wkS__',S_k_p_tst_wkS__);
fnorm_disp(flag_verbose,'dvol_ssnll_pwv_M_',dvol_ssnll_pwv_M_,'dvol_ssnll_tst_M_',dvol_ssnll_tst_M_);
fnorm_disp(flag_verbose,'dvol_ssnll_pwv',dvol_ssnll_pwv,'dvol_ssnll_tst',dvol_ssnll_tst);
fnorm_disp(flag_verbose,'dvol_S_k_p_pwv_wkS__',dvol_S_k_p_pwv_wkS__,'dvol_S_k_p_tst_wkS__',dvol_S_k_p_tst_wkS__);
fnorm_disp(flag_verbose,'dvol_dvol_ssnll_pwv',dvol_dvol_ssnll_pwv,'dvol_dvol_ssnll_tst',dvol_dvol_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_ssnll_pwv_M3__',dtau_ssnll_pwv_M3__,'dtau_ssnll_tst_M3__',dtau_ssnll_tst_M3__);
fnorm_disp(flag_verbose,'dtau_ssnll_pwv',dtau_ssnll_pwv,'dtau_ssnll_tst',dtau_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_S_k_p_pwv_wkS3___',dtau_S_k_p_pwv_wkS3___,'dtau_S_k_p_tst_wkS3___',dtau_S_k_p_tst_wkS3___);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pwv_M3__',dtau_dvol_ssnll_pwv_M3__,'dtau_dvol_ssnll_tst_M3__',dtau_dvol_ssnll_tst_M3__);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pwv',dtau_dvol_ssnll_pwv,'dtau_dvol_ssnll_tst',dtau_dvol_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_dvol_S_k_p_pwv_wkS3___',dtau_dvol_S_k_p_pwv_wkS3___,'dtau_dvol_S_k_p_tst_wkS3___',dtau_dvol_S_k_p_tst_wkS3___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pwv_M33___',dtau_dtau_ssnll_pwv_M33___,'dtau_dtau_ssnll_tst_M33___',dtau_dtau_ssnll_tst_M33___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pwv',dtau_dtau_ssnll_pwv,'dtau_dtau_ssnll_tst',dtau_dtau_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_dtau_S_k_p_pwv_wkS33____',dtau_dtau_S_k_p_pwv_wkS33____,'dtau_dtau_S_k_p_tst_wkS33____',dtau_dtau_S_k_p_tst_wkS33____);
%%%%%%%%;
n_wk = n_w_max*n_k_p_r; n_3 = 3; n_1 = 1;
%%%%;
S_k_p_errabs_wkS__ = abs(S_k_p_pwv_wkS__ - S_k_p_tst_wkS__);
dtau_S_k_p_errabs_wkS3___ = abs(dtau_S_k_p_pwv_wkS3___ - dtau_S_k_p_tst_wkS3___);
dtau_dtau_S_k_p_errabs_wkS33____ = abs(dtau_dtau_S_k_p_pwv_wkS33____ - dtau_dtau_S_k_p_tst_wkS33____);
%%%%;
[tmp_val,tmp_ij] = max(S_k_p_errabs_wkS__,[],'all'); tmp_index = tmp_ij-1;
tmp_nwk = mod(tmp_index,n_wk); tmp_index = round((tmp_index-tmp_nwk)/n_wk);
tmp_nS = mod(tmp_index,n_S); tmp_index = round((tmp_index-tmp_nS)/n_S);
assert(tmp_index==0);
tmp_polar_a = viewing_polar_a_S_(1+tmp_nS);
tmp_azimu_b = viewing_azimu_b_S_(1+tmp_nS);
if (flag_verbose>0);
disp(sprintf(' %% S_k_p_errabs_wkS__: %0.16f tmp_nwk %d tmp_nS %d polar_a/pi %+0.2f azimu_b/pi %+0.2f',tmp_val,tmp_nwk,tmp_nS,tmp_polar_a/pi,tmp_azimu_b/pi));
end;%if (flag_verbose>0);
%%%%;
[tmp_val,tmp_ij] = max(dtau_S_k_p_errabs_wkS3___,[],'all'); tmp_index = tmp_ij-1;
tmp_nwk = mod(tmp_index,n_wk); tmp_index = round((tmp_index-tmp_nwk)/n_wk);
tmp_nS = mod(tmp_index,n_S); tmp_index = round((tmp_index-tmp_nS)/n_S);
tmp_n3 = mod(tmp_index,n_3); tmp_index = round((tmp_index-tmp_n3)/n_3);
assert(tmp_index==0);
tmp_polar_a = viewing_polar_a_S_(1+tmp_nS);
tmp_azimu_b = viewing_azimu_b_S_(1+tmp_nS);
if (flag_verbose>0);
disp(sprintf(' %% dtau_S_k_p_errabs_wkS3___: %0.16f tmp_nwk %d tmp_nS %d tmp_n3 %d polar_a/pi %+0.2f azimu_b/pi %+0.2f',tmp_val,tmp_nwk,tmp_nS,tmp_n3,tmp_polar_a/pi,tmp_azimu_b/pi));
end;%if (flag_verbose>0);
%%%%;
[tmp_val,tmp_ij] = max(dtau_dtau_S_k_p_errabs_wkS33____,[],'all'); tmp_index = tmp_ij-1;
tmp_nwk = mod(tmp_index,n_wk); tmp_index = round((tmp_index-tmp_nwk)/n_wk);
tmp_nS = mod(tmp_index,n_S); tmp_index = round((tmp_index-tmp_nS)/n_S);
tmp_nx = mod(tmp_index,n_3); tmp_index = round((tmp_index-tmp_nx)/n_3);
tmp_ny = mod(tmp_index,n_3); tmp_index = round((tmp_index-tmp_ny)/n_3);
assert(tmp_index==0);
tmp_polar_a = viewing_polar_a_S_(1+tmp_nS);
tmp_azimu_b = viewing_azimu_b_S_(1+tmp_nS);
if (flag_verbose>0);
disp(sprintf(' %% dtau_dtau_S_k_p_errabs_wkS33____: %0.16f tmp_nwk %d tmp_nS %d tmp_nx %d tmp_ny %d polar_a/pi %+0.2f azimu_b/pi %+0.2f',tmp_val,tmp_nwk,tmp_nS,tmp_nx,tmp_ny,tmp_polar_a/pi,tmp_azimu_b/pi));
end;%if (flag_verbose>0);
%%%%;

flag_disp=0;
if flag_disp;
%%%%%%%%;
% visualize errors as function of location on sphere. ;
%%%%%%%%;
[ ...
 k_p_polar_a_wS__ ...
,k_p_azimu_b_wS__ ...
,k_c_0_wS__ ...
,k_c_1_wS__ ...
,k_c_2_wS__ ...
] = ...
cg_rhs_2( ...
 n_S ...
,n_w_max ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
k_p_polar_a_wkS__ = reshape(permute(repmat(k_p_polar_a_wS__,[1,1,n_k_p_r]),[1,3,2]),[n_w_sum,n_S]);
k_p_azimu_b_wkS__ = reshape(permute(repmat(k_p_azimu_b_wS__,[1,1,n_k_p_r]),[1,3,2]),[n_w_sum,n_S]);
k_c_0_wkS__ = reshape(permute(bsxfun(@times,k_c_0_wS__,reshape(k_p_r_,[1,1,n_k_p_r])),[1,3,2]),[n_w_sum,n_S]);
k_c_1_wkS__ = reshape(permute(bsxfun(@times,k_c_1_wS__,reshape(k_p_r_,[1,1,n_k_p_r])),[1,3,2]),[n_w_sum,n_S]);
k_c_2_wkS__ = reshape(permute(bsxfun(@times,k_c_2_wS__,reshape(k_p_r_,[1,1,n_k_p_r])),[1,3,2]),[n_w_sum,n_S]);
viewing_polar_a_wkS__ = reshape(permute(repmat(viewing_polar_a_S_,[1,n_w_sum]),[2,1]),[n_w_sum,n_S]);
viewing_azimu_b_wkS__ = reshape(permute(repmat(viewing_azimu_b_S_,[1,n_w_sum]),[2,1]),[n_w_sum,n_S]);
%%%%;
S_k_p_errabs_wkS__ = abs(S_k_p_pwv_wkS__ - S_k_p_tst_wkS__);
dtau_S_k_p_errabs_wkS3___ = abs(dtau_S_k_p_pwv_wkS3___ - dtau_S_k_p_tst_wkS3___);
dtau_dtau_S_k_p_errabs_wkS33____ = abs(dtau_dtau_S_k_p_pwv_wkS33____ - dtau_dtau_S_k_p_tst_wkS33____);
%%%%;
figure(1+nf);nf=nf+1;figbig;clf;
xlim_ = [0,pi];
llim_ = [-6,0];
p_row = 3; p_col = 5; np=0;
subplot(p_row,p_col,1+np);np=np+1;cla;
tmp_wkS__ = S_k_p_errabs_wkS__; tmp_str = 'S_k_p_errabs_wkS__';
plot(k_p_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
xlim(xlim_); xlabel('k_p_polar_a','Interpreter','none');
ylim(llim_); ylabel(sprintf('log10(errabs)'),'Interpreter','none');
title(sprintf('%s',tmp_str),'Interpreter','none');
for na=0:3-1;
subplot(p_row,p_col,1+np);np=np+1;cla;
tmp_wkS__ = dtau_S_k_p_errabs_wkS3___(:,:,1+na); tmp_str = sprintf('dtau_S_k_p_errabs_wkS3___(:,:,1+%d)',na);
plot(k_p_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
xlim(xlim_); xlabel('k_p_polar_a','Interpreter','none');
ylim(llim_); ylabel(sprintf('log10(errabs)'),'Interpreter','none');
title(sprintf('%s',tmp_str),'Interpreter','none');
end;%for na=0:3-1;
for na=0:9-1;
subplot(p_row,p_col,1+np);np=np+1;cla;
tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+na); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d)',na);
plot(k_p_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
xlim(xlim_); xlabel('k_p_polar_a','Interpreter','none');
ylim(llim_); ylabel(sprintf('log10(errabs)'),'Interpreter','none');
title(sprintf('%s',tmp_str),'Interpreter','none');
end;%for na=0:3-1;
%%%%;
figure(1+nf);nf=nf+1;figbig;clf;
xlim_ = [0,pi];
llim_ = [-6,0];
p_row = 3; p_col = 5; np=0;
subplot(p_row,p_col,1+np);np=np+1;cla;
tmp_wkS__ = S_k_p_errabs_wkS__; tmp_str = 'S_k_p_errabs_wkS__';
plot(viewing_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
xlim(xlim_); xlabel('viewing_polar_a','Interpreter','none');
ylim(llim_); ylabel(sprintf('log10(errabs)'),'Interpreter','none');
title(sprintf('%s',tmp_str),'Interpreter','none');
for na=0:3-1;
subplot(p_row,p_col,1+np);np=np+1;cla;
tmp_wkS__ = dtau_S_k_p_errabs_wkS3___(:,:,1+na); tmp_str = sprintf('dtau_S_k_p_errabs_wkS3___(:,:,1+%d)',na);
plot(viewing_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
xlim(xlim_); xlabel('viewing_polar_a','Interpreter','none');
ylim(llim_); ylabel(sprintf('log10(errabs)'),'Interpreter','none');
title(sprintf('%s',tmp_str),'Interpreter','none');
end;%for na=0:3-1;
for na=0:9-1;
subplot(p_row,p_col,1+np);np=np+1;cla;
tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+na); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d)',na);
plot(viewing_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
xlim(xlim_); xlabel('viewing_polar_a','Interpreter','none');
ylim(llim_); ylabel(sprintf('log10(errabs)'),'Interpreter','none');
title(sprintf('%s',tmp_str),'Interpreter','none');
end;%for na=0:3-1;
%%%%%%%%;
% Verdict: templates on the equator have data-points near the poles. ;
% The polar_a and azimu_b derivatives of these polar data-points are not accurate. ;
%%%%%%%%;
end;%if flag_disp;

flag_disp=0;
if flag_disp;
%%%%%%%%;
% demonstrate match and/or mismatch between templates and their targets. ;
%%%%%%%%;
S_k_p_errabs_wkS__ = abs(S_k_p_pwv_wkS__ - S_k_p_tst_wkS__);
dtau_S_k_p_errabs_wkS3___ = abs(dtau_S_k_p_pwv_wkS3___ - dtau_S_k_p_tst_wkS3___);
dtau_dtau_S_k_p_errabs_wkS33____ = abs(dtau_dtau_S_k_p_pwv_wkS33____ - dtau_dtau_S_k_p_tst_wkS33____);
%%%%;
figure(1+nf);nf=nf+1;figbig;clf;
%nS_ = [84,477,530,750,1024];
nS_ = transpose(efind(abs(viewing_polar_a_S_-pi/2)<1e-6));
nk_p_r_ = [n_k_p_r-1];
dnw = 1;
markersize_use = 8;
c_use__ = colormap_81s; n_c_use = size(c_use__,1);
xlim_ = 1.25*k_p_r_max*[-1,+1];
ylim_ = 1.25*k_p_r_max*[-1,+1];
zlim_ = 1.25*k_p_r_max*[-1,+1];
llim_ = [-6,0];
p_row = 3; p_col = 5; np=0;
for np=0:1+3+9-1;
na=0;
if np==na; tmp_wkS__ = S_k_p_errabs_wkS__; tmp_str = 'S_k_p_errabs_wkS__'; end; na=na+1;
if np==na; tmp_wkS__ = dtau_S_k_p_errabs_wkS3___(:,:,1+0); tmp_str = sprintf('dtau_S_k_p_errabs_wkS3___(:,:,1+%d)',0); end; na=na+1;
if np==na; tmp_wkS__ = dtau_S_k_p_errabs_wkS3___(:,:,1+1); tmp_str = sprintf('dtau_S_k_p_errabs_wkS3___(:,:,1+%d)',1); end; na=na+1;
if np==na; tmp_wkS__ = dtau_S_k_p_errabs_wkS3___(:,:,1+2); tmp_str = sprintf('dtau_S_k_p_errabs_wkS3___(:,:,1+%d)',2); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+0,1+0); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',0,0); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+0,1+1); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',0,1); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+0,1+2); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',0,2); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+1,1+0); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',1,0); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+1,1+1); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',1,1); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+1,1+2); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',1,2); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+2,1+0); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',2,0); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+2,1+1); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',2,1); end; na=na+1;
if np==na; tmp_wkS__ = dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+2,1+2); tmp_str = sprintf('dtau_dtau_S_k_p_errabs_wkS33____(:,:,1+%d,1+%d)',2,2); end; na=na+1;
subplot(p_row,p_col,1+np);cla;
%plot(k_p_polar_a_wkS__(:),log10(tmp_wkS__(:)),'k.');
plot_sphere_grid_0(struct('k_max',0.85*k_p_r_max));
hold on;
for nS=nS_;
for nk_p_r=nk_p_r_;
n_w = n_w_(1+nk_p_r); n_w_csum = n_w_csum_(1+nk_p_r);
for nw=0:dnw:n_w-1;
nwk = nw + n_w_csum;
nc_use = max(0,min(n_c_use-1,floor(n_c_use*(log10(tmp_wkS__(1+nwk,1+nS)) - min(llim_))/diff(llim_))));
plot3(k_c_0_wkS__(1+nwk,1+nS),k_c_1_wkS__(1+nwk,1+nS),k_c_2_wkS__(1+nwk,1+nS),'ko','MarkerSize',markersize_use,'MarkerFaceColor',c_use__(1+nc_use,:));
end;%for nw=0:n_w-1;
end;%for nk_p_r=nk_p_r_
end;%for nS=nS_;
hold off;
xlim(xlim_); xlabel('k_c_0','Interpreter','none');
ylim(ylim_); ylabel('k_c_1','Interpreter','none');
zlim(zlim_); zlabel('k_c_2','Interpreter','none');
axisnotick3d; axis vis3d;
title(sprintf('%s',tmp_str),'Interpreter','none');
drawnow();
end;%for np=0:1+3+9-1;
np=1+3+9;
subplot(p_row,p_col,1+np);cla; imagesc(1:64,[1,64]); axisnotick; fig81s;
%%%%%%%%;
end;%if flag_disp;

%{
%%%%%%%%;
% Note that the equatorial viewing-angles are not well resolved. ;
% This is particularly true for the template with polar_a = pi/2 and azimu_b = 0 or pi. ;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;
nS_ = transpose(efind(abs(viewing_polar_a_S_-pi/2)<1e-6)); n_nS = numel(nS_);
p_row = 8; p_col = ceil(n_nS/p_row); np=0;
for nnS=0:n_nS-1;
subplot(p_row,p_col,1+np);np=np+1;cla;
nS = nS_(1+nnS);
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,log10(dtau_dtau_S_k_p_errabs_wkS33____(:,1+nS,1+0,1+1)),llim_,colormap_81s); axis image; axisnotick;
title(sprintf('%d',nS));
drawnow();
end;%for nnS=0:n_nS-1;
%%%%%%%%;
figure(1+nf);nf=nf+1;clf;figbig;
nS_ = transpose(efind(abs(viewing_polar_a_S_-pi/2)<1e-6 & (abs(viewing_azimu_b_S_-1*pi)<1e-6 | abs(viewing_azimu_b_S_-0*pi)<1e-6))); n_nS = numel(nS_);
%tmp_pwv_wk_ = dtau_S_k_p_pwv_wkS3___(:,1+nS,1+1);
%tmp_tst_wk_ = dtau_S_k_p_tst_wkS3___(:,1+nS,1+1); 
tmp_pwv_wk_ = dtau_dtau_S_k_p_pwv_wkS33____(:,1+nS,1+1,1+0);
tmp_tst_wk_ = dtau_dtau_S_k_p_tst_wkS33____(:,1+nS,1+1,1+0);
tmp_lim_ =  1.25*max(abs(tmp_pwv_wk_))*[-1,+1];
p_row = n_nS; p_col = 4; np=0;
for nnS=0:n_nS-1;
nS = nS_(1+nnS);
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,real(tmp_pwv_wk_),tmp_lim_,colormap_beach); axis image; axisnotick;
title(sprintf('nS %d: real pwv',nS));
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,imag(tmp_pwv_wk_),tmp_lim_,colormap_beach); axis image; axisnotick;
title(sprintf('nS %d: imag pwv',nS));
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,real(tmp_tst_wk_),tmp_lim_,colormap_beach); axis image; axisnotick;
title(sprintf('nS %d: real tst',nS));
subplot(p_row,p_col,1+np);np=np+1;cla;
imagesc_p(n_k_p_r,k_p_r_,n_w_,n_w_sum,imag(tmp_tst_wk_),tmp_lim_,colormap_beach); axis image; axisnotick;
title(sprintf('nS %d: imag tst',nS));
drawnow();
end;%for nnS=0:n_nS-1;
%%%%%%%%;
%}

%%%%%%%%;
% Now test difference quotients. ;
%%%%%%%%;

dtau = 1e-4;

ssnll_pwv_mid_M_ = ssnll_pwv_M_;
ssnll_pwv_mid = ssnll_pwv;
S_k_p_pwv_mid_wkS__ = S_k_p_pwv_wkS__;
dvol_ssnll_pwv_mid_M_ = dvol_ssnll_pwv_M_;
dvol_ssnll_pwv_mid = dvol_ssnll_pwv;
dvol_S_k_p_pwv_mid_wkS__ = dvol_S_k_p_pwv_wkS__;
dvol_dvol_ssnll_pwv_mid = dvol_dvol_ssnll_pwv;
dtau_ssnll_pwv_mid_M3__ = dtau_ssnll_pwv_M3__;
dtau_ssnll_pwv_mid = dtau_ssnll_pwv;
dtau_S_k_p_pwv_mid_wkS3___ = dtau_S_k_p_pwv_wkS3___;
dtau_dvol_ssnll_pwv_mid_M3__ = dtau_dvol_ssnll_pwv_M3__;
dtau_dvol_ssnll_pwv_mid = dtau_dvol_ssnll_pwv;
dtau_dvol_S_k_p_pwv_mid_wkS3___ = dtau_dvol_S_k_p_pwv_wkS3___;
dtau_dtau_ssnll_pwv_mid_M33___ = dtau_dtau_ssnll_pwv_M33___;
dtau_dtau_ssnll_pwv_mid = dtau_dtau_ssnll_pwv;
dtau_dtau_S_k_p_pwv_mid_wkS33____ = dtau_dtau_S_k_p_pwv_wkS33____;

ssnll_tst_mid_M_ = ssnll_tst_M_;
ssnll_tst_mid = ssnll_tst;
S_k_p_tst_mid_wkS__ = S_k_p_tst_wkS__;
dvol_ssnll_tst_mid_M_ = dvol_ssnll_tst_M_;
dvol_ssnll_tst_mid = dvol_ssnll_tst;
dvol_S_k_p_tst_mid_wkS__ = dvol_S_k_p_tst_wkS__;
dvol_dvol_ssnll_tst_mid = dvol_dvol_ssnll_tst;
dtau_ssnll_tst_mid_M3__ = dtau_ssnll_tst_M3__;
dtau_ssnll_tst_mid = dtau_ssnll_tst;
dtau_S_k_p_tst_mid_wkS3___ = dtau_S_k_p_tst_wkS3___;
dtau_dvol_ssnll_tst_mid_M3__ = dtau_dvol_ssnll_tst_M3__;
dtau_dvol_ssnll_tst_mid = dtau_dvol_ssnll_tst;
dtau_dvol_S_k_p_tst_mid_wkS3___ = dtau_dvol_S_k_p_tst_wkS3___;
dtau_dtau_ssnll_tst_mid_M33___ = dtau_dtau_ssnll_tst_M33___;
dtau_dtau_ssnll_tst_mid = dtau_dtau_ssnll_tst;
dtau_dtau_S_k_p_tst_mid_wkS33____ = dtau_dtau_S_k_p_tst_wkS33____;

%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
tmp_parameter_ssnll = parameter_ssnll;
tmp_parameter_ssnll.flag_verbose = 0*flag_verbose;
tmp_parameter_ssnll.tolerance_pinv = 1e-6;
tmp_parameter_ssnll.viewing_k_eq_d = viewing_k_eq_d;
tmp_parameter_ssnll.template_k_eq_d = template_k_eq_d;
tmp_parameter_ssnll.n_order = n_order;
[ ...
 tmp_parameter_ssnll ...
,ssnll_tst_pos_M_ ...
,ssnll_tst_pos ...
,S_k_p_tst_pos_wkS__ ...
,dvol_ssnll_tst_pos_M_ ...
,dvol_ssnll_tst_pos ...
,dvol_S_k_p_tst_pos_wkS__ ...
,dvol_dvol_ssnll_tst_pos ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 tmp_parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_qk_ ...
,dvol_a_k_p_qk_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,S_k_p_tst_wkS__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,+(euler_polar_a_M_ + 1.0*dtau*dtau_euler_polar_a_M_) ...
,+(euler_azimu_b_M_ + 1.0*dtau*dtau_euler_azimu_b_M_) ...
,+(euler_gamma_z_M_ + 1.0*dtau*dtau_euler_gamma_z_M_) ...
,[] ...
,[] ...
,[] ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: time %0.2fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
tmp_parameter_ssnll = parameter_ssnll;
tmp_parameter_ssnll.flag_verbose = 0*flag_verbose;
tmp_parameter_ssnll.tolerance_pinv = 1e-6;
tmp_parameter_ssnll.viewing_k_eq_d = viewing_k_eq_d;
tmp_parameter_ssnll.template_k_eq_d = template_k_eq_d;
tmp_parameter_ssnll.n_order = n_order;
[ ...
 tmp_parameter_ssnll ...
,ssnll_tst_neg_M_ ...
,ssnll_tst_neg ...
,S_k_p_tst_neg_wkS__ ...
,dvol_ssnll_tst_neg_M_ ...
,dvol_ssnll_tst_neg ...
,dvol_S_k_p_tst_neg_wkS__ ...
,dvol_dvol_ssnll_tst_neg ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,~ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 tmp_parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_qk_ ...
,dvol_a_k_p_qk_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_S ...
,S_k_p_tst_wkS__ ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,+(euler_polar_a_M_ - 1.0*dtau*dtau_euler_polar_a_M_) ...
,+(euler_azimu_b_M_ - 1.0*dtau*dtau_euler_azimu_b_M_) ...
,+(euler_gamma_z_M_ - 1.0*dtau*dtau_euler_gamma_z_M_) ...
,[] ...
,[] ...
,[] ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: time %0.2fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
dtau_M3__ = [ dtau_euler_polar_a_M_ , dtau_euler_azimu_b_M_ , dtau_euler_gamma_z_M_ ] ;
dtau_dtau_M33___ = bsxfun(@times,reshape(dtau_M3__,[n_M,n_3,n_1]),reshape(dtau_M3__,[n_M,n_1,n_3]));
%%%%%%%%;
dtau_ssnll_tst_dif_M_ = (ssnll_tst_pos_M_ - ssnll_tst_neg_M_)/max(1e-12,2*dtau);
dtau_ssnll_tst_mid_M_ = sum(dtau_ssnll_tst_mid_M3__.*dtau_M3__,2);
dtau_ssnll_pwv_mid_M_ = sum(dtau_ssnll_pwv_mid_M3__.*dtau_M3__,2);
fnorm_disp(flag_verbose,'dtau_ssnll_tst_dif_M_',dtau_ssnll_tst_dif_M_,'dtau_ssnll_tst_mid_M_',dtau_ssnll_tst_mid_M_);
fnorm_disp(flag_verbose,'dtau_ssnll_tst_dif_M_',dtau_ssnll_tst_dif_M_,'dtau_ssnll_pwv_mid_M_',dtau_ssnll_pwv_mid_M_);
dtau_ssnll_tst_dif = (ssnll_tst_pos - ssnll_tst_neg)/max(1e-12,2*dtau);
dtau_ssnll_tst_mid = dtau_ssnll_tst_mid;
dtau_ssnll_pwv_mid = dtau_ssnll_pwv_mid;
fnorm_disp(flag_verbose,'dtau_ssnll_tst_dif',dtau_ssnll_tst_dif,'dtau_ssnll_tst_mid',dtau_ssnll_tst_mid);
fnorm_disp(flag_verbose,'dtau_ssnll_tst_dif',dtau_ssnll_tst_dif,'dtau_ssnll_pwv_mid',dtau_ssnll_pwv_mid);
dtau_dvol_ssnll_tst_dif_M_ = (dvol_ssnll_tst_pos_M_ - dvol_ssnll_tst_neg_M_)/max(1e-12,2*dtau);
dtau_dvol_ssnll_tst_mid_M_ = sum(dtau_dvol_ssnll_tst_mid_M3__.*dtau_M3__,2);
dtau_dvol_ssnll_pwv_mid_M_ = sum(dtau_dvol_ssnll_pwv_mid_M3__.*dtau_M3__,2);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_tst_dif_M_',dtau_dvol_ssnll_tst_dif_M_,'dtau_dvol_ssnll_tst_mid_M_',dtau_dvol_ssnll_tst_mid_M_);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_tst_dif_M_',dtau_dvol_ssnll_tst_dif_M_,'dtau_dvol_ssnll_pwv_mid_M_',dtau_dvol_ssnll_pwv_mid_M_);
dtau_dvol_ssnll_tst_dif = (dvol_ssnll_tst_pos - dvol_ssnll_tst_neg)/max(1e-12,2*dtau);
dtau_dvol_ssnll_tst_mid = dtau_dvol_ssnll_tst_mid;
dtau_dvol_ssnll_pwv_mid = dtau_dvol_ssnll_pwv_mid;
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_tst_dif',dtau_dvol_ssnll_tst_dif,'dtau_dvol_ssnll_tst_mid',dtau_dvol_ssnll_tst_mid);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_tst_dif',dtau_dvol_ssnll_tst_dif,'dtau_dvol_ssnll_pwv_mid',dtau_dvol_ssnll_pwv_mid);
dtau_dtau_ssnll_tst_dif_M_ = ( ssnll_tst_pos_M_ - 2*ssnll_tst_mid_M_ + ssnll_tst_neg_M_ ) / max(1e-12,dtau^2) ;
dtau_dtau_ssnll_tst_mid_M_ = sum(dtau_dtau_ssnll_tst_mid_M33___.*dtau_dtau_M33___,[2,3]);
dtau_dtau_ssnll_pwv_mid_M_ = sum(dtau_dtau_ssnll_pwv_mid_M33___.*dtau_dtau_M33___,[2,3]);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_tst_dif_M_',dtau_dtau_ssnll_tst_dif_M_,'dtau_dtau_ssnll_tst_mid_M_',dtau_dtau_ssnll_tst_mid_M_);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_tst_dif_M_',dtau_dtau_ssnll_tst_dif_M_,'dtau_dtau_ssnll_pwv_mid_M_',dtau_dtau_ssnll_pwv_mid_M_);
dtau_dtau_ssnll_tst_dif = ( ssnll_tst_pos - 2*ssnll_tst_mid + ssnll_tst_neg ) / max(1e-12,dtau^2) ;
dtau_dtau_ssnll_tst_mid = dtau_dtau_ssnll_tst_mid;
dtau_dtau_ssnll_pwv_mid = dtau_dtau_ssnll_pwv_mid;
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_tst_dif',dtau_dtau_ssnll_tst_dif,'dtau_dtau_ssnll_tst_mid',dtau_dtau_ssnll_tst_mid);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_tst_dif',dtau_dtau_ssnll_tst_dif,'dtau_dtau_ssnll_pwv_mid',dtau_dtau_ssnll_pwv_mid);
%%%%%%%%;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%;

%%%%%%%%;
% Set up another test with some 'off-grid' images. ;
%%%%%%%%;
n_M = 5;
index_nCTF_from_nM_ = [1;0;0;1;1];
index_neta_from_nM_ = [1;0;1;0;1];
index_nS_from_nM_ = [64;128;512;768;850];
M_k_p_wkM__ = zeros(n_w_sum,n_M);
euler_polar_a_M_ = viewing_polar_a_S_(1+index_nS_from_nM_);
euler_azimu_b_M_ = viewing_azimu_b_S_(1+index_nS_from_nM_);
euler_gamma_z_M_ = [pi/3;pi/4;pi/5;pi/6;pi/7];
for nM=0:n_M-1;
M_k_p_wkM__(:,1+nM) = rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,T_k_p_wkS__(:,1+index_nS_from_nM_(1+nM)),+euler_gamma_z_M_(1+nM));
end;%for nM=0:n_M-1;
nM = 1; euler_polar_a_M_(1+nM) = +2*pi/17; euler_azimu_b_M_(1+nM) = +19*pi/11; %<-- arbitrary off-grid viewing-angle. ;
nM = 3; euler_polar_a_M_(1+nM) = +9*pi/17; euler_azimu_b_M_(1+nM) = +17*pi/11; %<-- arbitrary off-grid viewing-angle. ;
nM = 4; euler_polar_a_M_(1+nM) = +3*pi/17; euler_azimu_b_M_(1+nM) = +10*pi/11; %<-- arbitrary off-grid viewing-angle. ;
%%%%;
rng(7);
dtau_euler_polar_a_M_ = 2*pi*rand(n_M,1);
dtau_euler_azimu_b_M_ = 2*pi*rand(n_M,1);
dtau_euler_gamma_z_M_ = 2*pi*rand(n_M,1);
%dtau_fnorm = fnorm([ dtau_euler_polar_a_M_ , dtau_euler_azimu_b_M_ , dtau_euler_gamma_z_M_ ]);
%dtau_euler_polar_a_M_ = dtau_euler_polar_a_M_/max(1e-12,dtau_fnorm);
%dtau_euler_azimu_b_M_ = dtau_euler_azimu_b_M_/max(1e-12,dtau_fnorm);
%dtau_euler_gamma_z_M_ = dtau_euler_gamma_z_M_/max(1e-12,dtau_fnorm);
dtau = 1e-5;
%%%%;
ssnll_0 = 0.0d0;
for nM=0:n_M-1;
nS = index_nS_from_nM_(1+nM);
T_k_p_wk_ = T_k_p_wkS__(:,1+nS);
nCTF = index_nCTF_from_nM_(1+nM);
CTF_k_p_wk_ = CTF_k_p_wkC__(:,1+nCTF);
neta = index_neta_from_nM_(1+nM);
eta_k_p_wk_ = eta_k_p_wke__(:,1+neta);
tmp_polar_a = euler_polar_a_M_(1+nM);
tmp_azimu_b = euler_azimu_b_M_(1+nM);
tmp_gamma_z = 0.0;
tmp_R_a__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
U_k_p_wk_ = zeros(n_w_sum,1);
for nsource_a=0:n_source-1;
tmp_delta_U_ = tmp_R_a__*delta_a_c__(:,1+nsource_a);
tmp_delta_U = fnorm(tmp_delta_U_(1+[0,1]));
tmp_omega_U = atan2(tmp_delta_U_(1+1),tmp_delta_U_(1+0));
U_k_p_wk_ = U_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_U_(1+0) + k_c_1_wk_*tmp_delta_U_(1+1)));
end;%for nsource_a=0:n_source-1;
tmp_polar_a = viewing_polar_a_S_(1+nS);
tmp_azimu_b = viewing_azimu_b_S_(1+nS);
tmp_gamma_z = 0.0;
tmp_R_b__ = Rz(-tmp_gamma_z)*Ry(-tmp_polar_a)*Rz(-tmp_azimu_b);
V_k_p_wk_ = zeros(n_w_sum,1);
for nsource_b=0:n_source-1;
tmp_delta_V_ = tmp_R_b__*delta_b_c__(:,1+nsource_b);
tmp_delta_V = fnorm(tmp_delta_V_(1+[0,1]));
tmp_omega_V = atan2(tmp_delta_V_(1+1),tmp_delta_V_(1+0));
V_k_p_wk_ = V_k_p_wk_ + exp(+i*2*pi*(k_c_0_wk_*tmp_delta_V_(1+0) + k_c_1_wk_*tmp_delta_V_(1+1)));
end;%for nsource_b=0:n_source-1;
if (flag_verbose>1); disp(sprintf(' %% T_k_p_wk_ vs V_k_p_wk_: %0.16f',fnorm(T_k_p_wk_ - V_k_p_wk_)/fnorm(T_k_p_wk_))); end;
ssnll_0 = ssnll_0 + 0.5*sum(abs(U_k_p_wk_.*CTF_k_p_wk_ - V_k_p_wk_).^2.*eta_k_p_wk_.*weight_2d_wk_,'all')*(4*pi^2);
end;%for nM=0:n_M-1;

%%%%%%%%;
% Calculate derivative using ssnll_from_plane_wave_expansion_0. ;
%%%%%%%%;
tmp_t = tic();
n_source_a = n_source; v_source_a_ = ones(n_source_a,1);
n_source_b = n_source; v_source_b_ = ones(n_source_b,1);
n_source_dvol_a = n_source; v_source_dvol_a_ = ones(n_source_dvol_a,1);
viewing_gamma_z_S_ = zeros(n_S,1);
[ ...
 ~ ...
,ssnll_pwv_M_ ...
,ssnll_pwv ...
,S_k_p_pwv_wkS__ ...
,dvol_ssnll_pwv_M_ ...
,dvol_ssnll_pwv ...
,dvol_S_k_p_pwv_wkS__ ...
,dvol_dvol_ssnll_pwv ...
,dtau_ssnll_pwv_M3__ ...
,dtau_ssnll_pwv ...
,dtau_S_k_p_pwv_wkS3___ ...
,dtau_dvol_ssnll_pwv_M3__ ...
,dtau_dvol_ssnll_pwv ...
,dtau_dvol_S_k_p_pwv_wkS3___ ...
,dtau_dtau_ssnll_pwv_M33___ ...
,dtau_dtau_ssnll_pwv ...
,dtau_dtau_S_k_p_pwv_wkS33____ ...
] = ...
ssnll_from_plane_wave_expansion_0( ...
 parameter_ssnll ...
,n_source_a ...
,v_source_a_ ...
,delta_a_c__ ...
,n_source_b ...
,v_source_b_ ...
,delta_b_c__ ...
,n_source_dvol_a ...
,v_source_dvol_a_ ...
,delta_dvol_a_c__ ...
,n_k_p_r ...
,k_p_r_ ...
,n_w_max ...
,weight_2d_wk_ ...
,n_CTF ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,n_eta ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,n_M ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,0*euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,n_S ...
,index_nS_from_nM_ ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_gamma_z_S_ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_plane_wave_expansion_0: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% Calculate derivative using ssnll_from_a_k_p_14. ;
%%%%%%%%;
tmp_t = tic();
weight_imagecount_M_ = ones(n_M,1);
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
[ ...
 parameter_ssnll ...
,ssnll_tst_M_ ...
,ssnll_tst ...
,S_k_p_tst_wkS__ ...
,dvol_ssnll_tst_M_ ...
,dvol_ssnll_tst ...
,dvol_S_k_p_tst_wkS__ ...
,dvol_dvol_ssnll_tst ...
,dtau_ssnll_tst_M3__ ...
,dtau_ssnll_tst ...
,dtau_S_k_p_tst_wkS3___ ...
,dtau_dvol_ssnll_tst_M3__ ...
,dtau_dvol_ssnll_tst ...
,dtau_dvol_S_k_p_tst_wkS3___ ...
,dtau_dtau_ssnll_tst_M33___ ...
,dtau_dtau_ssnll_tst ...
,dtau_dtau_S_k_p_tst_wkS33____ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_form_ ...
,dvol_a_k_p_form_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_viewing_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% tabulate results. ;
%%%%%%%%;
if (flag_verbose>0); disp(sprintf(' %%%%%%%%%%%%%%%% : ')); end;
if (flag_verbose>0); disp(sprintf(' %% off-grid test: ')); end;
if (flag_verbose>0); disp(sprintf(' %%%%%%%%%%%%%%%% : ')); end;
fnorm_disp(flag_verbose,'ssnll_0',ssnll_0,'ssnll_pwv',ssnll_pwv);
fnorm_disp(flag_verbose,'ssnll_pwv_M_',ssnll_pwv_M_,'ssnll_tst_M_',ssnll_tst_M_);
fnorm_disp(flag_verbose,'ssnll_pwv',ssnll_pwv,'ssnll_tst',ssnll_tst);
fnorm_disp(flag_verbose,'S_k_p_pwv_wkS__',S_k_p_pwv_wkS__,'S_k_p_tst_wkS__',S_k_p_tst_wkS__);
fnorm_disp(flag_verbose,'dvol_ssnll_pwv_M_',dvol_ssnll_pwv_M_,'dvol_ssnll_tst_M_',dvol_ssnll_tst_M_);
fnorm_disp(flag_verbose,'dvol_ssnll_pwv',dvol_ssnll_pwv,'dvol_ssnll_tst',dvol_ssnll_tst);
fnorm_disp(flag_verbose,'dvol_S_k_p_pwv_wkS__',dvol_S_k_p_pwv_wkS__,'dvol_S_k_p_tst_wkS__',dvol_S_k_p_tst_wkS__);
fnorm_disp(flag_verbose,'dvol_dvol_ssnll_pwv',dvol_dvol_ssnll_pwv,'dvol_dvol_ssnll_tst',dvol_dvol_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_ssnll_pwv_M3__',dtau_ssnll_pwv_M3__,'dtau_ssnll_tst_M3__',dtau_ssnll_tst_M3__);
fnorm_disp(flag_verbose,'dtau_ssnll_pwv',dtau_ssnll_pwv,'dtau_ssnll_tst',dtau_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_S_k_p_pwv_wkS3___',dtau_S_k_p_pwv_wkS3___,'dtau_S_k_p_tst_wkS3___',dtau_S_k_p_tst_wkS3___);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pwv_M3__',dtau_dvol_ssnll_pwv_M3__,'dtau_dvol_ssnll_tst_M3__',dtau_dvol_ssnll_tst_M3__);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_pwv',dtau_dvol_ssnll_pwv,'dtau_dvol_ssnll_tst',dtau_dvol_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_dvol_S_k_p_pwv_wkS3___',dtau_dvol_S_k_p_pwv_wkS3___,'dtau_dvol_S_k_p_tst_wkS3___',dtau_dvol_S_k_p_tst_wkS3___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pwv_M33___',dtau_dtau_ssnll_pwv_M33___,'dtau_dtau_ssnll_tst_M33___',dtau_dtau_ssnll_tst_M33___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_pwv',dtau_dtau_ssnll_pwv,'dtau_dtau_ssnll_tst',dtau_dtau_ssnll_tst);
fnorm_disp(flag_verbose,'dtau_dtau_S_k_p_pwv_wkS33____',dtau_dtau_S_k_p_pwv_wkS33____,'dtau_dtau_S_k_p_tst_wkS33____',dtau_dtau_S_k_p_tst_wkS33____);
n_wk = n_w_max*n_k_p_r; n_3 = 3;
%%%%;
S_k_p_errabs_wkS__ = abs(S_k_p_pwv_wkS__ - S_k_p_tst_wkS__);
dtau_S_k_p_errabs_wkS3___ = abs(dtau_S_k_p_pwv_wkS3___ - dtau_S_k_p_tst_wkS3___);
dtau_dtau_S_k_p_errabs_wkS33____ = abs(dtau_dtau_S_k_p_pwv_wkS33____ - dtau_dtau_S_k_p_tst_wkS33____);
%%%%;
[tmp_val,tmp_ij] = max(S_k_p_errabs_wkS__,[],'all'); tmp_index = tmp_ij-1;
tmp_nwk = mod(tmp_index,n_wk); tmp_index = round((tmp_index-tmp_nwk)/n_wk);
tmp_nS = mod(tmp_index,n_S); tmp_index = round((tmp_index-tmp_nS)/n_S);
assert(tmp_index==0);
tmp_polar_a = viewing_polar_a_S_(1+tmp_nS);
tmp_azimu_b = viewing_azimu_b_S_(1+tmp_nS);
if (flag_verbose>0);
disp(sprintf(' %% S_k_p_errabs_wkS__: %0.16f tmp_nwk %d tmp_nS %d polar_a/pi %+0.2f azimu_b/pi %+0.2f',tmp_val,tmp_nwk,tmp_nS,tmp_polar_a/pi,tmp_azimu_b/pi));
end;%if (flag_verbose>0);
%%%%;
[tmp_val,tmp_ij] = max(dtau_S_k_p_errabs_wkS3___,[],'all'); tmp_index = tmp_ij-1;
tmp_nwk = mod(tmp_index,n_wk); tmp_index = round((tmp_index-tmp_nwk)/n_wk);
tmp_nS = mod(tmp_index,n_S); tmp_index = round((tmp_index-tmp_nS)/n_S);
tmp_n3 = mod(tmp_index,n_3); tmp_index = round((tmp_index-tmp_n3)/n_3);
assert(tmp_index==0);
tmp_polar_a = viewing_polar_a_S_(1+tmp_nS);
tmp_azimu_b = viewing_azimu_b_S_(1+tmp_nS);
if (flag_verbose>0);
disp(sprintf(' %% dtau_S_k_p_errabs_wkS3___: %0.16f tmp_nwk %d tmp_nS %d tmp_n3 %d polar_a/pi %+0.2f azimu_b/pi %+0.2f',tmp_val,tmp_nwk,tmp_nS,tmp_n3,tmp_polar_a/pi,tmp_azimu_b/pi));
end;%if (flag_verbose>0);
%%%%;
[tmp_val,tmp_ij] = max(dtau_dtau_S_k_p_errabs_wkS33____,[],'all'); tmp_index = tmp_ij-1;
tmp_nwk = mod(tmp_index,n_wk); tmp_index = round((tmp_index-tmp_nwk)/n_wk);
tmp_nS = mod(tmp_index,n_S); tmp_index = round((tmp_index-tmp_nS)/n_S);
tmp_nx = mod(tmp_index,n_3); tmp_index = round((tmp_index-tmp_nx)/n_3);
tmp_ny = mod(tmp_index,n_3); tmp_index = round((tmp_index-tmp_ny)/n_3);
assert(tmp_index==0);
tmp_polar_a = viewing_polar_a_S_(1+tmp_nS);
tmp_azimu_b = viewing_azimu_b_S_(1+tmp_nS);
if (flag_verbose>0);
disp(sprintf(' %% dtau_dtau_S_k_p_errabs_wkS33____: %0.16f tmp_nwk %d tmp_nS %d tmp_nx %d tmp_ny %d polar_a/pi %+0.2f azimu_b/pi %+0.2f',tmp_val,tmp_nwk,tmp_nS,tmp_nx,tmp_ny,tmp_polar_a/pi,tmp_azimu_b/pi));
end;%if (flag_verbose>0);
%%%%;

%%%%%%%%;
% Now test weight_imagecount_M_. ;
%%%%%%%%;

%%%%%%%%;
% Set up CTF and eta. ;
% This does not test anisotropic CTF. ;
% Nor does this test anisotropic eta. ;
%%%%%%%%;
n_alpha = 3; CTF_alpha_ = [0.10;0.15;0.30];
n_power = 2; eta_power_ = [0.50;0.75];
n_CTF = n_alpha*n_power;
n_eta = n_alpha*n_power;
CTF_k_p_wkC__ = zeros(n_w_sum,n_CTF);
eta_k_p_wke__ = zeros(n_w_sum,n_eta);
for nalpha=0:n_alpha-1;
CTF_alpha = CTF_alpha_(1+nalpha);
for npower=0:n_power-1;
eta_power = eta_power_(1+npower);
nCTF = nalpha+npower*n_alpha;
neta = nalpha+npower*n_alpha;
CTF_k_p_wk_ = (reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1])).^(1-eta_power);
CTF_k_p_wkC__(:,1+nCTF) = CTF_k_p_wk_;
eta_k_p_wk_ = (reshape(repmat(reshape(besselj(0,CTF_alpha*k_p_r_),[1,n_k_p_r]),[n_w_max,1]),[n_w_sum,1])).^(0+eta_power);
eta_k_p_wke__(:,1+neta) = eta_k_p_wk_;
end;%for npower=0:n_power-1;
end;%for nalpha=0:n_alpha-1;
%%%%;

%%%%%%%%;
% testing full on-grid ssnll. ;
%%%%%%%%;
n_M = n_S;
n_N = floor(n_S/2);
rng(0);
index_nN_from_nM_ = floor(n_N*rand(n_M,1));
index_nM_from_nN__ = cell(n_N,1);
weight_imagecount_N_ = zeros(n_N,1);
for nN=0:n_N-1;
tmp_index_ = efind(index_nN_from_nM_==nN);
index_nM_from_nN__{1+nN} = tmp_index_;
weight_imagecount_N_(1+nN) = numel(tmp_index_);
end;%for nN=0:n_N-1;
weight_imagecount_M_ = ones(n_M,1);
%%%%;
index_nCTF_from_nN_ = zeros(n_N,1);
for nN=0:n_N-1;
index_nCTF_from_nN_(1+nN) = mod(nN,n_CTF);
end;%for nN=0:n_N-1;
index_nCTF_from_nM_ = index_nCTF_from_nN_(1+index_nN_from_nM_);
%%%%;
index_neta_from_nN_ = zeros(n_N,1);
for nN=0:n_N-1;
index_neta_from_nN_(1+nN) = mod(nN,n_eta);
end;%for nN=0:n_N-1;
index_neta_from_nM_ = index_neta_from_nN_(1+index_nN_from_nM_);
%%%%;
euler_polar_a_N_ = viewing_polar_a_S_(1:n_N);
euler_azimu_b_N_ = viewing_azimu_b_S_(1:n_N);
euler_gamma_z_N_ = 2*pi*rand(n_N,1);
euler_polar_a_M_ = euler_polar_a_N_(1+index_nN_from_nM_);
euler_azimu_b_M_ = euler_azimu_b_N_(1+index_nN_from_nM_);
euler_gamma_z_M_ = euler_gamma_z_N_(1+index_nN_from_nM_);
N_k_p_wkN__ = T_k_p_wkS__(:,1:n_N);
for nN=0:n_N-1;
N_k_p_wkN__(:,1+nN) = rotate_p_to_p_fftw(n_k_p_r,n_w_,n_w_sum,N_k_p_wkN__(:,1+nN),+euler_gamma_z_N_(1+nN));
end;%for nN=0:n_N-1;
M_k_p_wkM__ = N_k_p_wkN__(:,1+index_nN_from_nM_);
%%%%;
euler_polar_a_N_ = viewing_polar_a_S_(1:n_N);
euler_azimu_b_N_ = viewing_azimu_b_S_(1:n_N);
euler_gamma_z_N_ = 2*pi*rand(n_N,1);
euler_polar_a_M_ = euler_polar_a_N_(1+index_nN_from_nM_);
euler_azimu_b_M_ = euler_azimu_b_N_(1+index_nN_from_nM_);
euler_gamma_z_M_ = euler_gamma_z_N_(1+index_nN_from_nM_);
dtau_euler_polar_a_N_ = 1*pi*rand(n_N,1);
dtau_euler_azimu_b_N_ = 2*pi*rand(n_N,1);
dtau_euler_gamma_z_N_ = 2*pi*rand(n_N,1);
dtau_euler_polar_a_M_ = dtau_euler_polar_a_N_(1+index_nN_from_nM_);
dtau_euler_azimu_b_M_ = dtau_euler_azimu_b_N_(1+index_nN_from_nM_);
dtau_euler_gamma_z_M_ = dtau_euler_gamma_z_N_(1+index_nN_from_nM_);
%%%%;

%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
[ ...
 parameter_ssnll ...
,ssnll_tst_M_ ...
,ssnll_tst_M ...
,S_k_p_tst_wkS__ ...
,dvol_ssnll_tst_M_ ...
,dvol_ssnll_tst_M ...
,dvol_S_k_p_tst_wkS__ ...
,dvol_dvol_ssnll_tst_M ...
,dtau_ssnll_tst_M3__ ...
,dtau_ssnll_tst_M ...
,dtau_S_k_p_tst_wkS3___ ...
,dtau_dvol_ssnll_tst_M3__ ...
,dtau_dvol_ssnll_tst_M ...
,dtau_dvol_S_k_p_tst_wkS3___ ...
,dtau_dtau_ssnll_tst_M33___ ...
,dtau_dtau_ssnll_tst_M ...
,dtau_dtau_S_k_p_tst_wkS33____ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_form_ ...
,dvol_a_k_p_form_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_viewing_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_M ...
,weight_imagecount_M_ ...
,M_k_p_wkM__ ...
,index_nCTF_from_nM_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nM_ ...
,eta_k_p_wke__ ...
,euler_polar_a_M_ ...
,euler_azimu_b_M_ ...
,euler_gamma_z_M_ ...
,dtau_euler_polar_a_M_ ...
,dtau_euler_azimu_b_M_ ...
,dtau_euler_gamma_z_M_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
tmp_t = tic();
if ~exist('wS_from_single_shell_sba__','var'); wS_from_single_shell_sba__=[]; end;
if ~exist('dwSda_from_single_shell_sba__','var'); dwSda_from_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_single_shell_sba__','var'); dwSdb_from_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_single_shell_sba__','var'); ddwSdaa_from_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_single_shell_sba__','var'); ddwSdab_from_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_single_shell_sba__','var'); ddwSdbb_from_single_shell_sba__=[]; end;
if ~exist('R_use__','var'); R_use__ = []; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('a_R_k_p_qk_','var'); a_R_k_p_qk_=[]; end;
if ~exist('dvol_a_R_k_p_qk_','var'); dvol_a_R_k_p_qk_=[]; end;
if ~exist('ba_from_single_shell_baba__','var'); ba_from_single_shell_baba__=[]; end;
if ~exist('wS_from_R_single_shell_sba__','var'); wS_from_R_single_shell_sba__=[]; end;
if ~exist('dwSda_from_R_single_shell_sba__','var'); dwSda_from_R_single_shell_sba__=[]; end;
if ~exist('dwSdb_from_R_single_shell_sba__','var'); dwSdb_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdaa_from_R_single_shell_sba__','var'); ddwSdaa_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdab_from_R_single_shell_sba__','var'); ddwSdab_from_R_single_shell_sba__=[]; end;
if ~exist('ddwSdbb_from_R_single_shell_sba__','var'); ddwSdbb_from_R_single_shell_sba__=[]; end;
[ ...
 parameter_ssnll ...
,ssnll_tst_N_ ...
,ssnll_tst_N ...
,S_k_p_tst_wkS__ ...
,dvol_ssnll_tst_N_ ...
,dvol_ssnll_tst_N ...
,dvol_S_k_p_tst_wkS__ ...
,dvol_dvol_ssnll_tst_N ...
,dtau_ssnll_tst_N3__ ...
,dtau_ssnll_tst_N ...
,dtau_S_k_p_tst_wkS3___ ...
,dtau_dvol_ssnll_tst_N3__ ...
,dtau_dvol_ssnll_tst_N ...
,dtau_dvol_S_k_p_tst_wkS3___ ...
,dtau_dtau_ssnll_tst_N33___ ...
,dtau_dtau_ssnll_tst_N ...
,dtau_dtau_S_k_p_tst_wkS33____ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
] = ...
ssnll_from_a_k_p_14( ...
 parameter_ssnll ...
,n_qk ...
,n_qk_csum_ ...
,k_p_r_qk_ ...
,k_p_azimu_b_qk_ ...
,k_p_polar_a_qk_ ...
,weight_3d_k_p_qk_ ...
,weight_shell_qk_ ...
,n_k_p_r ...
,k_p_r_ ...
,k_p_r_max ...
,weight_3d_k_p_r_ ...
,k_c_0_qk_ ...
,k_c_1_qk_ ...
,k_c_2_qk_ ...
,n_polar_a_k_ ...
,polar_a_ka__ ...
,n_azimu_b_ka__ ...
,a_k_p_form_ ...
,dvol_a_k_p_form_ ...
,n_w_ ...
,weight_2d_k_p_r_ ...
,weight_2d_wk_ ...
,n_viewing_S ...
,[] ...
,[] ...
,[] ...
,[] ...
,[] ...
,viewing_polar_a_S_ ...
,viewing_azimu_b_S_ ...
,viewing_weight_S_ ...
,n_viewing_polar_a ...
,viewing_polar_a_ ...
,n_viewing_azimu_b_ ...
,viewing_gamma_z_S_ ...
,n_N ...
,weight_imagecount_N_ ...
,N_k_p_wkN__ ...
,index_nCTF_from_nN_ ...
,CTF_k_p_wkC__ ...
,index_neta_from_nN_ ...
,eta_k_p_wke__ ...
,euler_polar_a_N_ ...
,euler_azimu_b_N_ ...
,euler_gamma_z_N_ ...
,dtau_euler_polar_a_N_ ...
,dtau_euler_azimu_b_N_ ...
,dtau_euler_gamma_z_N_ ...
,wS_from_single_shell_sba__ ...
,dwSda_from_single_shell_sba__ ...
,dwSdb_from_single_shell_sba__ ...
,ddwSdaa_from_single_shell_sba__ ...
,ddwSdab_from_single_shell_sba__ ...
,ddwSdbb_from_single_shell_sba__ ...
,R_use__ ...
,a_R_k_p_qk_ ...
,dvol_a_R_k_p_qk_ ...
,ba_from_single_shell_baba__ ...
,wS_from_R_single_shell_sba__ ...
,dwSda_from_R_single_shell_sba__ ...
,dwSdb_from_R_single_shell_sba__ ...
,ddwSdaa_from_R_single_shell_sba__ ...
,ddwSdab_from_R_single_shell_sba__ ...
,ddwSdbb_from_R_single_shell_sba__ ...
);
tmp_t = toc(tmp_t); if (flag_verbose>0); disp(sprintf(' %% ssnll_from_a_k_p_14: %0.6fs',tmp_t)); end;
%%%%%%%%;

%%%%%%%%;
% tabulate results. ;
%%%%%%%%;
fnorm_disp(flag_verbose,'ssnll_tst_N_(1+index_nN_from_nM_)',ssnll_tst_N_(1+index_nN_from_nM_),'ssnll_tst_M_',ssnll_tst_M_);
fnorm_disp(flag_verbose,'ssnll_tst_N',ssnll_tst_N,'ssnll_tst_M',ssnll_tst_M);
fnorm_disp(flag_verbose,'dvol_ssnll_tst_N_(1+index_nN_from_nM_)',dvol_ssnll_tst_N_(1+index_nN_from_nM_),'dvol_ssnll_tst_M_',dvol_ssnll_tst_M_);
fnorm_disp(flag_verbose,'dvol_ssnll_tst_N',dvol_ssnll_tst_N,'dvol_ssnll_tst_M',dvol_ssnll_tst_M);
fnorm_disp(flag_verbose,'dvol_dvol_ssnll_tst_N',dvol_dvol_ssnll_tst_N,'dvol_dvol_ssnll_tst_M',dvol_dvol_ssnll_tst_M);
fnorm_disp(flag_verbose,'dtau_ssnll_tst_N3__(1+index_nN_from_nM_,:)',dtau_ssnll_tst_N3__(1+index_nN_from_nM_,:),'dtau_ssnll_tst_M3__',dtau_ssnll_tst_M3__);
fnorm_disp(flag_verbose,'dtau_ssnll_tst_N',dtau_ssnll_tst_N,'dtau_ssnll_tst_M',dtau_ssnll_tst_M);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_tst_N3__(1+index_nN_from_nM_,:)',dtau_dvol_ssnll_tst_N3__(1+index_nN_from_nM_,:),'dtau_dvol_ssnll_tst_M3__',dtau_dvol_ssnll_tst_M3__);
fnorm_disp(flag_verbose,'dtau_dvol_ssnll_tst_N',dtau_dvol_ssnll_tst_N,'dtau_dvol_ssnll_tst_M',dtau_dvol_ssnll_tst_M);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_tst_N33___(1+index_nN_from_nM_,:,:)',dtau_dtau_ssnll_tst_N33___(1+index_nN_from_nM_,:,:),'dtau_dtau_ssnll_tst_M33___',dtau_dtau_ssnll_tst_M33___);
fnorm_disp(flag_verbose,'dtau_dtau_ssnll_tst_N',dtau_dtau_ssnll_tst_N,'dtau_dtau_ssnll_tst_M',dtau_dtau_ssnll_tst_M);

