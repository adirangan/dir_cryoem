%function test_rotations_dr();

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Generating grids ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
n_r = 32;
n_x = 2*n_r; n_y = 2*n_r;
max_x_c = 1.0; max_y_c = 1.0;
grid_x_c_ = linspace(-max_x_c/2,+max_x_c/2,n_x);
x_c_ = linspace(-max_x_c/2,+max_x_c/2,n_x);
y_c_ = linspace(-max_y_c/2,+max_y_c/2,n_y);
X_c_ = ones(n_y,1)*x_c_;
Y_c_ = transpose(y_c_)*ones(1,n_x);
R_ = sqrt(X_c_.^2 + Y_c_.^2); W_ = atan2(Y_c_,X_c_);
P_ = 0.125*(1 + 0.5*cos(5*W_) + 0.25*sin(3*W_) + 0.125*cos(1*W_));
G_x_c_ = 0.25*exp(-((X_c_-0.125).^2 + (Y_c_-0.125).^2)/2/0.125^2); 
S_x_c_ = exp(-R_./P_) + G_x_c_;
S_x_c_ = recenter2(S_x_c_);
tmp_kx_ij = n_x/2 + (-n_r/2:n_r/2-1); tmp_ky_ij = n_x/2 + (-n_r/2:n_r/2-1);
S_k_c_ = fft2(S_x_c_); S_k_c_ = recenter2(S_k_c_); S_k_c_ = S_k_c_(1+tmp_kx_ij,1+tmp_ky_ij); S_k_c_ = decenter2(S_k_c_);
max_k_c = 1.0*n_r/max_x_c;
k_c_ = linspace(-max_k_c/2,+max_k_c/2,n_r);
grid_k_p_ = linspace(1,max_k_c/2,n_r);
n_w_ = max(6,ceil(2*pi*grid_k_p_)); n_A = sum(n_w_); n_w_max = max(n_w_);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Generating initial function S_k_p_. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
S_k_p_ = zeros(n_A,1);
ic=0;
for nr=0:n_r-1;
r = grid_k_p_(1+nr);
for nw=0:n_w_(1+nr)-1;
w = 2*pi*nw/n_w_(1+nr);
%%%%%%%%%%%%%%%%;
% rugged S_k_p_;
%%%%%%%%%%%%%%%%;
n_A_tmp = 2; n_B_tmp = 3;
s_A_tmp = 8 + 2*cos(n_A_tmp*w) + 1*cos(2*n_A_tmp*w) - 0.5*cos(3*n_A_tmp*w);
s_B_tmp = 8 + 2*cos(n_B_tmp*w) - 1*cos(2*n_B_tmp*w) + 1.5*cos(3*n_B_tmp*w);
n_A_tmp = 4; n_B_tmp = 5;
A = exp(-r./s_A_tmp).*(1 + 0.5*cos(n_A_tmp*2*w));
B = exp(-r./s_B_tmp).*(1 + 0.5*sin(n_B_tmp*2*w));
S_k_p_(1+ic) = A + i*B;
%{
%%%%%%%%%%%%%%%%;
% smooth S_k_p_;
%%%%%%%%%%%%%%%%;
n_A_tmp = 1; n_B_tmp = 2;
s_A_tmp = 8 + 2*cos(n_A_tmp*w) + 1*cos(2*n_A_tmp*w) - 0.5*cos(3*n_A_tmp*w);
s_B_tmp = 8 + 2*cos(n_B_tmp*w) - 1*cos(2*n_B_tmp*w) + 1.5*cos(3*n_B_tmp*w);
n_A_tmp = 2; n_B_tmp = 1;
A = exp(-r./s_A_tmp).*(1 + 0.25*cos(n_A_tmp*2*w));
B = exp(-r./s_B_tmp).*(1 + 0.35*sin(n_B_tmp*2*w));
S_k_p_(1+ic) = A + i*B;
 %}
%%%%%%%%%%%%%%%%;
ic = ic+1;
end;%for nw=0:n_w_(1+nr)-1;
end;%for nr=0:n_r-1;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Generating rotated versions of S_k_p_. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
gamma = pi/8;
T1_k_p_ = rotate_p_to_p(n_r,n_w_,n_A,S_k_p_,+gamma);
T2_k_p_ = rotate_p_to_p_lagrange(n_r,n_w_,n_A,S_k_p_,+gamma);
T3_k_p_ = rotate_p_to_p_spectral(n_r,n_w_,n_A,S_k_p_,+gamma);

flag_disp=1;
if flag_disp;
figure(1);
pcols = 4;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,1+0*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(S_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(S_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,1+1*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(S_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(S_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,2+0*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(T1_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(T1_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,2+1*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(T1_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(T1_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,3+0*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(T2_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(T2_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,3+1*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(T2_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(T2_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,4+0*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(T3_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(T3_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,4+1*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(T3_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(T3_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
return;
end;%if flag_disp;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Calculate errors ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
D1_k_p_ = T3_k_p_(:) - T1_k_p_(:);
D2_k_p_ = T3_k_p_(:) - T2_k_p_(:);

flag_disp=0;
if flag_disp;
figure(2);
pcols = 2;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,1+0*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(D1_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('real(D1_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,1+1*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(D1_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('imag(D1_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,2+0*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(D2_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('real(D2_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,2+1*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(D2_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('imag(D2_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
end;%if flag_disp;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Rotate back  ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
U1_k_p_ = rotate_p_to_p(n_r,n_w_,n_A,T1_k_p_,-gamma);
U2_k_p_ = rotate_p_to_p_lagrange(n_r,n_w_,n_A,T2_k_p_,-gamma);
U3_k_p_ = rotate_p_to_p_spectral(n_r,n_w_,n_A,T3_k_p_,-gamma);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Calculate errors ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
E1_k_p_ = S_k_p_(:) - U1_k_p_(:);
E2_k_p_ = S_k_p_(:) - U2_k_p_(:);
E3_k_p_ = S_k_p_(:) - U3_k_p_(:);

flag_disp=1;
if flag_disp;
figure(3);
pcols = 3;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,1+0*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(E1_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('real(E1_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,1+1*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(E1_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('imag(E1_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,2+0*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(E2_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('real(E2_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,2+1*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(E2_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('imag(E2_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,3+0*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(E3_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('real(E3_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,3+1*pcols);
clim = imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(E3_k_p_),[],colormap(colormap_pm(64)));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title(sprintf('imag(E3_k_p_) [%0.5f,%0.5f]',min(clim),max(clim)),'Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
end;%if flag_disp;




