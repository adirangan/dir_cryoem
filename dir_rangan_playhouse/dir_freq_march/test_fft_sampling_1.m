%{
%% taken from test_fft_sampling_0.m ;
d1 = 5; d2 =7;
rng(1);
C = reshape(ceil(8*rand(d1*d2,1)) + i*ceil(8*rand(d1*d2,1)),d1,d2);
B = fft2(C);
k1_ = linspace(0,2*pi,d1+1); k1_ = k1_(1:end-1);
k2_ = linspace(0,2*pi,d2+1); k2_ = k2_(1:end-1);
[K2_,K1_] = meshgrid(k2_,k1_);
A = nufft2d2(d1*d2,K1_(:),K2_(:),-1,1e-12,d1,d2,decenter2(C));
A = reshape(A,d1,d2);
 %}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
% Generating initial S_x_c_ ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
tic;
n_r = 32;
n_x = 2*n_r; n_y = 2*n_r;
max_x_c = 1.0; max_y_c = 1.0;
grid_x_c_ = linspace(-max_x_c/2,+max_x_c/2,n_x);
x_c_ = linspace(-max_x_c/2,+max_x_c/2,n_x);
y_c_ = linspace(-max_y_c/2,+max_y_c/2,n_y);
X_c_ = ones(n_y,1)*x_c_;
Y_c_ = transpose(y_c_)*ones(1,n_x);
nS_sample = 0; param_1 = nS_sample*sqrt(2.5d0); param_2 = 2*(nS_sample+2);
S_x_c_ = get_F2_x_c_(n_x,max_x_c/2+grid_x_c_,max_x_c,n_x,max_x_c/2+grid_x_c_,max_x_c,param_1,param_2);
S_x_c_ = reshape(S_x_c_,n_x,n_x);
tmp_kx_ij = n_x/2 + (-n_r:n_r-1); tmp_ky_ij = n_x/2 + (-n_r:n_r-1);
S_k_c_ = fft2(S_x_c_); S_k_c_ = recenter2(S_k_c_); S_k_c_ = S_k_c_(1+tmp_kx_ij,1+tmp_ky_ij); S_k_c_ = decenter2(S_k_c_);
max_k_c = 1.0*2*n_r/max_x_c;
half_diameter_k_c = max_k_c/2.0;
k_c_ = linspace(-max_k_c/2,+max_k_c/2,2*n_r);
dtmp = half_diameter_k_c/n_r;
grid_k_p_ = linspace(dtmp,half_diameter_k_c,n_r);
for nr=0:n_r-1; n_polar_a_(1+nr) = round(pi*(nr+1)); end;%for nr=0:n_r-1;
n_w_ = 2*n_polar_a_; n_A = sum(n_w_); n_w_max = max(n_w_);
S_k_p_ = interp_c_to_p(2*n_r,max_k_c,2*n_r,max_k_c,S_k_c_,n_r,grid_k_p_,n_w_,n_A);
%%%%%%%%;
nX_r = 16*n_r;
gridX_k_p_ = linspace(dtmp,half_diameter_k_c,nX_r);
for nXr=0:nX_r-1; 
%tmp = max(64,4*ceil(round(pi*(nXr+1))/4)); 
tmp = 128;
nX_polar_a_(1+nXr) = tmp; 
end;%for nXr=0:nX_r-1;
nX_w_ = 2*nX_polar_a_; nX_A = sum(nX_w_); nX_w_max = max(nX_w_);
%%%%%%%%;
k1_ = zeros(1,nX_A); k2_ = zeros(1,nX_A);
nXa=0;
for nXr=0:nX_r-1;
tmp_k = gridX_k_p_(1+nXr);
tmp_w_ = linspace(0,2*pi,nX_w_(1+nXr)+1);
for nXw=0:nX_w_(1+nXr)-1;
k1_(1+nXa) = pi*tmp_k/half_diameter_k_c*cos(tmp_w_(1+nXw)); %<-- not sure what is going on here. ;
k2_(1+nXa) = pi*tmp_k/half_diameter_k_c*sin(tmp_w_(1+nXw)); %<-- not sure what is going on here. ;
nXa=nXa+1;
end;%for nXw=0:nX_w_(1+nXr)-1;
end;%for nXr=0:nX_r-1;
A_k_p_ = nufft2d2(nX_A,k1_(:),k2_(:),-1,1e-12,n_x,n_y,decenter2(S_x_c_));
%%%%%%%%;
S_k_q_ = interp_p_to_q(n_r,n_w_,n_A,S_k_p_);
C_x_c = innerproduct_c(n_x,x_c_,n_y,y_c_,S_x_c_,S_x_c_);
disp(sprintf(' %% <S_x_c_,S_x_c_> = (%0.4f,%0.4f)',real(C_x_c),imag(C_x_c)));
C_k_c = innerproduct_c(n_r,k_c_,n_r,k_c_,S_k_c_,S_k_c_);
disp(sprintf(' %% <S_k_c_,S_k_c_> = (%0.4f,%0.4f)',real(C_k_c),imag(C_k_c)));
C_k_p = innerproduct_p(n_r,grid_k_p_,n_w_,n_A,S_k_p_,S_k_p_);
disp(sprintf(' %% <S_k_p_,S_k_p_> = (%0.4f,%0.4f)',real(C_k_p),imag(C_k_p)));
C_k_q = innerproduct_p(n_r,grid_k_p_,n_w_,n_A,S_k_q_,S_k_q_);
disp(sprintf(' %% <S_k_q_,S_k_q_> = (%0.4f,%0.4f)',real(C_k_q),imag(C_k_q)));
disp(sprintf(' %% create S time: %0.4f',toc));
flag_disp=1;
if flag_disp;
%%%%%%%%;
% Plot original image, fourier transform, and nufft output. ;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
figure(1); pcols = 4;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,1+0*pcols); 
imagesc_c(n_x,x_c_,n_y,y_c_,real(decenter2(S_x_c_)),[],colormap(colormap_beach()));
xlim(max_x_c/2*[-1,1]);ylim(max_y_c/2*[-1,1]);
title('real(S_x_c_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[],'Ydir','normal'); axis square;
subplot(2,pcols,1+1*pcols); 
imagesc_c(n_x,x_c_,n_y,y_c_,imag(decenter2(S_x_c_)),[],colormap(colormap_beach()));
xlim(max_x_c/2*[-1,1]);ylim(max_y_c/2*[-1,1]);
title('imag(S_x_c_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[],'Ydir','normal'); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,2+0*pcols); 
imagesc_c(2*n_r,k_c_,2*n_r,k_c_,real(decenter2(S_k_c_)),[],colormap(colormap_beach()));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(S_k_c_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[],'Ydir','normal'); axis square;
subplot(2,pcols,2+1*pcols); 
imagesc_c(2*n_r,k_c_,2*n_r,k_c_,imag(decenter2(S_k_c_)),[],colormap(colormap_beach()));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(S_k_c_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[],'Ydir','normal'); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,3+0*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,real(S_k_p_),[],colormap(colormap_beach()));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(S_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,3+1*pcols);
imagesc_p(n_r,grid_k_p_,n_w_,n_A,imag(S_k_p_),[],colormap(colormap_beach()));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(S_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
subplot(2,pcols,4+0*pcols);
imagesc_p(nX_r,gridX_k_p_,nX_w_,nX_A,real(A_k_p_),[],colormap(colormap_beach()));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('real(A_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
subplot(2,pcols,4+1*pcols);
imagesc_p(nX_r,gridX_k_p_,nX_w_,nX_A,imag(A_k_p_),[],colormap(colormap_beach()));
xlim(max_k_c/2*[-1,1]);ylim(max_k_c/2*[-1,1]);
title('imag(A_k_p_)','Interpreter','none');
set(gca,'XTick',[],'YTick',[]); axis square;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ;
set(gcf,'Position',1+[0,0,1024*2,1024]);
dir_trunk = sprintf('/data/rangan/dir_cryoem/dir_rangan_playhouse');
tmp_fname = sprintf('%s/dir_freq_march/dir_jpg/freq_march_1_A',dir_trunk);
disp(sprintf(' %% writing %s',sprintf('%s.jpg',tmp_fname)));
print('-djpeg',sprintf('%s.jpg',tmp_fname));
disp('returning'); return;
end;%if flag_disp;

flag_disp=0;
if flag_disp;
%%%%%%%%;
% Plot ring of images for various k. ;
%%%%%%%%;
nX_w_sum_ = cumsum([0,nX_w_]);
%c_ = colormap('cool'); n_c = size(c_,1);
c_ = colormap('hsv'); n_c = size(c_,1);
nXr_ = round(linspace(0,64,24));
for nnXr=1:length(nXr_);
nXr = nXr_(nnXr);
subplot(4,6,nnXr); hold on;
tmp_ij_ = nX_w_sum_(1+nXr) + [0:nX_w_(1+nXr)-1 , 0]; %<-- connected path. ;
%nc = max(1,min(n_c,floor(n_c*nXr/nX_r))); plot(A_k_p_(1+tmp_ij_),'-','Color',c_(nc,:));
for nXw=0:nX_w_(1+nXr)-1; nc = max(1,min(n_c,floor(n_c*periodize(2*nXw,0,nX_w_(1+nXr))/nX_w_(1+nXr)))); plot(A_k_p_(1+tmp_ij_(1+[nXw,nXw+1])),'-','Color',c_(nc,:),'LineWidth',3); end;%for nXw=0:nX_w_(1+nXr)-1;
plot([0,0],1650*[-1,+1],'k:','LineWidth',0.5);
plot(2300*[-1,+1],[0,0],'k:','LineWidth',0.5);
hold off;
ylim(1650*[-1,+1]); xlim(2300*[-1,+1]); text(-2000,+1500,sprintf('k%0.2f',gridX_k_p_(1+nXr)));
set(gca,'XTick',[],'YTick',[]); grid on;
end;%for nnXr=1:length(nXr_);
set(gcf,'Position',1+[0,0,1024*2,1024]);
dir_trunk = sprintf('/data/rangan/dir_cryoem/dir_rangan_playhouse');
tmp_fname = sprintf('%s/dir_freq_march/dir_jpg/freq_march_1_fig_nX%d',dir_trunk,nnXr);
disp(sprintf(' %% writing %s',sprintf('%s.jpg',tmp_fname)));
print('-djpeg',sprintf('%s.jpg',tmp_fname));
disp('returning'); return;
end;%if flag_disp;

flag_disp=0;
if flag_disp;
%%%%%%%%;
% Plot one ring of images (at fixed k) for various (1-d) displacements delta. ;
%%%%%%%%;
tmp_k = 6.0;
[~,nXr] = min(abs(gridX_k_p_-tmp_k)); nXr = nXr-1;
nX_w_sum_ = cumsum([0,nX_w_]);
tmp_ij_ = nX_w_sum_(1+nXr) + [0:nX_w_(1+nXr)-1 , 0]; %<-- connected path. ;
%c_ = colormap('cool'); n_c = size(c_,1);
c_ = colormap('hsv'); n_c = size(c_,1);
%%%%%%%%;
subplot(1,2,1); hold on;
for nXw=0:nX_w_(1+nXr)-1; nc = max(1,min(n_c,floor(n_c*periodize(2*nXw,0,nX_w_(1+nXr))/nX_w_(1+nXr)))); plot(A_k_p_(1+tmp_ij_(1+[nXw,nXw+1])),'-','Color',c_(nc,:),'LineWidth',3); end;%for nXw=0:nX_w_(1+nXr)-1;
plot([0,0],1650*[-1,+1],'k:','LineWidth',0.5);
plot(2300*[-1,+1],[0,0],'k:','LineWidth',0.5);
hold off;
ylim(1650*[-1,+1]); xlim(2300*[-1,+1]); text(-2000,+1500,sprintf('k%0.2f',gridX_k_p_(1+nXr)));
set(gca,'XTick',[],'YTick',[]); grid on;
title('perfectly centered images');
%%%%%%%%;
delta_d_ = linspace(-0.1,+0.1,3);
delta_w_ = linspace(0,2*pi,9); delta_w_ = delta_w_(1:end-1);
subplot(1,2,2); hold on;
for ndelta_d=1:length(delta_d_);
for ndelta_w=1:length(delta_w_);
delta_d = delta_d_(ndelta_d); delta_w = delta_w_(ndelta_w);
for nXw=0:nX_w_(1+nXr)-1; psi = 2*pi*nXw/nX_w_(1+nXr); nc = max(1,min(n_c,floor(n_c*periodize(2*nXw,0,nX_w_(1+nXr))/nX_w_(1+nXr)))); plot(exp(+i*tmp_k*delta_d*cos(psi-delta_w))*A_k_p_(1+tmp_ij_(1+[nXw,nXw+1])),'-','Color',c_(nc,:),'LineWidth',3); end;%for nXw=0:nX_w_(1+nXr)-1;
end;%for ndelta_w=1:length(delta_w_);
end;%for ndelta_d=1:length(delta_d_);
plot([0,0],1650*[-1,+1],'k:','LineWidth',0.5);
plot(2300*[-1,+1],[0,0],'k:','LineWidth',0.5);
hold off;
ylim(1650*[-1,+1]); xlim(2300*[-1,+1]); text(-2000,+1500,sprintf('k%0.2f',gridX_k_p_(1+nXr)));
set(gca,'XTick',[],'YTick',[]); grid on;
title(sprintf('centering error <= %0.2f',max(abs(delta_d_))));
%%%%%%%%;
set(gcf,'Position',1+[0,0,1024*2,1024]);
dir_trunk = sprintf('/data/rangan/dir_cryoem/dir_rangan_playhouse');
tmp_fname = sprintf('%s/dir_freq_march/dir_jpg/freq_march_1_centering_error_k%d',dir_trunk,round(tmp_k));
disp(sprintf(' %% writing %s',sprintf('%s.jpg',tmp_fname)));
print('-djpeg',sprintf('%s.jpg',tmp_fname));
disp('returning'); return;
end;%if flag_disp;

flag_disp=0;
if flag_disp;
%%%%%%%%;
% Movie of ring of images as k increases. ;
%%%%%%%%;
nX_w_sum_ = cumsum([0,nX_w_]);
%c_ = colormap('cool'); n_c = size(c_,1);
c_ = colormap('hsv'); n_c = size(c_,1);
subplot(1,1,1); hold on;
for nXr=0:nX_r-1;
cla;
tmp_ij_ = nX_w_sum_(1+nXr) + [0:nX_w_(1+nXr)-1 , 0]; %<-- connected path. ;
%nc = max(1,min(n_c,floor(n_c*nXr/nX_r))); plot(A_k_p_(1+tmp_ij_),'-','Color',c_(nc,:));
for nXw=0:nX_w_(1+nXr)-1; nc = max(1,min(n_c,floor(n_c*periodize(2*nXw,0,nX_w_(1+nXr))/nX_w_(1+nXr)))); plot(A_k_p_(1+tmp_ij_(1+[nXw,nXw+1])),'-','Color',c_(nc,:),'LineWidth',3); end;%for nXw=0:nX_w_(1+nXr)-1;
plot([0,0],1650*[-1,+1],'k:','LineWidth',0.5);
plot(2300*[-1,+1],[0,0],'k:','LineWidth',0.5);
ylim(1650*[-1,+1]); xlim(2300*[-1,+1]); text(-2000,+1500,sprintf('k%0.2f',gridX_k_p_(1+nXr)));
drawnow();
pause(0.125);
end;%for nXr=0:nX_r-1;
hold off;
disp('returning'); return;
end;%if flag_disp;

flag_disp=1;
if flag_disp;
%%%%%%%%;
% Stack of rings associated with various k. ;
%%%%%%%%;
nX_w_sum_ = cumsum([0,nX_w_]); dkX = mean(diff(gridX_k_p_));
%c_ = colormap('cool'); n_c = size(c_,1);
c_ = colormap('hsv'); n_c = size(c_,1);
subplot(1,1,1); hold on;
px_ = zeros(4,nX_A);
py_ = zeros(4,nX_A);
pz_ = zeros(4,nX_A);
pc_ = zeros(4,nX_A,3);
nXa=0;
%for nXr=0:nX_r-1;
for nXr=0:64;
tmp_ij_ = nX_w_sum_(1+nXr) + [0:nX_w_(1+nXr)-1 , 0]; %<-- connected path. ;
for nXw=0:nX_w_(1+nXr)-1; 
nc = max(1,min(n_c,floor(n_c*periodize(2*nXw,0,nX_w_(1+nXr))/nX_w_(1+nXr)))); 
x1 = real(A_k_p_(1+tmp_ij_(1+[nXw+0]))); x2 = real(A_k_p_(1+tmp_ij_(1+[nXw+1])));
y1 = imag(A_k_p_(1+tmp_ij_(1+[nXw+0]))); y2 = imag(A_k_p_(1+tmp_ij_(1+[nXw+1])));
z1 = gridX_k_p_(1+nXr) - dkX/2; z2 = gridX_k_p_(1+nXr) + dkX/2;
px_(:,1+nXa) = [x1;x2;x2;x1];
py_(:,1+nXa) = [y1;y2;y2;y1];
pz_(:,1+nXa) = [z1;z1;z2;z2];
pc_(:,1+nXa,:) = repmat(c_(nc,:),4,1);
nXa = nXa+1;
end;%for nXw=0:nX_w_(1+nXr)-1;
end;%for nXr=0:nX_r-1;
p=patch(px_,py_,pz_,pc_); set(p,'EdgeColor','none');
hold off;
grid on;
xlabel('real'); ylabel('imag'); zlabel('k');
set(gcf,'Position',1+[0,0,1024*2,1024]);
dir_trunk = sprintf('/data/rangan/dir_cryoem/dir_rangan_playhouse');
tmp_fname = sprintf('%s/dir_freq_march/dir_jpg/freq_march_1_stack',dir_trunk);
disp(sprintf(' %% writing %s',sprintf('%s.jpg',tmp_fname)));
print('-djpeg',sprintf('%s.jpg',tmp_fname));
disp('returning'); return;
end;%if flag_disp;

flag_disp=1;
if flag_disp;
%%%%%%%%;
% Surface of rings across various k. ;
%%%%%%%%;
nX_w_sum_ = cumsum([0,nX_w_]); dkX = mean(diff(gridX_k_p_));
%c_ = colormap('cool'); n_c = size(c_,1);
c_ = colormap('hsv'); n_c = size(c_,1);
subplot(1,1,1); hold on;
px_ = zeros(4,nX_A);
py_ = zeros(4,nX_A);
pz_ = zeros(4,nX_A);
pc_ = zeros(4,nX_A,3);
nXa=0;
%for nXr=0:nX_r-2;
for nXr=0:64;
nXr_pre = nXr+0;
nXr_pos = nXr+1;
tmp_ij_pre_ = nX_w_sum_(1+nXr_pre) + [0:nX_w_(1+nXr_pre)-1 , 0]; %<-- connected path. ;
tmp_ij_pos_ = nX_w_sum_(1+nXr_pos) + [0:nX_w_(1+nXr_pos)-1 , 0]; %<-- connected path. ;
for nXw=0:nX_w_(1+nXr_pre)-1; 
nc = max(1,min(n_c,floor(n_c*periodize(2*nXw,0,nX_w_(1+nXr_pre))/nX_w_(1+nXr_pre)))); 
x1_pre = real(A_k_p_(1+tmp_ij_pre_(1+[nXw+0]))); x2_pre = real(A_k_p_(1+tmp_ij_pre_(1+[nXw+1])));
y1_pre = imag(A_k_p_(1+tmp_ij_pre_(1+[nXw+0]))); y2_pre = imag(A_k_p_(1+tmp_ij_pre_(1+[nXw+1])));
x1_pos = real(A_k_p_(1+tmp_ij_pos_(1+[nXw+0]))); x2_pos = real(A_k_p_(1+tmp_ij_pos_(1+[nXw+1])));
y1_pos = imag(A_k_p_(1+tmp_ij_pos_(1+[nXw+0]))); y2_pos = imag(A_k_p_(1+tmp_ij_pos_(1+[nXw+1])));
z_pre = gridX_k_p_(1+nXr_pre); z_pos = gridX_k_p_(1+nXr_pos);
px_(:,1+nXa) = [x1_pre;x2_pre;x2_pos;x1_pos];
py_(:,1+nXa) = [y1_pre;y2_pre;y2_pos;y1_pos];
pz_(:,1+nXa) = [z_pre;z_pre;z_pos;z_pos];
pc_(:,1+nXa,:) = repmat(c_(nc,:),4,1);
nXa = nXa+1;
end;%for nXw=0:nX_w_(1+nXr_pre)-1;
end;%for nXr=0:nX_r-2;
p=patch(px_,py_,pz_,pc_); set(p,'EdgeColor','none');
hold off;
disp('returning'); return;
end;%if flag_disp;

